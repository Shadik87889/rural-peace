<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel Dashboard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for a clean look -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Google Fonts for Testimonials (Anton and Dancing Script) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Anton&family=Dancing+Script:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <!-- Summernote CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css"
      rel="stylesheet"
    />

    <!-- Chart.js CDN for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

    <!-- Custom CSS for admin panel -->
    <link rel="stylesheet" href="admin-panel-extra.css" />
  </head>
  <body>
    <!-- Overlay for mobile sidebar (hidden by default) -->
    <div id="sidebar-overlay" class="lg:hidden hidden overlay"></div>

    <!-- Sidebar -->
    <aside
      id="sidebar"
      class="w-64 bg-white shadow-lg p-6 flex flex-col rounded-r-lg max-h-screen overflow-y-auto sidebar-menu fixed lg:static inset-y-0 left-0 z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out"
    >
      <!-- Logo/Brand Section -->
      <div class="flex items-center justify-center mb-10 mt-2">
        <img
          src="https://placehold.co/40x40/ED3A52/white?text=A"
          alt="Admin Logo"
          class="w-10 h-10 rounded-full mr-3 shadow-md"
        />
        <span class="text-xl font-bold text-gray-800">Admin Panel</span>
      </div>

      <!-- Search Bar for Sidebar (Visible on mobile when sidebar is open, hidden on desktop) -->
      <div class="relative mb-6 lg:hidden">
        <input
          type="text"
          id="sidebar-search"
          placeholder="Search..."
          class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-700 text-sm w-full"
        />
        <i
          class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
        ></i>
      </div>

      <!-- Navigation Menu -->
      <nav class="flex-grow">
        <ul class="space-y-2">
          <!-- Dashboard -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200 active-link"
              data-page="dashboard"
            >
              <i class="fas fa-chart-line text-lg mr-4"></i>
              Dashboard
            </a>
          </li>
          <!-- Registration -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
              data-page="registration"
            >
              <i class="fas fa-user-plus text-lg mr-4"></i>
              Registration
            </a>
          </li>
          <!-- Messages -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
              data-page="messages"
            >
              <i class="fas fa-envelope text-lg mr-4"></i>
              Messages
            </a>
          </li>
          <!-- Our Teacher -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
              data-page="our-teacher"
            >
              <i class="fas fa-chalkboard-teacher text-lg mr-4"></i>
              Our Teacher
            </a>
          </li>
          <!-- Student History -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
              data-page="student-history"
            >
              <i class="fas fa-history text-lg mr-4"></i>
              Student History
            </a>
          </li>
          <!-- Courses -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
              data-page="courses"
            >
              <i class="fas fa-book-open text-lg mr-4"></i>
              Courses
            </a>
          </li>
          <!-- Community Forum -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
              data-page="community-forum"
            >
              <i class="fas fa-users text-lg mr-4"></i>
              Community Forum
            </a>
          </li>
          <!-- Blog -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
              data-page="blog"
            >
              <i class="fas fa-blog text-lg mr-4"></i>
              Blog
            </a>
          </li>
          <!-- Free Resources -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
              data-page="free-resources"
            >
              <i class="fas fa-file-alt text-lg mr-4"></i>
              Free Resources
            </a>
          </li>
          <!-- Mock Test -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
              data-page="mock-test"
            >
              <i class="fas fa-clipboard-list text-lg mr-4"></i>
              Mock Test
            </a>
          </li>
          <!-- Quizzes -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
              data-page="quizzes"
            >
              <i class="fas fa-question-circle text-lg mr-4"></i>
              Quizzes
            </a>
          </li>
          <!-- Testimonial -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
              data-page="testimonial"
            >
              <i class="fas fa-star text-lg mr-4"></i>
              Testimonial
            </a>
          </li>
          <!-- Block List -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
              data-page="block-list"
            >
              <i class="fas fa-ban text-lg mr-4"></i>
              Block List
            </a>
          </li>
          <!-- Home Page Link -->
          <li>
            <a
              href="#"
              class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
              data-page="homepage"
            >
              <i class="fas fa-home text-lg mr-4"></i>
              Home Page
            </a>
          </li>
        </ul>
      </nav>

      <!-- Log Out Button - Removed for now -->
      <!-- <div class="mt-auto pt-6 border-t border-gray-200">
        <a
          href="#"
          id="logout-btn"
          class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
        >
          <i class="fas fa-sign-out-alt text-lg mr-4"></i>
          Log Out
        </a>
      </div> -->
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col bg-gray-50 h-full w-[100%]">
      <!-- Removed max-h-screen -->
      <!-- Header -->
      <header
        class="bg-white shadow-sm py-4 px-6 flex items-center justify-between flex-nowrap rounded-bl-lg"
      >
        <div class="flex items-center space-x-4 flex-shrink-0">
          <!-- Hamburger Menu Icon for Mobile -->
          <button
            id="hamburger-menu"
            class="lg:hidden text-gray-600 hover:text-red-600 text-2xl"
          >
            <i class="fas fa-bars"></i>
          </button>
          <!-- Date Picker -->
          <div class="relative">
            <input
              type="date"
              id="date-picker"
              class="p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500 text-gray-700 text-sm w-32 sm:w-auto"
            />
          </div>
          <!-- Export PDF Button -->
          <button
            id="export-pdf-btn"
            class="flex items-center bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md transition-colors duration-200 text-sm hidden md:flex"
          >
            <i class="fas fa-file-export mr-2"></i>
            Export PDF
          </button>
        </div>

        <div
          class="flex items-center space-x-4 sm:space-x-6 flex-shrink-0 ml-auto"
        >
          <!-- Search Bar for Header (Hidden on small screens, shown on medium and up) -->
          <div class="relative hidden md:block flex-grow-0">
            <input
              type="text"
              placeholder="Search..."
              class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-700 text-sm w-40 lg:w-64"
            />
            <i
              class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
            ></i>
          </div>
          <!-- Icons (e.g., Notifications, Settings) -->
          <button
            id="notifications-btn"
            class="relative text-gray-600 hover:text-red-600 transition-colors duration-200"
          >
            <i class="fas fa-bell text-xl"></i>
            <span
              class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full transform translate-x-1/2 -translate-y-1/2"
              >3</span
            >
          </button>
          <button
            id="settings-btn"
            class="text-gray-600 hover:text-red-600 transition-colors duration-200"
          >
            <i class="fas fa-cog text-xl"></i>
          </button>
          <!-- User Avatar/Sign In - Modified to be always visible and not a dropdown trigger -->
          <div class="relative group flex-shrink-0">
            <img
              src="https://placehold.co/40x40/9CA3AF/white?text=U"
              alt="User Avatar"
              class="w-10 h-10 rounded-full border-2 border-gray-300 transition-all duration-200"
              title="Admin User"
            />
          </div>
        </div>
      </header>

      <!-- Page Content Area -->
      <main
        id="content-area"
        class="flex-1 p-4 sm:p-6 md:p-8 overflow-y-auto custom-scrollbar"
      >
        <!-- Content will be loaded here dynamically -->
      </main>
    </div>

    <!-- Message Box (replaces alert) -->
    <div
      id="message-box"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[1000] hidden"
    >
      <div
        class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"
      >
        <p id="message-content" class="text-gray-800 text-lg mb-4"></p>
        <button
          id="close-message-box"
          class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200"
        >
          OK
        </button>
      </div>
    </div>

    <!-- jQuery (Summernote dependency) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Summernote JS -->
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        doc,
        addDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        query,
        where,
        getDoc, // Added getDoc for fetching single testimonial
        serverTimestamp, // Import serverTimestamp for consistent dates
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

      // Firebase configuration and initialization
      // Use the provided Firebase config for local development
      const defaultAppId = "ielts-mahir-community-forum";
      const defaultFirebaseConfig = {
        apiKey: "AIzaSyAxsd0CnLsh7t7yFy3ZPp6saGD_YpLL1mY",
        authDomain: "ielts-mahir-community-forum.firebaseapp.com",
        projectId: "ielts-mahir-community-forum",
        storageBucket: "ielts-mahir-community-forum.firebasestorage.app",
        messagingSenderId: "1036043607546",
        appId: "1:1036043607546:web:bd217e04cc0ec5f296d843",
        measurementId: "G-YC4CG1WKD3",
      };

      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : defaultFirebaseConfig;
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const appId = typeof __app_id !== "undefined" ? __app_id : defaultAppId;

      let userId = null; // To store the authenticated user's ID
      let isAuthReady = false; // Flag to indicate if auth is ready

      // Current Summernote Editor instance
      let summernoteEditorInstance = null;

      // Global state for filters and pagination
      let blogCurrentPage = 1;
      const blogItemsPerPage = 6;
      // Initialize with 'all categories' to match HTML dropdown value
      let blogCurrentFilters = {
        status: "all",
        category: "all categories",
        searchTerm: "",
      };

      let testimonialCurrentPage = 1;
      const testimonialItemsPerPage = 6;
      let testimonialCurrentFilters = { status: "all", searchTerm: "" };

      let contactMessageCurrentPage = 1;
      const contactMessageItemsPerPage = 5;
      let contactMessageCurrentFilters = { status: "all", searchTerm: "" };

      let teacherCurrentPage = 1;
      const teacherItemsPerPage = 6;
      let teacherCurrentFilters = { status: "all", searchTerm: "" };
      let freeResourceCurrentPage = 1;
      const freeResourceItemsPerPage = 6;
      let freeResourceCurrentFilters = {
        status: "all",
        category: "all categories",
        searchTerm: "",
      };
      // Authenticate anonymously on page load
      async function authenticateFirebase() {
        try {
          if (typeof __initial_auth_token !== "undefined") {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
          userId = auth.currentUser.uid;
          isAuthReady = true; // Only set to true on successful authentication
          console.log("Firebase authenticated. User ID:", userId);
        } catch (error) {
          console.error("Firebase authentication failed:", error);
          isAuthReady = false; // Keep false on failure
          showMessage(
            `Failed to connect to Firebase: ${error.message}. Please check your internet connection and Firebase setup.`
          );
        }
      }

      // --- Message Box Utility (replaces alert) ---
      const showMessage = (message) => {
        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        messageContent.textContent = message;
        messageBox.classList.remove("hidden");
      };

      // --- Standalone function to resize and convert image to Base64 ---
      const processAndResizeImage = (file, maxWidth, maxHeight, callback) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            let width = img.width;
            let height = img.height;

            // Calculate new dimensions while maintaining aspect ratio
            if (width > height) {
              if (width > maxWidth) {
                height *= maxWidth / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width *= maxHeight / height;
                height = maxHeight;
              }
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            // Use quality 1.0 (maximum) for JPEG to retain highest possible quality
            // at the new, reduced dimensions. File size will be smaller than original
            // due to reduced dimensions, but quality will be maximized.
            const dataUrl = canvas.toDataURL("image/jpeg", 1.0);
            callback(dataUrl);
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      };

      // --- Drag and Drop Image Utility with Resizing ---
      // Function to set up drag and drop for an image input with optional resizing
      const setupImageDragAndDrop = (
        hiddenInputId,
        dropZoneId,
        previewImgId,
        maxWidth = 800,
        maxHeight = 400
      ) => {
        const hiddenInput = document.getElementById(hiddenInputId);
        const dropZone = document.getElementById(dropZoneId);
        const previewImg = document.getElementById(previewImgId);
        const placeholderText = dropZone.querySelector(".placeholder-text");
        const changeText = dropZone.querySelector(".change-text");

        if (
          !hiddenInput ||
          !dropZone ||
          !previewImg ||
          !placeholderText ||
          !changeText
        ) {
          console.error(
            `Missing elements for drag and drop setup: ${hiddenInputId}, ${dropZoneId}, ${previewImgId}`
          );
          return;
        }

        // Function to update preview and hidden input
        const updateImagePreview = (src) => {
          if (src) {
            previewImg.src = src;
            previewImg.classList.remove("hidden");
            placeholderText.classList.add("hidden");
            changeText.classList.remove("hidden");
            hiddenInput.value = src;
          } else {
            previewImg.src = "";
            previewImg.classList.add("hidden");
            placeholderText.classList.remove("hidden");
            changeText.classList.add("hidden");
            hiddenInput.value = ""; // Clear the input if no image
          }
        };

        // Initialize with existing value if any
        updateImagePreview(hiddenInput.value);

        // Prevent default drag behaviors
        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false); // Global prevent
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        // Highlight drop zone when item dragged over it
        ["dragenter", "dragover"].forEach((eventName) => {
          dropZone.addEventListener(
            eventName,
            () => dropZone.classList.add("border-red-500", "bg-red-50"),
            false
          );
        });

        ["dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(
            eventName,
            () => dropZone.classList.remove("border-red-500", "bg-red-50"),
            false
          );
        });

        // Handle dropped files
        dropZone.addEventListener(
          "drop",
          (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
              const file = files[0];
              if (file.type.startsWith("image/")) {
                processAndResizeImage(file, maxWidth, maxHeight, (dataUrl) => {
                  updateImagePreview(dataUrl);
                  showMessage(
                    "Image dropped, resized, and converted to Data URL."
                  );
                });
              } else {
                showMessage(
                  "Please drop an image file (e.g., .jpg, .png, .gif)."
                );
              }
            } else if (dt.getData("text/plain")) {
              // Handle URL dropped (if a URL is dragged from browser)
              const url = dt.getData("text/plain");
              // For URLs, we don't resize immediately as it's not a local file.
              // We'll trust the URL for now, but a server-side proxy would be better for real apps.
              if (url.match(/\.(jpeg|jpg|gif|png|webp|svg)$/i)) {
                // Simple URL validation for image
                updateImagePreview(url);
                showMessage("Image URL dropped.");
              } else {
                showMessage("Dropped text is not a valid image URL.");
              }
            }
          },
          false
        );

        // Handle click to open file dialog
        dropZone.addEventListener("click", () => {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = "image/*";
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith("image/")) {
              processAndResizeImage(file, maxWidth, maxHeight, (dataUrl) => {
                updateImagePreview(dataUrl);
                showMessage(
                  "Image selected, resized, and converted to Data URL."
                );
              });
            } else {
              showMessage("Please select an image file.");
            }
          };
          input.click();
        });

        // Add a function to programmatically set the image (for edit functionality)
        dropZone._setImage = updateImagePreview;
      };

      // --- Page Content Loading Function ---
      // Function to generate common HTML elements for different pages
      const generatePageHeader = (title) => `
          <h1 class="text-3xl font-bold text-gray-800 mb-6">${title}</h1>
          <div class="bg-white p-6 rounded-xl shadow-md mb-8">
              <p class="text-gray-600">This is the content for the <strong>${title}</strong> page.</p>
          </div>
          `;

      // Data storage for dynamic content (mock data) - primarily for demonstration before full Firebase integration
      const mockRegistrations = [
        { name: "John Doe", date: "2024-01-15" },
        { name: "Jane Smith", date: "2024-01-10" },
      ];

      const mockCourses = [
        {
          name: "Advanced Math",
          description:
            "Comprehensive course covering advanced mathematical concepts.",
          enrolled: 150,
          rating: 4.8,
        },
        {
          name: "Basic English",
          description: "Essential English grammar and communication skills.",
          enrolled: 200,
          rating: 4.5,
        },
      ];

      // Function to render registrations
      const renderRegistrations = () => {
        const registrationList = document.getElementById("registration-list");
        if (!registrationList) return; // Ensure element exists

        registrationList.innerHTML = ""; // Clear existing
        mockRegistrations.forEach((reg) => {
          const listItem = document.createElement("li");
          listItem.className =
            "flex justify-between items-center p-3 bg-gray-50 rounded-lg";
          listItem.innerHTML = `
                      <span>${reg.name} - <span class="text-gray-600">Registered on ${reg.date}</span></span>
                      <button class="text-blue-500 hover:text-blue-700" onclick="showMessage('Editing ${reg.name}\'s registration.')"><i class="fas fa-edit"></i></button>
                  `;
          registrationList.appendChild(listItem);
        });
      };

      // Function to render courses
      const renderCourses = () => {
        const coursesGrid = document.getElementById("courses-grid");
        if (!coursesGrid) return; // Ensure element exists

        coursesGrid.innerHTML = ""; // Clear existing
        mockCourses.forEach((course) => {
          const courseCard = document.createElement("div");
          courseCard.className = "bg-gray-50 p-4 rounded-lg shadow-sm";
          courseCard.innerHTML = `
                      <h3 class="font-bold text-gray-800 text-lg mb-2">${course.name}</h3>
                      <p class="text-gray-600 text-sm">${course.description}</p>
                      <div class="flex justify-between items-center mt-3 text-sm">
                          <span class="text-gray-500"><i class="fas fa-users mr-1"></i> ${course.enrolled} Enrolled</span>
                          <span class="text-gray-500"><i class="fas fa-star mr-1"></i> ${course.rating} Rating</span>
                      </div>
                      <button class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-4 rounded-lg" onclick="showMessage('Editing ${course.name} course.')">Edit Course</button>
                  `;
          coursesGrid.appendChild(courseCard);
        });
      };

      // --- Testimonial Management Functions (for Admin Panel) ---
      // Function to close all open testimonial dropdowns
      const closeAllKebabDropdowns = () => {
        document
          .querySelectorAll(".kebab-dropdown.active")
          .forEach((dropdown) => {
            dropdown.classList.remove("active");
          });
      };

      // Global functions for testimonial management to be called from HTML onclick
      window.updateTestimonialStatus = async (id, newStatus) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to update testimonial status before Firebase auth was ready."
          );
          return;
        }
        closeAllKebabDropdowns(); // Close dropdown after action
        try {
          const testimonialDocRef = doc(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "testimonials",
            id
          );
          await updateDoc(testimonialDocRef, { status: newStatus });
          showMessage(`Testimonial status updated to '${newStatus}'.`);
          console.log(
            `Successfully updated testimonial ${id} status to ${newStatus}.`
          );
        } catch (error) {
          console.error("Error updating testimonial status:", error);
          showMessage(`Failed to update testimonial status: ${error.message}.`);
        }
      };

      window.editTestimonial = async (id) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to edit testimonial before Firebase auth was ready."
          );
          return;
        }
        closeAllKebabDropdowns(); // Close dropdown after action
        try {
          const testimonialDocRef = doc(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "testimonials",
            id
          );
          const docSnap = await getDoc(testimonialDocRef);

          if (docSnap.exists()) {
            const testimonial = docSnap.data();
            console.log("Fetched testimonial for editing:", testimonial);
            // Populate the form for editing
            document.getElementById("testimonial-id").value = id;
            document.getElementById("testimonial-name").value =
              testimonial.name;
            document.getElementById("testimonial-role").value =
              testimonial.role;
            document.getElementById("testimonial-text").value =
              testimonial.text || "";

            // Update the image preview and hidden input using the custom function
            const avatarDropZone = document.getElementById("avatar-drop-zone");
            if (avatarDropZone && avatarDropZone._setImage) {
              avatarDropZone._setImage(testimonial.avatarSrc || "");
            }

            // Handle type selection and video URL
            const typeTextRadio = document.getElementById(
              "testimonial-type-text"
            );
            const typeVideoRadio = document.getElementById(
              "testimonial-type-video"
            );
            const videoUrlGroup = document.getElementById("video-url-group");
            const testimonialVideoSrc = document.getElementById(
              "testimonial-video-src"
            );

            if (testimonial.type === "video") {
              typeVideoRadio.checked = true;
              videoUrlGroup.classList.remove("hidden");
              testimonialVideoSrc.value = testimonial.videoSrc || "";
            } else {
              typeTextRadio.checked = true;
              videoUrlGroup.classList.add("hidden");
              testimonialVideoSrc.value = "";
            }

            // Change button text for update
            document.getElementById("add-testimonial-btn").textContent =
              "Update Testimonial";
            showMessage(
              "Form populated for editing. Update and submit to save changes."
            );
          } else {
            showMessage("Testimonial not found.");
            console.warn("Testimonial document not found for ID:", id);
          }
        } catch (error) {
          console.error("Error fetching testimonial for edit:", error);
          showMessage(
            `Failed to load testimonial for editing: ${error.message}.`
          );
        }
      };

      window.deleteTestimonial = async (id) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to delete testimonial before Firebase auth was ready."
          );
          return;
        }
        closeAllKebabDropdowns(); // Close dropdown after action
        // Using the custom message box for confirmation
        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        const closeMessageBoxBtn = document.getElementById("close-message-box");

        messageContent.textContent =
          "Are you sure you want to delete this testimonial? This action cannot be undone.";
        messageBox.classList.remove("hidden");

        // Add a temporary confirm button to the message box
        const confirmDeleteBtn = document.createElement("button");
        confirmDeleteBtn.textContent = "Confirm Delete";
        confirmDeleteBtn.className =
          "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 ml-2";
        confirmDeleteBtn.id = "confirm-delete-btn";
        messageBox.querySelector(".text-center").appendChild(confirmDeleteBtn);

        confirmDeleteBtn.addEventListener("click", async () => {
          try {
            const testimonialDocRef = doc(
              db,
              "artifacts",
              appId,
              "public",
              "data",
              "testimonials",
              id
            );
            await deleteDoc(testimonialDocRef);
            showMessage("Testimonial deleted successfully.");
            console.log(`Successfully deleted testimonial ${id}.`);
          } catch (error) {
            console.error("Error deleting testimonial:", error);
            showMessage(`Failed to delete testimonial: ${error.message}.`);
          } finally {
            // Clean up the temporary button
            confirmDeleteBtn.remove();
            messageBox.classList.add("hidden"); // Close after action
          }
        });

        // Ensure the original close button also cleans up the temporary button
        const originalCloseHandler = closeMessageBoxBtn.onclick; // Save original handler
        closeMessageBoxBtn.onclick = () => {
          confirmDeleteBtn.remove();
          messageBox.classList.add("hidden");
          if (originalCloseHandler) originalCloseHandler(); // Call original if exists
          closeMessageBoxBtn.onclick = originalCloseHandler; // Restore original handler
        };
      };

      const renderTestimonials = (filters, currentPage, itemsPerPage) => {
        if (!isAuthReady) {
          console.warn(
            "Firebase Auth not ready for testimonials. Displaying warning to user."
          );
          showMessage(
            "Testimonials cannot be loaded or managed because Firebase authentication is not ready. Please try refreshing the page."
          );
          return;
        }

        const pendingList = document.getElementById(
          "pending-testimonials-list"
        );
        const approvedList = document.getElementById(
          "approved-testimonials-list"
        );
        const rejectedList = document.getElementById(
          "rejected-testimonials-list"
        );
        const testimonialPaginationContainer = document.getElementById(
          "testimonial-pagination"
        );

        if (
          !pendingList ||
          !approvedList ||
          !rejectedList ||
          !testimonialPaginationContainer
        ) {
          console.error(
            "Testimonial lists or pagination container not found in DOM. Cannot render."
          );
          return; // Ensure elements exist
        }

        // Real-time listener for testimonials
        const testimonialsRef = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "testimonials"
        );
        console.log(
          `Setting up onSnapshot for testimonials at path: artifacts/${appId}/public/data/testimonials`
        );

        onSnapshot(
          testimonialsRef,
          (snapshot) => {
            console.log("Testimonial data snapshot received.");
            pendingList.innerHTML = "";
            approvedList.innerHTML = "";
            rejectedList.innerHTML = "";
            testimonialPaginationContainer.innerHTML = "";

            let allTestimonials = [];
            snapshot.forEach((doc) => {
              allTestimonials.push({ id: doc.id, ...doc.data() });
            });

            // Apply filters
            let filteredTestimonials = allTestimonials.filter((testimonial) => {
              const matchesStatus =
                filters.status === "all" ||
                testimonial.status === filters.status;
              const matchesSearchTerm =
                filters.searchTerm === "" ||
                testimonial.name
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                testimonial.role
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                (testimonial.text &&
                  testimonial.text
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()));
              return matchesStatus && matchesSearchTerm;
            });

            // Sort testimonials (e.g., by timestamp descending)
            filteredTestimonials.sort((a, b) => {
              const dateA = a.timestamp ? a.timestamp.toDate() : new Date(0);
              const dateB = b.timestamp ? b.timestamp.toDate() : new Date(0);
              return dateB.getTime() - dateA.getTime();
            });

            const totalPages = Math.ceil(
              filteredTestimonials.length / itemsPerPage
            );
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTestimonials = filteredTestimonials.slice(
              startIndex,
              endIndex
            );

            if (paginatedTestimonials.length === 0) {
              console.log("Filtered testimonials collection is empty.");
              // Optionally show a message in the lists if they are empty
              pendingList.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No pending testimonials.</p>';
              approvedList.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No approved testimonials.</p>';
              rejectedList.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No rejected testimonials.</p>';
            }

            // Clear previous content
            pendingList.innerHTML = "";
            approvedList.innerHTML = "";
            rejectedList.innerHTML = "";

            paginatedTestimonials.forEach((testimonial) => {
              console.log("Fetched testimonial:", testimonial); // Log each fetched testimonial

              const card = document.createElement("div");
              card.classList.add("testimonial-card-admin");
              card.dataset.id = testimonial.id; // Set data-id for easy lookup

              let contentHtml = "";

              if (testimonial.type === "video") {
                card.classList.add("video-card-admin"); // Add specific class for video styling
                contentHtml = `
                              <img src="${testimonial.avatarSrc}" alt="${
                  testimonial.name
                }" class="avatar video-avatar" onerror="this.src='https://placehold.co/80x80/9CA3AF/white?text=User'">
                              <video class="tes-video" src="${
                                testimonial.videoSrc
                              }" preload="metadata"></video>
                              <div class="play-button" data-video-id="${
                                testimonial.id
                              }"><i class="fa-solid fa-play"></i></div>
                              <div class="pause-button" data-video-id="${
                                testimonial.id
                              }" style="display:none;"><i class="fa-solid fa-pause"></i></div>
                              <p class="name video-name">${testimonial.name}</p>
                              <p class="role video-role">${testimonial.role}</p>
                              <!-- Hidden text for editing purposes -->
                              <p class="hidden-text" style="display:none;">${
                                testimonial.text || ""
                              }</p>
                          `;
              } else {
                contentHtml = `
                              <img src="${testimonial.avatarSrc}" alt="${testimonial.name}" class="avatar" onerror="this.src='https://placehold.co/80x80/9CA3AF/white?text=User'">
                              <div class="text-content">
                                  <p class="text">"${testimonial.text}"</p>
                              </div>
                              <p class="name">${testimonial.name}</p>
                              <p class="role">${testimonial.role}</p>
                          `;
              }

              // Kebab menu HTML structure
              const kebabMenu = `
                  <div class="kebab-menu-container">
                      <button class="kebab-button" aria-label="Testimonial actions" data-testimonial-id="${
                        testimonial.id
                      }">
                          <i class="fas fa-ellipsis-v"></i>
                      </button>
                      <div class="kebab-dropdown">
                          ${
                            testimonial.status === "pending"
                              ? `
                              <button onclick="updateTestimonialStatus('${testimonial.id}', 'approved')"><i class="fas fa-check-circle"></i> Approve</button>
                              <button onclick="updateTestimonialStatus('${testimonial.id}', 'rejected')"><i class="fas fa-times-circle"></i> Reject</button>
                              `
                              : ""
                          }
                          ${
                            testimonial.status === "approved"
                              ? `
                              <button onclick="updateTestimonialStatus('${testimonial.id}', 'pending')"><i class="fas fa-ban"></i> Unpublish</button>
                              `
                              : ""
                          }
                          ${
                            testimonial.status === "rejected"
                              ? `
                              <button onclick="updateTestimonialStatus('${testimonial.id}', 'approved')"><i class="fas fa-check-circle"></i> Approve</button>
                              `
                              : ""
                          }
                          <button onclick="editTestimonial('${
                            testimonial.id
                          }')"><i class="fas fa-edit"></i> Edit</button>
                          <button onclick="deleteTestimonial('${
                            testimonial.id
                          }')"><i class="fas fa-trash-alt"></i> Delete</button>
                      </div>
                  </div>
              `;

              // Add kebab menu and testimonial content
              card.innerHTML = contentHtml + kebabMenu;

              // Append to correct list based on status after filtering/pagination
              if (
                filters.status === "all" ||
                testimonial.status === filters.status
              ) {
                if (testimonial.status === "pending") {
                  pendingList.appendChild(card);
                } else if (testimonial.status === "approved") {
                  approvedList.appendChild(card);
                } else if (testimonial.status === "rejected") {
                  rejectedList.appendChild(card);
                }
              }
            });

            // Generate pagination controls
            testimonialPaginationContainer.innerHTML = "";
            if (totalPages > 1) {
              const paginationNav = document.createElement("nav");
              paginationNav.className =
                "flex justify-center items-center space-x-2 mt-4";

              const prevButton = document.createElement("button");
              prevButton.textContent = "Previous";
              prevButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                currentPage === 1
                  ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                  : "bg-red-500 hover:bg-red-600 text-white"
              }`;
              prevButton.disabled = currentPage === 1;
              prevButton.addEventListener("click", () => {
                testimonialCurrentPage = currentPage - 1;
                renderTestimonials(
                  filters,
                  testimonialCurrentPage,
                  itemsPerPage
                );
              });
              paginationNav.appendChild(prevButton);

              for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement("button");
                pageButton.textContent = i;
                pageButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                  i === currentPage
                    ? "bg-red-600 text-white"
                    : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                }`;
                pageButton.addEventListener("click", () => {
                  testimonialCurrentPage = i;
                  renderTestimonials(
                    filters,
                    testimonialCurrentPage,
                    itemsPerPage
                  );
                });
                paginationNav.appendChild(pageButton);
              }

              const nextButton = document.createElement("button");
              nextButton.textContent = "Next";
              nextButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                currentPage === totalPages
                  ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                  : "bg-red-500 hover:bg-red-600 text-white"
              }`;
              nextButton.disabled = currentPage === totalPages;
              nextButton.addEventListener("click", () => {
                testimonialCurrentPage = currentPage + 1;
                renderTestimonials(
                  filters,
                  testimonialCurrentPage,
                  itemsPerPage
                );
              });
              paginationNav.appendChild(nextButton);

              testimonialPaginationContainer.appendChild(paginationNav);
            }

            // Add event listeners for video play/pause
            document
              .querySelectorAll(".testimonial-card-admin .play-button")
              .forEach((button) => {
                button.addEventListener("click", (e) => {
                  const videoId = e.currentTarget.dataset.videoId;
                  const videoElement = document.querySelector(
                    `.testimonial-card-admin[data-id="${videoId}"] .tes-video`
                  );
                  const pauseButton = document.querySelector(
                    `.testimonial-card-admin[data-id="${videoId}"] .pause-button`
                  );

                  if (videoElement) {
                    videoElement.play();
                    e.currentTarget.style.display = "none";
                    if (pauseButton) pauseButton.style.display = "flex";
                  }
                });
              });

            document
              .querySelectorAll(".testimonial-card-admin .pause-button")
              .forEach((button) => {
                button.addEventListener("click", (e) => {
                  const videoId = e.currentTarget.dataset.videoId;
                  const videoElement = document.querySelector(
                    `.testimonial-card-admin[data-id="${videoId}"] .tes-video`
                  );
                  const playButton = document.querySelector(
                    `.testimonial-card-admin[data-id="${videoId}"] .play-button`
                  );

                  if (videoElement) {
                    videoElement.pause();
                    e.currentTarget.style.display = "none";
                    if (playButton) playButton.style.display = "flex";
                  }
                });
              });

            document
              .querySelectorAll(".testimonial-card-admin .tes-video")
              .forEach((video) => {
                video.addEventListener("ended", (e) => {
                  const videoId = e.target.closest(".testimonial-card-admin")
                    .dataset.id;
                  const playButton = document.querySelector(
                    `.testimonial-card-admin[data-id="${videoId}"] .play-button`
                  );
                  const pauseButton = document.querySelector(
                    `.testimonial-card-admin[data-id="${videoId}"] .pause-button`
                  );
                  if (playButton) playButton.style.display = "flex";
                  if (pauseButton) pauseButton.style.display = "none";
                });
                video.addEventListener("play", (e) => {
                  const videoId = e.target.closest(".testimonial-card-admin")
                    .dataset.id;
                  const playButton = document.querySelector(
                    `.testimonial-card-admin[data-id="${videoId}"] .play-button`
                  );
                  const pauseButton = document.querySelector(
                    `.testimonial-card-admin[data-id="${videoId}"] .pause-button`
                  );
                  if (playButton) playButton.style.display = "none";
                  if (pauseButton) pauseButton.style.display = "flex";
                });
                video.addEventListener("pause", (e) => {
                  const videoId = e.target.closest(".testimonial-card-admin")
                    .dataset.id;
                  const playButton = document.querySelector(
                    `.testimonial-card-admin[data-id="${videoId}"] .play-button`
                  );
                  const pauseButton = document.querySelector(
                    `.testimonial-card-admin[data-id="${videoId}"] .pause-button`
                  );
                  if (playButton) playButton.style.display = "flex";
                  if (pauseButton) pauseButton.style.display = "none";
                });
              });

            // Add event listener for kebab buttons
            document.querySelectorAll(".kebab-button").forEach((button) => {
              button.addEventListener("click", (event) => {
                event.stopPropagation(); // Prevent document click from immediately closing it
                const dropdown = button.nextElementSibling; // Get the dropdown div
                closeAllKebabDropdowns(); // Close any other open dropdowns
                dropdown.classList.toggle("active");
              });
            });
          },
          (error) => {
            console.error("Error fetching testimonials:", error);
            showMessage(
              `Error loading testimonials: ${error.message}. Please try again.`
            );
          }
        );
      };

      // --- Quiz Management Functions (for Admin Panel) ---
      // Global functions for quiz management to be called from HTML onclick
      window.updateQuizStatus = async (id, newStatus) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to update quiz status before Firebase auth was ready."
          );
          return;
        }
        try {
          const quizDocRef = doc(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "quizzes",
            id
          );
          await updateDoc(quizDocRef, { status: newStatus });
          showMessage(`Quiz status updated to '${newStatus}'.`);
          console.log(
            `Successfully updated quiz ${id} status to ${newStatus}.`
          );
        } catch (error) {
          console.error("Error updating quiz status:", error);
          showMessage(`Failed to update quiz status: ${error.message}.`);
        }
      };

      window.editQuiz = async (id) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to edit quiz before Firebase auth was ready."
          );
          return;
        }
        try {
          const quizDocRef = doc(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "quizzes",
            id
          );
          const docSnap = await getDoc(quizDocRef);

          if (docSnap.exists()) {
            const quiz = docSnap.data();
            console.log("Fetched quiz for editing:", quiz);
            // Populate the form for editing
            document.getElementById("quiz-id").value = id;
            document.getElementById("quiz-title").value = quiz.title;
            document.getElementById("quiz-description").value =
              quiz.description;
            document.getElementById("quiz-questions-count").value =
              quiz.questionsCount;

            // Change button text for update
            document.getElementById("add-quiz-btn").textContent = "Update Quiz";
            showMessage(
              "Form populated for editing. Update and submit to save changes."
            );
          } else {
            showMessage("Quiz not found.");
            console.warn("Quiz document not found for ID:", id);
          }
        } catch (error) {
          console.error("Error fetching quiz for edit:", error);
          showMessage(`Failed to load quiz for editing: ${error.message}.`);
        }
      };

      window.deleteQuiz = async (id) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to delete quiz before Firebase auth was ready."
          );
          return;
        }
        // Using the custom message box for confirmation
        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        const closeMessageBoxBtn = document.getElementById("close-message-box");

        messageContent.textContent =
          "Are you sure you want to delete this quiz? This action cannot be undone.";
        messageBox.classList.remove("hidden");

        // Add a temporary confirm button to the message box
        const confirmDeleteBtn = document.createElement("button");
        confirmDeleteBtn.textContent = "Confirm Delete";
        confirmDeleteBtn.className =
          "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 ml-2";
        confirmDeleteBtn.id = "confirm-delete-btn";
        messageBox.querySelector(".text-center").appendChild(confirmDeleteBtn);

        confirmDeleteBtn.addEventListener("click", async () => {
          try {
            const quizDocRef = doc(
              db,
              "artifacts",
              appId,
              "public",
              "data",
              "quizzes",
              id
            );
            await deleteDoc(quizDocRef);
            showMessage("Quiz deleted successfully.");
            console.log(`Successfully deleted quiz ${id}.`);
          } catch (error) {
            console.error("Error deleting quiz:", error);
            showMessage(`Failed to delete quiz: ${error.message}.`);
          } finally {
            // Clean up the temporary button
            confirmDeleteBtn.remove();
            messageBox.classList.add("hidden"); // Close after action
          }
        });

        // Ensure the original close button also cleans up the temporary button
        const originalCloseHandler = closeMessageBoxBtn.onclick; // Save original handler
        closeMessageBoxBtn.onclick = () => {
          confirmDeleteBtn.remove();
          messageBox.classList.add("hidden");
          if (originalCloseHandler) originalCloseHandler(); // Call original if exists
          closeMessageBoxBtn.onclick = originalCloseHandler; // Restore original handler
        };
      };

      const renderQuizzes = () => {
        if (!isAuthReady) {
          console.warn(
            "Firebase Auth not ready for quizzes. Displaying warning to user."
          );
          showMessage(
            "Quizzes cannot be loaded or managed because Firebase authentication is not ready. Please try refreshing the page."
          );
          return;
        }

        const publishedList = document.getElementById("published-quizzes-list");
        const draftList = document.getElementById("draft-quizzes-list");

        if (!publishedList || !draftList) {
          console.error("Quiz lists not found in DOM. Cannot render.");
          return;
        }

        const quizzesRef = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "quizzes"
        );
        console.log(
          `Setting up onSnapshot for quizzes at path: artifacts/${appId}/public/data/quizzes`
        );

        onSnapshot(
          quizzesRef,
          (snapshot) => {
            console.log("Quiz data snapshot received.");
            publishedList.innerHTML = "";
            draftList.innerHTML = "";

            if (snapshot.empty) {
              console.log("Quizzes collection is empty.");
              publishedList.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No published quizzes.</p>';
              draftList.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No draft quizzes.</p>';
            }

            snapshot.forEach((doc) => {
              const quiz = { id: doc.id, ...doc.data() };
              console.log("Fetched quiz:", quiz);

              const card = document.createElement("div");
              card.classList.add(
                "bg-white",
                "p-4",
                "rounded-lg",
                "shadow-sm",
                "flex",
                "flex-col"
              );
              card.innerHTML = `
                          <h3 class="font-bold text-gray-800 text-lg mb-2">${
                            quiz.title
                          }</h3>
                          <p class="text-gray-600 text-sm flex-grow mb-2">${
                            quiz.description
                          }</p>
                          <p class="text-gray-500 text-xs mb-4">Questions: ${
                            quiz.questionsCount
                          }</p>
                          <div class="flex flex-wrap gap-2 mt-auto">
                              ${
                                quiz.status === "draft"
                                  ? `<button class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateQuizStatus('${quiz.id}', 'published')">Publish</button>`
                                  : `<button class="bg-orange-600 hover:bg-orange-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateQuizStatus('${quiz.id}', 'draft')">Unpublish</button>`
                              }
                              <button class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="editQuiz('${
                                quiz.id
                              }')">Edit</button>
                              <button class="bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="deleteQuiz('${
                                quiz.id
                              }')">Delete</button>
                          </div>
                      `;

              if (quiz.status === "published") {
                publishedList.appendChild(card);
              } else if (quiz.status === "draft") {
                draftList.appendChild(card);
              }
            });
          },
          (error) => {
            console.error("Error fetching quizzes:", error);
            showMessage(
              `Error loading quizzes: ${error.message}. Please try again.`
            );
          }
        );
      };

      // --- Blog Management Functions (for Admin Panel) ---
      // Global functions for blog management to be called from HTML onclick
      window.updateBlogPostStatus = async (id, newStatus) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to update blog post status before Firebase auth was ready."
          );
          return;
        }
        try {
          const blogPostDocRef = doc(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "blogPosts",
            id
          );
          await updateDoc(blogPostDocRef, { status: newStatus });
          showMessage(`Blog post status updated to '${newStatus}'.`);
          console.log(
            `Successfully updated blog post ${id} status to ${newStatus}.`
          );
        } catch (error) {
          console.error("Error updating blog post status:", error);
          showMessage(`Failed to update blog post status: ${error.message}.`);
        }
      };

      window.editBlogPost = async (id) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to edit blog post before Firebase auth was ready."
          );
          return;
        }
        try {
          const blogPostDocRef = doc(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "blogPosts",
            id
          );
          const docSnap = await getDoc(blogPostDocRef);

          if (docSnap.exists()) {
            const blogPost = docSnap.data();
            console.log("Fetched blog post for editing:", blogPost);

            // Populate the form for editing
            document.getElementById("blog-id").value = id;
            document.getElementById("blog-title").value = blogPost.title;
            document.getElementById("blog-category").value = blogPost.category;

            // Set content for Summernote Editor
            if ($("#blog-content").data("summernote")) {
              $("#blog-content").summernote("code", blogPost.content || "");
            } else {
              // Fallback for direct assignment if Summernote isn't ready
              document.getElementById("blog-content").value =
                blogPost.content || "";
            }

            document.getElementById("blog-author").value = blogPost.author;

            // Update the blog image preview and hidden input using the custom function
            const blogImageDropZone = document.getElementById(
              "blog-image-drop-zone"
            );
            if (blogImageDropZone && blogImageDropZone._setImage) {
              blogImageDropZone._setImage(blogPost.image || "");
            }
            // Update the author image preview and hidden input using the custom function
            const authorImageDropZone = document.getElementById(
              "author-image-drop-zone"
            );
            if (authorImageDropZone && authorImageDropZone._setImage) {
              authorImageDropZone._setImage(blogPost.authorImg || "");
            }

            // Change button text for update
            document.getElementById("add-blog-btn").textContent =
              "Update Blog Post";
            showMessage(
              "Form populated for editing. Update and submit to save changes."
            );
          } else {
            showMessage("Blog post not found.");
            console.warn("Blog post document not found for ID:", id);
          }
        } catch (error) {
          console.error("Error fetching blog post for edit:", error);
          showMessage(
            `Failed to load blog post for editing: ${error.message}.`
          );
        }
      };

      window.deleteBlogPost = async (id) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to delete blog post before Firebase auth was ready."
          );
          return;
        }
        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        const closeMessageBoxBtn = document.getElementById("close-message-box");

        messageContent.textContent =
          "Are you sure you want to delete this blog post? This action cannot be undone.";
        messageBox.classList.remove("hidden");

        const confirmDeleteBtn = document.createElement("button");
        confirmDeleteBtn.textContent = "Confirm Delete";
        confirmDeleteBtn.className =
          "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 ml-2";
        confirmDeleteBtn.id = "confirm-delete-btn";
        messageBox.querySelector(".text-center").appendChild(confirmDeleteBtn);

        confirmDeleteBtn.addEventListener("click", async () => {
          try {
            const blogPostDocRef = doc(
              db,
              "artifacts",
              appId,
              "public",
              "data",
              "blogPosts",
              id
            );
            await deleteDoc(blogPostDocRef);
            showMessage("Blog post deleted successfully.");
            console.log(`Successfully deleted blog post ${id}.`);
          } catch (error) {
            console.error("Error deleting blog post:", error);
            showMessage(`Failed to delete blog post: ${error.message}.`);
          } finally {
            confirmDeleteBtn.remove();
            messageBox.classList.add("hidden");
          }
        });

        const originalCloseHandler = closeMessageBoxBtn.onclick;
        closeMessageBoxBtn.onclick = () => {
          confirmDeleteBtn.remove();
          messageBox.classList.add("hidden");
          if (originalCloseHandler) originalCloseHandler();
          closeMessageBoxBtn.onclick = originalCloseHandler;
        };
      };

      const renderBlogPosts = (filters, currentPage, itemsPerPage) => {
        if (!isAuthReady) {
          console.warn(
            "Firebase Auth not ready for blog posts. Displaying warning to user."
          );
          showMessage(
            "Blog posts cannot be loaded or managed because Firebase authentication is not ready. Please try refreshing the page."
          );
          return;
        }

        const blogPostsContainer = document.getElementById(
          "blog-posts-container"
        );
        const blogPostsListHeading = document.getElementById(
          "blog-posts-list-heading"
        );
        const blogPaginationContainer = document.getElementById(
          "blog-pagination"
        );

        if (
          !blogPostsContainer ||
          !blogPaginationContainer ||
          !blogPostsListHeading
        ) {
          console.error("Blog post elements not found in DOM. Cannot render.");
          return;
        }

        const blogPostsRef = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "blogPosts"
        );
        console.log(
          `Setting up onSnapshot for blogPosts at path: artifacts/${appId}/public/data/blogPosts`
        );

        onSnapshot(
          blogPostsRef,
          (snapshot) => {
            console.log("Blog post data snapshot received.");

            // Clear previous content from the main container
            blogPostsContainer.innerHTML = "";
            blogPaginationContainer.innerHTML = "";

            let allBlogPosts = [];
            snapshot.forEach((doc) => {
              allBlogPosts.push({ id: doc.id, ...doc.data() });
            });

            // Apply filters
            let filteredBlogPosts = allBlogPosts.filter((blogPost) => {
              const matchesStatus =
                filters.status === "all" || blogPost.status === filters.status;
              // Corrected category matching to "all categories"
              const matchesCategory =
                filters.category === "all categories" ||
                blogPost.category === filters.category;
              const matchesSearchTerm =
                filters.searchTerm === "" ||
                blogPost.title
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                (blogPost.content &&
                  blogPost.content
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase())) ||
                blogPost.author
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase());
              return matchesStatus && matchesCategory && matchesSearchTerm;
            });

            // Sort blog posts (e.g., by timestamp descending)
            filteredBlogPosts.sort((a, b) => {
              // FIX: Changed filteredTestimonials to filteredBlogPosts
              const dateA = a.timestamp ? a.timestamp.toDate() : new Date(0);
              const dateB = b.timestamp ? b.timestamp.toDate() : new Date(0);
              return dateB.getTime() - dateA.getTime();
            });

            const totalPages = Math.ceil(
              filteredBlogPosts.length / itemsPerPage
            );
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedBlogPosts = filteredBlogPosts.slice(
              startIndex,
              endIndex
            );

            // Update heading based on filters
            if (filters.status === "all") {
              blogPostsListHeading.textContent = "All Blog Posts";
            } else if (filters.status === "published") {
              blogPostsListHeading.textContent = "Published Blog Posts";
            } else if (filters.status === "draft") {
              blogPostsListHeading.textContent = "Draft Blog Posts";
            }

            if (paginatedBlogPosts.length === 0) {
              console.log("Filtered blog posts collection is empty.");
              blogPostsContainer.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No blog posts found matching your criteria.</p>';
            }

            paginatedBlogPosts.forEach((blogPost) => {
              console.log("Fetched blog post:", blogPost);

              const dateObj = blogPost.timestamp
                ? blogPost.timestamp.toDate()
                : new Date(); // Convert Firebase Timestamp to Date
              const formattedDate = dateObj.toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric",
              });

              const card = document.createElement("div");
              card.classList.add(
                "bg-white",
                "p-4",
                "rounded-lg",
                "shadow-sm",
                "flex",
                "flex-col",
                "border",
                "border-gray-300"
              );
              card.innerHTML = `
                      <img src="${
                        blogPost.image ||
                        "https://placehold.co/400x200/cccccc/white?text=Blog+Image"
                      }" alt="${
                blogPost.title
              }" class="w-full h-[40vw] md:h-[24vw] lg:h-[14vw] object-cover rounded-md mb-4 onerror="this.src='https://placehold.co/400x200/cccccc/white?text=Blog+Image'">
                      <div class="flex items-center justify-between text-xs text-gray-500 mb-2">
                          <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full">${
                            blogPost.category
                          }</span>
                          <span>${formattedDate}</span>
                      </div>
                      <h3 class="font-bold text-gray-800 text-lg mb-2">${
                        blogPost.title
                      }</h3>
                      
                      <div class="flex items-center text-sm text-gray-700 mb-4">
                          <img src="${
                            blogPost.authorImg ||
                            "https://placehold.co/40x40/9CA3AF/white?text=A"
                          }" alt="${
                blogPost.author
              }" class="w-8 h-8 rounded-full mr-2" onerror="this.src='https://placehold.co/40x40/9CA3AF/white?text=A'">
                          <span>${blogPost.author}</span>
                      </div>
                      <div class="flex flex-wrap gap-2 mt-auto">
                          ${
                            blogPost.status === "draft"
                              ? `<button class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateBlogPostStatus('${blogPost.id}', 'published')">Publish</button>`
                              : `<button class="bg-orange-600 hover:bg-orange-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateBlogPostStatus('${blogPost.id}', 'draft')">Unpublish</button>`
                          }
                          <button class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="editBlogPost('${
                            blogPost.id
                          }')">Edit</button>
                          <button class="bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="deleteBlogPost('${
                            blogPost.id
                          }')">Delete</button>
                      </div>
                  `;
              // Always append to the main blogPostsContainer
              blogPostsContainer.appendChild(card);
            });

            // Generate pagination controls
            blogPaginationContainer.innerHTML = "";
            if (totalPages > 1) {
              const paginationNav = document.createElement("nav");
              paginationNav.className =
                "flex justify-center items-center space-x-2 mt-4";

              const prevButton = document.createElement("button");
              prevButton.textContent = "Previous";
              prevButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                currentPage === 1
                  ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                  : "bg-red-500 hover:bg-red-600 text-white"
              }`;
              prevButton.disabled = currentPage === 1;
              prevButton.addEventListener("click", () => {
                blogCurrentPage = currentPage - 1;
                renderBlogPosts(filters, blogCurrentPage, itemsPerPage);
              });
              paginationNav.appendChild(prevButton);

              for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement("button");
                pageButton.textContent = i;
                pageButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                  i === currentPage
                    ? "bg-red-600 text-white"
                    : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                }`;
                pageButton.addEventListener("click", () => {
                  blogCurrentPage = i;
                  renderBlogPosts(filters, blogCurrentPage, itemsPerPage);
                });
                paginationNav.appendChild(pageButton);
              }

              const nextButton = document.createElement("button");
              nextButton.textContent = "Next";
              nextButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                currentPage === totalPages
                  ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                  : "bg-red-500 hover:bg-red-600 text-white"
              }`;
              nextButton.disabled = currentPage === totalPages;
              nextButton.addEventListener("click", () => {
                blogCurrentPage = currentPage + 1;
                renderBlogPosts(filters, blogCurrentPage, itemsPerPage);
              });
              paginationNav.appendChild(nextButton);

              blogPaginationContainer.appendChild(paginationNav);
            }
          },
          (error) => {
            console.error("Error fetching blog posts:", error);
            showMessage(
              `Error loading blog posts: ${error.message}. Please try again.`
            );
          }
        );
      };

      // --- Contact Messages Management Functions (for Admin Panel) ---
      window.sendContactReply = async (messageId) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to send reply before Firebase auth was ready."
          );
          return;
        }
        const replyInput = document.getElementById(`reply-input-${messageId}`);
        const replyText = replyInput ? replyInput.value.trim() : "";

        if (replyText === "") {
          showMessage("Reply message cannot be empty.");
          return;
        }

        try {
          const messageDocRef = doc(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "contactMessages",
            messageId
          );
          await updateDoc(messageDocRef, {
            adminReply: replyText,
            adminReplyTimestamp: serverTimestamp(),
            status: "replied",
          });
          showMessage("Reply sent successfully and message marked as replied!");
          console.log(`Reply sent for message ${messageId}: "${replyText}"`);
          if (replyInput) replyInput.value = ""; // Clear input field
          // Close the reply form after sending
          const replyForm = document.getElementById(`reply-form-${messageId}`);
          if (replyForm) replyForm.classList.add("hidden");
        } catch (error) {
          console.error("Error sending reply:", error);
          showMessage(`Failed to send reply: ${error.message}.`);
        }
      };

      window.toggleReplyForm = (messageId) => {
        const replyForm = document.getElementById(`reply-form-${messageId}`);
        if (replyForm) {
          replyForm.classList.toggle("hidden");
        }
      };

      const renderContactMessages = (filters, currentPage, itemsPerPage) => {
        if (!isAuthReady) {
          console.warn(
            "Firebase Auth not ready for contact messages. Displaying warning to user."
          );
          showMessage(
            "Contact messages cannot be loaded or managed because Firebase authentication is not ready. Please try refreshing the page."
          );
          return;
        }

        const contactMessagesContainer = document.getElementById(
          "contact-messages-list"
        );
        const contactMessagePaginationContainer = document.getElementById(
          "contact-message-pagination"
        );

        if (!contactMessagesContainer || !contactMessagePaginationContainer) {
          console.error(
            "Contact messages container or pagination container not found. Cannot render."
          );
          return;
        }

        const contactMessagesRef = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "contactMessages"
        );
        console.log(
          `Setting up onSnapshot for contactMessages at path: artifacts/${appId}/public/data/contactMessages`
        );

        onSnapshot(
          contactMessagesRef,
          (snapshot) => {
            console.log("Contact message data snapshot received.");
            contactMessagesContainer.innerHTML = ""; // Clear previous content
            contactMessagePaginationContainer.innerHTML = "";

            let allMessages = [];
            snapshot.forEach((doc) => {
              allMessages.push({ id: doc.id, ...doc.data() });
            });

            // Apply filters
            let filteredMessages = allMessages.filter((message) => {
              const matchesStatus =
                filters.status === "all" || message.status === filters.status;
              const matchesSearchTerm =
                filters.searchTerm === "" ||
                message.name
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                message.email
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                message.subject
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                message.message
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                (message.adminReply &&
                  message.adminReply
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()));
              return matchesStatus && matchesSearchTerm;
            });

            // Sort messages (e.g., by timestamp descending)
            filteredMessages.sort((a, b) => {
              const dateA = a.timestamp ? a.timestamp.toDate() : new Date(0);
              const dateB = b.timestamp ? b.timestamp.toDate() : new Date(0);
              return dateB.getTime() - dateA.getTime();
            });

            const totalPages = Math.ceil(
              filteredMessages.length / itemsPerPage
            );
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedMessages = filteredMessages.slice(
              startIndex,
              endIndex
            );

            if (paginatedMessages.length === 0) {
              contactMessagesContainer.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No contact messages found matching your criteria.</p>';
            }

            paginatedMessages.forEach((message) => {
              const dateObj = message.timestamp
                ? message.timestamp.toDate()
                : new Date();
              const formattedDate = dateObj.toLocaleString(); // Use local string for full date/time

              const card = document.createElement("div");
              card.classList.add(
                "bg-white",
                "p-4",
                "rounded-lg",
                "shadow-sm",
                "border",
                "border-gray-300"
              );

              let replySection = "";
              let statusBadge = "";

              if (message.status === "pending") {
                statusBadge =
                  '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-semibold">Pending</span>';
                replySection = `
                            <button onclick="toggleReplyForm('${message.id}')" class="mt-4 bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200">
                                <i class="fas fa-reply mr-2"></i> Reply
                            </button>
                            <div id="reply-form-${message.id}" class="hidden mt-4 p-3 bg-gray-100 rounded-lg">
                                <label for="reply-input-${message.id}" class="block text-gray-700 text-sm font-semibold mb-2">Your Reply:</label>
                                <textarea id="reply-input-${message.id}" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Type your reply here..."></textarea>
                                <button onclick="sendContactReply('${message.id}')" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200">Send Reply</button>
                                <button onclick="toggleReplyForm('${message.id}')" class="mt-2 ml-2 bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm py-2 px-3 rounded-lg transition-colors duration-200">Cancel</button>
                            </div>
                        `;
              } else if (message.status === "replied") {
                statusBadge =
                  '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">Replied</span>';
                const replyDate = message.adminReplyTimestamp
                  ? message.adminReplyTimestamp.toDate().toLocaleString()
                  : "N/A";
                replySection = `
                            <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                                <p class="text-gray-700 text-sm font-semibold">Admin Reply:</p>
                                <p class="text-gray-600 text-sm mt-1">${message.adminReply}</p>
                                <p class="text-gray-500 text-xs mt-2">Replied on: ${replyDate}</p>
                            </div>
                        `;
              }

              card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">${message.subject}</h3>
                                <p class="text-gray-700 text-sm">From: ${message.name} &lt;<a href="mailto:${message.email}" class="text-blue-600 hover:underline">${message.email}</a>&gt;</p>
                                <p class="text-gray-700 text-sm">Phone: <a href="tel:${message.phone}" class="text-blue-600 hover:underline">${message.phone}</a></p>
                                <p class="text-gray-500 text-xs mt-1">Received: ${formattedDate}</p>
                            </div>
                            ${statusBadge}
                        </div>
                        <p class="text-gray-600 text-base mb-4 border-t pt-3 mt-3">${message.message}</p>
                        ${replySection}
                    `;
              contactMessagesContainer.appendChild(card);
            });

            // Generate pagination controls
            contactMessagePaginationContainer.innerHTML = "";
            if (totalPages > 1) {
              const paginationNav = document.createElement("nav");
              paginationNav.className =
                "flex justify-center items-center space-x-2 mt-4";

              const prevButton = document.createElement("button");
              prevButton.textContent = "Previous";
              prevButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                currentPage === 1
                  ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                  : "bg-red-500 hover:bg-red-600 text-white"
              }`;
              prevButton.disabled = currentPage === 1;
              prevButton.addEventListener("click", () => {
                contactMessageCurrentPage = currentPage - 1;
                renderContactMessages(
                  contactMessageCurrentFilters,
                  contactMessageCurrentPage,
                  contactMessageItemsPerPage
                );
              });
              paginationNav.appendChild(prevButton);

              for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement("button");
                pageButton.textContent = i;
                pageButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                  i === currentPage
                    ? "bg-red-600 text-white"
                    : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                }`;
                pageButton.addEventListener("click", () => {
                  contactMessageCurrentPage = i;
                  renderContactMessages(
                    contactMessageCurrentFilters,
                    contactMessageCurrentPage,
                    contactMessageItemsPerPage
                  );
                });
                paginationNav.appendChild(pageButton);
              }

              const nextButton = document.createElement("button");
              nextButton.textContent = "Next";
              nextButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                currentPage === totalPages
                  ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                  : "bg-red-500 hover:bg-red-600 text-white"
              }`;
              nextButton.disabled = currentPage === totalPages;
              nextButton.addEventListener("click", () => {
                contactMessageCurrentPage = currentPage + 1;
                renderContactMessages(
                  contactMessageCurrentFilters,
                  contactMessageCurrentPage,
                  contactMessageItemsPerPage
                );
              });
              paginationNav.appendChild(nextButton);

              contactMessagePaginationContainer.appendChild(paginationNav);
            }
          },
          (error) => {
            console.error("Error fetching contact messages:", error);
            showMessage(`Error loading contact messages: ${error.message}.`);
          }
        );
      };

      // --- Teacher Management Functions (for Admin Panel) ---
      // Global functions for teacher management to be called from HTML onclick
      window.updateTeacherStatus = async (id, newStatus) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to update teacher status before Firebase auth was ready."
          );
          return;
        }
        try {
          const teacherDocRef = doc(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "teachers",
            id
          );
          await updateDoc(teacherDocRef, { status: newStatus });
          showMessage(`Teacher status updated to '${newStatus}'.`);
          console.log(
            `Successfully updated teacher ${id} status to ${newStatus}.`
          );
        } catch (error) {
          console.error("Error updating teacher status:", error);
          showMessage(`Failed to update teacher status: ${error.message}.`);
        }
      };

      window.editTeacher = async (id) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to edit teacher before Firebase auth was ready."
          );
          return;
        }
        try {
          const teacherDocRef = doc(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "teachers",
            id
          );
          const docSnap = await getDoc(teacherDocRef);

          if (docSnap.exists()) {
            const teacher = docSnap.data();
            console.log("Fetched teacher for editing:", teacher);

            // Populate the form for editing
            document.getElementById("teacher-id").value = id;
            document.getElementById("teacher-name").value = teacher.name;
            // Set the selected value for the expertise dropdown
            document.getElementById("teacher-expertise").value =
              teacher.expertise;

            // Set content for Summernote Editor (teacher-bio)
            if ($("#teacher-bio").data("summernote")) {
              $("#teacher-bio").summernote("code", teacher.bio || "");
            } else {
              document.getElementById("teacher-bio").value = teacher.bio || "";
            }

            // Update the teacher image preview and hidden input
            const teacherImageDropZone = document.getElementById(
              "teacher-image-drop-zone"
            );
            if (teacherImageDropZone && teacherImageDropZone._setImage) {
              teacherImageDropZone._setImage(teacher.image || "");
            }

            // Change button text for update
            document.getElementById("add-teacher-btn").textContent =
              "Update Teacher";
            showMessage(
              "Form populated for editing. Update and submit to save changes."
            );
          } else {
            showMessage("Teacher not found.");
            console.warn("Teacher document not found for ID:", id);
          }
        } catch (error) {
          console.error("Error fetching teacher for edit:", error);
          showMessage(`Failed to load teacher for editing: ${error.message}.`);
        }
      };

      window.deleteTeacher = async (id) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to delete teacher before Firebase auth was ready."
          );
          return;
        }
        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        const closeMessageBoxBtn = document.getElementById("close-message-box");

        messageContent.textContent =
          "Are you sure you want to delete this teacher's profile? This action cannot be undone.";
        messageBox.classList.remove("hidden");

        const confirmDeleteBtn = document.createElement("button");
        confirmDeleteBtn.textContent = "Confirm Delete";
        confirmDeleteBtn.className =
          "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 ml-2";
        confirmDeleteBtn.id = "confirm-delete-btn";
        messageBox.querySelector(".text-center").appendChild(confirmDeleteBtn);

        confirmDeleteBtn.addEventListener("click", async () => {
          try {
            const teacherDocRef = doc(
              db,
              "artifacts",
              appId,
              "public",
              "data",
              "teachers",
              id
            );
            await deleteDoc(teacherDocRef);
            showMessage("Teacher profile deleted successfully.");
            console.log(`Successfully deleted teacher ${id}.`);
          } catch (error) {
            console.error("Error deleting teacher:", error);
            showMessage(`Failed to delete teacher: ${error.message}.`);
          } finally {
            confirmDeleteBtn.remove();
            messageBox.classList.add("hidden");
          }
        });

        const originalCloseHandler = closeMessageBoxBtn.onclick;
        closeMessageBoxBtn.onclick = () => {
          confirmDeleteBtn.remove();
          messageBox.classList.add("hidden");
          if (originalCloseHandler) originalCloseHandler();
          closeMessageBoxBtn.onclick = originalCloseHandler;
        };
      };

      const renderTeachers = (filters, currentPage, itemsPerPage) => {
        if (!isAuthReady) {
          console.warn(
            "Firebase Auth not ready for teachers. Displaying warning to user."
          );
          showMessage(
            "Teacher profiles cannot be loaded or managed because Firebase authentication is not ready. Please try refreshing the page."
          );
          return;
        }

        const teachersContainer = document.getElementById(
          "teachers-list-container"
        );
        const teacherPaginationContainer = document.getElementById(
          "teacher-pagination"
        );

        if (!teachersContainer || !teacherPaginationContainer) {
          console.error(
            "Teacher list or pagination container not found in DOM. Cannot render."
          );
          return;
        }

        const teachersRef = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "teachers"
        );
        console.log(
          `Setting up onSnapshot for teachers at path: artifacts/${appId}/public/data/teachers`
        );

        onSnapshot(
          teachersRef,
          (snapshot) => {
            console.log("Teacher data snapshot received.");
            teachersContainer.innerHTML = ""; // Clear previous content
            teacherPaginationContainer.innerHTML = "";

            let allTeachers = [];
            snapshot.forEach((doc) => {
              allTeachers.push({ id: doc.id, ...doc.data() });
            });

            // Apply filters
            let filteredTeachers = allTeachers.filter((teacher) => {
              const matchesStatus =
                filters.status === "all" || teacher.status === filters.status;
              const matchesSearchTerm =
                filters.searchTerm === "" ||
                teacher.name
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                teacher.expertise
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                (teacher.bio &&
                  teacher.bio
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()));
              return matchesStatus && matchesSearchTerm;
            });

            // Sort teachers (e.g., by timestamp descending)
            filteredTeachers.sort((a, b) => {
              const dateA = a.timestamp ? a.timestamp.toDate() : new Date(0);
              const dateB = b.timestamp ? b.timestamp.toDate() : new Date(0);
              return dateB.getTime() - dateA.getTime();
            });

            const totalPages = Math.ceil(
              filteredTeachers.length / itemsPerPage
            );
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTeachers = filteredTeachers.slice(
              startIndex,
              endIndex
            );

            if (paginatedTeachers.length === 0) {
              console.log("Filtered teachers collection is empty.");
              teachersContainer.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No teachers found matching your criteria.</p>';
            }

            paginatedTeachers.forEach((teacher) => {
              console.log("Fetched teacher:", teacher);

              const card = document.createElement("div");
              card.classList.add(
                "bg-white",
                "p-4",
                "rounded-lg",
                "shadow-sm",
                "flex",
                "flex-col",
                "items-center",
                "text-center",
                "border",
                "border-gray-300"
              );
              card.innerHTML = `
                  <img src="${
                    teacher.image ||
                    "https://placehold.co/100x100/9CA3AF/white?text=Teacher"
                  }" alt="${
                teacher.name
              }" class="w-24 h-24 rounded-full object-cover mb-4" onerror="this.src='https://placehold.co/100x100/9CA3AF/white?text=Teacher'">
                  <h3 class="font-bold text-gray-800 text-lg mb-1">${
                    teacher.name
                  }</h3>
                  <p class="text-red-600 text-sm mb-3">${teacher.expertise}</p>
                  <div class="flex flex-wrap gap-2 mt-auto">
                      ${
                        teacher.status === "inactive"
                          ? `<button class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateTeacherStatus('${teacher.id}', 'active')">Activate</button>`
                          : `<button class="bg-orange-600 hover:bg-orange-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateTeacherStatus('${teacher.id}', 'inactive')">Deactivate</button>`
                      }
                      <button class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="editTeacher('${
                        teacher.id
                      }')">Edit</button>
                      <button class="bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="deleteTeacher('${
                        teacher.id
                      }')">Delete</button>
                  </div>
              `;
              teachersContainer.appendChild(card);
            });

            // Generate pagination controls
            teacherPaginationContainer.innerHTML = "";
            if (totalPages > 1) {
              const paginationNav = document.createElement("nav");
              paginationNav.className =
                "flex justify-center items-center space-x-2 mt-4";

              const prevButton = document.createElement("button");
              prevButton.textContent = "Previous";
              prevButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                currentPage === 1
                  ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                  : "bg-red-500 hover:bg-red-600 text-white"
              }`;
              prevButton.disabled = currentPage === 1;
              prevButton.addEventListener("click", () => {
                teacherCurrentPage = currentPage - 1;
                renderTeachers(filters, teacherCurrentPage, itemsPerPage);
              });
              paginationNav.appendChild(prevButton);

              for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement("button");
                pageButton.textContent = i;
                pageButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                  i === currentPage
                    ? "bg-red-600 text-white"
                    : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                }`;
                pageButton.addEventListener("click", () => {
                  teacherCurrentPage = i;
                  renderTeachers(filters, teacherCurrentPage, itemsPerPage);
                });
                paginationNav.appendChild(pageButton);
              }

              const nextButton = document.createElement("button");
              nextButton.textContent = "Next";
              nextButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                currentPage === totalPages
                  ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                  : "bg-red-500 hover:bg-red-600 text-white"
              }`;
              nextButton.disabled = currentPage === totalPages;
              nextButton.addEventListener("click", () => {
                teacherCurrentPage = currentPage + 1;
                renderTeachers(filters, teacherCurrentPage, itemsPerPage);
              });
              paginationNav.appendChild(nextButton);

              teacherPaginationContainer.appendChild(paginationNav);
            }
          },
          (error) => {
            console.error("Error fetching teachers:", error);
            showMessage(
              `Error loading teachers: ${error.message}. Please try again.`
            );
          }
        );
      };
      // --- Free Resources Management Functions (for Admin Panel) ---
      window.updateFreeResourceStatus = async (id, newStatus) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to update free resource status before Firebase auth was ready."
          );
          return;
        }
        try {
          const resourceDocRef = doc(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "freeResources", // Collection for free resources
            id
          );
          await updateDoc(resourceDocRef, { status: newStatus });
          showMessage(`Free resource status updated to '${newStatus}'.`);
          console.log(
            `Successfully updated free resource ${id} status to ${newStatus}.`
          );
        } catch (error) {
          console.error("Error updating free resource status:", error);
          showMessage(
            `Failed to update free resource status: ${error.message}.`
          );
        }
      };

      window.editFreeResource = async (id) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to edit free resource before Firebase auth was ready."
          );
          return;
        }
        try {
          const resourceDocRef = doc(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "freeResources", // Collection for free resources
            id
          );
          const docSnap = await getDoc(resourceDocRef);

          if (docSnap.exists()) {
            const resource = docSnap.data();
            console.log("Fetched free resource for editing:", resource);

            document.getElementById("free-resource-id").value = id;
            document.getElementById("free-resource-title").value =
              resource.title;
            document.getElementById("free-resource-category").value =
              resource.category;
            document.getElementById("free-resource-link").value = resource.link;
            document.getElementById("free-resource-summary").value =
              resource.summary;
            document.getElementById(
              "free-resource-keypoints"
            ).value = Array.isArray(resource.keypoints)
              ? resource.keypoints.join("\n")
              : "";

            const resourceImageDropZone = document.getElementById(
              "free-resource-image-drop-zone"
            );
            if (resourceImageDropZone && resourceImageDropZone._setImage) {
              resourceImageDropZone._setImage(resource.img || "");
            }

            document.getElementById("add-free-resource-btn").textContent =
              "Update Free Resource";
            showMessage(
              "Form populated for editing. Update and submit to save changes."
            );
          } else {
            showMessage("Free resource not found.");
            console.warn("Free resource document not found for ID:", id);
          }
        } catch (error) {
          console.error("Error fetching free resource for edit:", error);
          showMessage(
            `Failed to load free resource for editing: ${error.message}.`
          );
        }
      };

      window.deleteFreeResource = async (id) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          console.warn(
            "Attempted to delete free resource before Firebase auth was ready."
          );
          return;
        }
        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        const closeMessageBoxBtn = document.getElementById("close-message-box");

        messageContent.textContent =
          "Are you sure you want to delete this free resource? This action cannot be undone.";
        messageBox.classList.remove("hidden");

        const confirmDeleteBtn = document.createElement("button");
        confirmDeleteBtn.textContent = "Confirm Delete";
        confirmDeleteBtn.className =
          "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 ml-2";
        confirmDeleteBtn.id = "confirm-delete-btn";
        messageBox.querySelector(".text-center").appendChild(confirmDeleteBtn);

        confirmDeleteBtn.addEventListener("click", async () => {
          try {
            const resourceDocRef = doc(
              db,
              "artifacts",
              appId,
              "public",
              "data",
              "freeResources", // Collection for free resources
              id
            );
            await deleteDoc(resourceDocRef);
            showMessage("Free resource deleted successfully.");
            console.log(`Successfully deleted free resource ${id}.`);
          } catch (error) {
            console.error("Error deleting free resource:", error);
            showMessage(`Failed to delete free resource: ${error.message}.`);
          } finally {
            confirmDeleteBtn.remove();
            messageBox.classList.add("hidden");
          }
        });

        const originalCloseHandler = closeMessageBoxBtn.onclick;
        closeMessageBoxBtn.onclick = () => {
          confirmDeleteBtn.remove();
          messageBox.classList.add("hidden");
          if (originalCloseHandler) originalCloseHandler();
          closeMessageBoxBtn.onclick = originalCloseHandler;
        };
      };

      const renderFreeResources = (filters, currentPage, itemsPerPage) => {
        if (!isAuthReady) {
          console.warn(
            "Firebase Auth not ready for free resources. Displaying warning to user."
          );
          showMessage(
            "Free resources cannot be loaded or managed because Firebase authentication is not ready. Please try refreshing the page."
          );
          return;
        }

        const resourcesContainer = document.getElementById(
          "free-resources-list-container"
        );
        const resourcePaginationContainer = document.getElementById(
          "free-resource-pagination"
        );

        if (!resourcesContainer || !resourcePaginationContainer) {
          console.error(
            "Free resource list or pagination container not found in DOM. Cannot render."
          );
          return;
        }

        const freeResourcesRef = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "freeResources" // Collection for free resources
        );
        console.log(
          `Setting up onSnapshot for freeResources at path: artifacts/${appId}/public/data/freeResources`
        );

        onSnapshot(
          freeResourcesRef,
          (snapshot) => {
            console.log("Free resource data snapshot received.");
            resourcesContainer.innerHTML = ""; // Clear previous content
            resourcePaginationContainer.innerHTML = "";

            let allResources = [];
            snapshot.forEach((doc) => {
              allResources.push({ id: doc.id, ...doc.data() });
            });

            // Apply filters
            let filteredResources = allResources.filter((resource) => {
              const matchesStatus =
                filters.status === "all" || resource.status === filters.status;
              const matchesCategory =
                filters.category === "all categories" ||
                resource.category.toLowerCase() ===
                  filters.category.toLowerCase();
              const matchesSearchTerm =
                filters.searchTerm === "" ||
                resource.title
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                resource.category
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                (resource.summary &&
                  resource.summary
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()));
              return matchesStatus && matchesCategory && matchesSearchTerm;
            });

            // Sort resources (e.g., by timestamp descending)
            filteredResources.sort((a, b) => {
              const dateA = a.timestamp ? a.timestamp.toDate() : new Date(0);
              const dateB = b.timestamp ? b.timestamp.toDate() : new Date(0);
              return dateB.getTime() - dateA.getTime();
            });

            const totalPages = Math.ceil(
              filteredResources.length / itemsPerPage
            );
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedResources = filteredResources.slice(
              startIndex,
              endIndex
            );

            if (paginatedResources.length === 0) {
              console.log("Filtered free resources collection is empty.");
              resourcesContainer.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No free resources found matching your criteria.</p>';
            }

            paginatedResources.forEach((resource) => {
              console.log("Fetched free resource:", resource);

              const dateObj = resource.timestamp
                ? resource.timestamp.toDate()
                : new Date();
              const formattedDate = dateObj.toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              });

              const card = document.createElement("div");
              card.classList.add(
                "bg-white",
                "p-4",
                "rounded-lg",
                "shadow-sm",
                "flex",
                "flex-col",
                "border",
                "border-gray-300"
              );
              card.innerHTML = `
                  <img src="${
                    resource.img ||
                    "https://placehold.co/400x200/cccccc/white?text=Resource+Image"
                  }" alt="${
                resource.title
              }" class="w-full h-36 object-cover rounded-md mb-4" onerror="this.src='https://placehold.co/400x200/cccccc/white?text=Resource+Image'">
                  <h3 class="font-bold text-gray-800 text-lg mb-1">${
                    resource.title
                  }</h3>
                  <p class="text-red-600 text-sm mb-2">${resource.category}</p>
                  <p class="text-gray-500 text-xs mb-3">${formattedDate}</p>
                  <p class="text-gray-700 text-sm flex-grow mb-3">${
                    resource.summary || "No summary available."
                  }</p>
                  <div class="flex flex-wrap gap-2 mt-auto">
                      ${
                        resource.status === "inactive"
                          ? `<button class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateFreeResourceStatus('${resource.id}', 'active')">Activate</button>`
                          : `<button class="bg-orange-600 hover:bg-orange-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateFreeResourceStatus('${resource.id}', 'inactive')">Deactivate</button>`
                      }
                      <button class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="editFreeResource('${
                        resource.id
                      }')">Edit</button>
                      <button class="bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="deleteFreeResource('${
                        resource.id
                      }')">Delete</button>
                  </div>
              `;
              resourcesContainer.appendChild(card);
            });

            // Generate pagination controls
            resourcePaginationContainer.innerHTML = "";
            if (totalPages > 1) {
              const paginationNav = document.createElement("nav");
              paginationNav.className =
                "flex justify-center items-center space-x-2 mt-4";

              const prevButton = document.createElement("button");
              prevButton.textContent = "Previous";
              prevButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                currentPage === 1
                  ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                  : "bg-red-500 hover:bg-red-600 text-white"
              }`;
              prevButton.disabled = currentPage === 1;
              prevButton.addEventListener("click", () => {
                freeResourceCurrentPage = currentPage - 1;
                renderFreeResources(
                  filters,
                  freeResourceCurrentPage,
                  freeResourceItemsPerPage
                );
              });
              paginationNav.appendChild(prevButton);

              for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement("button");
                pageButton.textContent = i;
                pageButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                  i === currentPage
                    ? "bg-red-600 text-white"
                    : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                }`;
                pageButton.addEventListener("click", () => {
                  freeResourceCurrentPage = i;
                  renderFreeResources(
                    filters,
                    freeResourceCurrentPage,
                    freeResourceItemsPerPage
                  );
                });
                paginationNav.appendChild(pageButton);
              }

              const nextButton = document.createElement("button");
              nextButton.textContent = "Next";
              nextButton.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                currentPage === totalPages
                  ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                  : "bg-red-500 hover:bg-red-600 text-white"
              }`;
              nextButton.disabled = currentPage === totalPages;
              nextButton.addEventListener("click", () => {
                freeResourceCurrentPage = currentPage + 1;
                renderFreeResources(
                  filters,
                  freeResourceCurrentPage,
                  freeResourceItemsPerPage
                );
              });
              paginationNav.appendChild(nextButton);

              resourcePaginationContainer.appendChild(paginationNav);
            }
          },
          (error) => {
            console.error("Error fetching free resources:", error);
            showMessage(
              `Error loading free resources: ${error.message}. Please try again.`
            );
          }
        );
      };

      // --- Chart Rendering Function ---
      let overviewChartInstance = null; // Store chart instance to destroy/update
      const renderCharts = () => {
        const ctx = document.getElementById("overviewChart");

        if (ctx) {
          // Destroy existing chart if it exists to prevent re-rendering issues
          if (overviewChartInstance) {
            overviewChartInstance.destroy();
          }

          overviewChartInstance = new Chart(ctx, {
            type: "bar",
            data: {
              labels: [
                "Dec 1",
                "Dec 2",
                "Dec 3",
                "Dec 4",
                "Dec 5",
                "Dec 6",
                "Dec 7",
                "Dec 8",
                "Dec 9",
              ],
              datasets: [
                {
                  label: "Completion Rate",
                  data: [30, 60, 90, 70, 95, 50, 100, 80, 40], // Mock data
                  backgroundColor: [
                    "rgba(239, 68, 68, 0.8)", // Red-500
                    "rgba(59, 130, 246, 0.8)", // Blue-500
                    "rgba(16, 185, 129, 0.8)", // Green-500
                    "rgba(245, 158, 11, 0.8)", // Yellow-500
                    "rgba(239, 68, 68, 0.8)",
                    "rgba(59, 130, 246, 0.8)",
                    "rgba(16, 185, 129, 0.8)",
                    "rgba(245, 158, 11, 0.8)",
                    "rgba(239, 68, 68, 0.8)",
                  ],
                  borderColor: [
                    "rgba(239, 68, 68, 1)",
                    "rgba(59, 130, 246, 1)",
                    "rgba(16, 185, 129, 1)",
                    "rgba(245, 158, 11, 1)",
                    "rgba(239, 68, 68, 1)",
                    "rgba(59, 130, 246, 1)",
                    "rgba(16, 185, 129, 1)",
                    "rgba(245, 158, 11, 1)",
                    "rgba(239, 68, 68, 1)",
                  ],
                  borderWidth: 1,
                  borderRadius: 5, // Rounded corners for bars
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false, // Hide legend
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  title: {
                    display: true,
                    text: "Percentage (%)",
                  },
                },
                x: {
                  grid: {
                    display: false, // Hide vertical grid lines
                  },
                },
              },
            },
          });
        }
      };

      // Function to load content based on page name
      const loadPageContent = (pageName) => {
        const contentArea = document.getElementById("content-area");
        const navLinks = document.querySelectorAll(".nav-link");

        // Remove active class from all links
        navLinks.forEach((link) =>
          link.classList.remove("active-link", "bg-red-50", "text-red-600")
        );

        // Add active class to the current link
        const activeLink = document.querySelector(
          `.nav-link[data-page="${pageName}"]`
        );
        if (activeLink) {
          activeLink.classList.add("active-link", "bg-red-50", "text-red-600");
        }

        let contentHtml = "";

        // Destroy Summernote instance if it exists before loading new content
        if (summernoteEditorInstance && $("#blog-content").data("summernote")) {
          $("#blog-content").summernote("destroy");
          summernoteEditorInstance = null; // Clear the instance
          console.log("Summernote Editor instance destroyed.");
        }
        if (summernoteEditorInstance && $("#teacher-bio").data("summernote")) {
          $("#teacher-bio").summernote("destroy");
          summernoteEditorInstance = null; // Clear the instance
          console.log("Summernote Editor instance destroyed for teacher-bio.");
        }

        switch (pageName) {
          case "dashboard":
            contentHtml = `
                              ${generatePageHeader("Dashboard")}

                              <!-- Statistics Cards -->
                              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                  <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                                      <div>
                                          <div class="text-3xl font-bold text-gray-800">13,500</div>
                                          <div class="text-gray-500">Total Courses</div>
                                      </div>
                                      <i class="fas fa-book-open text-5xl text-red-200"></i>
                                  </div>
                                  <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                                      <div>
                                          <div class="text-3xl font-bold text-gray-800">13,500</div>
                                          <div class="text-gray-500">Total Students</div>
                                      </div>
                                      <i class="fas fa-users text-5xl text-blue-200"></i>
                                  </div>
                                  <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                                      <div>
                                          <div class="text-3xl font-bold text-gray-800">$ 500</div>
                                          <div class="text-gray-500">Revenue</div>
                                      </div>
                                      <i class="fas fa-dollar-sign text-5xl text-green-200"></i>
                                  </div>
                                  <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                                      <div>
                                          <div class="text-3xl font-bold text-gray-800">8</div>
                                          <div class="text-gray-500">Active Batches</div>
                                      </div>
                                      <i class="fas fa-layer-group text-5xl text-purple-200"></i>
                                  </div>
                              </div>

                              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                                  <!-- Overview Chart Section -->
                                  <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                                      <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4">
                                          <h2 class="text-xl font-semibold text-gray-800 mb-2 sm:mb-0">Overview</h2>
                                          <div class="relative w-full sm:w-auto">
                                              <select class="p-2 border border-gray-300 rounded-md text-sm w-full">
                                                  <option>Sort By Messages</option>
                                                  <option>Sort By Date</option>
                                              </select>
                                              <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                          </div>
                                      </div>
                                      <div class="h-64 mb-4">
                                          <canvas id="overviewChart"></canvas>
                                      </div>
                                      <div class="flex flex-wrap justify-center sm:justify-between gap-2 mt-4">
                                          <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm w-full sm:w-auto transition-colors duration-200" onclick="showMessage('Button December 1 clicked!')">December 1 80%</button>
                                          <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm w-full sm:w-auto transition-colors duration-200" onclick="showMessage('Button December 2 clicked!')">December 2 80%</button>
                                          <button class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm w-full sm:w-auto transition-colors duration-200" onclick="showMessage('Button December 3 clicked!')">December 3 80%</button>
                                          <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm w-full sm:w-auto transition-colors duration-200" onclick="showMessage('Button December 4 clicked!')">December 4 80%</button>
                                      </div>
                                  </div>

                                  <!-- Messages Section -->
                                  <div class="bg-white p-6 rounded-xl shadow-md">
                                      <div class="flex items-center justify-between mb-4">
                                          <h2 class="text-xl font-semibold text-gray-800">Messages</h2>
                                          <a href="#" class="text-red-500 hover:underline text-sm" onclick="showMessage('Viewing all messages!')">View All</a>
                                      </div>
                                      <div class="relative mb-4">
                                          <input type="text" placeholder="Search..." class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-700 text-sm w-full">
                                          <i
                                            class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                                          ></i>
                                      </div>
                                      <div class="space-y-4">
                                          <!-- Message Item 1 -->
                                          <div class="flex items-start">
                                              <img src="https://placehold.co/40x40/9CA3AF/white?text=JJ" alt="Jacob Jones" class="w-10 h-10 rounded-full mr-3">
                                              <div class="flex-1">
                                                  <div class="flex justify-between items-center mb-1">
                                                      <span class="font-semibold text-gray-800">Jacob Jones</span>
                                                      <span class="text-xs text-gray-500">today 05:30PM</span>
                                                  </div>
                                                  <p class="text-gray-600 text-sm">Hey! Did you finish the Hi-Fi wireframes for flora app design?</p>
                                              </div>
                                          </div>
                                          <!-- Message Item 2 -->
                                          <div class="flex items-start">
                                              <img src="https://placehold.co/40x40/9CA3AF/white?text=DL" alt="Devon Lane" class="w-10 h-10 rounded-full mr-3">
                                              <div class="flex-1">
                                                  <div class="flex justify-between items-center mb-1">
                                                      <span class="font-semibold text-gray-800">Devon Lane</span>
                                                      <span class="text-xs text-gray-500">today 05:30PM</span>
                                                  </div>
                                                  <p class="text-gray-600 text-sm">Hey! Did you finish the Hi-Fi wireframes for flora app design?</p>
                                              </div>
                                          </div>
                                          <!-- Message Item 3 -->
                                          <div class="flex items-start">
                                              <img src="https://placehold.co/40x40/9CA3AF/white?text=AF" alt="Albert Flores" class="w-10 h-10 rounded-full mr-3">
                                              <div class="flex-1">
                                                  <div class="flex justify-between items-center mb-1">
                                                      <span class="font-semibold text-gray-800">Albert Flores</span>
                                                      <span class="text-xs text-gray-500">Today-PM</span>
                                                  </div>
                                                  <p class="text-gray-600 text-sm">Hey! Did you finish the Hi-Fi wireframes for flora app design?</p>
                                              </div>
                                          </div>
                                          <!-- Message Item 4 -->
                                          <div class="flex items-start">
                                              <img src="https://placehold.co/40x40/9CA3AF/white?text=AM" alt="Arlene McCoy" class="w-10 h-10 rounded-full mr-3">
                                              <div class="flex-1">
                                                  <div class="flex justify-between items-center mb-1">
                                                      <span class="font-semibold text-gray-800">Arlene McCoy</span>
                                                      <span class="text-xs text-gray-500">1d</span>
                                                  </div>
                                                  <p class="text-gray-600 text-sm">Hey! Did you finish the Hi-Fi wireframes for flora app design?</p>
                                              </div>
                                          </div>
                                          <!-- Message Item 5 -->
                                          <div class="flex items-start">
                                              <img src="https://placehold.co/40x40/9CA3AF/white?text=BC" alt="Bessie Cooper" class="w-10 h-10 rounded-full mr-3">
                                              <div class="flex-1">
                                                  <div class="flex justify-between items-center mb-1">
                                                      <span class="font-semibold text-gray-800">Bessie Cooper</span>
                                                      <span class="text-xs text-gray-500">2d</span>
                                                  </div>
                                                  <p class="text-gray-600 text-sm">Hey! Did you finish the Hi-Fi wireframes for flora app design?</p>
                                              </div>
                                          </div>
                                      </div>
                                  </div>
                              </div>

                              <!-- Course Analytics Table -->
                              <div class="bg-white p-6 rounded-xl shadow-md">
                                  <h2 class="text-xl font-semibold text-gray-800 mb-4">Course Analytics</h2>
                                  <div class="overflow-x-auto">
                                      <table class="min-w-full divide-y divide-gray-200">
                                          <thead class="bg-gray-50">
                                              <tr>
                                                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course Name</th>
                                                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchases</th>
                                                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Views</th>
                                                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completion Rate</th>
                                              </tr>
                                          </thead>
                                          <tbody class="bg-white divide-y divide-gray-200">
                                              <tr>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Math</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">100</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">5000</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">85%</td>
                                              </tr>
                                              <tr>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Science</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">120</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">6000</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">90%</td>
                                              </tr>
                                              <tr>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">History</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">80</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">3000</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">75%</td>
                                              </tr>
                                              <tr>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">English</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">150</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">7500</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">92%</td>
                                              </tr>
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                          `;
            break;
          case "registration":
            contentHtml = `
                              ${generatePageHeader("Registration")}
                              <div class="bg-white p-6 rounded-xl shadow-md">
                                  <p class="text-gray-700">Manage user registrations here. Add new users, edit profiles, or view registration logs.</p>
                                  <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                      <h3 class="text-lg font-semibold text-gray-800 mb-3">Add New User</h3>
                                      <form id="add-user-form">
                                          <div class="mb-4">
                                              <label for="new-username" class="block text-gray-700 text-sm font-semibold mb-2">Username</label>
                                              <input type="text" id="new-username" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Enter new username" required>
                                          </div>
                                          <div class="mb-4">
                                              <label for="new-useremail" class="block text-gray-700 text-sm font-semibold mb-2">Email</label>
                                              <input type="email" id="new-useremail" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Enter new user's email" required>
                                          </div>
                                          <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add New User</button>
                                      </form>
                                  </div>
                                  <div class="mt-6">
                                      <h3 class="text-lg font-semibold text-gray-800 mb-3">Recent Registrations</h3>
                                      <ul id="registration-list" class="space-y-2">
                                          <!-- Registrations will be rendered here -->
                                      </ul>
                                  </div>
                              </div>
                          `;
            break;
          case "messages":
            contentHtml = `
                              ${generatePageHeader("Contact Form Submissions")}
                              <div class="bg-white p-6 rounded-xl shadow-md">
                                  <p class="text-gray-700">Review and respond to messages submitted through the website's contact form.</p>
                                  <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                      <h3 class="text-lg font-semibold text-gray-800 mb-3">Filter Contact Messages</h3>
                                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                          <div>
                                              <label for="contact-filter-status" class="block text-gray-700 text-sm font-semibold mb-2">Status</label>
                                              <select id="contact-filter-status" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500">
                                                  <option value="all">All Statuses</option>
                                                  <option value="pending">Pending</option>
                                                  <option value="replied">Replied</option>
                                              </select>
                                          </div>
                                          <div>
                                              <label for="contact-filter-search" class="block text-gray-700 text-sm font-semibold mb-2">Search</label>
                                              <input type="text" id="contact-filter-search" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Search by name, email, subject...">
                                          </div>
                                      </div>
                                  </div>
                                  <div id="contact-messages-list" class="space-y-4">
                                      <!-- Contact form submissions will be rendered here -->
                                  </div>
                                  <div id="contact-message-pagination" class="mt-8 flex justify-center">
                                    <!-- Contact Message Pagination will be rendered here -->
                                  </div>
                              </div>
                          `;
            // Setup filter event listeners for contact messages
            setTimeout(() => {
              document
                .getElementById("contact-filter-status")
                .addEventListener("change", (e) => {
                  contactMessageCurrentFilters.status = e.target.value;
                  contactMessageCurrentPage = 1; // Reset to first page on filter change
                  renderContactMessages(
                    contactMessageCurrentFilters,
                    contactMessageCurrentPage,
                    contactMessageItemsPerPage
                  );
                });

              document
                .getElementById("contact-filter-search")
                .addEventListener("input", (e) => {
                  contactMessageCurrentFilters.searchTerm = e.target.value;
                  contactMessageCurrentPage = 1; // Reset to first page on filter change
                  renderContactMessages(
                    contactMessageCurrentFilters,
                    contactMessageCurrentPage,
                    contactMessageItemsPerPage
                  );
                });
            }, 0); // Use setTimeout to ensure elements are rendered
            break;
          case "our-teacher":
            contentHtml = `
                              ${generatePageHeader("Teacher Management")}
                              <div class="bg-white p-6 rounded-xl shadow-md">
                                  <p class="text-gray-700">Add, edit, and manage profiles for all your IELTS teachers. Use the rich text editor for detailed biographies.</p>
                                  <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                      <h3 class="text-lg font-semibold text-gray-800 mb-3">Add/Edit Teacher</h3>
                                      <form id="teacher-form">
                                          <input type="hidden" id="teacher-id">
                                          <div class="mb-4">
                                              <label for="teacher-name" class="block text-gray-700 text-sm font-semibold mb-2">Teacher Name</label>
                                              <input type="text" id="teacher-name" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., Mahir Hossain" required>
                                          </div>
                                          <div class="mb-4">
                                              <label for="teacher-expertise" class="block text-gray-700 text-sm font-semibold mb-2">Expertise</label>
                                              <select id="teacher-expertise" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                                                  <option value="">Select an Expertise</option>
                                                  <option value="IELTS Speaking">IELTS Speaking</option>
                                                  <option value="IELTS Writing">IELTS Writing</option>
                                                  <option value="IELTS Listening">IELTS Listening</option>
                                                  <option value="IELTS Reading">IELTS Reading</option>
                                                  <option value="IELTS General Training">IELTS General Training</option>
                                                  <option value="IELTS Academic">IELTS Academic</option>
                                                  <option value="Grammar & Vocabulary">Grammar & Vocabulary</option>
                                                  <option value="Test Strategies">Test Strategies</option>
                                                  <option value="Beginner IELTS">Beginner IELTS</option>
                                                  <option value="Advanced IELTS">Advanced IELTS</option>
                                                  <option value="Overall IELTS">Overall IELTS</option>
                                              </select>
                                          </div>
                                          <div class="mb-4">
                                              <label for="teacher-bio" class="block text-gray-700 text-sm font-semibold mb-2">Biography</label>
                                              <textarea id="teacher-bio" name="bio" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-48"></textarea>
                                          </div>
                                          <!-- Drag and Drop for Teacher Image -->
                                          <div class="mb-6">
                                              <label class="block text-gray-700 text-sm font-semibold mb-2">Teacher Image</label>
                                              <input type="hidden" id="teacher-image">
                                              <div id="teacher-image-drop-zone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-red-400 transition-colors duration-200">
                                                  <img id="teacher-image-preview" class="hidden max-w-full h-auto mx-auto mb-2 rounded-full w-24 h-24 object-cover" src="" alt="Teacher Image Preview">
                                                  <p class="text-gray-500 placeholder-text"><i class="fas fa-cloud-upload-alt mr-2"></i> Drag & drop an image here or click to select</p>
                                                  <p class="text-gray-500 change-text hidden"><i class="fas fa-sync-alt mr-2"></i> Click or drag to change image</p>
                                              </div>
                                          </div>
                                          <button type="submit" id="add-teacher-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add Teacher</button>
                                      </form>
                                  </div>

                                  <div class="mt-8 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Filter Teachers</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="teacher-filter-status" class="block text-gray-700 text-sm font-semibold mb-2">Status</label>
                                            <select id="teacher-filter-status" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500">
                                                <option value="all">All Statuses</option>
                                                <option value="active">Active</option>
                                                <option value="inactive">Inactive</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="teacher-filter-search" class="block text-gray-700 text-sm font-semibold mb-2">Search</label>
                                            <input type="text" id="teacher-filter-search" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Search by name, expertise...">
                                        </div>
                                    </div>
                                  </div>

                                  <div class="mt-8">
                                      <h3 class="text-xl font-semibold text-gray-800 mb-4">All Teachers</h3>
                                      <div id="teachers-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                          <!-- Teachers will be rendered here -->
                                      </div>
                                  </div>
                                  <div id="teacher-pagination" class="mt-8 flex justify-center">
                                    <!-- Teacher Pagination will be rendered here -->
                                  </div>
                              </div>
                          `;
            // Initialize Summernote for teacher-bio
            setTimeout(() => {
              const teacherBioTextArea = document.getElementById("teacher-bio");
              if (teacherBioTextArea) {
                $(teacherBioTextArea).summernote({
                  placeholder: "Enter teacher's biography here...",
                  tabsize: 2,
                  height: 200,
                  toolbar: [
                    ["style", ["style"]],
                    ["font", ["bold", "italic", "underline", "clear"]],
                    ["fontname", ["fontname"]],
                    ["fontsize", ["fontsize"]],
                    ["color", ["color"]],
                    ["para", ["ul", "ol", "paragraph"]],
                    ["height", ["height"]],
                    ["insert", ["link", "picture", "hr"]],
                    ["view", ["codeview", "help"]],
                    ["misc", ["undo", "redo"]],
                  ],
                  callbacks: {
                    onImageUpload: function (files) {
                      const editor = $(this);
                      if (files.length > 0) {
                        const file = files[0];
                        if (file.type.startsWith("image/")) {
                          processAndResizeImage(file, 600, 300, (dataUrl) => {
                            editor.summernote("insertImage", dataUrl);
                            showMessage(
                              "Image inserted into bio (resized and Base64 encoded)."
                            );
                          });
                        } else {
                          showMessage("Please upload an image file.");
                        }
                      }
                    },
                  },
                });
                summernoteEditorInstance = $(teacherBioTextArea); // Store the instance
                console.log("Summernote Editor initialized for teacher bio.");
              }

              // Setup drag and drop for teacher image
              setupImageDragAndDrop(
                "teacher-image",
                "teacher-image-drop-zone",
                "teacher-image-preview",
                200,
                200
              );

              // Setup filter event listeners for teachers
              document
                .getElementById("teacher-filter-status")
                .addEventListener("change", (e) => {
                  teacherCurrentFilters.status = e.target.value;
                  teacherCurrentPage = 1; // Reset to first page on filter change
                  renderTeachers(
                    teacherCurrentFilters,
                    teacherCurrentPage,
                    teacherItemsPerPage
                  );
                });

              document
                .getElementById("teacher-filter-search")
                .addEventListener("input", (e) => {
                  teacherCurrentFilters.searchTerm = e.target.value;
                  teacherCurrentPage = 1; // Reset to first page on filter change
                  renderTeachers(
                    teacherCurrentFilters,
                    teacherCurrentPage,
                    teacherItemsPerPage
                  );
                });
            }, 0); // Use setTimeout to ensure elements are rendered
            break;
          case "student-history":
            contentHtml = `
                              ${generatePageHeader("Student History")}
                              <div class="bg-white p-6 rounded-xl shadow-md">
                                  <p class="text-gray-700">Track student progress, course completions, and activity logs. Search for specific student records.</p>
                                  <div class="mt-6 overflow-x-auto">
                                      <table class="min-w-full divide-y divide-gray-200">
                                          <thead class="bg-gray-50">
                                              <tr>
                                                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                                                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Enrolled Courses</th>
                                                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Activity</th>
                                                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                              </tr>
                                          </thead>
                                          <tbody class="bg-white divide-y divide-gray-200">
                                              <tr>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Alice Johnson</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Math, English</td>
                                                  <td class="px-6 py-4 whitespace-nowrap">
                                                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                                                  </td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Today</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                      <button class="text-blue-600 hover:text-blue-900 mr-2" onclick="showMessage('Viewing Alice Johnson\'s history.')">View</button>
                                                      <button class="text-red-600 hover:text-red-900" onclick="showMessage('Deleting Alice Johnson\'s record.')">Delete</button>
                                                  </td>
                                              </tr>
                                              <tr>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Bob Williams</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Science</td>
                                                  <td class="px-6 py-4 whitespace-nowrap">
                                                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">In Progress</span>
                                                  </td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Today</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                      <button class="text-blue-600 hover:text-blue-900 mr-2" onclick="showMessage('Viewing Bob Williams\'s history.')">View</button>
                                                      <button class="text-red-600 hover:text-red-900" onclick="showMessage('Deleting Bob Williams\'s record.')">Delete</button>
                                                  </td>
                                              </tr>
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                          `;
            break;
          case "courses":
            contentHtml = `
                              ${generatePageHeader("Courses")}
                              <div class="bg-white p-6 rounded-xl shadow-md">
                                  <p class="text-gray-700">Manage all available courses. Add new courses, edit details, and track enrollment.</p>
                                  <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                      <h3 class="text-lg font-semibold text-gray-800 mb-3">Add New Course</h3>
                                      <form id="add-course-form">
                                          <div class="mb-4">
                                              <label for="new-course-name" class="block text-gray-700 text-sm font-semibold mb-2">Course Name</label>
                                              <input type="text" id="new-course-name" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., Advanced Algebra" required>
                                          </div>
                                          <div class="mb-4">
                                              <label for="new-course-description" class="block text-gray-700 text-sm font-semibold mb-2">Description</label>
                                              <textarea id="new-course-description" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-24" placeholder="Brief description of the course"></textarea>
                                          </div>
                                          <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add New Course</button>
                                      </form>
                                  </div>
                                  <div class="mt-6">
                                      <h3 class="text-lg font-semibold text-gray-800 mb-3">Current Courses</h3>
                                      <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                          <!-- Courses will be rendered here -->
                                      </div>
                                  </div>
                              </div>
                          `;
            break;
          case "community-forum":
            contentHtml = `
                              ${generatePageHeader("Community Forum")}
                              <div class="bg-white p-6 rounded-xl shadow-md">
                                  <p class="text-gray-700">Oversee discussions, moderate content, and manage users in the community forum.</p>
                                  <div class="mt-4 space-y-4">
                                      <div class="flex items-start p-3 bg-gray-50 rounded-lg">
                                          <i class="fas fa-comments text-3xl text-blue-500 mr-3 mt-1"></i>
                                          <div>
                                              <h4 class="font-semibold text-gray-800">Discussion: Best IELTS Preparation Books</h4>
                                              <p class="text-gray-600 text-sm">"What are your top recommendations for IELTS preparation books?"</p>
                                              <span class="text-xs text-gray-500">Posted by: UserX - 2024-06-22</span>
                                          </div>
                                          <button class="ml-auto text-red-500 hover:text-red-700" onclick="showMessage('Moderating forum discussion.')"><i class="fas fa-shield-alt"></i> Moderate</button>
                                      </div>
                                      <div class="flex items-start p-3 bg-gray-50 rounded-lg">
                                          <i class="fas fa-exclamation-triangle text-3xl text-yellow-500 mr-3 mt-1"></i>
                                          <div>
                                              <h4 class="font-semibold text-gray-800">Reported Post: Spam Content</h4>
                                              <p class="text-gray-600 text-sm">"This post contains irrelevant advertisements and should be removed."</p>
                                              <span class="text-xs text-gray-500">Reported: 2024-06-21</span>
                                          </div>
                                          <button class="ml-auto text-red-500 hover:text-red-700" onclick="showMessage('Reviewing reported post.')"><i class="fas fa-eye"></i> Review</button>
                                      </div>
                                  </div>
                              </div>
                          `;
            break;
          case "blog":
            contentHtml = `
                              ${generatePageHeader("Blog Management")}
                              <div class="bg-white p-6 rounded-xl shadow-md">
                                  <p class="text-gray-700">Create, edit, and publish blog posts. Manage content and authors.</p>
                                  <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                      <h3 class="text-lg font-semibold text-gray-800 mb-3">Add/Edit Blog Post</h3>
                                      <form id="blog-post-form">
                                          <input type="hidden" id="blog-id">
                                          <div class="mb-4">
                                              <label for="blog-title" class="block text-gray-700 text-sm font-semibold mb-2">Title</label>
                                              <input type="text" id="blog-title" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Enter blog post title" required>
                                          </div>
                                          <div class="mb-4">
                                              <label for="blog-category" class="block text-gray-700 text-sm font-semibold mb-2">Category</label>
                                              <select id="blog-category" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                                                  <option value="">Select a Category</option>
                                                  <option value="all categories">All Categories</option>
                                                  <option value="preparation">Preparation</option>
                                                  <option value="reading">Reading</option>
                                                  <option value="writing">Writing</option>
                                                  <option value="listening">Listening</option>
                                                  <option value="speaking">Speaking</option>
                                                  <option value="grammar">Grammar</option>
                                                  <option value="study plan">Study Plan</option>
                                                  <option value="higher study">Higher Study</option>
                                                  <option value="ielts motivation">IELTS Motivation</option>
                                                  <option value="others">Others</option>
                                              </select>
                                          </div>
                                          <div class="mb-4">
                                              <label for="blog-content" class="block text-gray-700 text-sm font-semibold mb-2">Content</label>
                                              <textarea id="blog-content" name="content" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-48"></textarea>
                                          </div>
                                          <div class="mb-4">
                                              <label for="blog-author" class="block text-gray-700 text-sm font-semibold mb-2">Author Name</label>
                                              <input type="text" id="blog-author" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., John Doe" required>
                                          </div>
                                          <!-- Drag and Drop for Author Image -->
                                          <div class="mb-4">
                                              <label class="block text-gray-700 text-sm font-semibold mb-2">Author Image</label>
                                              <input type="hidden" id="blog-author-img">
                                              <div id="author-image-drop-zone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-red-400 transition-colors duration-200">
                                                  <img id="author-image-preview" class="hidden max-w-full h-auto mx-auto mb-2 rounded-full w-24 h-24 object-cover" src="" alt="Author Image Preview">
                                                  <p class="text-gray-500 placeholder-text"><i class="fas fa-cloud-upload-alt mr-2"></i> Drag & drop an image here or click to select</p>
                                                  <p class="text-gray-500 change-text hidden"><i class="fas fa-sync-alt mr-2"></i> Click or drag to change image</p>
                                              </div>
                                          </div>
                                          <!-- Drag and Drop for Featured Image -->
                                          <div class="mb-6">
                                              <label class="block text-gray-700 text-sm font-semibold mb-2">Featured Image</label>
                                              <input type="hidden" id="blog-image">
                                              <div id="blog-image-drop-zone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-red-400 transition-colors duration-200">
                                                  <img id="blog-image-preview" class="hidden max-w-full h-auto mx-auto mb-2" src="" alt="Blog Image Preview">
                                                  <p class="text-gray-500 placeholder-text"><i class="fas fa-cloud-upload-alt mr-2"></i> Drag & drop an image here or click to select</p>
                                                  <p class="text-gray-500 change-text hidden"><i class="fas fa-sync-alt mr-2"></i> Click or drag to change image</p>
                                              </div>
                                          </div>
                                          <button type="submit" id="add-blog-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add Blog Post</button>
                                      </form>
                                  </div>

                                  <div class="mt-8 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Filter Blog Posts</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label for="blog-filter-status" class="block text-gray-700 text-sm font-semibold mb-2">Status</label>
                                            <select id="blog-filter-status" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500">
                                                <option value="all">All Statuses</option>
                                                <option value="published">Published</option>
                                                <option value="draft">Draft</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="blog-filter-category" class="block text-gray-700 text-sm font-semibold mb-2">Category</label>
                                            <select id="blog-filter-category" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500">
                                                <option value="all categories">All Categories</option>
                                                <option value="preparation">Preparation</option>
                                                <option value="reading">Reading</option>
                                                <option value="writing">Writing</option>
                                                <option value="listening">Listening</option>
                                                <option value="speaking">Speaking</option>
                                                <option value="grammar">Grammar</option>
                                                <option value="study plan">Study Plan</option>
                                                <option value="higher study">Higher Study</option>
                                                <option value="ielts motivation">IELTS Motivation</option>
                                                <option value="others">Others</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="blog-filter-search" class="block text-gray-700 text-sm font-semibold mb-2">Search</label>
                                            <input type="text" id="blog-filter-search" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Search by title, author...">
                                        </div>
                                    </div>
                                  </div>
                                  
                                  <!-- Combined list for all blog posts -->
                                  <div class="mt-8" id="blog-display-section">
                                      <h3 class="text-xl font-semibold text-gray-800 mb-4" id="blog-posts-list-heading">All Blog Posts</h3>
                                      <div id="blog-posts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                          <!-- All filtered blog posts will be rendered here -->
                                      </div>
                                  </div>

                                  <div id="blog-pagination" class="mt-8 flex justify-center">
                                    <!-- Blog Pagination will be rendered here -->
                                  </div>
                              </div>
                          `;
            break;
          case "free-resources":
            contentHtml = `
                              ${generatePageHeader("Free Resources Management")}
                              <div class="bg-white p-6 rounded-xl shadow-md">
                                  <p class="text-gray-700">Manage free learning resources like e-books, practice materials, and webinars. Ensure content is up-to-date and accessible.</p>
                                  
                                  <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                      <h3 class="text-lg font-semibold text-gray-800 mb-3">Add/Edit Free Resource (Video)</h3>
                                      <form id="free-resource-form">
                                          <input type="hidden" id="free-resource-id">
                                          <div class="mb-4">
                                              <label for="free-resource-title" class="block text-gray-700 text-sm font-semibold mb-2">Video Title</label>
                                              <input type="text" id="free-resource-title" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., IELTS Speaking Band 7.5 Real Test" required>
                                          </div>
                                          <div class="mb-4">
                                              <label for="free-resource-category" class="block text-gray-700 text-sm font-semibold mb-2">Category</label>
                                              <select id="free-resource-category" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                                                  <option value="">Select a Category</option>
                                                  <option value="Speaking">Speaking</option>
                                                  <option value="Writing">Writing</option>
                                                  <option value="Listening">Listening</option>
                                                  <option value="Reading">Reading</option>
                                                  <option value="Grammar">Grammar</option>
                                                  <option value="Vocabulary">Vocabulary</option>
                                                  option value="Higher Study">Higher Study</option>
                                                  <option value="Tips & Tricks">Tips & Tricks</option>
                                                  <option value="Study Plan">Study Plan</option>
                                                  <option value="Live">Classes</option>
                                                  <option value="Full Tests">Full Tests</option>
                                                  <option value="Motivation">Motivation</option>
                                                  <option value="Others">Others</option>
                                              </select>
                                          </div>
                                          <div class="mb-4">
                                              <label for="free-resource-link" class="block text-gray-700 text-sm font-semibold mb-2">YouTube Video Link</label>
                                              <input type="url" id="free-resource-link" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., https://www.youtube.com/watch?v=VIDEO_ID" required>
                                          </div>
                                          <div class="mb-4">
                                              <label for="free-resource-summary" class="block text-gray-700 text-sm font-semibold mb-2">Summary</label>
                                              <textarea id="free-resource-summary" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-24" placeholder="Brief summary of the video content"></textarea>
                                          </div>
                                          <div class="mb-6">
                                              <label for="free-resource-keypoints" class="block text-gray-700 text-sm font-semibold mb-2">Key Points (One per line)</label>
                                              <textarea id="free-resource-keypoints" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-32" placeholder="List key takeaways, one point per line"></textarea>
                                          </div>
                                          <!-- Drag and Drop for Thumbnail Image -->
                                          <div class="mb-6">
                                              <label class="block text-gray-700 text-sm font-semibold mb-2">Thumbnail Image</label>
                                              <input type="hidden" id="free-resource-image">
                                              <div id="free-resource-image-drop-zone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-red-400 transition-colors duration-200">
                                                  <img id="free-resource-image-preview" class="hidden max-w-full h-auto mx-auto mb-2" src="" alt="Thumbnail Image Preview">
                                                  <p class="text-gray-500 placeholder-text"><i class="fas fa-cloud-upload-alt mr-2"></i> Drag & drop an image here or click to select</p>
                                                  <p class="text-gray-500 change-text hidden"><i class="fas fa-sync-alt mr-2"></i> Click or drag to change image</p>
                                              </div>
                                          </div>
                                          <button type="submit" id="add-free-resource-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add Free Resource</button>
                                      </form>
                                  </div>

                                  <div class="mt-8 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Filter Free Resources</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label for="free-resource-filter-status" class="block text-gray-700 text-sm font-semibold mb-2">Status</label>
                                            <select id="free-resource-filter-status" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500">
                                                <option value="all">All Statuses</option>
                                                <option value="active">Active</option>
                                                <option value="inactive">Inactive</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="free-resource-filter-category" class="block text-gray-700 text-sm font-semibold mb-2">Category</label>
                                            <select id="free-resource-filter-category" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500">
                                                <option value="">Select a Category</option>
                                                  <option value="Speaking">Speaking</option>
                                                  <option value="Writing">Writing</option>
                                                  <option value="Listening">Listening</option>
                                                  <option value="Reading">Reading</option>
                                                  <option value="Grammar">Grammar</option>
                                                  <option value="Vocabulary">Vocabulary</option>
                                                  option value="Higher Study">Higher Study</option>
                                                  <option value="Tips & Tricks">Tips & Tricks</option>
                                                  <option value="Study Plan">Study Plan</option>
                                                  <option value="Live">Classes</option>
                                                  <option value="Full Tests">Full Tests</option>
                                                  <option value="Motivation">Motivation</option>
                                                  <option value="Others">Others</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="free-resource-filter-search" class="block text-gray-700 text-sm font-semibold mb-2">Search</label>
                                            <input type="text" id="free-resource-filter-search" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Search by title, category, summary...">
                                        </div>
                                    </div>
                                  </div>

                                  <div class="mt-8">
                                      <h3 class="text-xl font-semibold text-gray-800 mb-4">All Free Resources</h3>
                                      <div id="free-resources-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                          <!-- Free resources will be rendered here -->
                                      </div>
                                  </div>
                                  <div id="free-resource-pagination" class="mt-8 flex justify-center">
                                    <!-- Free Resource Pagination will be rendered here -->
                                  </div>
                              </div>
                          `;
            // Setup drag and drop for free resource thumbnail
            setTimeout(() => {
              setupImageDragAndDrop(
                "free-resource-image",
                "free-resource-image-drop-zone",
                "free-resource-image-preview",
                480,
                270 // Standard YouTube thumbnail aspect ratio
              );

              // Setup filter event listeners for free resources
              document
                .getElementById("free-resource-filter-status")
                .addEventListener("change", (e) => {
                  freeResourceCurrentFilters.status = e.target.value;
                  freeResourceCurrentPage = 1; // Reset to first page on filter change
                  renderFreeResources(
                    freeResourceCurrentFilters,
                    freeResourceCurrentPage,
                    freeResourceItemsPerPage
                  );
                });

              document
                .getElementById("free-resource-filter-category")
                .addEventListener("change", (e) => {
                  freeResourceCurrentFilters.category = e.target.value;
                  freeResourceCurrentPage = 1; // Reset to first page on filter change
                  renderFreeResources(
                    freeResourceCurrentFilters,
                    freeResourceCurrentPage,
                    freeResourceItemsPerPage
                  );
                });

              document
                .getElementById("free-resource-filter-search")
                .addEventListener("input", (e) => {
                  freeResourceCurrentFilters.searchTerm = e.target.value;
                  freeResourceCurrentPage = 1; // Reset to first page on filter change
                  renderFreeResources(
                    freeResourceCurrentFilters,
                    freeResourceCurrentPage,
                    freeResourceItemsPerPage
                  );
                });
            }, 0); // Use setTimeout to ensure elements are rendered
            break;
          case "mock-test":
            contentHtml = `
                              ${generatePageHeader("Mock Test Management")}
                              <div class="bg-white p-6 rounded-xl shadow-md">
                                  <p class="text-gray-700">Create, configure, and administer mock tests. Review results and provide feedback.</p>
                                  <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                      <h3 class="text-lg font-semibold text-gray-800 mb-3">Add New Mock Test</h3>
                                      <form id="add-mock-test-form">
                                          <div class="mb-4">
                                              <label for="mock-test-title" class="block text-gray-700 text-sm font-semibold mb-2">Test Title</label>
                                              <input type="text" id="mock-test-title" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., IELTS Full Mock Test 1" required>
                                          </div>
                                          <div class="mb-4">
                                              <label for="mock-test-duration" class="block text-gray-700 text-sm font-semibold mb-2">Duration (minutes)</label>
                                              <input type="number" id="mock-test-duration" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" min="1" required>
                                          </div>
                                          <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add Mock Test</button>
                                      </form>
                                  </div>
                                  <div class="mt-6">
                                      <h3 class="text-lg font-semibold text-gray-800 mb-3">Upcoming Mock Tests</h3>
                                      <ul class="space-y-2">
                                          <li class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                              <span>IELTS Speaking Practice - <span class="text-gray-600">Date: 2024-07-01</span></span>
                                              <button class="text-blue-500 hover:text-blue-700" onclick="showMessage('Editing IELTS Speaking Practice.')"><i class="fas fa-edit"></i></button>
                                          </li>
                                          <li class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                              <span>General English Writing - <span class="text-gray-600">Date: 2024-07-05</span></span>
                                              <button class="text-blue-500 hover:text-blue-700" onclick="showMessage('Editing General English Writing.')"><i class="fas fa-edit"></i></button>
                                          </li>
                                      </ul>
                                  </div>
                              </div>
                          `;
            break;
          case "quizzes":
            contentHtml = `
                              ${generatePageHeader("Quizzes Management")}
                              <div class="bg-white p-6 rounded-xl shadow-md">
                                  <p class="text-gray-700">Design and manage interactive quizzes. Track student performance and review answers.</p>
                                  <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                      <h3 class="text-lg font-semibold text-gray-800 mb-3">Add/Edit Quiz</h3>
                                      <form id="quiz-form">
                                          <input type="hidden" id="quiz-id">
                                          <div class="mb-4">
                                              <label for="quiz-title" class="block text-gray-700 text-sm font-semibold mb-2">Quiz Title</label>
                                              <input type="text" id="quiz-title" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., Verb Tenses Quiz" required>
                                          </div>
                                          <div class="mb-4">
                                              <label for="quiz-description" class="block text-gray-700 text-sm font-semibold mb-2">Description</label>
                                              <textarea id="quiz-description" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-24" placeholder="Brief description of the quiz"></textarea>
                                          </div>
                                          <div class="mb-6">
                                              <label for="quiz-questions-count" class="block text-gray-700 text-sm font-semibold mb-2">Number of Questions</label>
                                              <input type="number" id="quiz-questions-count" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" min="1" required>
                                          </div>
                                          <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add Quiz</button>
                                      </form>
                                  </div>

                                  <div class="mt-8">
                                      <h3 class="text-xl font-semibold text-gray-800 mb-4">Published Quizzes</h3>
                                      <div id="published-quizzes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                          <!-- Published quizzes will be rendered here -->
                                      </div>
                                  </div>

                                  <div class="mt-8">
                                      <h3 class="text-xl font-semibold text-gray-800 mb-4">Draft Quizzes</h3>
                                      <div id="draft-quizzes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                          <!-- Draft quizzes will be rendered here -->
                                      </div>
                                  </div>
                              </div>
                          `;
            break;
          case "testimonial":
            contentHtml = `
                              ${generatePageHeader("Testimonial Management")}
                              <div class="testimonials-section-admin bg-white p-6 rounded-xl shadow-md">
                                  <p class="text-gray-700 mb-6">Manage customer testimonials. Approve, reject, edit, or delete submitted testimonials.</p>

                                  <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                      <h3 class="text-lg font-semibold text-gray-800 mb-3">Add/Edit Testimonial</h3>
                                      <form id="testimonial-form">
                                          <input type="hidden" id="testimonial-id">
                                          <div class="mb-4">
                                              <label for="testimonial-name" class="block text-gray-700 text-sm font-semibold mb-2">Name</label>
                                              <input type="text" id="testimonial-name" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., Jane Doe" required>
                                          </div>
                                          <div class="mb-4">
                                              <label for="testimonial-role" class="block text-gray-700 text-sm font-semibold mb-2">Role/Course</label>
                                              <input type="text" id="testimonial-role" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., IELTS Student" required>
                                          </div>
                                          <div class="mb-4">
                                              <label class="block text-gray-700 text-sm font-semibold mb-2">Testimonial Type</label>
                                              <div class="flex items-center space-x-4">
                                                  <label class="inline-flex items-center">
                                                      <input type="radio" name="testimonial-type" id="testimonial-type-text" value="text" class="form-radio text-red-600" checked>
                                                      <span class="ml-2 text-gray-700">Text</span>
                                                  </label>
                                                  <label class="inline-flex items-center">
                                                      <input type="radio" name="testimonial-type" id="testimonial-type-video" value="video" class="form-radio text-red-600">
                                                      <span class="ml-2 text-gray-700">Video</span>
                                                  </label>
                                              </div>
                                          </div>
                                          <div class="mb-4" id="text-content-group">
                                              <label for="testimonial-text" class="block text-gray-700 text-sm font-semibold mb-2">Testimonial Text</label>
                                              <textarea id="testimonial-text" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-24" placeholder="Enter testimonial text"></textarea>
                                          </div>
                                          <div class="mb-4 hidden" id="video-url-group">
                                              <label for="testimonial-video-src" class="block text-gray-700 text-sm font-semibold mb-2">Video URL</label>
                                              <input type="url" id="testimonial-video-src" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., https://example.com/video.mp4">
                                          </div>
                                          <!-- Drag and Drop for Avatar Image -->
                                          <div class="mb-6">
                                              <label class="block text-gray-700 text-sm font-semibold mb-2">Avatar Image</label>
                                              <input type="hidden" id="testimonial-avatar-src">
                                              <div id="avatar-drop-zone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-red-400 transition-colors duration-200">
                                                  <img id="avatar-image-preview" class="hidden max-w-full h-auto mx-auto mb-2 rounded-full w-24 h-24 object-cover" src="" alt="Avatar Image Preview">
                                                  <p class="text-gray-500 placeholder-text"><i class="fas fa-cloud-upload-alt mr-2"></i> Drag & drop an image here or click to select</p>
                                                  <p class="text-gray-500 change-text hidden"><i class="fas fa-sync-alt mr-2"></i> Click or drag to change image</p>
                                              </div>
                                          </div>
                                          <button type="submit" id="add-testimonial-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add Testimonial</button>
                                      </form>
                                  </div>

                                  <div class="mt-8 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Filter Testimonials</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="testimonial-filter-status" class="block text-gray-700 text-sm font-semibold mb-2">Status</label>
                                            <select id="testimonial-filter-status" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500">
                                                <option value="all">All Statuses</option>
                                                <option value="pending">Pending</option>
                                                <option value="approved">Approved</option>
                                                <option value="rejected">Rejected</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="testimonial-filter-search" class="block text-gray-700 text-sm font-semibold mb-2">Search</label>
                                            <input type="text" id="testimonial-filter-search" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Search by name, role, text...">
                                        </div>
                                    </div>
                                  </div>

                                  <div class="mt-8">
                                      <h3 class="text-xl font-semibold text-gray-800 mb-4">Pending Testimonials</h3>
                                      <div id="pending-testimonials-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                          <!-- Pending testimonials will be rendered here -->
                                      </div>
                                  </div>

                                  <div class="mt-8">
                                      <h3 class="text-xl font-semibold text-gray-800 mb-4">Approved Testimonials</h3>
                                      <div id="approved-testimonials-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                          <!-- Approved testimonials will be rendered here -->
                                      </div>
                                  </div>

                                  <div class="mt-8">
                                      <h3 class="text-xl font-semibold text-gray-800 mb-4">Rejected Testimonials</h3>
                                      <div id="rejected-testimonials-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                          <!-- Rejected testimonials will be rendered here -->
                                      </div>
                                  </div>
                                  <div id="testimonial-pagination" class="mt-8 flex justify-center">
                                    <!-- Testimonial Pagination will be rendered here -->
                                  </div>
                              </div>
                          `;

            // Setup radio button logic for testimonial type
            setTimeout(() => {
              const typeTextRadio = document.getElementById(
                "testimonial-type-text"
              );
              const typeVideoRadio = document.getElementById(
                "testimonial-type-video"
              );
              const textContentGroup = document.getElementById(
                "text-content-group"
              );
              const videoUrlGroup = document.getElementById("video-url-group");

              const toggleTestimonialType = () => {
                if (typeVideoRadio.checked) {
                  textContentGroup.classList.add("hidden");
                  videoUrlGroup.classList.remove("hidden");
                } else {
                  textContentGroup.classList.remove("hidden");
                  videoUrlGroup.classList.add("hidden");
                }
              };

              typeTextRadio.addEventListener("change", toggleTestimonialType);
              typeVideoRadio.addEventListener("change", toggleTestimonialType);
              toggleTestimonialType(); // Set initial visibility

              // Setup drag and drop for avatar image with specific max dimensions for avatars
              setupImageDragAndDrop(
                "testimonial-avatar-src",
                "avatar-drop-zone",
                "avatar-image-preview",
                200,
                200
              );

              // Setup filter event listeners
              document
                .getElementById("testimonial-filter-status")
                .addEventListener("change", (e) => {
                  testimonialCurrentFilters.status = e.target.value;
                  testimonialCurrentPage = 1; // Reset to first page on filter change
                  renderTestimonials(
                    testimonialCurrentFilters,
                    testimonialCurrentPage,
                    testimonialItemsPerPage
                  );
                });

              document
                .getElementById("testimonial-filter-search")
                .addEventListener("input", (e) => {
                  testimonialCurrentFilters.searchTerm = e.target.value;
                  testimonialCurrentPage = 1; // Reset to first page on filter change
                  renderTestimonials(
                    testimonialCurrentFilters,
                    testimonialCurrentPage,
                    testimonialItemsPerPage
                  );
                });
            }, 0); // Use setTimeout to ensure elements are rendered

            break;
          case "block-list":
            contentHtml = `
                              ${generatePageHeader("Block List")}
                              <div class="bg-white p-6 rounded-xl shadow-md">
                                  <p class="text-gray-700">Manage blocked users and content. Add or remove entries from the block list to maintain a safe environment.</p>
                                  <div class="mt-6 overflow-x-auto">
                                      <table class="min-w-full divide-y divide-gray-200">
                                          <thead class="bg-gray-50">
                                              <tr>
                                                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Blocked Item</th>
                                                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                                                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Blocked Date</th>
                                                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                              </tr>
                                          </thead>
                                          <tbody class="bg-white divide-y divide-gray-200">
                                              <tr>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Spam User 123</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">User</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Repeated spamming</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2024-06-15</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                      <button class="text-green-600 hover:text-green-900" onclick="showMessage('Unblocking Spam User 123.')">Unblock</button>
                                                  </td>
                                              </tr>
                                              <tr>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Harmful Link Post</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Content</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Malware link</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2024-06-10</td>
                                                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                      <button class="text-green-600 hover:text-green-900" onclick="showMessage('Unblocking Harmful Link Post.')">Unblock</button>
                                                  </td>
                                              </tr>
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                          `;
            break;
        }

        contentArea.innerHTML = contentHtml;

        // Initialize Summernote Editor if the blog page is loaded
        if (pageName === "blog") {
          const blogContentTextArea = document.getElementById("blog-content");
          if (blogContentTextArea) {
            // Summernote initialization
            $(blogContentTextArea).summernote({
              placeholder: "Start writing your blog post here...",
              tabsize: 2,
              height: 300,
              // Updated toolbar with more tools
              toolbar: [
                ["style", ["style"]],
                ["font", ["bold", "italic", "underline", "clear"]],
                ["fontname", ["fontname"]], // Added fontname
                ["fontsize", ["fontsize"]],
                ["color", ["color"]],
                ["para", ["ul", "ol", "paragraph"]],
                ["height", ["height"]], // Added height
                ["table", ["table"]],
                ["insert", ["link", "picture", "video", "hr"]], // Added hr
                ["view", ["codeview", "help"]],
                ["misc", ["undo", "redo"]], // Added undo/redo
              ],
              callbacks: {
                onImageUpload: function (files) {
                  const editor = $(this); // Get the Summernote editor instance

                  if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith("image/")) {
                      // Directly call the global processAndResizeImage function
                      // Use appropriate dimensions for Summernote images, e.g., 800x400
                      processAndResizeImage(file, 800, 400, (dataUrl) => {
                        // Insert the resized Base64 image directly into the editor
                        editor.summernote("insertImage", dataUrl);
                        showMessage(
                          "Image inserted into editor (resized and Base64 encoded)."
                        );
                      });
                    } else {
                      showMessage("Please upload an image file.");
                    }
                  }
                },
              },
            });
            summernoteEditorInstance = $(blogContentTextArea); // Store the instance for later destruction/access
            console.log("Summernote Editor initialized.");
          }
          // Setup drag and drop for blog post images after content is loaded
          setupImageDragAndDrop(
            "blog-image",
            "blog-image-drop-zone",
            "blog-image-preview",
            800,
            400
          );
          setupImageDragAndDrop(
            "blog-author-img",
            "author-image-drop-zone",
            "author-image-preview",
            200,
            200
          );

          // Setup filter event listeners for blog posts
          const blogFilterStatus = document.getElementById(
            "blog-filter-status"
          );
          const blogFilterCategory = document.getElementById(
            "blog-filter-category"
          );
          const blogFilterSearch = document.getElementById(
            "blog-filter-search"
          );

          if (blogFilterStatus) {
            blogFilterStatus.value = blogCurrentFilters.status; // Set initial value
            blogFilterStatus.addEventListener("change", (e) => {
              blogCurrentFilters.status = e.target.value;
              blogCurrentPage = 1; // Reset to first page on filter change
              renderBlogPosts(
                blogCurrentFilters,
                blogCurrentPage,
                blogItemsPerPage
              );
            });
          }

          if (blogFilterCategory) {
            blogFilterCategory.value = blogCurrentFilters.category; // Set initial value
            blogFilterCategory.addEventListener("change", (e) => {
              blogCurrentFilters.category = e.target.value;
              blogCurrentPage = 1; // Reset to first page on filter change
              renderBlogPosts(
                blogCurrentFilters,
                blogCurrentPage,
                blogItemsPerPage
              );
            });
          }

          if (blogFilterSearch) {
            blogFilterSearch.value = blogCurrentFilters.searchTerm; // Set initial value
            blogFilterSearch.addEventListener("input", (e) => {
              blogCurrentFilters.searchTerm = e.target.value;
              blogCurrentPage = 1; // Reset to first page on filter change
              renderBlogPosts(
                blogCurrentFilters,
                blogCurrentPage,
                blogItemsPerPage
              );
            });
          }
        }

        // Re-render charts for dashboard page
        if (pageName === "dashboard") {
          renderCharts();
        }
        // Re-render registrations for registration page
        if (pageName === "registration") {
          renderRegistrations();
        }
        // Re-render courses for courses page
        if (pageName === "courses") {
          renderCourses();
        }
        // Re-render testimonials for testimonial page
        if (pageName === "testimonial") {
          renderTestimonials(
            testimonialCurrentFilters,
            testimonialCurrentPage,
            testimonialItemsPerPage
          );
          // Ensure drag and drop for avatar image is set up on testimonial page load
          setupImageDragAndDrop(
            "testimonial-avatar-src",
            "avatar-drop-zone",
            "avatar-image-preview",
            200,
            200
          );

          // Setup filter event listeners for testimonials
          const testimonialFilterStatus = document.getElementById(
            "testimonial-filter-status"
          );
          const testimonialFilterSearch = document.getElementById(
            "testimonial-filter-search"
          );

          if (testimonialFilterStatus) {
            testimonialFilterStatus.value = testimonialCurrentFilters.status; // Set initial value
            testimonialFilterStatus.addEventListener("change", (e) => {
              testimonialCurrentFilters.status = e.target.value;
              testimonialCurrentPage = 1; // Reset to first page on filter change
              renderTestimonials(
                testimonialCurrentFilters,
                testimonialCurrentPage,
                testimonialItemsPerPage
              );
            });
          }

          if (testimonialFilterSearch) {
            testimonialFilterSearch.value =
              testimonialCurrentFilters.searchTerm; // Set initial value
            testimonialFilterSearch.addEventListener("input", (e) => {
              testimonialCurrentFilters.searchTerm = e.target.value;
              testimonialCurrentPage = 1; // Reset to first page on filter change
              renderTestimonials(
                testimonialCurrentFilters,
                testimonialCurrentPage,
                testimonialItemsPerPage
              );
            });
          }
        }
        // Re-render quizzes for quizzes page
        if (pageName === "quizzes") {
          renderQuizzes();
        }
        // Re-render blog posts for blog page
        if (pageName === "blog") {
          // Initialize filters and then render posts
          blogCurrentFilters = {
            status: "all",
            category: "all categories",
            searchTerm: "",
          };
          // Ensure dropdowns reflect initial state
          const blogFilterStatus = document.getElementById(
            "blog-filter-status"
          );
          const blogFilterCategory = document.getElementById(
            "blog-filter-category"
          );
          if (blogFilterStatus)
            blogFilterStatus.value = blogCurrentFilters.status;
          if (blogFilterCategory)
            blogFilterCategory.value = blogCurrentFilters.category;

          renderBlogPosts(
            blogCurrentFilters,
            blogCurrentPage,
            blogItemsPerPage
          );
        }
        // Re-render contact messages for messages page
        if (pageName === "messages") {
          renderContactMessages(
            contactMessageCurrentFilters,
            contactMessageCurrentPage,
            contactMessageItemsPerPage
          );
        }
        // Re-render teachers for our-teacher page
        if (pageName === "our-teacher") {
          renderTeachers(
            teacherCurrentFilters,
            teacherCurrentPage,
            teacherItemsPerPage
          );
        }
        // Re-render free resources for free-resources page
        if (pageName === "free-resources") {
          renderFreeResources(
            freeResourceCurrentFilters,
            freeResourceCurrentPage,
            freeResourceItemsPerPage
          );
        }
      };

      // --- Event Listeners ---
      document.addEventListener("DOMContentLoaded", async () => {
        await authenticateFirebase(); // Ensure Firebase is authenticated first
        loadPageContent("dashboard"); // Load dashboard by default

        // Handle navigation clicks
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const page = e.currentTarget.dataset.page;
            loadPageContent(page);
          });
        });

        // Close message box
        document
          .getElementById("close-message-box")
          .addEventListener("click", () => {
            document.getElementById("message-box").classList.add("hidden");
          });

        // Hamburger menu toggle for mobile
        const hamburgerMenu = document.getElementById("hamburger-menu");
        const sidebar = document.getElementById("sidebar");
        const sidebarOverlay = document.getElementById("sidebar-overlay");

        hamburgerMenu.addEventListener("click", () => {
          sidebar.classList.toggle("-translate-x-full");
          sidebar.classList.toggle("translate-x-0");
          sidebarOverlay.classList.toggle("hidden");
        });

        sidebarOverlay.addEventListener("click", () => {
          sidebar.classList.add("-translate-x-full");
          sidebar.classList.remove("translate-x-0");
          sidebarOverlay.classList.add("hidden");
        });

        // Close sidebar if screen size changes from mobile to desktop
        window.addEventListener("resize", () => {
          if (window.innerWidth >= 1024) {
            // lg breakpoint
            sidebar.classList.remove("-translate-x-full", "translate-x-0");
            sidebar.classList.add("lg:translate-x-0");
            sidebarOverlay.classList.add("hidden");
          }
        });

        // Handle Add Testimonial Form Submission
        document
          .getElementById("content-area")
          .addEventListener("submit", async (e) => {
            if (e.target && e.target.id === "testimonial-form") {
              e.preventDefault();

              if (!isAuthReady) {
                showMessage("Firebase not ready. Please try again.");
                console.warn(
                  "Attempted form submission before Firebase auth was ready."
                );
                return;
              }

              const testimonialId = document.getElementById("testimonial-id")
                .value;
              const name = document.getElementById("testimonial-name").value;
              const role = document.getElementById("testimonial-role").value;
              // Get avatarSrc from the hidden input updated by drag and drop
              const avatarSrc = document.getElementById(
                "testimonial-avatar-src"
              ).value;

              const typeTextRadio = document.getElementById(
                "testimonial-type-text"
              );
              const type = typeTextRadio.checked ? "text" : "video";
              let textContent = "";
              let videoSrc = "";

              if (type === "text") {
                textContent = document.getElementById("testimonial-text").value;
              } else {
                videoSrc = document.getElementById("testimonial-video-src")
                  .value;
              }

              const testimonialData = {
                name,
                role,
                avatarSrc:
                  avatarSrc ||
                  "https://placehold.co/80x80/9CA3AF/white?text=User", // Default placeholder
                type,
                timestamp: serverTimestamp(), // Use server timestamp for creation/update
                status: "pending", // New testimonials are always pending
              };

              if (type === "text") {
                testimonialData.text = textContent;
              } else {
                testimonialData.videoSrc = videoSrc;
              }

              try {
                if (testimonialId) {
                  // Update existing testimonial
                  const docRef = doc(
                    db,
                    "artifacts",
                    appId,
                    "public",
                    "data",
                    "testimonials",
                    testimonialId
                  );
                  await updateDoc(docRef, testimonialData);
                  showMessage("Testimonial updated successfully!");
                  console.log("Testimonial updated with ID: ", testimonialId);
                } else {
                  // Add new testimonial
                  const docRef = await addDoc(
                    collection(
                      db,
                      "artifacts",
                      appId,
                      "public",
                      "data",
                      "testimonials"
                    ),
                    testimonialData
                  );
                  showMessage("Testimonial added successfully!");
                  console.log("Testimonial written with ID: ", docRef.id);
                }

                // Reset form and button text
                e.target.reset();
                document.getElementById("testimonial-id").value = ""; // Clear hidden ID
                document.getElementById("add-testimonial-btn").textContent =
                  "Add Testimonial";
                // Ensure text/video fields are reset correctly based on type
                if (typeTextRadio.checked) {
                  document.getElementById("testimonial-text").value = "";
                } else {
                  document.getElementById("testimonial-video-src").value = "";
                }
                // Clear drag and drop image previews
                document.getElementById("avatar-drop-zone")._setImage("");
              } catch (e) {
                console.error("Error adding/updating testimonial: ", e);
                showMessage(`Error: ${e.message}`);
              }
            } else if (e.target && e.target.id === "quiz-form") {
              e.preventDefault();

              if (!isAuthReady) {
                showMessage("Firebase not ready. Please try again.");
                console.warn(
                  "Attempted form submission before Firebase auth was ready."
                );
                return;
              }

              const quizId = document.getElementById("quiz-id").value;
              const title = document.getElementById("quiz-title").value;
              const description = document.getElementById("quiz-description")
                .value;
              const questionsCount = parseInt(
                document.getElementById("quiz-questions-count").value,
                10
              );

              const quizData = {
                title,
                description,
                questionsCount,
                timestamp: serverTimestamp(),
                status: "draft", // New quizzes are always draft initially
              };

              try {
                if (quizId) {
                  // Update existing quiz
                  const docRef = doc(
                    db,
                    "artifacts",
                    appId,
                    "public",
                    "data",
                    "quizzes",
                    quizId
                  );
                  await updateDoc(docRef, quizData);
                  showMessage("Quiz updated successfully!");
                  console.log("Quiz updated with ID: ", quizId);
                } else {
                  // Add new quiz
                  const docRef = await addDoc(
                    collection(
                      db,
                      "artifacts",
                      appId,
                      "public",
                      "data",
                      "quizzes"
                    ),
                    quizData
                  );
                  showMessage("Quiz added successfully!");
                  console.log("Quiz written with ID: ", docRef.id);
                }

                // Reset form and button text
                e.target.reset();
                document.getElementById("quiz-id").value = ""; // Clear hidden ID
                document.getElementById("add-quiz-btn").textContent =
                  "Add Quiz";
              } catch (e) {
                console.error("Error adding/updating quiz: ", e);
                showMessage(`Error: ${e.message}`);
              }
            } else if (e.target && e.target.id === "blog-post-form") {
              e.preventDefault();

              if (!isAuthReady) {
                showMessage("Firebase not ready. Please try again.");
                console.warn(
                  "Attempted form submission before Firebase auth was ready."
                );
                return;
              }

              const blogId = document.getElementById("blog-id").value;
              const title = document.getElementById("blog-title").value;
              const category = document.getElementById("blog-category").value;
              // Get content from Summernote editor
              const content = $("#blog-content").summernote("code");
              const author = document.getElementById("blog-author").value;
              // Get image URLs from the hidden inputs updated by drag and drop
              const authorImg = document.getElementById("blog-author-img")
                .value;
              const image = document.getElementById("blog-image").value;

              const blogPostData = {
                title,
                category,
                content,
                author,
                authorImg:
                  authorImg || "https://placehold.co/40x40/9CA3AF/white?text=A",
                image:
                  image ||
                  "https://placehold.co/400x200/cccccc/white?text=Blog+Image",
                timestamp: serverTimestamp(),
                status: "draft", // New blog posts are always draft initially
              };

              try {
                if (blogId) {
                  // Update existing blog post
                  const docRef = doc(
                    db,
                    "artifacts",
                    appId,
                    "public",
                    "data",
                    "blogPosts",
                    blogId
                  );
                  await updateDoc(docRef, blogPostData);
                  showMessage("Blog post updated successfully!");
                  console.log("Blog post updated with ID: ", blogId);
                } else {
                  // Add new blog post
                  const docRef = await addDoc(
                    collection(
                      db,
                      "artifacts",
                      appId,
                      "public",
                      "data",
                      "blogPosts"
                    ),
                    blogPostData
                  );
                  showMessage("Blog post added successfully!");
                  console.log("Blog post written with ID: ", docRef.id);
                }

                // Reset form and button text
                e.target.reset();
                document.getElementById("blog-id").value = ""; // Clear hidden ID
                document.getElementById("add-blog-btn").textContent =
                  "Add Blog Post";
                if ($("#blog-content").data("summernote")) {
                  $("#blog-content").summernote("code", ""); // Clear editor content
                }
                // Clear drag and drop image previews
                document.getElementById("blog-image-drop-zone")._setImage("");
                document.getElementById("author-image-drop-zone")._setImage("");
              } catch (e) {
                console.error("Error adding/updating blog post: ", e);
                showMessage(`Error: ${e.message}`);
              }
            } else if (e.target && e.target.id === "teacher-form") {
              e.preventDefault();

              if (!isAuthReady) {
                showMessage("Firebase not ready. Please try again.");
                console.warn(
                  "Attempted teacher form submission before Firebase auth was ready."
                );
                return;
              }

              const teacherId = document.getElementById("teacher-id").value;
              const name = document.getElementById("teacher-name").value;
              const expertise = document.getElementById("teacher-expertise")
                .value; // Now from select
              const bio = $("#teacher-bio").summernote("code"); // Get content from Summernote
              const image = document.getElementById("teacher-image").value;

              const teacherData = {
                name,
                expertise,
                bio,
                image:
                  image ||
                  "https://placehold.co/200x200/9CA3AF/white?text=Teacher",
                timestamp: serverTimestamp(),
                status: "active", // New teachers are active by default
              };

              try {
                if (teacherId) {
                  // Update existing teacher
                  const docRef = doc(
                    db,
                    "artifacts",
                    appId,
                    "public",
                    "data",
                    "teachers",
                    teacherId
                  );
                  await updateDoc(docRef, teacherData);
                  showMessage("Teacher profile updated successfully!");
                  console.log("Teacher profile updated with ID: ", teacherId);
                } else {
                  // Add new teacher
                  const docRef = await addDoc(
                    collection(
                      db,
                      "artifacts",
                      appId,
                      "public",
                      "data",
                      "teachers"
                    ),
                    teacherData
                  );
                  showMessage("Teacher added successfully!");
                  console.log("Teacher profile written with ID: ", docRef.id);
                }

                // Reset form and button text
                e.target.reset();
                document.getElementById("teacher-id").value = ""; // Clear hidden ID
                document.getElementById("add-teacher-btn").textContent =
                  "Add Teacher";
                if ($("#teacher-bio").data("summernote")) {
                  $("#teacher-bio").summernote("code", ""); // Clear editor content
                }
                // Clear drag and drop image preview
                document
                  .getElementById("teacher-image-drop-zone")
                  ._setImage("");
              } catch (e) {
                console.error("Error adding/updating teacher: ", e);
                showMessage(`Error: ${e.message}`);
              }
            } else if (e.target && e.target.id === "free-resource-form") {
              // Handle Free Resources form submission
              e.preventDefault();

              if (!isAuthReady) {
                showMessage("Firebase not ready. Please try again.");
                console.warn(
                  "Attempted free resource form submission before Firebase auth was ready."
                );
                return;
              }

              const resourceId = document.getElementById("free-resource-id")
                .value;
              const title = document.getElementById("free-resource-title")
                .value;
              const category = document.getElementById("free-resource-category")
                .value;
              const link = document.getElementById("free-resource-link").value;
              const summary = document.getElementById("free-resource-summary")
                .value;
              const keypointsText = document.getElementById(
                "free-resource-keypoints"
              ).value;
              const keypoints = keypointsText
                .split("\n")
                .map((kp) => kp.trim())
                .filter((kp) => kp !== "");
              const img = document.getElementById("free-resource-image").value;

              const resourceData = {
                title,
                category,
                link,
                summary,
                keypoints,
                img:
                  img ||
                  "https://placehold.co/400x200/cccccc/white?text=Resource+Image", // Default image
                timestamp: serverTimestamp(), // Auto-generated timestamp
                status: "active", // Default status for new resources
                views: "0 views", // Default views count. Needs external logic for real tracking.
              };

              try {
                if (resourceId) {
                  // Update existing resource
                  const docRef = doc(
                    db,
                    "artifacts",
                    appId,
                    "public",
                    "data",
                    "freeResources",
                    resourceId
                  );
                  await updateDoc(docRef, resourceData);
                  showMessage("Free resource updated successfully!");
                  console.log("Free resource updated with ID: ", resourceId);
                } else {
                  // Add new resource
                  const docRef = await addDoc(
                    collection(
                      db,
                      "artifacts",
                      appId,
                      "public",
                      "data",
                      "freeResources"
                    ),
                    resourceData
                  );
                  showMessage("Free resource added successfully!");
                  console.log("Free resource written with ID: ", docRef.id);
                }

                // Reset form and button text
                e.target.reset();
                document.getElementById("free-resource-id").value = "";
                document.getElementById("add-free-resource-btn").textContent =
                  "Add Free Resource";
                document
                  .getElementById("free-resource-image-drop-zone")
                  ._setImage(""); // Clear drag-drop preview
              } catch (e) {
                console.error("Error adding/updating free resource: ", e);
                showMessage(`Error: ${e.message}`);
              }
            }
          });
      });
    </script>
  </body>
</html>
