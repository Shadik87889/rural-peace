<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IELTS Mastery Hub</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Import Inter font for consistency */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap");

      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* Custom form-radio style for consistency with React app's checked state */
      .form-radio:checked {
        background-color: #3b82f6; /* blue-500 */
        border-color: #3b82f6;
      }

      /* Animations from React app */
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }
      .animate-fade-in-up {
        animation: fadeInUp 0.7s ease-out forwards;
      }
      .animate-zoom-in {
        animation: zoomIn 0.3s ease-out forwards;
      }
      .animate-pulse-slow {
        animation: pulse-slow 2s infinite;
      }
      .animate-pulse-fast {
        animation: pulse-fast 1s infinite;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes zoomIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      @keyframes pulse-slow {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.05);
          opacity: 0.8;
        }
      }
      @keyframes pulse-fast {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.02);
          opacity: 0.9;
        }
      }

      /* Custom scrollbar for better aesthetics */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: #a0aec0; /* gray-400 */
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #718096; /* gray-600 */
      }
    </style>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 py-12 px-4 sm:px-6 lg:px-8"
  >
    <div id="app">
      <!-- Application content will be rendered here by JavaScript -->
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        collection,
        query,
        onSnapshot,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Global variables to mimic React state and refs
      let currentView = "module-selection"; // 'module-selection', 'module-test-selection', 'test-in-progress', 'my-progress'
      let selectedModule = null; // 'listening', 'reading', etc.
      let selectedTestTitle = null; // Title of the selected mock test
      let userId = null;
      let isAuthReady = false;
      let showModal = false;
      let modalContent = {};

      // Firebase instances
      let appInstance;
      let db;
      let auth;

      // Ensure global variables are accessible by the functions
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : {};
      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      // Mock test data (same as React app)
      const allMockTests = [
        {
          id: "L_M_1",
          module: "listening",
          title: "Listening Mock Test 1 (Basic)",
          topic: "Academic - Everyday Conversations",
          source: "IDP",
        },
        {
          id: "L_BC_1",
          module: "listening",
          title: "Listening Practice Test 2 (Intermediate)",
          topic: "General Training - Public Announcements",
          source: "British Council",
        },
        {
          id: "L_IDP_3",
          module: "listening",
          title: "Listening Exam Prep (Advanced)",
          topic: "Academic - University Lecture",
          source: "IDP",
        },
        {
          id: "L_BC_4",
          module: "listening",
          title: "Listening Advanced (Challenging)",
          topic: "General Training - News Report",
          source: "British Council",
        },
        {
          id: "L_IDP_5",
          module: "listening",
          title: "Listening Focus Test (Accent Training)",
          topic: "Academic - Multiple Accents",
          source: "IDP",
        },

        {
          id: "R_M_1",
          module: "reading",
          title: "Reading Academic Test A (Basic)",
          topic: "Academic - Science & Technology",
          source: "IDP",
        },
        {
          id: "R_BC_1",
          module: "reading",
          title: "Reading General Test B (Intermediate)",
          topic: "General Training - Work & Society",
          source: "British Council",
        },
        {
          id: "R_IDP_3",
          module: "reading",
          title: "Reading Challenging (Academic)",
          topic: "Academic - Historical Article",
          source: "IDP",
        },
        {
          id: "R_BC_4",
          module: "reading",
          title: "Reading Practice (General)",
          topic: "General Training - Advertisements",
          source: "British Council",
        },
        {
          id: "R_IDP_5",
          module: "reading",
          title: "Reading Strategy Test (Skimming)",
          topic: "Academic - Long Passages",
          source: "IDP",
        },

        {
          id: "W_M_1",
          module: "writing",
          title: "Writing Academic Test 1 (Basic)",
          topic: "Academic - Data Analysis & Opinion Essay",
          source: "IDP",
        },
        {
          id: "W_BC_1",
          module: "writing",
          title: "Writing General Test 1 (Intermediate)",
          topic: "General Training - Letter & Essay",
          source: "British Council",
        },
        {
          id: "W_IDP_3",
          module: "writing",
          title: "Writing Task 2 Focus (Advanced)",
          topic: "Academic - Problem & Solution",
          source: "IDP",
        },
        {
          id: "W_BC_4",
          module: "writing",
          title: "Writing Task 1 & 2 (General)",
          topic: "General Training - Complaint Letter",
          source: "British Council",
        },
        {
          id: "W_IDP_5",
          module: "writing",
          title: "Writing Coherence Practice",
          topic: "Academic - Argumentative Essay",
          source: "IDP",
        },

        {
          id: "S_M_1",
          module: "speaking",
          title: "Speaking Mock Interview A (Basic)",
          topic: "Academic - Personal & Abstract Topics",
          source: "IDP",
        },
        {
          id: "S_BC_1",
          module: "speaking",
          title: "Speaking Practice Interview B (Intermediate)",
          topic: "General Training - Daily Life & Future",
          source: "British Council",
        },
        {
          id: "S_IDP_3",
          module: "speaking",
          title: "Speaking Fluency Builder (Advanced)",
          topic: "Academic - Technology & Society",
          source: "IDP",
        },
        {
          id: "S_BC_4",
          module: "speaking",
          title: "Speaking Pronunciation Drill (General)",
          topic: "General Training - Hobbies & Interests",
          source: "British Council",
        },
        {
          id: "S_IDP_5",
          module: "speaking",
          title: "Speaking Part 3 Deep Dive",
          topic: "Academic - Discussion Topics",
          source: "IDP",
        },
      ];

      // --- Utility Functions/Components ---

      /**
       * Renders the main application based on the currentView.
       * This function acts as the central router for the application's main views.
       */
      function renderApp() {
        const appDiv = document.getElementById("app");
        appDiv.innerHTML = ""; // Clear previous content

        // Render header, which is static across most views
        const headerHtml = `
                <header class="text-center mb-16">
                    <h1 class="text-6xl font-extrabold text-blue-900 drop-shadow-lg leading-tight">
                        <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-700">
                            IELTS Mastery Hub
                        </span>
                    </h1>
                    <p class="text-2xl text-gray-700 mt-4 max-w-2xl mx-auto">
                        Your ultimate destination for world-class IELTS preparation.
                    </p>
                    ${
                      isAuthReady && userId
                        ? `
                    <p class="mt-6 text-lg text-gray-600 font-mono bg-white bg-opacity-70 backdrop-blur-sm inline-block px-4 py-2 rounded-xl shadow-md border border-gray-200">
                        User ID: <span class="font-semibold text-gray-800">${userId}</span>
                    </p>
                    `
                        : ""
                    }
                </header>
            `;
        appDiv.insertAdjacentHTML("beforeend", headerHtml);

        // Create a dedicated div for the main content to allow specific module rendering
        let contentDiv = document.createElement("div");
        contentDiv.className = "main-content-area"; // Add a class for easier selection
        appDiv.appendChild(contentDiv);

        // Render specific view based on current state
        switch (currentView) {
          case "module-selection":
            renderModuleSelection(contentDiv);
            break;
          case "module-test-selection":
            renderModuleTestSelection(contentDiv);
            break;
          case "test-in-progress":
            renderTestInProgress(contentDiv);
            break;
          case "my-progress":
            renderMyProgressDashboard(contentDiv);
            break;
        }

        // Always render modal on top if showModal is true
        renderModal();
      }

      /**
       * Sets application state and triggers a re-render of the entire app.
       * This is the primary way to change views and selected test data.
       * Also handles resetting test specific states when a new test session begins.
       * @param {string} view - The new view state ('module-selection', 'module-test-selection', etc.).
       * @param {string} module - The selected module (optional, e.g., 'listening').
       * @param {string} testTitle - The title of the selected mock test (optional).
       */
      function setAppState(view, module = null, testTitle = null) {
        // Only reset test state if we are moving TO a test-in-progress view
        // from a non-test-in-progress view, or if changing modules.
        if (view === "test-in-progress" && currentView !== "test-in-progress") {
          if (module === "listening") resetListeningTestState();
          if (module === "reading") resetReadingTestState();
          if (module === "writing") resetWritingTestState();
          if (module === "speaking") resetSpeakingTestState();
        } else if (
          view === "module-test-selection" &&
          currentView === "test-in-progress"
        ) {
          // If exiting a test, ensure timers are cleared
          stopAllListeningTimers();
          stopAllReadingTimers();
          stopAllWritingTimers();
          stopAllSpeakingTimers();
        }

        currentView = view;
        if (module !== null) selectedModule = module;
        if (testTitle !== null) selectedTestTitle = testTitle;
        renderApp(); // Re-render the entire application
      }

      /**
       * Displays a modal message.
       * @param {string} title - Modal title.
       * @param {string} message - Modal message.
       */
      function showMessageModal(title, message) {
        modalContent = { title, message };
        showModal = true;
        renderModal(); // Re-render only the modal part
      }

      /**
       * Hides the modal.
       */
      function hideMessageModal() {
        showModal = false;
        renderModal();
      }

      /**
       * Renders the Modal component. This modal overlays the entire application.
       */
      function renderModal() {
        let modalContainer = document.getElementById("modal-container");
        if (!modalContainer) {
          modalContainer = document.createElement("div");
          modalContainer.id = "modal-container";
          document.body.appendChild(modalContainer);
        }

        if (!showModal) {
          modalContainer.innerHTML = "";
          return;
        }

        modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 animate-fade-in">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm transform scale-95 animate-zoom-in">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">${modalContent.title}</h3>
                        <p class="text-gray-600 mb-8 leading-relaxed">${modalContent.message}</p>
                        <button id="modal-close-button"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105"
                        >
                            Got It!
                        </button>
                    </div>
                </div>
            `;
        document.getElementById(
          "modal-close-button"
        ).onclick = hideMessageModal;
      }

      /**
       * Returns HTML for a loading spinner.
       * @returns {string} HTML string.
       */
      function getLoadingSpinnerHtml() {
        return `
                <div class="flex justify-center items-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-purple-500"></div>
                    <p class="ml-3 text-md text-gray-700">Processing...</p>
                </div>
            `;
      }

      /**
       * Formats time from seconds into MM:SS format.
       * @param {number} seconds - Total seconds to format.
       * @returns {string} Formatted time string (MM:SS).
       */
      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${minutes
          .toString()
          .padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
      }

      // SVG Icons (converted from Lucide React components) - kept identical
      const MicIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>`;
      const HeadphonesIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-headphones"><path d="M3 14h3a2 2 0 0 1 2 2v3a2 3 0 0 1-2 2H3a2 3 0 0 1-2-2v-3a2 3 0 0 1 2-2Z"/><path d="M18 14h3a2 2 0 0 1 2 2v3a2 3 0 0 1-2 2h-3a2 3 0 0 1-2-2v-3a2 3 0 0 1 2-2Z"/><path d="M7 14v-3a9 9 0 0 1 18 0v3"/></svg>`;
      const BookOpenIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`;
      const FileTextIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`;
      const ActivityIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-activity"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`;
      const ChevronLeftIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>`;
      const LightbulbIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lightbulb w-5 h-5 mr-2 text-blue-500"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 6c0 1.3.5 2.6 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M7 14h10"/><path d="M12 22v-4"/><path d="M8 22h8"/></svg>`;

      // --- Module Selection Component ---
      function renderModuleSelection(parentDiv) {
        const moduleSelectionHtml = `
                <div class="flex flex-wrap justify-center gap-8 max-w-6xl mx-auto animate-fade-in-up">
                    <button id="listening-module-btn"
                        class="flex flex-col items-center justify-center p-10 bg-white rounded-3xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition duration-300 w-72 h-64 border-b-8 border-blue-500 hover:border-blue-700 group cursor-pointer focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-75 relative overflow-hidden"
                    >
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-blue-100 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <span class="w-20 h-20 text-blue-600 mb-6 group-hover:text-blue-800 transition duration-300 transform group-hover:scale-110 relative z-10">${HeadphonesIcon.replace(
                          /width="24" height="24"/g,
                          'width="80" height="80"'
                        )}</span>
                        <span class="text-3xl font-bold text-gray-800 group-hover:text-blue-900 transition duration-300 relative z-10">Listening</span>
                        <span class="text-base text-gray-600 mt-2 relative z-10">30 mins, 40 questions</span>
                    </button>

                    <button id="reading-module-btn"
                        class="flex flex-col items-center justify-center p-10 bg-white rounded-3xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition duration-300 w-72 h-64 border-b-8 border-green-500 hover:border-green-700 group cursor-pointer focus:outline-none focus:ring-4 focus:ring-green-300 focus:ring-opacity-75 relative overflow-hidden"
                    >
                        <div class="absolute inset-0 bg-gradient-to-br from-green-50 to-green-100 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <span class="w-20 h-20 text-green-600 mb-6 group-hover:text-green-800 transition duration-300 transform group-hover:scale-110 relative z-10">${BookOpenIcon.replace(
                          /width="24" height="24"/g,
                          'width="80" height="80"'
                        )}</span>
                        <span class="text-3xl font-bold text-gray-800 group-hover:text-green-900 transition duration-300 relative z-10">Reading</span>
                        <span class="text-base text-gray-600 mt-2 relative z-10">60 mins, 40 questions</span>
                    </button>

                    <button id="writing-module-btn"
                        class="flex flex-col items-center justify-center p-10 bg-white rounded-3xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition duration-300 w-72 h-64 border-b-8 border-yellow-500 hover:border-yellow-700 group cursor-pointer focus:outline-none focus:ring-4 focus:ring-yellow-300 focus:ring-opacity-75 relative overflow-hidden"
                    >
                        <div class="absolute inset-0 bg-gradient-to-br from-yellow-50 to-yellow-100 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <span class="w-20 h-20 text-yellow-600 mb-6 group-hover:text-yellow-800 transition duration-300 transform group-hover:scale-110 relative z-10">${FileTextIcon.replace(
                          /width="24" height="24"/g,
                          'width="80" height="80"'
                        )}</span>
                        <span class="text-3xl font-bold text-gray-800 group-hover:text-yellow-900 transition duration-300 relative z-10">Writing</span>
                        <span class="text-base text-gray-600 mt-2 relative z-10">60 mins, 2 tasks (AI graded)</span>
                    </button>

                    <button id="speaking-module-btn"
                        class="flex flex-col items-center justify-center p-10 bg-white rounded-3xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition duration-300 w-72 h-64 border-b-8 border-red-500 hover:border-red-700 group cursor-pointer focus:outline-none focus:ring-4 focus:ring-red-300 focus:ring-opacity-75 relative overflow-hidden"
                    >
                        <div class="absolute inset-0 bg-gradient-to-br from-red-50 to-red-100 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <span class="w-20 h-20 text-red-600 mb-6 group-hover:text-red-800 transition duration-300 transform group-hover:scale-110 relative z-10">${MicIcon.replace(
                          /width="24" height="24"/g,
                          'width="80" height="80"'
                        )}</span>
                        <span class="text-3xl font-bold text-gray-800 group-hover:text-red-900 transition duration-300 relative z-10">Speaking</span>
                        <span class="text-base text-gray-600 mt-2 relative z-10">11-14 mins, 3 parts (AI graded)</span>
                    </button>

                    <button id="my-progress-btn"
                        class="flex flex-col items-center justify-center p-10 bg-white rounded-3xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition duration-300 w-72 h-64 border-b-8 border-purple-500 hover:border-purple-700 group cursor:pointer focus:outline-none focus:ring-4 focus:ring-purple-300 focus:ring-opacity-75 relative overflow-hidden"
                    >
                        <div class="absolute inset-0 bg-gradient-to-br from-purple-50 to-purple-100 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <span class="w-20 h-20 text-purple-600 mb-6 group-hover:text-purple-800 transition duration-300 transform group-hover:scale-110 relative z-10">${ActivityIcon.replace(
                          /width="24" height="24"/g,
                          'width="80" height="80"'
                        )}</span>
                        <span class="text-3xl font-bold text-gray-800 group-hover:text-purple-900 transition duration-300 relative z-10">My Progress</span>
                        <span class="text-base text-gray-600 mt-2 relative z-10">Track your journey</span>
                    </button>
                </div>
            `;
        parentDiv.innerHTML = moduleSelectionHtml; // Set content

        // Add event listeners
        document.getElementById("listening-module-btn").onclick = () =>
          handleSelectModule("listening");
        document.getElementById("reading-module-btn").onclick = () =>
          handleSelectModule("reading");
        document.getElementById("writing-module-btn").onclick = () =>
          handleSelectModule("writing");
        document.getElementById("speaking-module-btn").onclick = () =>
          handleSelectModule("speaking");
        document.getElementById("my-progress-btn").onclick = () =>
          handleSelectModule("my-progress");
      }

      /**
       * Handles the selection of a module from the main screen.
       * @param {string} moduleName - The name of the selected module (e.g., 'listening').
       */
      function handleSelectModule(moduleName) {
        if (!isAuthReady || !userId) {
          showMessageModal(
            "System Loading",
            "Please wait a moment while the system initializes (authenticates with Firebase). If the problem persists, try refreshing the page."
          );
          return;
        }
        if (moduleName === "my-progress") {
          setAppState("my-progress");
        } else {
          setAppState("module-test-selection", moduleName);
        }
      }

      // --- Module Specific Test Selection Component ---
      function renderModuleTestSelection(parentDiv) {
        const filteredTests = allMockTests.filter(
          (test) => test.module === selectedModule
        );

        const getModuleDetails = (module) => {
          switch (module) {
            case "listening":
              return {
                title: "Listening",
                color: "blue",
                icon: HeadphonesIcon,
              };
            case "reading":
              return { title: "Reading", color: "green", icon: BookOpenIcon };
            case "writing":
              return { title: "Writing", color: "yellow", icon: FileTextIcon };
            case "speaking":
              return { title: "Speaking", color: "red", icon: MicIcon };
            default:
              return { title: "Module", color: "gray", icon: null };
          }
        };

        const moduleDetails = getModuleDetails(selectedModule);

        let testsHtml = "";
        if (filteredTests.length > 0) {
          testsHtml = filteredTests
            .map(
              (test) => `
                    <div data-testid="${test.id}" data-module="${
                test.module
              }" data-title="${test.title}"
                        class="bg-white rounded-3xl shadow-xl hover:shadow-2xl transform hover:-translate-y-2 transition duration-300 cursor-pointer flex flex-col justify-between overflow-hidden group border border-gray-200 relative"
                    >
                        <div class="p-8 flex flex-col items-start min-h-[220px] ${
                          moduleDetails.color === "blue"
                            ? "bg-gradient-to-br from-blue-50 to-blue-100"
                            : moduleDetails.color === "green"
                            ? "bg-gradient-to-br from-green-50 to-green-100"
                            : moduleDetails.color === "yellow"
                            ? "bg-gradient-to-br from-yellow-50 to-yellow-100"
                            : moduleDetails.color === "red"
                            ? "bg-red-50 to-red-100"
                            : ""
                        } border-b-4 border-${moduleDetails.color}-300">
                            <div class="w-14 h-14 rounded-full flex items-center justify-center mb-6 shadow-md ${
                              moduleDetails.color === "blue"
                                ? "bg-blue-200 text-blue-700"
                                : moduleDetails.color === "green"
                                ? "bg-green-200 text-green-700"
                                : moduleDetails.color === "yellow"
                                ? "bg-yellow-200 text-yellow-700"
                                : moduleDetails.color === "red"
                                ? "bg-red-200 text-red-700"
                                : ""
                            }">
                                ${moduleDetails.icon.replace(
                                  /width="24" height="24"/g,
                                  'width="48" height="48"'
                                )}
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-3 leading-tight">${
                              test.title
                            }</h3>
                            <p class="text-gray-700 text-base flex-grow">${
                              test.topic
                            }</p>
                        </div>
                        <div class="px-8 py-5 bg-gray-50 border-t border-gray-100 flex justify-between items-center">
                            <span class="text-sm font-bold px-4 py-1 rounded-full shadow-inner ${
                              test.source === "IDP"
                                ? "bg-orange-100 text-orange-800"
                                : "bg-purple-100 text-purple-800"
                            }">
                                ${test.source}
                            </span>
                            <span class="text-base text-gray-600 font-medium">${
                              test.module.charAt(0).toUpperCase() +
                              test.module.slice(1)
                            }</span>
                        </div>
                    </div>
                `
            )
            .join("");
        } else {
          testsHtml = `<p class="text-center text-gray-600 col-span-full py-16 text-xl">No mock tests available for this module yet. Please check back later!</p>`;
        }

        const moduleTestSelectionHtml = `
                <div class="max-w-6xl mx-auto py-8 animate-fade-in">
                    <div class="flex items-center justify-between mb-12">
                        <button id="back-to-modules-btn"
                            class="flex items-center text-gray-600 hover:text-gray-800 transition duration-300 text-lg font-semibold bg-white px-5 py-2 rounded-xl shadow-md hover:shadow-lg transform hover:scale-105"
                        >
                            ${ChevronLeftIcon.replace(
                              /width="24" height="24"/g,
                              'width="24" height="24" class="w-6 h-6 mr-2 text-gray-700"'
                            )}
                            Back to Modules
                        </button>
                        <h2 class="text-5xl font-extrabold text-${
                          moduleDetails.color
                        }-800 text-center tracking-tight flex-grow">
                            ${moduleDetails.title} Mock Tests
                        </h2>
                        <div class="w-auto"></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                        ${testsHtml}
                    </div>
                </div>
            `;
        parentDiv.innerHTML = moduleTestSelectionHtml;

        document.getElementById(
          "back-to-modules-btn"
        ).onclick = handleBackToModules;

        // Add event listeners for each test card
        filteredTests.forEach((test) => {
          document.querySelector(`[data-testid="${test.id}"]`).onclick = () =>
            handleSelectTest(test.module, test.id, test.title);
        });
      }

      /**
       * Handles the selection of a specific test.
       * @param {string} moduleName - The module of the selected test.
       * @param {string} testId - The ID of the selected test.
       * @param {string} testTitle - The title of the selected test.
       */
      function handleSelectTest(moduleName, testId, testTitle) {
        if (!isAuthReady || !userId) {
          showMessageModal(
            "System Loading",
            "Please wait a moment while the system initializes (authenticates with Firebase)."
          );
          return;
        }
        setAppState("test-in-progress", moduleName, testTitle);
      }

      /**
       * Handles navigation back to the module selection screen.
       */
      function handleBackToModules() {
        setAppState("module-selection");
      }

      // --- My Progress / Dashboard Component (Conceptual) ---
      /**
       * Renders the conceptual My Progress Dashboard.
       * @param {HTMLElement} parentDiv - The div to render the dashboard into.
       */
      function renderMyProgressDashboard(parentDiv) {
        const dashboardHtml = `
                <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100 w-full max-w-5xl mx-auto my-8 animate-fade-in-up">
                    <div class="flex items-center justify-between mb-12">
                        <button id="back-from-progress-btn"
                            class="flex items-center text-gray-600 hover:text-gray-800 transition duration-300 text-lg font-semibold bg-white px-5 py-2 rounded-xl shadow-md hover:shadow-lg transform hover:scale-105"
                        >
                            ${ChevronLeftIcon.replace(
                              /width="24" height="24"/g,
                              'width="24" height="24" class="w-6 h-6 mr-2 text-gray-700"'
                            )}
                            Back to Modules
                        </button>
                        <h2 class="text-5xl font-extrabold text-purple-800 text-center tracking-tight flex-grow">
                            My Progress Dashboard
                        </h2>
                        <div class="w-auto"></div>
                    </div>

                    <div class="text-center bg-purple-50 p-8 rounded-2xl border border-purple-200 shadow-inner">
                        <p class="text-gray-700 text-xl mb-6 leading-relaxed">
                            This is where your personalized progress and past test results would be displayed in a full system!
                            Imagine interactive charts showing your band scores over time, breakdowns by skill,
                            and AI-driven insights into your strengths and weaknesses.
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                                <h3 class="text-xl font-bold text-gray-800 mb-3">Overall Score Trend</h3>
                                <img src="https://placehold.co/400x150/f0f4f8/9ca3af?text=LINE+CHART" alt="Overall Score Chart" class="w-full rounded-md"/>
                                <p class="text-sm text-gray-500 mt-2">Your band score progress over last 5 tests.</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                                <h3 class="text-xl font-bold text-gray-800 mb-3">Skill Breakdown</h3>
                                <img src="https://placehold.co/400x150/f0f4f8/9ca3af?text=RADAR+CHART" alt="Skill Breakdown Chart" class="w-full rounded-md"/>
                                <p class="text-sm text-gray-500 mt-2">Performance across Listening, Reading, Writing, Speaking.</p>
                            </div>
                        </div>
                        <p class="text-gray-600 text-md mt-6">
                            Future enhancements would include detailed reports, personalized study recommendations, and more!
                        </p>
                    </div>
                </div>
            `;
        parentDiv.innerHTML = dashboardHtml;
        document.getElementById(
          "back-from-progress-btn"
        ).onclick = handleBackToModules;
      }

      // --- Individual IELTS Module Components Logic ---

      // Listening Test State & Functions
      let listeningTestState = {
        currentQuestion: 0,
        answers: {}, // Stores user answers for current test session
        timeRemaining: 30 * 60, // 30 minutes in seconds
        isPlaying: false,
        audioElement: null,
        timerInterval: null,
        audioUrl:
          "https://ieltstrainingonline.com/wp-content/uploads/2021/07/IELTS-Recent-Actual-Test-With-Answers-Practice-Test-30-Section1.mp3",
        questions: [
          {
            id: "L1",
            type: "multiple-choice",
            audioPrompt:
              "Section 1: You will hear a conversation between a student and a university administrator about course registration. Questions 1-5.",
            questionText:
              "1. What is the main reason the student wants to change courses?",
            options: [
              "a) The current course is too difficult.",
              "b) The timetable clashes with another commitment.",
              "c) They are more interested in a different subject.",
              "d) The lecturer is unhelpful.",
            ],
            correctAnswer: "b",
          },
          {
            id: "L2",
            type: "fill-in-the-blank",
            audioPrompt: "Now, fill in the missing information.",
            questionText:
              "2. The student’s new course begins on the __________ of September.",
            correctAnswer: "15th",
          },
          {
            id: "L3",
            type: "multiple-choice",
            audioPrompt: "Choose the correct option.",
            questionText: "3. What time does the library close on weekdays?",
            options: ["a) 5 PM", "b) 7 PM", "c) 9 PM", "d) Midnight"],
            correctAnswer: "b",
          },
          {
            id: "L4",
            type: "short-answer",
            audioPrompt: "Answer in no more than three words.",
            questionText: "4. What is the name of the new campus building?",
            correctAnswer: "Academic Hub",
          },
          {
            id: "L5",
            type: "matching",
            audioPrompt: "Match the speakers to their opinions.",
            questionText: "5. Match the following:",
            items: [
              { key: "A. John", value: "" },
              { key: "B. Sarah", value: "" },
            ],
            options: [
              "I. Enjoys group projects",
              "II. Prefers independent study",
            ],
            correctMapping: { A: "I", B: "II" },
          },
          {
            id: "L6",
            type: "multiple-choice",
            audioPrompt:
              "Section 2: You will hear a tour guide talking about a local museum. Questions 6-10.",
            questionText: "6. What is the museum's main exhibition about?",
            options: [
              "a) Ancient artifacts",
              "b) Modern art",
              "c) Local history",
              "d) Space exploration",
            ],
            correctAnswer: "c",
          },
          {
            id: "L7",
            type: "fill-in-the-blank",
            audioPrompt: "Complete the sentence.",
            questionText:
              "7. The museum is located next to the __________ park.",
            correctAnswer: "Central",
          },
          {
            id: "L8",
            type: "short-answer",
            audioPrompt: "What is the entry fee for adults?",
            questionText: "8. How much is an adult ticket?",
            correctAnswer: "£10",
          },
          {
            id: "L9",
            type: "multiple-choice",
            audioPrompt: "Which facilities are available?",
            questionText:
              "9. Visitors can find a gift shop and a __________ inside.",
            options: ["a) Swimming pool", "b) Cafe", "c) Gym", "d) Cinema"],
            correctAnswer: "b",
          },
          {
            id: "L10",
            type: "matching",
            audioPrompt: "Match the attractions to their features.",
            questionText: "10. Match the following:",
            items: [
              { key: "A. Sculpture Garden", value: "" },
              { key: "B. Science Wing", value: "" },
            ],
            options: [
              "I. Interactive displays",
              "II. Outdoor art installations",
            ],
            correctMapping: { A: "II", B: "I" },
          },
          {
            id: "L11",
            type: "multiple-choice",
            audioPrompt:
              "Section 3: You will hear two students discussing their research project. Questions 11-20.",
            questionText: "11. What is the primary topic of their research?",
            options: [
              "a) Climate change impacts",
              "b) Urban planning strategies",
              "c) Renewable energy sources",
              "d) Biodiversity conservation",
            ],
            correctAnswer: "d",
          },
          {
            id: "L12",
            type: "fill-in-the-blank",
            audioPrompt: "Fill in the blank.",
            questionText:
              "12. They decided to focus on the impact of habitat loss on __________ species.",
            correctAnswer: "endangered",
          },
          {
            id: "L13",
            type: "short-answer",
            audioPrompt: "Name one challenge they faced.",
            questionText: "13. What was a major difficulty in their research?",
            correctAnswer: "data collection",
          },
          {
            id: "L14",
            type: "multiple-choice",
            audioPrompt: "Which method did they use for data collection?",
            questionText: "14. They primarily used which method?",
            options: [
              "a) Surveys",
              "b) Experiments",
              "c) Field observations",
              "d) Library research",
            ],
            correctAnswer: "c",
          },
          {
            id: "L15",
            type: "matching",
            audioPrompt: "Match the problems to their solutions.",
            questionText: "15. Match the following:",
            items: [
              { key: "A. Limited funding", value: "" },
              { key: "B. Time constraints", value: "" },
            ],
            options: ["I. Prioritize tasks", "II. Seek grants"],
            correctMapping: { A: "II", B: "I" },
          },
          {
            id: "L16",
            type: "multiple-choice",
            audioPrompt: "When did solid chocolate become popular?",
            questionText: "16. Where did chocolate originate?",
            options: ["a) Europe", "b) Africa", "c) South America", "d) Asia"],
            correctAnswer: "c",
          },
          {
            id: "L17",
            type: "fill-in-the-blank",
            audioPrompt: "Complete the note.",
            questionText:
              "17. Cacao beans were first cultivated by the __________ civilization.",
            correctAnswer: "Olmec",
          },
          {
            id: "L18",
            type: "short-answer",
            audioPrompt: "What was chocolate first used for?",
            questionText: "18. What was its initial primary use?",
            correctAnswer: "beverage",
          },
          {
            id: "L19",
            type: "multiple-choice",
            audioPrompt: "When did solid chocolate become popular?",
            questionText:
              "19. Solid chocolate bars became widely available in the __________ century.",
            options: ["a) 17th", "b) 18th", "c) 19th", "d) 20th"],
            correctAnswer: "c",
          },
          {
            id: "L20",
            type: "matching",
            audioPrompt: "Match the periods to the uses of chocolate.",
            questionText: "20. Match the following:",
            items: [
              { key: "A. Ancient Times", value: "" },
              { key: "B. 17th Century Europe", value: "" },
            ],
            options: ["I. Medicinal drink", "II. Ritualistic beverage"],
            correctMapping: { A: "II", B: "I" },
          },
          {
            id: "L21",
            type: "multiple-choice",
            audioPrompt: "Listen carefully for details. Questions 21-25.",
            questionText: "21. What is the lecturer mainly discussing now?",
            options: [
              "a) Economic theories",
              "b) Social changes",
              "c) Technological advancements",
              "d) Environmental policies",
            ],
            correctAnswer: "c",
          },
          {
            id: "L22",
            type: "fill-in-the-blank",
            audioPrompt: "Fill in the gap.",
            questionText:
              "22. The new invention will revolutionize the __________ industry.",
            correctAnswer: "manufacturing",
          },
          {
            id: "L23",
            type: "short-answer",
            audioPrompt: "What is a key benefit mentioned?",
            questionText: "23. Give one advantage of this new technology.",
            correctAnswer: "increased efficiency",
          },
          {
            id: "L24",
            type: "multiple-choice",
            audioPrompt: "Which challenge is highlighted?",
            questionText:
              "24. A significant obstacle mentioned is the lack of __________.",
            options: [
              "a) funding",
              "b) skilled workers",
              "c) raw materials",
              "d) public interest",
            ],
            correctAnswer: "b",
          },
          {
            id: "L25",
            type: "matching",
            audioPrompt: "Match the impact to the sector.",
            questionText: "25. Match:",
            items: [
              { key: "A. Agriculture", value: "" },
              { key: "B. Transportation", value: "" },
            ],
            options: ["I. Driverless vehicles", "II. Precision farming"],
            correctMapping: { A: "II", B: "I" },
          },
          {
            id: "L26",
            type: "multiple-choice",
            audioPrompt:
              "Next, the speaker moves to discuss urban development. Questions 26-30.",
            questionText: "26. What is the main problem of rapid urban growth?",
            options: [
              "a) Traffic congestion",
              "b) Housing shortages",
              "c) Pollution",
              "d) Water scarcity",
            ],
            correctAnswer: "b",
          },
          {
            id: "L27",
            type: "fill-in-the-blank",
            audioPrompt: "Complete the sentence.",
            questionText:
              "27. Smart city initiatives aim to improve urban living through __________ solutions.",
            correctAnswer: "technological",
          },
          {
            id: "L28",
            type: "short-answer",
            audioPrompt: "What kind of energy is preferred for new buildings?",
            questionText: "28. What type of energy is being encouraged?",
            correctAnswer: "renewable",
          },
          {
            id: "L29",
            type: "multiple-choice",
            audioPrompt: "Which demographic is most affected?",
            questionText:
              "29. The speaker states that __________ are particularly impacted by rising costs.",
            options: [
              "a) young families",
              "b) elderly citizens",
              "c) students",
              "d) single professionals",
            ],
            correctAnswer: "a",
          },
          {
            id: "L30",
            type: "matching",
            audioPrompt: "Match the solution to the urban issue.",
            questionText: "30. Match:",
            items: [
              { key: "A. Traffic", value: "" },
              { key: "B. Waste", value: "" },
            ],
            options: [
              "I. Recycling programs",
              "II. Public transport expansion",
            ],
            correctMapping: { A: "II", B: "I" },
          },
          {
            id: "L31",
            type: "multiple-choice",
            audioPrompt:
              "Now, listen to a conversation about starting a small business. Questions 31-35.",
            questionText:
              "31. What is the first step recommended for new entrepreneurs?",
            options: [
              "a) Secure a loan",
              "b) Develop a business plan",
              "c) Find a location",
              "d) Hire staff",
            ],
            correctAnswer: "b",
          },
          {
            id: "L32",
            type: "fill-in-the-blank",
            audioPrompt: "Fill in the blank.",
            questionText:
              "32. Marketing strategies should focus on identifying the target __________.",
            correctAnswer: "audience",
          },
          {
            id: "L33",
            type: "short-answer",
            audioPrompt: "What is a common pitfall for new businesses?",
            questionText: "33. Name one mistake new businesses often make.",
            correctAnswer: "underestimating costs",
          },
          {
            id: "L34",
            type: "multiple-choice",
            audioPrompt: "What advice is given regarding competition?",
            questionText: "34. What should entrepreneurs do about competitors?",
            options: [
              "a) Ignore them",
              "b) Copy their ideas",
              "c) Analyze their strengths and weaknesses",
              "d) Try to eliminate them",
            ],
            correctAnswer: "c",
          },
          {
            id: "L35",
            type: "matching",
            audioPrompt: "Match the business function to its purpose.",
            questionText: "35. Match:",
            items: [
              { key: "A. Finance", value: "" },
              { key: "B. Operations", value: "" },
            ],
            options: ["I. Managing daily activities", "II. Securing capital"],
            correctMapping: { A: "II", B: "I" },
          },
          {
            id: "L36",
            type: "multiple-choice",
            audioPrompt:
              "The final section is about psychological research. Questions 36-40.",
            questionText: "36. What research method is primarily discussed?",
            options: [
              "a) Case studies",
              "b) Longitudinal studies",
              "c) Cross-sectional studies",
              "d) Experimental designs",
            ],
            correctAnswer: "d",
          },
          {
            id: "L37",
            type: "fill-in-the-blank",
            audioPrompt: "Complete the notes.",
            questionText:
              "37. The study aimed to measure the effect of sleep deprivation on __________ performance.",
            correctAnswer: "cognitive",
          },
          {
            id: "L38",
            type: "short-answer",
            audioPrompt: "What ethical consideration is mentioned?",
            questionText: "38. What is a key ethical concern in the study?",
            correctAnswer: "informed consent",
          },
          {
            id: "L39",
            type: "multiple-choice",
            audioPrompt: "What was a surprising finding?",
            questionText:
              "39. The most unexpected result was the link between sleep and __________.",
            options: [
              "a) physical health",
              "b) emotional stability",
              "c) dietary habits",
              "d) social interaction",
            ],
            correctAnswer: "b",
          },
          {
            id: "L40",
            type: "matching",
            audioPrompt: "Match the brain region to its function.",
            questionText: "40. Match:",
            items: [
              { key: "A. Prefrontal Cortex", value: "" },
              { key: "B. Hippocampus", value: "" },
            ],
            options: ["I. Memory formation", "II. Decision-making"],
            correctMapping: { A: "II", B: "I" },
          },
        ],
      };

      /**
       * Resets the listening test state. Called only when a new test is started.
       */
      function resetListeningTestState() {
        stopAllListeningTimers(); // Clear any existing timers
        if (listeningTestState.audioElement) {
          listeningTestState.audioElement.pause();
          listeningTestState.audioElement.removeEventListener(
            "ended",
            handleAudioEndedForListening
          );
          listeningTestState.audioElement = null; // Clear audio element
        }
        listeningTestState = {
          currentQuestion: 0,
          answers: {},
          timeRemaining: 30 * 60,
          isPlaying: false,
          audioElement: null,
          timerInterval: null,
          audioUrl:
            "https://ieltstrainingonline.com/wp-content/uploads/2021/07/IELTS-Recent-Actual-Test-With-Answers-Practice-Test-30-Section1.mp3",
          questions: listeningTestState.questions, // Keep questions static
        };
      }

      /**
       * Stops all active timers for the listening test.
       */
      function stopAllListeningTimers() {
        if (listeningTestState.timerInterval) {
          clearInterval(listeningTestState.timerInterval);
          listeningTestState.timerInterval = null;
        }
      }

      /**
       * Handles the 'ended' event for the audio element.
       * Sets isPlaying to false and updates UI.
       */
      function handleAudioEndedForListening() {
        listeningTestState.isPlaying = false;
        updateListeningControls();
        console.log("Audio playback ended.");
      }

      /**
       * Starts the overall timer for the listening test.
       */
      function startListeningTimer() {
        if (listeningTestState.timerInterval)
          clearInterval(listeningTestState.timerInterval); // Clear any old timer
        listeningTestState.timerInterval = setInterval(() => {
          listeningTestState.timeRemaining--;
          if (listeningTestState.timeRemaining <= 0) {
            clearInterval(listeningTestState.timerInterval);
            handleFinishListeningTest();
          }
          updateListeningTimerDisplay(); // Update UI every second
        }, 1000);
      }

      /**
       * Updates the time display on the UI.
       */
      function updateListeningTimerDisplay() {
        const timerSpan = document.getElementById("listening-time-left");
        if (timerSpan) {
          timerSpan.textContent = formatTime(listeningTestState.timeRemaining);
        }
      }

      /**
       * Handles changes in input fields for listening questions, saving answers to state.
       * @param {Event} e - The input change event.
       */
      function handleListeningInputChange(e) {
        const { name, value, type, checked } = e.target;
        const currentQ =
          listeningTestState.questions[listeningTestState.currentQuestion];

        if (type === "radio") {
          if (checked) {
            listeningTestState.answers[name] = value;
          }
        } else if (currentQ.type === "matching") {
          // For matching questions, name is typically like "L5-A"
          listeningTestState.answers[name] = value;
        } else {
          listeningTestState.answers[name] = value;
        }
        // No need to re-render the whole component, just updating state
        // The value is read directly from state when constructing the input HTML.
      }

      /**
       * Navigates to the next question in the listening test.
       */
      function handleNextListeningQuestion() {
        if (
          listeningTestState.currentQuestion <
          listeningTestState.questions.length - 1
        ) {
          listeningTestState.currentQuestion++;
          renderListeningQuestion(
            document.querySelector(".test-question-area")
          ); // Render only the question part
        } else {
          // If it's the last question and 'Next' is pressed, prompt for submission
          showMessageModal(
            "End of Listening Section",
            "You have completed all questions in the Listening section. Please submit your answers."
          );
        }
      }

      /**
       * Navigates to the previous question in the listening test.
       */
      function handlePreviousListeningQuestion() {
        if (listeningTestState.currentQuestion > 0) {
          listeningTestState.currentQuestion--;
          renderListeningQuestion(
            document.querySelector(".test-question-area")
          ); // Render only the question part
        }
      }

      /**
       * Plays or pauses the listening audio.
       */
      function handlePlayPauseListeningAudio() {
        if (!listeningTestState.audioElement) {
          console.error("Audio element not initialized.");
          showMessageModal(
            "Audio Error",
            "Audio is not ready. Please try again. Ensure you have interacted with the page first if autoplay is blocked."
          );
          return;
        }

        if (listeningTestState.isPlaying) {
          listeningTestState.audioElement.pause();
          console.log("Audio paused.");
        } else {
          listeningTestState.audioElement.play().catch((error) => {
            console.error("Error playing audio:", error);
            showMessageModal(
              "Audio Playback Error",
              "Could not play audio. Please ensure your browser allows autoplay (you might need to interact with the page first by clicking anywhere if audio doesn't start)."
            );
          });
          console.log("Audio playing...");
        }
        listeningTestState.isPlaying = !listeningTestState.isPlaying;
        updateListeningControls(); // Update the play/pause button UI
      }

      /**
       * Updates the play/pause button and audio status text in the UI.
       */
      function updateListeningControls() {
        const playPauseBtn = document.getElementById("play-pause-audio-btn");
        if (playPauseBtn) {
          playPauseBtn.innerHTML = `${HeadphonesIcon.replace(
            /width="24" height="24"/g,
            'width="20" height="20" class="w-5 h-5 mr-2"'
          )} ${listeningTestState.isPlaying ? "Pause Audio" : "Play Audio"}`;
        }
        const loadingSpinner = document.getElementById(
          "listening-audio-spinner"
        );
        if (loadingSpinner) {
          loadingSpinner.innerHTML =
            !listeningTestState.audioElement ||
            !listeningTestState.audioElement.canPlayType("audio/mpeg")
              ? getLoadingSpinnerHtml()
              : "";
        }
      }

      /**
       * Handles the completion and submission of the listening test.
       */
      async function handleFinishListeningTest() {
        stopAllListeningTimers();
        if (listeningTestState.audioElement) {
          listeningTestState.audioElement.pause();
        }
        showMessageModal(
          "Submitting Listening Answers",
          "Your Listening answers are being processed. This is where AI scoring would happen (conceptually, for demo purposes)."
        );
        await new Promise((resolve) => setTimeout(resolve, 2000));
        showMessageModal(
          "Listening Score Report",
          "Thank you for completing the Listening test! Your score report will be available in your dashboard (conceptually). This section is automatically graded by the system."
        );
        setAppState("module-test-selection", selectedModule);
        // resetListeningTestState is called by setAppState when entering test-in-progress next time
      }

      /**
       * Renders the Listening Test UI.
       * @param {HTMLElement} parentDiv - The div to render the test into.
       */
      function renderListeningTest(parentDiv) {
        // Initial setup for the entire Listening Test container
        const listeningTestContainerHtml = `
                <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100 w-full max-w-4xl mx-auto my-8 animate-fade-in-up">
                    <h2 class="text-4xl font-extrabold text-blue-800 mb-4 text-center tracking-tight">Listening Test</h2>
                    <p class="text-xl text-gray-700 mb-8 text-center font-medium">${selectedTestTitle}</p>

                    <div class="flex justify-between items-center mb-6 pb-4 border-b-2 border-gray-100">
                        <div class="text-lg font-semibold text-gray-700 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 102 0V6zm-3.707 5.707a1 1 0 001.414-1.414L9 8.586V7a1 1 0 10-2 0v2a1 1 0 00.293.707l3 3z" clip-rule="evenodd"></path></svg>
                            Time Left: <span class="text-red-600 ml-1" id="listening-time-left">${formatTime(
                              listeningTestState.timeRemaining
                            )}</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="play-pause-audio-btn"
                                class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-300 flex items-center transform hover:scale-105"
                                ${
                                  !listeningTestState.audioElement ||
                                  !listeningTestState.audioElement.canPlayType(
                                    "audio/mpeg"
                                  )
                                    ? "disabled"
                                    : ""
                                }
                            >
                                ${HeadphonesIcon.replace(
                                  /width="24" height="24"/g,
                                  'width="20" height="20" class="w-5 h-5 mr-2"'
                                )}
                                ${
                                  listeningTestState.isPlaying
                                    ? "Pause Audio"
                                    : "Play Audio"
                                }
                            </button>
                            <div id="listening-audio-spinner"></div>
                        </div>
                    </div>

                    <div class="test-question-area">
                        <!-- Current question will be rendered here dynamically -->
                    </div>

                    <div class="flex justify-between mt-10">
                        <button id="previous-listening-btn"
                            class="bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-xl hover:bg-gray-400 transition duration-300 shadow-md hover:shadow-lg transform hover:scale-105"
                        >
                            ${ChevronLeftIcon.replace(
                              /width="24" height="24"/g,
                              'width="24" height="24" class="inline-block mr-2"'
                            )} Previous
                        </button>
                        <button id="next-or-submit-listening-btn"
                            class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105"
                        ></button>
                    </div>
                </div>
            `;
        parentDiv.innerHTML = listeningTestContainerHtml;

        // Initialize audio element only once per test session
        if (!listeningTestState.audioElement) {
          listeningTestState.audioElement = new Audio(
            listeningTestState.audioUrl
          );
          listeningTestState.audioElement.preload = "auto";
          listeningTestState.audioElement.addEventListener(
            "ended",
            handleAudioEndedForListening
          );
        }
        startListeningTimer(); // Start the test timer

        // Attach core event listeners to buttons
        document.getElementById(
          "play-pause-audio-btn"
        ).onclick = handlePlayPauseListeningAudio;
        document.getElementById(
          "previous-listening-btn"
        ).onclick = handlePreviousListeningQuestion;

        // Initial render of the first question and update controls
        renderListeningQuestion(document.querySelector(".test-question-area"));
        updateListeningControls();
      }

      /**
       * Renders only the current listening question section, updating input values.
       * @param {HTMLElement} questionAreaDiv - The div specifically for questions.
       */
      function renderListeningQuestion(questionAreaDiv) {
        const currentQ =
          listeningTestState.questions[listeningTestState.currentQuestion];

        let questionInputHtml = "";
        if (currentQ.type === "multiple-choice") {
          questionInputHtml = `
                    <div class="space-y-4">
                        ${currentQ.options
                          .map(
                            (option) => `
                            <label class="flex items-center text-gray-700 cursor-pointer bg-white p-3 rounded-lg border border-gray-200 hover:bg-gray-100 transition duration-200 shadow-sm">
                                <input
                                    type="radio"
                                    name="${currentQ.id}"
                                    value="${option.charAt(0)}"
                                    ${
                                      listeningTestState.answers[
                                        currentQ.id
                                      ] === option.charAt(0)
                                        ? "checked"
                                        : ""
                                    }
                                    class="form-radio h-5 w-5 text-blue-600 rounded-full border-gray-300 focus:ring-blue-500 cursor-pointer"
                                />
                                <span class="ml-4 text-lg">${option}</span>
                            </label>
                        `
                          )
                          .join("")}
                    </div>
                `;
        } else if (currentQ.type === "fill-in-the-blank") {
          questionInputHtml = `
                    <input
                        type="text"
                        name="${currentQ.id}"
                        value="${listeningTestState.answers[currentQ.id] || ""}"
                        placeholder="Type your answer here..."
                        class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-3 focus:ring-blue-400 transition duration-300 text-gray-800 text-lg shadow-sm"
                    />
                `;
        } else if (currentQ.type === "matching") {
          questionInputHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <p class="font-bold text-gray-700 mb-3 text-lg">Items:</p>
                            <ul class="space-y-2">
                                ${currentQ.items
                                  .map(
                                    (item) => `
                                    <li class="text-gray-700 bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                                        ${item.key}
                                    </li>
                                `
                                  )
                                  .join("")}
                            </ul>
                        </div>
                        <div>
                            <p class="font-bold text-gray-700 mb-3 text-lg">Match Options:</p>
                            ${currentQ.items
                              .map(
                                (item) => `
                                <div class="flex items-center mb-3">
                                    <span class="mr-3 text-gray-700 font-medium">${
                                      item.key.split(".")[0]
                                    }:</span>
                                    <select
                                        name="${currentQ.id}-${
                                  item.key.split(".")[0]
                                }"
                                        class="flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-3 focus:ring-blue-400 transition duration-300 text-gray-800 shadow-sm"
                                    >
                                        <option value="">Select an option</option>
                                        ${currentQ.options
                                          .map(
                                            (opt) => `
                                            <option value="${opt.charAt(0)}" ${
                                              listeningTestState.answers[
                                                `${currentQ.id}-${
                                                  item.key.split(".")[0]
                                                }`
                                              ] === opt.charAt(0)
                                                ? "selected"
                                                : ""
                                            }>${opt}</option>
                                        `
                                          )
                                          .join("")}
                                    </select>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `;
        } else if (currentQ.type === "short-answer") {
          questionInputHtml = `
                    <textarea
                        name="${currentQ.id}"
                        placeholder="Write your short answer here (max 3 words usually)..."
                        rows="3"
                        class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-3 focus:ring-blue-400 transition duration-300 text-gray-800 text-lg shadow-sm resize-y"
                    >${listeningTestState.answers[currentQ.id] || ""}</textarea>
                `;
        }

        questionAreaDiv.innerHTML = `
                <div class="mb-8 bg-blue-50 p-5 rounded-xl border border-blue-200 shadow-inner animate-fade-in">
                    <p class="text-blue-800 text-lg font-semibold leading-relaxed">
                        <span class="font-bold text-blue-900 mr-2">Audio Prompt:</span> ${currentQ.audioPrompt}
                    </p>
                </div>

                <div class="mb-10 p-6 bg-gray-50 rounded-xl border border-gray-100 shadow-inner animate-fade-in">
                    <h3 class="text-2xl font-bold text-gray-800 mb-5">${currentQ.questionText}</h3>
                    ${questionInputHtml}
                </div>
            `;

        // Update Previous/Next/Submit button states
        const prevBtn = document.getElementById("previous-listening-btn");
        if (prevBtn) {
          prevBtn.disabled = listeningTestState.currentQuestion === 0;
          prevBtn.classList.toggle(
            "opacity-50",
            listeningTestState.currentQuestion === 0
          );
          prevBtn.classList.toggle(
            "cursor-not-allowed",
            listeningTestState.currentQuestion === 0
          );
        }

        const nextOrSubmitBtn = document.getElementById(
          "next-or-submit-listening-btn"
        );
        if (nextOrSubmitBtn) {
          if (
            listeningTestState.currentQuestion <
            listeningTestState.questions.length - 1
          ) {
            nextOrSubmitBtn.innerHTML = `Next Question &rarr;`;
            nextOrSubmitBtn.className =
              "bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105";
            nextOrSubmitBtn.onclick = handleNextListeningQuestion;
          } else {
            nextOrSubmitBtn.innerHTML = `Submit Listening`;
            nextOrSubmitBtn.className =
              "bg-gradient-to-r from-purple-600 to-pink-700 hover:from-purple-700 hover:to-pink-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105";
            nextOrSubmitBtn.onclick = handleFinishListeningTest;
          }
        }

        // Re-attach input change listeners after content is updated
        const inputs = questionAreaDiv.querySelectorAll(
          'input[name^="L"], textarea[name^="L"], select[name^="L"]'
        );
        inputs.forEach((input) => {
          input.onchange = handleListeningInputChange;
          if (input.tagName === "TEXTAREA" || input.type === "text") {
            input.oninput = handleListeningInputChange; // For immediate updates on text fields
          }
        });
      }

      // Reading Test State & Functions
      let readingTestState = {
        currentPassage: 0,
        answers: {}, // Stores user answers for current test session
        timeRemaining: 60 * 60, // 60 minutes in seconds
        timerInterval: null,
        isLoadingFeedback: false,
        readingFeedback: null,
        passages: [
          {
            id: "R1",
            title: "The Impact of Artificial Intelligence on Modern Society",
            text: `Artificial intelligence (AI) is rapidly transforming various aspects of modern society, from healthcare and education to transportation and entertainment. Its ability to process vast amounts of data and identify complex patterns has led to significant advancements, promising a future where tasks are automated, decisions are data-driven, and human capabilities are augmented. However, alongside these promising developments, AI also presents a range of challenges that require careful consideration.

One of the primary impacts of AI is its potential to revolutionize industries by automating repetitive and dangerous tasks. In manufacturing, AI-powered robots are increasing efficiency and precision, while in logistics, AI algorithms optimize delivery routes and manage inventory. This automation can lead to increased productivity and economic growth, but it also raises concerns about job displacement and the need for workforce retraining. Societies must adapt to these shifts by investing in education and developing new roles that leverage human creativity and critical thinking skills.

Furthermore, AI's application in data analysis has profound implications for decision-making. Machine learning models can analyze medical images to detect diseases earlier, predict market trends with greater accuracy, and personalize educational experiences. The ethical implications of AI, particularly concerning data privacy, bias in algorithms, and accountability for AI-driven decisions, are paramount. Ensuring fairness, transparency, and human oversight in AI systems is crucial to building public trust and preventing unintended negative consequences.

The integration of AI into daily life also brings about changes in human interaction and communication. Virtual assistants and chatbots are becoming increasingly sophisticated, providing instant information and support. While these tools offer convenience, there is a discussion about the extent to which human connection might be diminished. Balancing the benefits of AI with the preservation of human values and interactions will be key to shaping a future where AI serves humanity effectively and ethically.`,
            questions: [
              {
                id: "R1Q1",
                type: "multiple-choice",
                questionText:
                  "1. What is one of the primary impacts of AI mentioned in the text?",
                options: [
                  "a) Its ability to diminish human connection.",
                  "b) Its potential to revolutionize industries by automating tasks.",
                  "c) Its contribution to increased job displacement only.",
                  "d) Its exclusive focus on entertainment applications.",
                ],
                correctAnswer: "b",
              },
              {
                id: "R1Q2",
                type: "true-false-not-given",
                statement:
                  "2. The text suggests that AI will lead to a complete disappearance of human jobs.",
                correctAnswer: "False",
              },
              {
                id: "R1Q3",
                type: "summary-completion",
                prompt: "3. Complete the summary below:",
                summaryText:
                  "AI is changing various sectors, offering increased efficiency and precision through automation. However, this raises concerns about job displacement, necessitating investments in ___________ and the development of new roles.",
                correctAnswer: "education",
              },
              {
                id: "R1Q4",
                type: "short-answer",
                questionText: "4. Name one ethical concern regarding AI.",
                correctAnswer: "data privacy",
              },
              {
                id: "R1Q5",
                type: "multiple-choice",
                questionText:
                  "5. Which sector is NOT mentioned as being transformed by AI?",
                options: [
                  "a) Healthcare",
                  "b) Agriculture",
                  "c) Transportation",
                  "d) Education",
                ],
                correctAnswer: "b",
              },
              {
                id: "R1Q6",
                type: "matching-headings",
                prompt: "6. Match the following headings to the paragraphs:",
                headings: [
                  "I. Ethical Considerations",
                  "II. Automation and Industry",
                  "III. AI in Daily Life",
                ],
                correctMapping: {
                  "Paragraph 2": "II",
                  "Paragraph 3": "I",
                  "Paragraph 4": "III",
                },
              },
              {
                id: "R1Q7",
                type: "fill-in-the-blank",
                prompt:
                  "7. AI algorithms are used in logistics to optimize __________ routes.",
                summaryText:
                  "AI algorithms are used in logistics to optimize __________ routes.",
                correctAnswer: "delivery",
              },
              {
                id: "R1Q8",
                type: "true-false-not-given",
                statement:
                  "8. Virtual assistants are still in the early stages of development.",
                correctAnswer: "False",
              },
              {
                id: "R1Q9",
                type: "short-answer",
                questionText:
                  "9. What is needed to ensure public trust in AI systems?",
                correctAnswer: "fairness and transparency",
              },
              {
                id: "R1Q10",
                type: "multiple-choice",
                questionText: "10. What is a long-term goal of AI integration?",
                options: [
                  "a) To completely replace humans",
                  "b) To augment human capabilities",
                  "c) To reduce economic growth",
                  "d) To eliminate human interaction",
                ],
                correctAnswer: "b",
              },
            ],
          },
          {
            id: "R2",
            title: "The History of the Olympic Games",
            text: `The Olympic Games, a grand international multi-sport event, trace their origins back to ancient Greece, where they were held every four years in Olympia. The first recorded Olympic Games took place in 776 BC, and they continued for nearly 12 centuries until Emperor Theodosius I abolished them in 393 AD, deeming them a pagan festival. These ancient games were primarily religious, dedicated to the god Zeus, and featured a range of athletic contests, including running, wrestling, and chariot racing. Winners were crowned with olive wreaths and hailed as heroes, bringing immense prestige to their hometowns.

The revival of the Olympic Games in their modern form is attributed to Pierre de Coubertin, a French educator and historian. Inspired by the ancient Greek ideals of physical and moral excellence, Coubertin proposed the revival of the Games at a congress in Paris in 1894. His vision was to create an international sporting event that would promote peace and understanding among nations through athletic competition. The International Olympic Committee (IOC) was established, and the first modern Olympic Games were held in Athens, Greece, in 1896.

Since their revival, the modern Olympic Games have grown exponentially, becoming the world's foremost sporting spectacle. They have faced numerous challenges, including political boycotts, financial difficulties, and the complexities of hosting a massive international event. However, the core principles of friendship, respect, and excellence continue to guide the movement. The Games now encompass both Summer and Winter editions, featuring thousands of athletes from almost every country in the world competing in a vast array of sports. The legacy of the Olympics extends beyond sport, influencing urban development, national identity, and global diplomacy.`,
            questions: [
              {
                id: "R2Q11",
                type: "matching-headings",
                prompt: "11. Match the following headings to the paragraphs:",
                headings: [
                  "I. The Ancient Origins",
                  "II. Modern Revival and Growth",
                  "III. Olympic Legacy Beyond Sport",
                ],
                correctMapping: {
                  "Paragraph 1": "I",
                  "Paragraph 2": "II",
                  "Paragraph 3": "III",
                },
              },
              {
                id: "R2Q12",
                type: "short-answer",
                questionText:
                  "12. Who is credited with the revival of the modern Olympic Games?",
                correctAnswer: "Pierre de Coubertin",
              },
              {
                id: "R2Q13",
                type: "multiple-choice",
                questionText:
                  "13. When were the first recorded ancient Olympic Games held?",
                options: ["a) 393 AD", "b) 1896", "c) 776 BC", "d) 1894"],
                correctAnswer: "c",
              },
              {
                id: "R2Q14",
                type: "true-false-not-given",
                statement:
                  "14. The ancient Olympics were abolished due to financial difficulties.",
                correctAnswer: "False",
              },
              {
                id: "R2Q15",
                type: "fill-in-the-blank",
                prompt:
                  "15. Ancient Olympic winners were crowned with __________ wreaths.",
                summaryText:
                  "Ancient Olympic winners were crowned with __________ wreaths.",
                correctAnswer: "olive",
              },
              {
                id: "R2Q16",
                type: "short-answer",
                questionText:
                  "16. What was the main purpose of Coubertin's vision for the modern Games?",
                correctAnswer: "promote peace and understanding",
              },
              {
                id: "R2Q17",
                type: "multiple-choice",
                questionText:
                  "17. Which city hosted the first modern Olympic Games?",
                options: ["a) Paris", "b) Olympia", "c) Athens", "d) London"],
                correctAnswer: "c",
              },
              {
                id: "R2Q18",
                type: "true-false-not-given",
                statement:
                  "18. The modern Olympics have never faced political challenges.",
                correctAnswer: "False",
              },
              {
                id: "R2Q19",
                type: "fill-in-the-blank",
                prompt:
                  "19. The Games now include both Summer and __________ editions.",
                summaryText:
                  "The Games now include both Summer and __________ editions.",
                correctAnswer: "Winter",
              },
              {
                id: "R2Q20",
                type: "short-answer",
                questionText:
                  "20. Name one area outside of sport influenced by the Olympics.",
                correctAnswer: "urban development",
              },
            ],
          },
          {
            id: "R3",
            title: "The Benefits of Bilingualism",
            text: `Bilingualism, the ability to speak two languages, is increasingly common around the world and offers a wide array of cognitive, social, and economic benefits. Far from hindering development, as was once believed, research now indicates that being bilingual can actually enhance cognitive functions, providing a mental edge over monolingual individuals.

One significant cognitive advantage is improved executive function. This includes better problem-solving skills, enhanced multitasking abilities, and greater cognitive flexibility. Bilingual individuals constantly switch between two language systems, a mental exercise that strengthens their brain's ability to manage attention, ignore distractions, and move between different tasks. Studies have also shown that bilingualism can delay the onset of age-related cognitive decline, such as dementia, by several years.

Beyond cognitive benefits, bilingualism fosters a deeper understanding of different cultures. Language is intimately connected with culture, and learning a new language opens a window into new perspectives, traditions, and ways of thinking. This cultural sensitivity and empathy are invaluable in an increasingly globalized world, leading to more successful cross-cultural communication and relationships.

Economically, bilingual individuals often have a competitive edge in the job market. Many international companies seek employees who can communicate effectively with diverse clients and partners. Proficiency in multiple languages can lead to better job opportunities, higher salaries, and greater career mobility in various fields, from international business and diplomacy to tourism and education. Therefore, embracing bilingualism is not just about communication; it's about unlocking a richer life and broader opportunities.`,
            questions: [
              {
                id: "R3Q21",
                type: "multiple-choice",
                questionText:
                  "21. What was a past misconception about bilingualism?",
                options: [
                  "a) It enhances social skills.",
                  "b) It delays cognitive decline.",
                  "c) It hinders development.",
                  "d) It improves economic prospects.",
                ],
                correctAnswer: "c",
              },
              {
                id: "R3Q22",
                type: "fill-in-the-blank",
                prompt: "22. Bilingualism can improve __________ functions.",
                summaryText: "Bilingualism can improve __________ functions.",
                correctAnswer: "cognitive",
              },
              {
                id: "R3Q23",
                type: "short-answer",
                questionText:
                  "23. Name one component of improved executive function.",
                correctAnswer: "problem-solving skills",
              },
              {
                id: "R3Q24",
                type: "true-false-not-given",
                statement:
                  "24. Bilingual individuals rarely switch between their two languages.",
                correctAnswer: "False",
              },
              {
                id: "R3Q25",
                type: "matching-headings",
                prompt: "25. Match the following headings to the paragraphs:",
                headings: [
                  "I. Cognitive Advantages",
                  "II. Cultural Insights",
                  "III. Economic Opportunities",
                ],
                correctMapping: {
                  "Paragraph 2": "I",
                  "Paragraph 3": "II",
                  "Paragraph 4": "III",
                },
              },
              {
                id: "R3Q26",
                type: "multiple-choice",
                questionText:
                  "26. What does the text suggest about the connection between language and culture?",
                options: [
                  "a) They are unrelated.",
                  "b) Language hinders cultural understanding.",
                  "c) They are intimately connected.",
                  "d) Culture replaces language learning.",
                ],
                correctAnswer: "c",
              },
              {
                id: "R3Q27",
                type: "fill-in-the-blank",
                prompt:
                  "27. Learning a new language opens a window into new __________.",
                summaryText:
                  "Learning a new language opens a window into new __________.",
                correctAnswer: "perspectives",
              },
              {
                id: "R3Q28",
                type: "short-answer",
                questionText:
                  "28. What type of decline can bilingualism delay?",
                correctAnswer: "age-related cognitive decline",
              },
              {
                id: "R3Q29",
                type: "true-false-not-given",
                statement:
                  "29. All international companies require employees to be bilingual.",
                correctAnswer: "Not Given",
              },
              {
                id: "R3Q30",
                type: "multiple-choice",
                questionText:
                  "30. Which job sector is specifically mentioned as benefiting from bilingualism?",
                options: [
                  "a) Manufacturing",
                  "b) Construction",
                  "c) Diplomacy",
                  "d) Retail",
                ],
                correctAnswer: "c",
              },
            ],
          },
          {
            id: "R4",
            title: "The Evolution of Communication",
            text: `Communication has undergone a remarkable evolution throughout human history, transforming from rudimentary gestures and sounds to complex digital interactions. Each technological leap has dramatically reshaped how individuals connect, share information, and organize societies. Understanding this progression is key to appreciating our current communicative landscape.

Early forms of communication were primarily oral, relying on spoken language and storytelling to transmit knowledge across generations. The invention of writing systems, dating back to ancient Mesopotamia around 3500 BC, marked a pivotal shift. It allowed for the preservation of information beyond human memory and made possible the spread of ideas over vast distances and time, laying the groundwork for complex civilizations and organized record-keeping.

The advent of the printing press in the 15th century by Johannes Gutenberg revolutionized the dissemination of information. Books and pamphlets could be mass-produced, leading to increased literacy rates and the widespread exchange of ideas during the Renaissance and the Scientific Revolution. This era fostered critical thinking and decentralized knowledge, moving it from the exclusive domain of scribes and clergy to a broader populace.

The 19th and 20th centuries witnessed an explosion of electrical communication technologies: the telegraph, telephone, radio, and television. These innovations dramatically reduced the time and distance barriers, enabling near-instantaneous global communication. The late 20th century then ushered in the digital age with the internet and mobile technologies, creating an interconnected world where information is accessible instantly and communication is pervasive, continually evolving with new platforms and tools.`,
            questions: [
              {
                id: "R4Q31",
                type: "multiple-choice",
                questionText:
                  "31. What was the primary mode of early communication?",
                options: [
                  "a) Writing",
                  "b) Gestures and sounds",
                  "c) Telegraph",
                  "d) Printing",
                ],
                correctAnswer: "b",
              },
              {
                id: "R4Q32",
                type: "fill-in-the-blank",
                prompt:
                  "32. The invention of writing systems allowed for the preservation of information beyond human __________.",
                summaryText:
                  "The invention of writing systems allowed for the preservation of information beyond human __________.",
                correctAnswer: "memory",
              },
              {
                id: "R4Q33",
                type: "short-answer",
                questionText:
                  "33. Which civilization is associated with early writing systems?",
                correctAnswer: "Mesopotamia",
              },
              {
                id: "R4Q34",
                type: "true-false-not-given",
                statement:
                  "34. The printing press was invented in the 16th century.",
                correctAnswer: "False",
              },
              {
                id: "R4Q35",
                type: "matching-headings",
                prompt: "35. Match the following headings to the paragraphs:",
                headings: [
                  "I. The Digital Age",
                  "II. Early Oral Tradition",
                  "III. The Printing Revolution",
                  "IV. Electrical Innovations",
                ],
                correctMapping: {
                  "Paragraph 1": "II",
                  "Paragraph 2": "III",
                  "Paragraph 3": "IV",
                  "Paragraph 4": "I",
                },
              },
              {
                id: "R4Q36",
                type: "multiple-choice",
                questionText:
                  "36. What was a key outcome of the printing press?",
                options: [
                  "a) Decreased literacy rates",
                  "b) Centralized knowledge",
                  "c) Widespread exchange of ideas",
                  "d) Limited information access",
                ],
                correctAnswer: "c",
              },
              {
                id: "R4Q37",
                type: "fill-in-the-blank",
                prompt:
                  "37. The telegraph and telephone dramatically reduced __________ barriers.",
                summaryText:
                  "The telegraph and telephone dramatically reduced __________ barriers.",
                correctAnswer: "distance",
              },
              {
                id: "R4Q38",
                type: "short-answer",
                questionText:
                  "38. Name one 20th-century communication technology.",
                correctAnswer: "radio",
              },
              {
                id: "R4Q39",
                type: "true-false-not-given",
                statement: "39. The internet was developed in the early 1900s.",
                correctAnswer: "False",
              },
              {
                id: "R4Q40",
                type: "multiple-choice",
                questionText:
                  "40. What characterizes communication in the digital age?",
                options: [
                  "a) Slow information spread",
                  "b) Limited accessibility",
                  "c) Instant access to information",
                  "d) Manual data transfer",
                ],
                correctAnswer: "c",
              },
            ],
          },
        ],
      };

      /**
       * Resets the reading test state. Called only when a new test is started.
       */
      function resetReadingTestState() {
        stopAllReadingTimers(); // Clear any existing timers
        readingTestState = {
          currentPassage: 0,
          answers: {},
          timeRemaining: 60 * 60,
          timerInterval: null,
          isLoadingFeedback: false,
          readingFeedback: null,
          passages: readingTestState.passages, // Keep passages static
        };
      }

      /**
       * Stops all active timers for the reading test.
       */
      function stopAllReadingTimers() {
        if (readingTestState.timerInterval) {
          clearInterval(readingTestState.timerInterval);
          readingTestState.timerInterval = null;
        }
      }

      /**
       * Starts the overall timer for the reading test.
       */
      function startReadingTimer() {
        if (readingTestState.timerInterval)
          clearInterval(readingTestState.timerInterval);
        readingTestState.timerInterval = setInterval(() => {
          readingTestState.timeRemaining--;
          if (readingTestState.timeRemaining <= 0) {
            clearInterval(readingTestState.timerInterval);
            handleFinishReadingTest();
          }
          updateReadingTimerDisplay();
        }, 1000);
      }

      /**
       * Updates the time display on the UI for reading test.
       */
      function updateReadingTimerDisplay() {
        const timerSpan = document.getElementById("reading-time-left");
        if (timerSpan) {
          timerSpan.textContent = formatTime(readingTestState.timeRemaining);
        }
      }

      /**
       * Handles changes in input fields for reading questions, saving answers to state.
       * @param {Event} e - The input change event.
       */
      function handleReadingInputChange(e) {
        const { name, value, type, checked } = e.target;
        // For radio buttons, only update if checked
        if (type === "radio") {
          if (checked) {
            readingTestState.answers[name] = value;
          }
        } else {
          readingTestState.answers[name] = value;
        }
      }

      /**
       * Navigates to the next passage in the reading test.
       */
      function handleNextReadingPassage() {
        if (
          readingTestState.currentPassage <
          readingTestState.passages.length - 1
        ) {
          readingTestState.currentPassage++;
          // Re-render the reading test content to show next passage and its questions
          renderReadingPassageAndQuestions(
            document.querySelector(".reading-content-area")
          );
          updateReadingNavigationButtons();
        } else {
          showMessageModal(
            "End of Reading Section",
            "You have completed all passages in the Reading section. Please submit your answers."
          );
        }
      }

      /**
       * Navigates to the previous passage in the reading test.
       */
      function handlePreviousReadingPassage() {
        if (readingTestState.currentPassage > 0) {
          readingTestState.currentPassage--;
          // Re-render the reading test content to show previous passage and its questions
          renderReadingPassageAndQuestions(
            document.querySelector(".reading-content-area")
          );
          updateReadingNavigationButtons();
        }
      }

      /**
       * Updates the state of the Previous/Next/Submit buttons for reading test.
       */
      function updateReadingNavigationButtons() {
        const prevBtn = document.getElementById("previous-reading-btn");
        if (prevBtn) {
          prevBtn.disabled = readingTestState.currentPassage === 0;
          prevBtn.classList.toggle(
            "opacity-50",
            readingTestState.currentPassage === 0
          );
          prevBtn.classList.toggle(
            "cursor-not-allowed",
            readingTestState.currentPassage === 0
          );
        }

        const nextOrSubmitBtn = document.getElementById(
          "next-or-submit-reading-btn"
        );
        if (nextOrSubmitBtn) {
          const isLastPassage =
            readingTestState.currentPassage ===
            readingTestState.passages.length - 1;
          if (!isLastPassage) {
            nextOrSubmitBtn.innerHTML = `Next Passage &rarr;`;
            nextOrSubmitBtn.className =
              "bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105";
            nextOrSubmitBtn.onclick = handleNextReadingPassage;
          } else {
            nextOrSubmitBtn.innerHTML = readingTestState.isLoadingFeedback
              ? getLoadingSpinnerHtml()
              : "Submit Reading";
            nextOrSubmitBtn.className =
              "bg-gradient-to-r from-purple-600 to-pink-700 hover:from-purple-700 hover:to-pink-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105 flex items-center justify-center";
            nextOrSubmitBtn.disabled = readingTestState.isLoadingFeedback;
            nextOrSubmitBtn.onclick = handleFinishReadingTest;
          }
        }
      }

      /**
       * Simulates AI grading for Reading test answers.
       * @param {Object} userAnswers - Object containing user's answers.
       * @param {Array} allPassages - Array of all reading passages and their questions.
       * @returns {Promise<Object>} A promise that resolves with grading feedback.
       */
      async function simulateReadingAIGrading(userAnswers, allPassages) {
        let correctCount = 0;
        let totalQuestions = 0;
        let feedbackDetails = [];

        const allQuestions = allPassages.flatMap(
          (passage) => passage.questions
        );

        allQuestions.forEach((q) => {
          totalQuestions++;
          const userAnswer = userAnswers[q.id]; // Attempt to get a direct answer

          let isCorrect = false;
          let actualUserAnswer = userAnswer || "No Answer"; // Default for feedback display

          if (
            q.type === "multiple-choice" ||
            q.type === "short-answer" ||
            q.type === "fill-in-the-blank" ||
            q.type === "true-false-not-given"
          ) {
            if (
              userAnswer &&
              String(userAnswer).toLowerCase().trim() ===
                String(q.correctAnswer).toLowerCase().trim()
            ) {
              isCorrect = true;
              correctCount++;
            }
          } else if (q.type === "matching" || q.type === "matching-headings") {
            let allMatchesCorrect = true;
            // For matching, the answers are stored as `q.id-ItemKey` (e.g., 'R1Q6-Paragraph2')
            const matchedPairs = {};
            for (const key in q.correctMapping) {
              const subQuestionId = `${q.id}-${key.replace(
                /[^a-zA-Z0-9]/g,
                ""
              )}`; // Sanitize key for ID
              const userMatch = userAnswers[subQuestionId];
              matchedPairs[key] = userMatch || "No Match";

              if (
                !userMatch ||
                String(userMatch).toLowerCase().trim() !==
                  String(q.correctMapping[key]).toLowerCase().trim()
              ) {
                allMatchesCorrect = false;
                break;
              }
            }
            actualUserAnswer = matchedPairs; // Store the collected matches for display
            if (allMatchesCorrect) {
              isCorrect = true;
              correctCount++;
            }
          }

          feedbackDetails.push({
            questionText: q.questionText,
            userAnswer: actualUserAnswer,
            correctAnswer: q.correctAnswer || q.correctMapping, // Display correct mapping for matching types
            isCorrect: isCorrect,
            type: q.type,
          });
        });

        const accuracyPercentage =
          totalQuestions > 0 ? (correctCount / totalQuestions) * 100 : 0;
        let estimatedBand;

        if (accuracyPercentage >= 90) estimatedBand = "Band 8.0 - 9.0";
        else if (accuracyPercentage >= 80) estimatedBand = "Band 7.0 - 7.5";
        else if (accuracyPercentage >= 70) estimatedBand = "Band 6.0 - 6.5";
        else if (accuracyPercentage >= 60) estimatedBand = "Band 5.0 - 5.5";
        else if (accuracyPercentage >= 50) estimatedBand = "Band 4.0 - 4.5";
        else estimatedBand = "Below Band 4.0";

        const generalPrompt = `Based on an IELTS Reading test where the user answered ${correctCount} out of ${totalQuestions} questions correctly (Accuracy: ${accuracyPercentage.toFixed(
          2
        )}%), provide general feedback for an IELTS Reading test. Focus on common strengths and weaknesses (e.g., detail scanning, understanding main ideas, vocabulary in context, speed reading). Suggest 3-5 actionable areas for improvement. Format as JSON with fields: 'overallPerformanceSummary', 'strengths', 'areasForImprovement', 'estimatedBand'.`;

        let chatHistory = [{ role: "user", parts: [{ text: generalPrompt }] }];
        const payload = {
          contents: chatHistory,
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
              type: "OBJECT",
              properties: {
                overallPerformanceSummary: { type: "STRING" },
                strengths: { type: "STRING" },
                areasForImprovement: { type: "STRING" },
                estimatedBand: { type: "STRING" },
              },
              propertyOrdering: [
                "overallPerformanceSummary",
                "strengths",
                "areasForImprovement",
                "estimatedBand",
              ],
            },
          },
        };
        const apiKey = ""; // Set to empty string for Canvas to inject API key
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const result = await response.json();
          let aiGeneratedFeedback = {};
          if (
            result.candidates &&
            result.candidates.length > 0 &&
            result.candidates[0].content &&
            result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0
          ) {
            aiGeneratedFeedback = JSON.parse(
              result.candidates[0].content.parts[0].text
            );
          }

          return {
            correctCount,
            totalQuestions,
            accuracyPercentage,
            estimatedBand: aiGeneratedFeedback.estimatedBand || estimatedBand,
            feedbackDetails,
            overallPerformanceSummary:
              aiGeneratedFeedback.overallPerformanceSummary || "N/A",
            strengths: aiGeneratedFeedback.strengths || "N/A",
            areasForImprovement:
              aiGeneratedFeedback.areasForImprovement || "N/A",
          };
        } catch (error) {
          console.error(
            "Error calling Gemini API for Reading feedback:",
            error
          );
          return {
            correctCount,
            totalQuestions,
            accuracyPercentage,
            estimatedBand,
            feedbackDetails,
            overallPerformanceSummary:
              "Could not generate detailed AI feedback due to an error.",
            strengths: "N/A",
            areasForImprovement: "Please check console for errors.",
          };
        }
      }

      /**
       * Handles the completion and submission of the reading test.
       */
      async function handleFinishReadingTest() {
        stopAllReadingTimers();
        readingTestState.isLoadingFeedback = true;
        readingTestState.readingFeedback = null; // Clear previous feedback
        updateReadingNavigationButtons(); // Update button to show loading spinner

        showMessageModal(
          "Submitting Reading Answers",
          "Your Reading answers are being processed for AI evaluation. This may take a moment."
        );

        try {
          const feedback = await simulateReadingAIGrading(
            readingTestState.answers,
            readingTestState.passages
          );
          readingTestState.readingFeedback = feedback;
          hideMessageModal(); // Hide the submission modal
          // Show a new modal for success or directly render feedback
          showMessageModal(
            "Reading Feedback Generated",
            "Your detailed AI-generated feedback and estimated band score are now available below."
          );
        } catch (error) {
          console.error("Error during Reading AI grading:", error);
          hideMessageModal();
          showMessageModal(
            "Grading Error",
            `There was an error generating feedback: ${error.message}. Please try again later.`
          );
        } finally {
          readingTestState.isLoadingFeedback = false;
          renderReadingFeedbackSection(
            document.querySelector("#reading-feedback-section")
          ); // Re-render feedback section
          updateReadingNavigationButtons(); // Re-enable button
        }
      }

      /**
       * Renders the main Reading Test UI structure.
       * @param {HTMLElement} parentDiv - The div to render the test into.
       */
      function renderReadingTest(parentDiv) {
        // Initial setup for the entire Reading Test container
        const readingTestContainerHtml = `
                <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100 w-full max-w-6xl mx-auto my-8 animate-fade-in-up">
                    <h2 class="text-4xl font-extrabold text-blue-800 mb-4 text-center tracking-tight">Reading Test</h2>
                    <p class="text-xl text-gray-700 mb-8 text-center font-medium">${selectedTestTitle}</p>

                    <div class="flex justify-between items-center mb-6 pb-4 border-b-2 border-gray-100">
                        <div class="text-lg font-semibold text-gray-700 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 102 0V6zm-3.707 5.707a1 1 0 001.414-1.414L9 8.586V7a1 1 0 10-2 0v2a1 1 0 00.293.707l3 3z" clip-rule="evenodd"></path></svg>
                            Time Left: <span class="text-red-600 ml-1" id="reading-time-left">${formatTime(
                              readingTestState.timeRemaining
                            )}</span>
                        </div>
                        <div class="text-lg font-semibold text-gray-700">
                            Passage <span class="font-bold text-gray-800" id="current-passage-number">${
                              readingTestState.currentPassage + 1
                            }</span> of <span class="font-bold text-gray-800">${
          readingTestState.passages.length
        }</span>
                        </div>
                    </div>

                    <div class="reading-content-area grid md:grid-cols-2 gap-8">
                        <!-- Passage and Questions will be rendered here dynamically -->
                    </div>

                    <div class="flex justify-between mt-10">
                        <button id="previous-reading-btn"
                            class="bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-xl hover:bg-gray-400 transition duration-300 shadow-md hover:shadow-lg transform hover:scale-105"
                        >
                            ${ChevronLeftIcon.replace(
                              /width="24" height="24"/g,
                              'width="24" height="24" class="inline-block mr-2"'
                            )} Previous
                        </button>
                        <button id="next-or-submit-reading-btn"
                            class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105"
                        ></button>
                    </div>

                    <div id="reading-feedback-section"></div>
                </div>
            `;
        parentDiv.innerHTML = readingTestContainerHtml;

        startReadingTimer(); // Start the overall test timer

        // Attach core event listeners to buttons
        document.getElementById(
          "previous-reading-btn"
        ).onclick = handlePreviousReadingPassage;

        // Initial render of the first passage and its questions
        renderReadingPassageAndQuestions(
          document.querySelector(".reading-content-area")
        );
        updateReadingNavigationButtons();
        renderReadingFeedbackSection(
          document.querySelector("#reading-feedback-section")
        ); // Ensure feedback section is rendered if already present
      }

      /**
       * Renders the current reading passage and its associated questions.
       * This function is called on initial load and when navigating between passages.
       * @param {HTMLElement} contentAreaDiv - The div holding the passage and questions.
       */
      function renderReadingPassageAndQuestions(contentAreaDiv) {
        const currentP =
          readingTestState.passages[readingTestState.currentPassage];

        let questionsHtml = currentP.questions
          .map((q, qIndex) => {
            let questionInputHtml = "";
            if (q.type === "multiple-choice") {
              questionInputHtml = `
                        <div class="space-y-3">
                            ${q.options
                              .map(
                                (option) => `
                                <label class="flex items-center text-gray-700 cursor-pointer bg-white p-3 rounded-lg border border-gray-200 hover:bg-gray-100 transition duration-200 shadow-sm">
                                    <input
                                        type="radio"
                                        name="${q.id}"
                                        value="${option.charAt(0)}"
                                        ${
                                          readingTestState.answers[q.id] ===
                                          option.charAt(0)
                                            ? "checked"
                                            : ""
                                        }
                                        class="form-radio h-5 w-5 text-blue-600 rounded-full border-gray-300 focus:ring-blue-500 cursor-pointer"
                                    />
                                    <span class="ml-4 text-lg">${option}</span>
                                </label>
                            `
                              )
                              .join("")}
                        </div>
                    `;
            } else if (q.type === "true-false-not-given") {
              questionInputHtml = `
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <p class="font-semibold text-gray-700 mb-3 text-lg">Statement: "${
                              q.statement
                            }"</p>
                            <div class="flex space-x-6">
                                <label class="inline-flex items-center text-gray-700 cursor-pointer">
                                    <input type="radio" name="${
                                      q.id
                                    }" value="True" ${
                readingTestState.answers[q.id] === "True" ? "checked" : ""
              }
                                        class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500 cursor-pointer" />
                                    <span class="ml-2 text-lg">True</span>
                                </label>
                                <label class="inline-flex items-center text-gray-700 cursor-pointer">
                                    <input type="radio" name="${
                                      q.id
                                    }" value="False" ${
                readingTestState.answers[q.id] === "False" ? "checked" : ""
              }
                                        class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500 cursor-pointer" />
                                    <span class="ml-2 text-lg">False</span>
                                </label>
                                <label class="inline-flex items-center text-gray-700 cursor-pointer">
                                    <input type="radio" name="${
                                      q.id
                                    }" value="Not Given" ${
                readingTestState.answers[q.id] === "Not Given" ? "checked" : ""
              }
                                        class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500 cursor-pointer" />
                                    <span class="ml-2 text-lg">Not Given</span>
                                </label>
                            </div>
                        </div>
                    `;
            } else if (q.type === "summary-completion") {
              questionInputHtml = `
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <p class="italic text-gray-600 mb-3 text-lg">${
                              q.prompt
                            }</p>
                            <p class="bg-gray-100 p-3 rounded-lg border border-gray-200 mb-3 text-gray-700 leading-relaxed text-lg font-medium">${q.summaryText.replace(
                              "___________",
                              "_____"
                            )}</p>
                            <input
                                type="text"
                                name="${q.id}"
                                value="${readingTestState.answers[q.id] || ""}"
                                placeholder="Enter missing word(s)..."
                                class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-3 focus:ring-blue-400 transition duration-300 text-gray-800 text-lg shadow-sm"
                            />
                        </div>
                    `;
            } else if (q.type === "matching-headings") {
              questionInputHtml = `
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <p class="italic text-gray-600 mb-3 text-lg">${
                              q.prompt
                            }</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="font-bold text-gray-700 mb-3 text-lg">Headings:</p>
                                    <ul class="space-y-1">
                                        ${q.headings
                                          .map(
                                            (heading) => `
                                            <li class="text-gray-700 text-base py-1">${heading}</li>
                                        `
                                          )
                                          .join("")}
                                    </ul>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-700 mb-3 text-lg">Match to Paragraph:</p>
                                    ${Object.keys(q.correctMapping)
                                      .map(
                                        (paraKey) => `
                                        <div class="flex items-center mb-3">
                                            <span class="mr-3 text-gray-700 font-medium">${paraKey}:</span>
                                            <select
                                                name="${q.id}-${paraKey.replace(
                                          /[^a-zA-Z0-9]/g,
                                          ""
                                        )}"
                                                class="flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-3 focus:ring-blue-400 transition duration-300 text-gray-800 shadow-sm"
                                            >
                                                <option value="">Select a heading</option>
                                                ${q.headings
                                                  .map(
                                                    (heading) => `
                                                    <option value="${
                                                      heading.split(".")[0]
                                                    }" ${
                                                      readingTestState.answers[
                                                        `${
                                                          q.id
                                                        }-${paraKey.replace(
                                                          /[^a-zA-Z0-9]/g,
                                                          ""
                                                        )}`
                                                      ] ===
                                                      heading.split(".")[0]
                                                        ? "selected"
                                                        : ""
                                                    }>${heading}</option>
                                                `
                                                  )
                                                  .join("")}
                                            </select>
                                        </div>
                                    `
                                      )
                                      .join("")}
                                </div>
                            </div>
                        </div>
                    `;
            } else if (q.type === "short-answer") {
              questionInputHtml = `
                        <textarea
                            name="${q.id}"
                            placeholder="Write your short answer here..."
                            rows="3"
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-3 focus:ring-blue-400 transition duration-300 text-gray-800 text-lg shadow-sm resize-y"
                        >${readingTestState.answers[q.id] || ""}</textarea>
                    `;
            }
            return `
                    <div class="mb-8 pb-6 border-b border-gray-200 last:border-b-0 animate-fade-in">
                        <p class="text-lg font-semibold text-gray-800 mb-4">${q.questionText}</p>
                        ${questionInputHtml}
                    </div>
                `;
          })
          .join("");

        contentAreaDiv.innerHTML = `
                <div class="bg-blue-50 p-6 rounded-2xl overflow-y-auto max-h-[70vh] shadow-inner border border-blue-200 animate-fade-in">
                    <h3 class="text-2xl font-bold text-blue-800 mb-5">${
                      currentP.title
                    }</h3>
                    ${currentP.text
                      .split("\n\n")
                      .map(
                        (paragraph) =>
                          `<p class="text-gray-700 mb-4 leading-relaxed text-lg">${paragraph}</p>`
                      )
                      .join("")}
                </div>
                <div class="bg-gray-50 p-6 rounded-2xl overflow-y-auto max-h-[70vh] shadow-inner border border-gray-100 animate-fade-in">
                    <h3 class="text-2xl font-bold text-gray-800 mb-5">Questions for Passage ${
                      readingTestState.currentPassage + 1
                    }</h3>
                    ${questionsHtml}
                </div>
            `;

        // Update passage number display
        const currentPassageNumSpan = document.getElementById(
          "current-passage-number"
        );
        if (currentPassageNumSpan) {
          currentPassageNumSpan.textContent =
            readingTestState.currentPassage + 1;
        }

        // Re-attach input change listeners after content is updated
        const inputs = contentAreaDiv.querySelectorAll(
          'input[name^="R"], textarea[name^="R"], select[name^="R"]'
        );
        inputs.forEach((input) => {
          input.onchange = handleReadingInputChange;
          if (input.tagName === "TEXTAREA" || input.type === "text") {
            input.oninput = handleReadingInputChange; // For immediate updates on text fields
          }
        });
      }

      /**
       * Renders the AI Reading Feedback section.
       * @param {HTMLElement} feedbackSectionDiv - The div to render feedback into.
       */
      function renderReadingFeedbackSection(feedbackSectionDiv) {
        if (!readingTestState.readingFeedback) {
          feedbackSectionDiv.innerHTML = ""; // Clear if no feedback
          return;
        }

        let individualFeedbacksHtml = readingTestState.readingFeedback.feedbackDetails
          .map((detail, idx) => {
            let correctAnswerDisplay = "";
            let userAnswerDisplay = "";

            if (
              typeof detail.correctAnswer === "object" &&
              detail.correctAnswer !== null
            ) {
              // For matching types, format object into readable key-value pairs
              correctAnswerDisplay = Object.entries(detail.correctAnswer)
                .map(([key, value]) => `${key}: ${value}`)
                .join(", ");
            } else {
              correctAnswerDisplay = detail.correctAnswer;
            }

            if (
              typeof detail.userAnswer === "object" &&
              detail.userAnswer !== null
            ) {
              userAnswerDisplay = Object.entries(detail.userAnswer)
                .map(([key, value]) => `${key}: ${value}`)
                .join(", ");
            } else {
              userAnswerDisplay = detail.userAnswer;
            }

            return `
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm animate-fade-in">
                        <p class="text-lg font-semibold text-gray-800 mb-2">Question ${
                          idx + 1
                        }: ${detail.questionText}</p>
                        <p class="text-gray-700">Your Answer: <span class="font-medium ${
                          detail.isCorrect ? "text-green-600" : "text-red-600"
                        }">${userAnswerDisplay}</span></p>
                        <p class="text-gray-700">Correct Answer: <span class="font-medium text-green-600">${correctAnswerDisplay}</span></p>
                        <p class="font-bold mt-2 ${
                          detail.isCorrect ? "text-green-700" : "text-red-700"
                        }">Status: ${
              detail.isCorrect ? "Correct" : "Incorrect"
            }</p>
                    </div>
                `;
          })
          .join("");

        const readingFeedbackHtml = `
                <div class="mt-16 bg-green-50 p-8 rounded-3xl shadow-xl border border-green-200 animate-fade-in">
                    <h3 class="text-3xl font-extrabold text-green-800 mb-6 text-center tracking-tight">AI Reading Feedback</h3>
                    <p class="text-center text-2xl font-bold text-green-700 mb-4">Your Score: <span class="bg-green-200 px-4 py-2 rounded-lg">${
                      readingTestState.readingFeedback.correctCount
                    } / ${
          readingTestState.readingFeedback.totalQuestions
        }</span> (Accuracy: ${readingTestState.readingFeedback.accuracyPercentage.toFixed(
          2
        )}%)</p>
                    <p class="text-center text-2xl font-bold text-green-700 mb-8">Estimated Overall Band: <span class="bg-green-200 px-4 py-2 rounded-lg">${
                      readingTestState.readingFeedback.estimatedBand
                    }</span></p>

                    <div class="mb-8 p-6 bg-white rounded-2xl shadow-md border border-gray-100">
                        <h4 class="text-xl font-bold text-gray-800 mb-3 flex items-center">${FileTextIcon.replace(
                          /width="24" height="24"/g,
                          'width="20" height="20" class="w-5 h-5 mr-2 text-blue-500"'
                        )} Overall Performance Summary:</h4>
                        <p class="text-gray-700 leading-relaxed text-lg whitespace-pre-wrap">${
                          readingTestState.readingFeedback
                            .overallPerformanceSummary
                        }</p>
                    </div>

                    <div class="mb-8 p-6 bg-white rounded-2xl shadow-md border border-gray-100">
                        <h4 class="text-xl font-bold text-gray-800 mb-3 flex items-center">${ActivityIcon.replace(
                          /width="24" height="24"/g,
                          'width="20" height="20" class="w-5 h-5 mr-2 text-blue-500"'
                        )} Strengths:</h4>
                        <p class="text-gray-700 leading-relaxed text-lg whitespace-pre-wrap">${
                          readingTestState.readingFeedback.strengths
                        }</p>
                    </div>

                    <div class="p-6 bg-white rounded-2xl shadow-md border border-gray-100">
                        <h4 class="text-xl font-bold text-gray-800 mb-3 flex items-center">${LightbulbIcon.replace(
                          /width="24" height="24"/g,
                          'width="20" height="20" class="w-5 h-5 mr-2 text-blue-500"'
                        )} Areas for Improvement:</h4>
                        <p class="text-gray-700 leading-relaxed text-lg whitespace-pre-wrap">${
                          readingTestState.readingFeedback.areasForImprovement
                        }</p>
                    </div>

                    <div class="mt-10 p-6 bg-yellow-50 rounded-2xl border border-yellow-200 shadow-inner">
                        <h4 class="text-xl font-bold text-yellow-800 mb-4">Detailed Question-by-Question Review:</h4>
                        <div class="space-y-4">
                            ${individualFeedbacksHtml}
                        </div>
                    </div>

                    <div class="flex justify-center mt-10">
                        <button id="reading-feedback-back-to-modules-btn"
                            class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105"
                        >
                            Back to Module Tests
                        </button>
                    </div>
                </div>
            `;
        feedbackSectionDiv.innerHTML = readingFeedbackHtml; // Corrected variable name here
        document.getElementById(
          "reading-feedback-back-to-modules-btn"
        ).onclick = () => setAppState("module-test-selection", selectedModule);
      }

      // Writing Test State & Functions
      let writingTestState = {
        task1Answer: "",
        task2Answer: "",
        task1WordCount: 0,
        task2WordCount: 0,
        timeRemaining: 60 * 60, // 60 minutes in seconds
        timerInterval: null,
        isLoadingFeedback: false,
        feedback: null,
      };

      /**
       * Resets the writing test state. Called only when a new test is started.
       */
      function resetWritingTestState() {
        stopAllWritingTimers(); // Clear any existing timers
        writingTestState = {
          task1Answer: "",
          task2Answer: "",
          task1WordCount: 0,
          task2WordCount: 0,
          timeRemaining: 60 * 60,
          timerInterval: null,
          isLoadingFeedback: false,
          feedback: null,
        };
      }

      /**
       * Stops all active timers for the writing test.
       */
      function stopAllWritingTimers() {
        if (writingTestState.timerInterval) {
          clearInterval(writingTestState.timerInterval);
          writingTestState.timerInterval = null;
        }
      }

      /**
       * Starts the overall timer for the writing test.
       */
      function startWritingTimer() {
        if (writingTestState.timerInterval)
          clearInterval(writingTestState.timerInterval);
        writingTestState.timerInterval = setInterval(() => {
          writingTestState.timeRemaining--;
          if (writingTestState.timeRemaining <= 0) {
            clearInterval(writingTestState.timerInterval);
            handleFinishWritingTest();
          }
          updateWritingUI(); // Update UI every second
        }, 1000);
      }

      /**
       * Updates the time and word count displays on the UI for writing test.
       * This function should be called frequently (e.g., every second by timer, on input change).
       */
      function updateWritingUI() {
        const timerSpan = document.getElementById("writing-time-left");
        if (timerSpan) {
          timerSpan.textContent = formatTime(writingTestState.timeRemaining);
        }
        const task1CountSpan = document.getElementById(
          "task1-current-word-count"
        ); // Corrected ID
        if (task1CountSpan) {
          task1CountSpan.textContent = writingTestState.task1WordCount;
          task1CountSpan.className =
            writingTestState.task1WordCount < 150
              ? "text-red-500 font-bold"
              : "text-green-600 font-bold";
        }
        const task2CountSpan = document.getElementById(
          "task2-current-word-count"
        ); // Corrected ID
        if (task2CountSpan) {
          task2CountSpan.textContent = writingTestState.task2WordCount;
          task2CountSpan.className =
            writingTestState.task2WordCount < 250
              ? "text-red-500"
              : "text-green-600"; /* Fixed: keep font-bold */
          task2CountSpan.classList.add(
            "font-bold"
          ); /* Add font-bold class here */
        }
        // Update submit button state
        const submitBtn = document.getElementById("get-writing-feedback-btn");
        if (submitBtn) {
          submitBtn.disabled = writingTestState.isLoadingFeedback;
          submitBtn.innerHTML = writingTestState.isLoadingFeedback
            ? getLoadingSpinnerHtml()
            : `${ActivityIcon.replace(
                /width="24" height="24"/g,
                'width="24" height="24" class="w-6 h-6 mr-3"'
              )} Get AI Writing Feedback`;
        }
      }

      /**
       * Calculates the word count for a given text.
       * @param {string} text - The input text.
       * @returns {number} The word count.
       */
      function calculateWordCount(text) {
        const words = text.trim().split(/\s+/);
        return words.filter((word) => word !== "").length;
      }

      /**
       * Handles input change for Task 1, updating its answer and word count in state.
       * @param {Event} e - The input event.
       */
      function handleTask1Change(e) {
        const text = e.target.value;
        writingTestState.task1Answer = text;
        writingTestState.task1WordCount = calculateWordCount(text);
        updateWritingUI(); // Update word count display
      }

      /**
       * Handles input change for Task 2, updating its answer and word count in state.
       * @param {Event} e - The input event.
       */
      function handleTask2Change(e) {
        const text = e.target.value;
        writingTestState.task2Answer = text;
        writingTestState.task2WordCount = calculateWordCount(text);
        updateWritingUI(); // Update word count display
      }

      /**
       * Calls the Gemini API to simulate AI grading for writing tasks.
       * @param {string} task1 - The user's Task 1 response.
       * @param {string} task2 - The user's Task 2 response.
       * @returns {Promise<Object>} A promise that resolves with the AI feedback.
       */
      async function simulateAIGrading(task1, task2) {
        const prompt = `Evaluate the following IELTS Writing Task 1 and Task 2 responses. Provide a detailed band score estimation (e.g., Band 6.5) and specific feedback based on IELTS criteria (Task Achievement/Response, Coherence & Cohesion, Lexical Resource, Grammatical Range & Accuracy). Highlight strengths and areas for improvement for each task.

Task 1 Response:
"${task1}"

Task 2 Response:
"${task2}"

Provide the response in a structured JSON format with fields: 'task1Feedback', 'task2Feedback', 'overallEstimatedBand', 'suggestionsForImprovement'.`;

        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        const payload = {
          contents: chatHistory,
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
              type: "OBJECT",
              properties: {
                task1Feedback: { type: "STRING" },
                task2Feedback: { type: "STRING" },
                overallEstimatedBand: { type: "STRING" },
                suggestionsForImprovement: { type: "STRING" },
              },
              propertyOrdering: [
                "task1Feedback",
                "task2Feedback",
                "overallEstimatedBand",
                "suggestionsForImprovement",
              ],
            },
          },
        };
        const apiKey = ""; // Canvas will inject API key at runtime
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        console.log("Calling Gemini API for writing feedback...");
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const result = await response.json();
        console.log("Gemini API response:", result);

        if (
          result.candidates &&
          result.candidates.length > 0 &&
          result.candidates[0].content &&
          result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0
        ) {
          const jsonString = result.candidates[0].content.parts[0].text;
          try {
            return JSON.parse(jsonString);
          } catch (parseError) {
            console.error(
              "Failed to parse AI response JSON:",
              parseError,
              jsonString
            );
            throw new Error(
              "Invalid AI response format. Raw response: " + jsonString
            );
          }
        } else {
          throw new Error("No valid AI response received from Gemini API.");
        }
      }

      /**
       * Handles the submission of the writing test for AI feedback.
       */
      async function handleFinishWritingTest() {
        clearInterval(writingTestState.timerInterval);
        writingTestState.isLoadingFeedback = true;
        writingTestState.feedback = null; // Clear previous feedback
        updateWritingUI(); // Update UI to show loading state

        showMessageModal(
          "Submitting Writing Responses",
          "Your writing is being sent for advanced AI evaluation. This may take a moment."
        );

        try {
          const feedback = await simulateAIGrading(
            writingTestState.task1Answer,
            writingTestState.task2Answer
          );
          writingTestState.feedback = feedback;
          hideMessageModal(); // Hide the submission modal
          showMessageModal(
            "AI Feedback Generated",
            "Your detailed AI-generated feedback and estimated band score are now available below."
          );
        } catch (error) {
          console.error("Error during AI grading:", error);
          hideMessageModal();
          showMessageModal(
            "Grading Error",
            `There was an error generating feedback: ${error.message}. Please check your input or try again later.`
          );
        } finally {
          writingTestState.isLoadingFeedback = false;
          renderWritingFeedbackSection(
            document.querySelector("#writing-feedback-section")
          ); // Ensure feedback section is rendered/updated
          updateWritingUI(); // Update button state
        }
      }

      /**
       * Renders the Writing Test UI structure.
       * @param {HTMLElement} parentDiv - The div to render the test into.
       */
      function renderWritingTest(parentDiv) {
        const writingTestHtml = `
                <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100 w-full max-w-5xl mx-auto my-8 animate-fade-in-up">
                    <h2 class="text-4xl font-extrabold text-blue-800 mb-4 text-center tracking-tight">Writing Test</h2>
                    <p class="text-xl text-gray-700 mb-8 text-center font-medium">${selectedTestTitle}</p>

                    <div class="flex justify-between items-center mb-6 pb-4 border-b-2 border-gray-100">
                        <div class="text-lg font-semibold text-gray-700 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 102 0V6zm-3.707 5.707a1 1 0 001.414-1.414L9 8.586V7a1 1 0 10-2 0v2a1 1 0 00.293.707l3 3z" clip-rule="evenodd"></path></svg>
                            Time Left: <span class="text-red-600 ml-1" id="writing-time-left">${formatTime(
                              writingTestState.timeRemaining
                            )}</span>
                        </div>
                        <div class="text-gray-700 font-semibold text-right text-base">
                            Word Count: Task 1 (<span id="task1-current-word-count" class="${
                              writingTestState.task1WordCount < 150
                                ? "text-red-500"
                                : "text-green-600"
                            }">${
          writingTestState.task1WordCount
        }</span>), Task 2 (<span id="task2-current-word-count" class="${
          writingTestState.task2WordCount < 250
            ? "text-red-500"
            : "text-green-600"
        }">${writingTestState.task2WordCount}</span>)
                        </div>
                    </div>

                    <div class="mb-8 p-6 bg-gray-50 rounded-2xl border border-gray-100 shadow-inner">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Task 1: Report/Letter <span class="text-base font-normal text-gray-600">(approx. 20 minutes)</span></h3>
                        <p class="text-gray-700 mb-5 bg-blue-50 p-4 rounded-xl border border-blue-200 leading-relaxed text-lg shadow-sm">
                            *The graph below shows the percentage of the population aged 65 and over in three countries between 1980 and 2040. Summarise the information by selecting and reporting the main features, and make comparisons where relevant.*
                            <br/><br/>
                            <img src="https://i.ibb.co/hL4g6hJ/ielts-task1-graph.png" alt="IELTS Task 1 Graph Example: Population Aged 65 and Over" class="rounded-lg my-3 mx-auto shadow-md w-full max-w-xl h-auto"/>
                            (Source: Example IELTS Graph)
                        </p>
                        <textarea id="task1-answer"
                            placeholder="Write your Task 1 response here. Aim for at least 150 words."
                            rows="10"
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-3 focus:ring-blue-400 transition duration-300 text-gray-800 text-lg shadow-sm resize-y"
                        >${writingTestState.task1Answer}</textarea>
                    </div>

                    <div class="mb-10 p-6 bg-gray-50 rounded-2xl border border-gray-100 shadow-inner">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Task 2: Essay <span class="text-base font-normal text-gray-600">(approx. 40 minutes)</span></h3>
                        <p class="text-gray-700 mb-5 bg-blue-50 p-4 rounded-xl border border-blue-200 leading-relaxed text-lg shadow-sm">
                            *Some people believe that the best way to improve public health is by increasing the number of sports facilities. Others, however, believe that this is not enough and that other measures are required. Discuss both these views and give your own opinion.*
                        </p>
                        <textarea id="task2-answer"
                            placeholder="Write your Task 2 essay here. Aim for at least 250 words."
                            rows="15"
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-3 focus:ring-blue-400 transition duration-300 text-gray-800 text-lg shadow-sm resize-y"
                        >${writingTestState.task2Answer}</textarea>
                    </div>

                    <div class="flex justify-center mt-10">
                        <button id="get-writing-feedback-btn"
                            class="bg-gradient-to-r from-purple-600 to-pink-700 hover:from-purple-700 hover:to-pink-800 text-white font-bold py-4 px-10 rounded-2xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105 text-xl flex items-center justify-center"
                            ${
                              writingTestState.isLoadingFeedback
                                ? "disabled"
                                : ""
                            }
                        >
                            ${
                              writingTestState.isLoadingFeedback
                                ? getLoadingSpinnerHtml()
                                : `${ActivityIcon.replace(
                                    /width="24" height="24"/g,
                                    'width="24" height="24" class="w-6 h-6 mr-3"'
                                  )} Get AI Writing Feedback`
                            }
                        </button>
                    </div>
                    <div id="writing-feedback-section"></div>
                </div>
            `;
        parentDiv.innerHTML = writingTestHtml;

        startWritingTimer(); // Start the overall test timer

        // Attach event listeners
        document.getElementById("task1-answer").oninput = handleTask1Change;
        document.getElementById("task2-answer").oninput = handleTask2Change;
        document.getElementById(
          "get-writing-feedback-btn"
        ).onclick = handleFinishWritingTest;

        // Initial UI update for timer and word counts
        updateWritingUI();
        // Render feedback section if already present (e.g., after navigation back)
        renderWritingFeedbackSection(
          document.querySelector("#writing-feedback-section")
        );
      }

      /**
       * Renders the AI Writing Feedback section.
       * @param {HTMLElement} feedbackSectionDiv - The div to render feedback into.
       */
      function renderWritingFeedbackSection(feedbackSectionDiv) {
        if (!writingTestState.feedback) {
          feedbackSectionDiv.innerHTML = ""; // Clear if no feedback
          return;
        }

        const writingFeedbackHtml = `
                <div class="mt-16 bg-green-50 p-8 rounded-3xl shadow-xl border border-green-200 animate-fade-in">
                    <h3 class="text-3xl font-extrabold text-green-800 mb-6 text-center tracking-tight">AI Writing Feedback</h3>
                    <p class="text-center text-2xl font-bold text-green-700 mb-8">Estimated Overall Band: <span class="bg-green-200 px-4 py-2 rounded-lg">${
                      writingTestState.feedback.overallEstimatedBand || "N/A"
                    }</span></p>

                    <div class="mb-8 p-6 bg-white rounded-2xl shadow-md border border-gray-100">
                        <h4 class="text-xl font-bold text-gray-800 mb-3 flex items-center">${FileTextIcon.replace(
                          /width="24" height="24"/g,
                          'width="20" height="20" class="w-5 h-5 mr-2 text-blue-500"'
                        )} Task 1 Feedback:</h4>
                        <p class="text-gray-700 leading-relaxed text-lg whitespace-pre-wrap">${
                          writingTestState.feedback.task1Feedback ||
                          "No feedback available."
                        }</p>
                    </div>

                    <div class="mb-8 p-6 bg-white rounded-2xl shadow-md border border-gray-100">
                        <h4 class="text-xl font-bold text-gray-800 mb-3 flex items-center">${FileTextIcon.replace(
                          /width="24" height="24"/g,
                          'width="20" height="20" class="w-5 h-5 mr-2 text-blue-500"'
                        )} Task 2 Feedback:</h4>
                        <p class="text-gray-700 leading-relaxed text-lg whitespace-pre-wrap">${
                          writingTestState.feedback.task2Feedback ||
                          "No feedback available."
                        }</p>
                    </div>

                    <div class="p-6 bg-white rounded-2xl shadow-md border border-gray-100">
                        <h4 class="text-xl font-bold text-gray-800 mb-3 flex items-center">${ActivityIcon.replace(
                          /width="24" height="24"/g,
                          'width="20" height="20" class="w-5 h-5 mr-2 text-blue-500"'
                        )} Suggestions for Improvement:</h4>
                        <p class="text-gray-700 leading-relaxed text-lg whitespace-pre-wrap">${
                          writingTestState.feedback.suggestionsForImprovement ||
                          "No suggestions available."
                        }</p>
                    </div>

                    <div class="flex justify-center mt-10">
                        <button id="writing-feedback-back-to-modules-btn"
                            class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105"
                        >
                            Back to Module Tests
                        </button>
                    </div>
                </div>
            `;
        feedbackSectionDiv.innerHTML = writingFeedbackHtml;
        document.getElementById(
          "writing-feedback-back-to-modules-btn"
        ).onclick = () => setAppState("module-test-selection", selectedModule);
      }

      // Speaking Test State & Functions
      let speakingTestState = {
        currentPart: 1,
        currentQuestionIndex: 0,
        recordingStatus: "idle", // 'idle', 'preparing', 'recording', 'processing', 'all_done'
        timeRemaining: 15 * 60, // Overall test time: 15 minutes
        responseTimer: 0, // Timer for individual response/prep
        overallTimerInterval: null,
        responseTimerInterval: null,
        mediaRecorder: null,
        audioChunks: [],
        isLoadingFeedback: false,
        allRecordedResponses: [], // Stores all recorded { question, audioBase64, transcribedText, aiFeedback }
        finalFeedback: null, // Stores the aggregated feedback at the end
        questions: {
          // Static questions
          1: [
            "Let's talk about your hometown. Where are you from?",
            "Do you like living there? Why or why not?",
            "What is your favorite place in your hometown?",
            "How has your hometown changed over the years?",
            "Do you think you will always live in your hometown?",
            "Tell me about a typical day in your life.",
            "What kind of music do you enjoy?",
            "Do you prefer reading books or watching movies?",
            "What is your favorite type of food?",
            "Describe a place you would like to visit in the future.",
          ],
          2: [
            {
              cueCard:
                "Describe a successful person you know. You should say: who this person is; what they do; what makes them successful; and explain why you admire them.",
              prepTime: 60, // seconds
              talkTime: 120, // seconds (1-2 minutes)
            },
            {
              cueCard:
                "Describe a historical event that you find interesting. You should say: what the event was; when and where it happened; who was involved; and explain why you find it interesting.",
              prepTime: 60,
              talkTime: 120,
            },
            {
              cueCard:
                "Describe a difficult decision you once made. You should say: what the decision was; when you made it; what the result was; and explain why it was difficult.",
              prepTime: 60,
              talkTime: 120,
            },
          ],
          3: [
            "Let's discuss success in general. What qualities do you think are essential for success in modern society?",
            "Do you think success is always about wealth and status?",
            "How important is education in achieving success?",
            "What role does luck play in people's success?",
            "Do you believe that everyone has an equal opportunity to succeed?",
            "How has technology changed the way people communicate?",
            "What are the advantages and disadvantages of living in a big city?",
            "To what extent should governments be responsible for public health?",
            "How important is it for people to have hobbies and interests?",
            "Do you think traditional skills are still relevant in the modern world?",
          ],
        },
      };

      /**
       * Resets the speaking test state to initial values.
       * Called only when a new test session begins.
       */
      function resetSpeakingTestState() {
        stopAllSpeakingTimers(); // Ensure all timers are cleared
        if (
          speakingTestState.mediaRecorder &&
          speakingTestState.mediaRecorder.state === "recording"
        ) {
          speakingTestState.mediaRecorder.stop();
        }
        speakingTestState = {
          currentPart: 1,
          currentQuestionIndex: 0,
          recordingStatus: "idle",
          timeRemaining: 15 * 60,
          responseTimer: 0,
          overallTimerInterval: null,
          responseTimerInterval: null,
          mediaRecorder: null,
          audioChunks: [],
          isLoadingFeedback: false,
          allRecordedResponses: [],
          finalFeedback: null,
          questions: speakingTestState.questions, // Keep questions static
        };
      }

      /**
       * Stops all active timers for the speaking test (overall and response timers).
       */
      function stopAllSpeakingTimers() {
        if (speakingTestState.overallTimerInterval) {
          clearInterval(speakingTestState.overallTimerInterval);
          speakingTestState.overallTimerInterval = null;
        }
        if (speakingTestState.responseTimerInterval) {
          clearInterval(speakingTestState.responseTimerInterval);
          speakingTestState.responseTimerInterval = null;
        }
      }

      /**
       * Starts the individual response/preparation timer.
       * @param {number} duration - The duration of the timer in seconds.
       * @param {function} onTimerEndCallback - Callback function to execute when timer ends.
       */
      function startResponseTimerForSpeaking(
        duration,
        onTimerEndCallback = null
      ) {
        if (speakingTestState.responseTimerInterval)
          clearInterval(speakingTestState.responseTimerInterval);
        speakingTestState.responseTimer = duration;
        speakingTestState.responseTimerInterval = setInterval(() => {
          speakingTestState.responseTimer--;
          if (speakingTestState.responseTimer <= 0) {
            clearInterval(speakingTestState.responseTimerInterval);
            speakingTestState.responseTimerInterval = null;
            if (onTimerEndCallback) {
              onTimerEndCallback();
            }
          }
          updateSpeakingUI(); // Re-render to update response timer
        }, 1000);
      }

      /**
       * Starts the microphone recording.
       */
      async function startRecordingSpeaking() {
        console.log("Attempting to start recording...");
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          console.log("Microphone access granted.");
          speakingTestState.mediaRecorder = new MediaRecorder(stream, {
            mimeType: "audio/webm",
          }); // Use webm for broader compatibility
          speakingTestState.audioChunks = [];

          speakingTestState.mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              speakingTestState.audioChunks.push(event.data);
              console.log("Audio data available:", event.data.size, "bytes");
            }
          };

          speakingTestState.mediaRecorder.onstop = async () => {
            console.log("MediaRecorder stopped.");
            const audioBlob = new Blob(speakingTestState.audioChunks, {
              type: "audio/webm",
            }); // Match mimeType
            console.log(
              "Audio blob created:",
              audioBlob.type,
              audioBlob.size,
              "bytes"
            );

            if (audioBlob.size === 0) {
              console.warn(
                "Recorded audio blob is empty. Microphone might not be capturing audio."
              );
              showMessageModal(
                "No Audio Captured",
                "It seems no audio was captured. Please ensure your microphone is working correctly and try again. Check your system's sound input settings."
              );
            }

            const base64Audio = await blobToBase64(audioBlob);
            console.log(
              "Audio converted to Base64. Size (approx):",
              base64Audio.length,
              "characters"
            );

            const currentQuestionObj =
              speakingTestState.currentPart === 2
                ? speakingTestState.questions[speakingTestState.currentPart][
                    speakingTestState.currentQuestionIndex
                  ].cueCard
                : speakingTestState.questions[speakingTestState.currentPart][
                    speakingTestState.currentQuestionIndex
                  ];

            // Store audio and question for later AI processing
            speakingTestState.allRecordedResponses.push({
              question: currentQuestionObj,
              audioBase64: base64Audio,
              transcribedText: "", // Will be filled after transcription
              aiFeedback: null, // Will be filled after evaluation
            });

            // Stop all tracks to release microphone
            stream.getTracks().forEach((track) => track.stop());

            speakingTestState.recordingStatus = "idle"; // Back to idle after recording stops
            speakingTestState.responseTimer = 0; // Reset response timer
            updateSpeakingUI(); // Re-render to update UI
            console.log("Recording stopped and response saved to state.");
          };

          speakingTestState.mediaRecorder.start();
          speakingTestState.recordingStatus = "recording";
          updateSpeakingUI(); // Re-render to show recording status
          console.log("Recording started successfully.");

          let duration = 0;
          if (speakingTestState.currentPart === 1) {
            duration = 30; // Max 30 seconds for Part 1 questions
          } else if (speakingTestState.currentPart === 2) {
            duration =
              speakingTestState.questions[speakingTestState.currentPart][
                speakingTestState.currentQuestionIndex
              ].talkTime;
          } else if (speakingTestState.currentPart === 3) {
            duration = 60; // Max 60 seconds for Part 3 questions
          }
          startResponseTimerForSpeaking(duration, stopRecordingSpeaking); // Auto-stop when timer runs out
        } catch (err) {
          console.error("Error accessing microphone:", err);
          if (
            err.name === "NotAllowedError" ||
            err.name === "PermissionDeniedError"
          ) {
            showMessageModal(
              "Microphone Access Denied",
              "Microphone access was denied. Please enable it in your browser settings to proceed with the Speaking test. (e.g., in Chrome: click the lock icon in the address bar, then allow microphone)."
            );
          } else if (err.name === "NotFoundError") {
            showMessageModal(
              "No Microphone Found",
              "No microphone device was found. Please ensure a microphone is connected and properly installed."
            );
          } else {
            showMessageModal(
              "Microphone Error",
              `An unexpected error occurred accessing the microphone: ${err.message}. Please try again.`
            );
          }
          speakingTestState.recordingStatus = "idle";
          updateSpeakingUI();
        }
      }

      /**
       * Stops the microphone recording.
       */
      function stopRecordingSpeaking() {
        console.log("Attempting to stop recording...");
        if (
          speakingTestState.mediaRecorder &&
          speakingTestState.mediaRecorder.state === "recording"
        ) {
          speakingTestState.mediaRecorder.stop();
          if (speakingTestState.responseTimerInterval)
            clearInterval(speakingTestState.responseTimerInterval);
          speakingTestState.responseTimer = 0; // Reset timer immediately
          console.log("Stop signal sent to MediaRecorder.");
          // State will be updated in onstop handler of mediaRecorder
        } else {
          console.log("MediaRecorder was not recording or is null.");
        }
      }

      /**
       * Converts an Audio Blob to a Base64 string.
       * @param {Blob} blob - The audio blob.
       * @returns {Promise<string>} A promise that resolves with the Base64 string.
       */
      function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => {
            if (reader.result) {
              resolve(reader.result.split(",")[1]);
            } else {
              reject(new Error("FileReader did not produce a result."));
            }
          };
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      /**
       * Processes all recorded audio responses with AI for transcription and evaluation.
       */
      async function processAllResponsesWithAI() {
        stopAllSpeakingTimers(); // Ensure all timers are stopped before processing
        speakingTestState.isLoadingFeedback = true;
        speakingTestState.finalFeedback = null;
        speakingTestState.recordingStatus = "processing";
        updateSpeakingUI(); // Update UI to show processing state

        showMessageModal(
          "Analyzing All Responses",
          `Sending ${speakingTestState.allRecordedResponses.length} responses for AI evaluation. This may take a few moments.`
        );

        // Process each recorded response
        for (
          let i = 0;
          i < speakingTestState.allRecordedResponses.length;
          i++
        ) {
          const res = speakingTestState.allRecordedResponses[i];
          try {
            console.log(`Processing response for question: "${res.question}"`);

            // 1. Transcribe Audio
            const transcriptionPrompt = "Transcribe the following audio:";
            let chatHistoryTranscription = [];
            chatHistoryTranscription.push({
              role: "user",
              parts: [
                { text: transcriptionPrompt },
                {
                  inlineData: {
                    mimeType: "audio/webm", // Match the mimeType used during recording
                    data: res.audioBase64,
                  },
                },
              ],
            });
            const transcriptionPayload = { contents: chatHistoryTranscription };
            const apiKey = ""; // Canvas will inject API key
            const transcriptionApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            console.log("Calling transcription API...");
            const transcriptionResponse = await fetch(transcriptionApiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(transcriptionPayload),
            });
            const transcriptionResult = await transcriptionResponse.json();
            console.log("Transcription API response:", transcriptionResult);

            let transcribedText = "Could not transcribe your speech.";
            if (
              transcriptionResult.candidates &&
              transcriptionResult.candidates.length > 0 &&
              transcriptionResult.candidates[0].content &&
              transcriptionResult.candidates[0].content.parts &&
              transcriptionResult.candidates[0].content.parts.length > 0
            ) {
              transcribedText =
                transcriptionResult.candidates[0].content.parts[0].text;
              console.log("Transcribed text:", transcribedText);
            } else {
              console.warn(
                "No transcription candidates found for question:",
                res.question
              );
            }
            res.transcribedText = transcribedText; // Store transcribed text in the response object

            // 2. Evaluate Transcribed Text
            const evaluationPrompt = `You are an IELTS examiner. Evaluate the following spoken response to the question: "${res.question}".
                    Response: "${transcribedText}"

                    Provide a detailed band score estimation (e.g., Band 6.5) for Fluency & Coherence, Lexical Resource, Grammatical Range & Accuracy, and Pronunciation. Then give an overall estimated band score for this specific response. Also, provide specific feedback on strengths and areas for improvement, and suggest one or two alternative ways to phrase difficult sentences to achieve a higher score.
                    Provide the response in a structured JSON format with fields: 'fluencyCoherence', 'lexicalResource', 'grammaticalRangeAccuracy', 'pronunciation', 'overallEstimatedBand', 'feedbackDetails', 'alternativePhrasingSuggestions'.`;

            const evaluationPayload = {
              contents: [{ role: "user", parts: [{ text: evaluationPrompt }] }],
              generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: "OBJECT",
                  properties: {
                    fluencyCoherence: { type: "STRING" },
                    lexicalResource: { type: "STRING" },
                    grammaticalRangeAccuracy: { type: "STRING" },
                    pronunciation: { type: "STRING" },
                    overallEstimatedBand: { type: "STRING" },
                    feedbackDetails: { type: "STRING" },
                    alternativePhrasingSuggestions: { type: "STRING" },
                  },
                  propertyOrdering: [
                    "fluencyCoherence",
                    "lexicalResource",
                    "grammaticalRangeAccuracy",
                    "pronunciation",
                    "overallEstimatedBand",
                    "feedbackDetails",
                    "alternativePhrasingSuggestions",
                  ],
                },
              },
            };

            const evaluationApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            console.log("Calling evaluation API...");
            const evaluationResponse = await fetch(evaluationApiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(evaluationPayload),
            });
            const evaluationResult = await evaluationResponse.json();
            console.log("Evaluation API response:", evaluationResult);

            if (
              evaluationResult.candidates &&
              evaluationResult.candidates.length > 0 &&
              evaluationResult.candidates[0].content &&
              evaluationResult.candidates[0].content.parts &&
              evaluationResult.candidates[0].content.parts.length > 0
            ) {
              const jsonString =
                evaluationResult.candidates[0].content.parts[0].text;
              try {
                res.aiFeedback = JSON.parse(jsonString); // Store AI feedback in the response object
                console.log("AI feedback parsed successfully for question.");
              } catch (parseError) {
                console.error(
                  "Failed to parse AI response JSON for evaluation:",
                  parseError,
                  jsonString
                );
                res.aiFeedback = {
                  overallEstimatedBand: "N/A",
                  feedbackDetails: "Error parsing AI feedback. Check console.",
                };
              }
            } else {
              console.warn(
                "No AI evaluation candidates found for question:",
                res.question
              );
              res.aiFeedback = {
                overallEstimatedBand: "N/A",
                feedbackDetails: "No AI evaluation received for this response.",
              };
            }
          } catch (error) {
            console.error(
              `Error processing response for question "${res.question}":`,
              error
            );
            res.transcribedText = "Error during transcription or evaluation.";
            res.aiFeedback = {
              overallEstimatedBand: "N/A",
              feedbackDetails: `An error occurred: ${error.message}.`,
            };
          }
        }

        // Aggregate overall band score
        const bandScores = speakingTestState.allRecordedResponses
          .map((res) =>
            parseFloat(
              String(res.aiFeedback?.overallEstimatedBand || "0.0").replace(
                "Band ",
                ""
              )
            )
          )
          .filter((score) => !isNaN(score) && score > 0);

        let overallBand = "N/A";
        if (bandScores.length > 0) {
          const sum = bandScores.reduce((acc, score) => acc + score, 0);
          const average = sum / bandScores.length;
          // Round to the nearest .0 or .5
          overallBand = `Band ${Math.round(average * 2) / 2}`;
        }

        speakingTestState.finalFeedback = {
          individualFeedbacks: speakingTestState.allRecordedResponses,
          overallBand: overallBand,
        };

        hideMessageModal();
        showMessageModal(
          "Speaking Feedback Ready",
          "Your comprehensive AI-generated feedback for the entire test is now available below."
        );
        speakingTestState.isLoadingFeedback = false;
        speakingTestState.recordingStatus = "all_done";
        updateSpeakingUI(); // Final UI update to show feedback
        console.log("All responses processed and final feedback set.");
      }

      /**
       * Handles navigation to the next question in the speaking test.
       */
      function handleNextSpeakingQuestion() {
        if (speakingTestState.recordingStatus === "idle") {
          const currentQuestionsInPart =
            speakingTestState.questions[speakingTestState.currentPart];
          const nextQuestionIndex = speakingTestState.currentQuestionIndex + 1;

          if (nextQuestionIndex < currentQuestionsInPart.length) {
            speakingTestState.currentQuestionIndex = nextQuestionIndex;
            speakingTestState.responseTimer = 0; // Reset response timer for new question
            updateSpeakingUI();
          } else {
            if (speakingTestState.currentPart < 3) {
              speakingTestState.currentPart++;
              speakingTestState.currentQuestionIndex = 0; // Reset index for new part
              speakingTestState.responseTimer = 0; // Reset response timer for new part
              // If moving to Part 2, start preparation timer
              if (speakingTestState.currentPart === 2) {
                speakingTestState.recordingStatus = "preparing";
                const cueCard =
                  speakingTestState.questions[speakingTestState.currentPart][
                    speakingTestState.currentQuestionIndex
                  ];
                startResponseTimerForSpeaking(cueCard.prepTime, () => {
                  speakingTestState.recordingStatus = "idle"; // Allow recording after prep time
                  updateSpeakingUI();
                });
              }
              updateSpeakingUI();
            } else {
              // All parts and questions done, initiate final processing
              handleFinishSpeakingTest();
            }
          }
        } else {
          showMessageModal(
            "Action Required",
            "Please stop recording your current response before moving to the next question."
          );
        }
      }

      /**
       * Handles the completion and submission of the entire speaking test.
       */
      async function handleFinishSpeakingTest() {
        stopAllSpeakingTimers();
        if (
          speakingTestState.mediaRecorder &&
          speakingTestState.mediaRecorder.state === "recording"
        ) {
          stopRecordingSpeaking();
          // Wait briefly for the onstop event to process the last audio chunk
          await new Promise((resolve) => setTimeout(resolve, 500));
        }
        await processAllResponsesWithAI(); // Process all recorded responses
        // setAppState will be called after processing is done and feedback is shown
      }

      /**
       * Renders the Speaking Test UI structure and initiates overall timer.
       * @param {HTMLElement} parentDiv - The div to render the test into.
       */
      function renderSpeakingTest(parentDiv) {
        // Initial setup for the entire Speaking Test container
        const speakingTestContainerHtml = `
                <div class="speaking-test-container bg-white p-8 rounded-3xl shadow-xl border border-gray-100 w-full max-w-4xl mx-auto my-8 animate-fade-in-up">
                    <h2 class="text-4xl font-extrabold text-blue-800 mb-4 text-center tracking-tight">Speaking Test</h2>
                    <p class="text-xl text-gray-700 mb-8 text-center font-medium">${selectedTestTitle}</p>

                    <div class="flex justify-between items-center mb-6 pb-4 border-b-2 border-gray-100">
                        <div class="text-lg font-semibold text-gray-700 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 102 0V6zm-3.707 5.707a1 1 0 001.414-1.414L9 8.586V7a1 1 0 10-2 0v2a1 1 0 00.293.707l3 3z" clip-rule="evenodd"></path></svg>
                            Total Time Left: <span class="text-red-600 ml-1" id="speaking-overall-time-left">${formatTime(
                              speakingTestState.timeRemaining
                            )}</span>
                        </div>
                        <div class="text-lg font-semibold text-gray-700">
                            Part: <span class="font-bold text-gray-800" id="speaking-current-part">${
                              speakingTestState.currentPart
                            }</span> / 3
                        </div>
                    </div>

                    <div class="mb-8 p-6 bg-blue-50 rounded-2xl border border-blue-200 shadow-inner min-h-[150px] flex flex-col justify-center items-center text-center">
                        <h3 class="text-2xl font-bold text-blue-800 mb-4" id="speaking-question-type"></h3>
                        <p class="text-gray-800 text-3xl font-semibold leading-relaxed" id="speaking-current-question-text"></p>
                        <div class="mt-4 text-gray-600 text-lg" id="speaking-part2-prep-time"></div>
                    </div>

                    <div class="flex flex-col items-center justify-center space-y-4 mb-10" id="speaking-controls"></div>

                    <div class="flex justify-center mt-10">
                        <button id="speaking-next-or-submit-btn"
                            class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105"
                        ></button>
                    </div>

                    <div id="speaking-feedback-section"></div>
                </div>
            `;
        parentDiv.innerHTML = speakingTestContainerHtml;

        // Start overall timer only once per test session
        if (!speakingTestState.overallTimerInterval) {
          speakingTestState.overallTimerInterval = setInterval(() => {
            speakingTestState.timeRemaining--;
            if (speakingTestState.timeRemaining <= 0) {
              clearInterval(speakingTestState.overallTimerInterval);
              if (
                speakingTestState.recordingStatus !== "processing" &&
                speakingTestState.recordingStatus !== "all_done"
              ) {
                handleFinishSpeakingTest(); // Auto-submit on time ran out
              }
            }
            updateSpeakingUI();
          }, 1000);
        }

        updateSpeakingUI(); // Initial render and attach listeners
        renderSpeakingFeedbackSection(
          document.querySelector("#speaking-feedback-section")
        ); // Render feedback if already processed
      }

      /**
       * Updates the Speaking UI elements (timers, questions, buttons, status).
       * This function is called frequently to keep the UI in sync with state.
       */
      function updateSpeakingUI() {
        const currentQuestionsInPart =
          speakingTestState.questions[speakingTestState.currentPart];
        const currentQuestion =
          speakingTestState.currentPart === 2
            ? currentQuestionsInPart[speakingTestState.currentQuestionIndex]
            : currentQuestionsInPart[speakingTestState.currentQuestionIndex];
        const isLastQuestionInPart =
          speakingTestState.currentQuestionIndex ===
          currentQuestionsInPart.length - 1;
        const isLastPart = speakingTestState.currentPart === 3;
        const currentQuestionText =
          speakingTestState.currentPart === 2
            ? currentQuestion.cueCard
            : currentQuestion;

        // Update static elements that change based on state
        const overallTimeLeftSpan = document.getElementById(
          "speaking-overall-time-left"
        );
        if (overallTimeLeftSpan)
          overallTimeLeftSpan.textContent = formatTime(
            speakingTestState.timeRemaining
          );

        const currentPartSpan = document.getElementById(
          "speaking-current-part"
        );
        if (currentPartSpan)
          currentPartSpan.textContent = speakingTestState.currentPart;

        const questionTypeH3 = document.getElementById(
          "speaking-question-type"
        );
        if (questionTypeH3)
          questionTypeH3.innerHTML =
            speakingTestState.currentPart === 2
              ? "Cue Card: Prepare for 1 minute, then speak for 1-2 minutes."
              : "AI Examiner's Question:";

        const currentQuestionTextP = document.getElementById(
          "speaking-current-question-text"
        );
        if (currentQuestionTextP)
          currentQuestionTextP.textContent = `"${currentQuestionText}"`;

        const part2PrepTimeDiv = document.getElementById(
          "speaking-part2-prep-time"
        );
        if (part2PrepTimeDiv) {
          if (speakingTestState.currentPart === 2) {
            if (speakingTestState.recordingStatus === "preparing") {
              part2PrepTimeDiv.innerHTML = `<p class="font-medium">Preparation Time: <span class="font-bold text-blue-700">${formatTime(
                speakingTestState.responseTimer
              )}</span></p>`;
            } else if (speakingTestState.recordingStatus === "idle") {
              // After prep, show talk time info
              part2PrepTimeDiv.innerHTML = `<p class="font-medium">Talk Time: <span class="font-bold text-green-700">${formatTime(
                currentQuestion.talkTime
              )}</span></p>`;
            } else {
              part2PrepTimeDiv.innerHTML = ""; // Clear when recording
            }
          } else {
            part2PrepTimeDiv.innerHTML = ""; // Clear for other parts
          }
        }

        const speakingControlsDiv = document.getElementById(
          "speaking-controls"
        );
        let controlsHtml = "";
        if (speakingTestState.recordingStatus === "idle") {
          const isPart2PrepComplete =
            (speakingTestState.currentPart === 2 &&
              speakingTestState.responseTimer === 0) ||
            speakingTestState.currentPart !== 2;
          controlsHtml = `
                    <button id="start-recording-btn"
                        class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-10 rounded-full shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105 text-xl flex items-center"
                        ${!isPart2PrepComplete ? "disabled" : ""}
                    >
                        ${MicIcon.replace(
                          /width="24" height="24"/g,
                          'width="24" height="24" class="w-6 h-6 mr-3"'
                        )}
                        Start Recording
                    </button>
                    ${
                      !isPart2PrepComplete &&
                      speakingTestState.currentPart === 2
                        ? `<p class="text-sm text-gray-500">Wait for preparation time to end.</p>`
                        : ""
                    }
                `;
        } else if (speakingTestState.recordingStatus === "preparing") {
          controlsHtml = `
                    <div class="flex flex-col items-center">
                        <button class="bg-gray-400 text-white font-bold py-4 px-10 rounded-full shadow-lg cursor-not-allowed text-xl flex items-center" disabled>
                            ${MicIcon.replace(
                              /width="24" height="24"/g,
                              'width="24" height="24" class="w-6 h-6 mr-3"'
                            )}
                            Preparing...
                        </button>
                        <p class="mt-3 text-blue-600 font-semibold text-lg flex items-center">
                            <span class="relative flex h-3 w-3 mr-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
                            </span>
                            Preparation Time: <span class="text-gray-700 ml-2">(${formatTime(
                              speakingTestState.responseTimer
                            )})</span>
                        </p>
                    </div>
                 `;
        } else if (speakingTestState.recordingStatus === "recording") {
          controlsHtml = `
                    <div class="flex flex-col items-center">
                        <button id="stop-recording-btn"
                            class="bg-gradient-to-r from-red-600 to-rose-700 hover:from-red-700 hover:to-rose-800 text-white font-bold py-4 px-10 rounded-full shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105 text-xl flex items-center"
                        >
                            ${MicIcon.replace(
                              /width="24" height="24"/g,
                              'width="24" height="24" class="w-6 h-6 mr-3"'
                            )}
                            Stop Recording
                        </button>
                        <p class="mt-3 text-red-600 font-semibold text-lg flex items-center">
                            <span class="relative flex h-3 w-3 mr-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                            </span>
                            Recording... <span class="text-gray-700 ml-2">(${formatTime(
                              speakingTestState.responseTimer
                            )})</span>
                        </p>
                    </div>
                `;
        } else if (speakingTestState.recordingStatus === "processing") {
          controlsHtml = `
                    <div class="flex flex-col items-center">
                        ${getLoadingSpinnerHtml()}
                        <p class="text-gray-700 mt-3 text-lg">Analyzing your response with AI...</p>
                    </div>
                `;
        }
        speakingControlsDiv.innerHTML = controlsHtml;

        // Attach/Re-attach listeners to controls based on `recordingStatus`
        if (speakingTestState.recordingStatus === "idle") {
          const startBtn = document.getElementById("start-recording-btn");
          if (startBtn) startBtn.onclick = startRecordingSpeaking;
        } else if (speakingTestState.recordingStatus === "recording") {
          const stopBtn = document.getElementById("stop-recording-btn");
          if (stopBtn) stopBtn.onclick = stopRecordingSpeaking;
        }

        // Update Next/Submit button
        const nextOrSubmitBtn = document.getElementById(
          "speaking-next-or-submit-btn"
        );
        if (nextOrSubmitBtn) {
          if (
            isLastPart &&
            isLastQuestionInPart &&
            speakingTestState.recordingStatus === "idle"
          ) {
            nextOrSubmitBtn.className =
              "bg-gradient-to-r from-purple-600 to-pink-700 hover:from-purple-700 hover:to-pink-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105";
            nextOrSubmitBtn.textContent = "Submit Entire Speaking Test";
            nextOrSubmitBtn.disabled =
              speakingTestState.recordingStatus !== "idle" ||
              speakingTestState.allRecordedResponses.length <
                speakingTestState.questions[1].length +
                  speakingTestState.questions[2].length +
                  speakingTestState.questions[3].length; // Ensure all questions are recorded before final submission
            nextOrSubmitBtn.onclick = handleFinishSpeakingTest;
          } else {
            nextOrSubmitBtn.className =
              "bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105";
            nextOrSubmitBtn.textContent = "Next Question →";
            nextOrSubmitBtn.disabled =
              speakingTestState.recordingStatus !== "idle"; // Disable if not idle (recording or processing)
            nextOrSubmitBtn.onclick = handleNextSpeakingQuestion;
          }
        }
      }

      /**
       * Renders the AI Speaking Feedback section.
       * @param {HTMLElement} feedbackSectionDiv - The div to render feedback into.
       */
      function renderSpeakingFeedbackSection(feedbackSectionDiv) {
        if (
          !speakingTestState.finalFeedback ||
          speakingTestState.recordingStatus !== "all_done"
        ) {
          feedbackSectionDiv.innerHTML = ""; // Clear if no feedback or not in 'all_done' state
          return;
        }

        let individualFeedbacksHtml = speakingTestState.finalFeedback.individualFeedbacks
          .map((item, index) => {
            const iconSizeForFeedback = 'width="16" height="16"'; // smaller icons for feedback
            return `
                    <div class="mb-10 p-6 bg-white rounded-2xl shadow-md border border-gray-100 animate-fade-in">
                        <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="text-blue-500 mr-2">Q${
                          index + 1
                        }:</span> ${
              typeof item.question === "object"
                ? item.question.cueCard
                : item.question
            }</h4>

                        <div class="mb-4">
                            <h5 class="font-bold text-lg text-gray-800">Your Transcribed Response:</h5>
                            <p class="text-gray-700 italic leading-relaxed text-base bg-gray-100 p-3 rounded-lg border border-gray-200 whitespace-pre-wrap">${
                              item.transcribedText ||
                              "Transcription not available."
                            }</p>
                        </div>

                        ${
                          item.aiFeedback
                            ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-100">
                                    <h6 class="font-bold text-base text-gray-800 mb-1">Fluency & Coherence:</h6>
                                    <p class="text-gray-700 text-sm">${
                                      item.aiFeedback.fluencyCoherence || "N/A"
                                    }</p>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-100">
                                    <h6 class="font-bold text-base text-gray-800 mb-1">Lexical Resource:</h6>
                                    <p class="text-gray-700 text-sm">${
                                      item.aiFeedback.lexicalResource || "N/A"
                                    }</p>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-100">
                                    <h6 class="font-bold text-base text-gray-800 mb-1">Grammatical Range & Accuracy:</h6>
                                    <p class="text-gray-700 text-sm">${
                                      item.aiFeedback
                                        .grammaticalRangeAccuracy || "N/A"
                                    }</p>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-100">
                                    <h6 class="font-bold text-base text-gray-800 mb-1">Pronunciation:</h6>
                                    <p class="text-gray-700 text-sm">${
                                      item.aiFeedback.pronunciation || "N/A"
                                    }</p>
                                </div>
                            </div>

                            <p class="text-lg font-semibold text-gray-700 mb-4 text-right">Estimated Band for this question: <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-md">${
                              item.aiFeedback.overallEstimatedBand || "N/A"
                            }</span></p>

                            <div class="mb-4 p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-100">
                                <h5 class="text-lg font-bold text-gray-800 mb-2 flex items-center">${ActivityIcon.replace(
                                  /width="24" height="24"/g,
                                  iconSizeForFeedback
                                )} Detailed Feedback:</h5>
                                <p class="text-gray-700 leading-relaxed text-base whitespace-pre-wrap">${
                                  item.aiFeedback.feedbackDetails ||
                                  "No detailed feedback available."
                                }</p>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-100">
                                <h5 class="text-lg font-bold text-gray-800 mb-2 flex items-center">${LightbulbIcon.replace(
                                  /width="24" height="24"/g,
                                  iconSizeForFeedback
                                )} Alternative Phrasing:</h5>
                                <p class="text-gray-700 leading-relaxed text-base whitespace-pre-wrap">${
                                  item.aiFeedback
                                    .alternativePhrasingSuggestions ||
                                  "No suggestions available."
                                }</p>
                            </div>
                        `
                            : '<p class="text-red-600">AI Feedback for this question could not be generated.</p>'
                        }
                    </div>
                `;
          })
          .join("");

        feedbackSectionDiv.innerHTML = `
                <div class="mt-16 bg-green-50 p-8 rounded-3xl shadow-xl border border-green-200 animate-fade-in">
                    <h3 class="text-3xl font-extrabold text-green-800 mb-6 text-center tracking-tight">Comprehensive AI Speaking Feedback</h3>
                    <p class="text-center text-2xl font-bold text-green-700 mb-8">Overall Estimated Band: <span class="bg-green-200 px-4 py-2 rounded-lg">${speakingTestState.finalFeedback.overallBand}</span></p>

                    ${individualFeedbacksHtml}

                    <div class="flex justify-center mt-10">
                        <button id="speaking-feedback-back-to-modules-btn"
                            class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105"
                        >
                            Back to Module Tests
                        </button>
                    </div>
                </div>
            `;
        document.getElementById(
          "speaking-feedback-back-to-modules-btn"
        ).onclick = () => {
          setAppState("module-test-selection", selectedModule);
          // resetSpeakingTestState is called by setAppState when entering test-in-progress next time
        };
      }

      // Function to render the specific test based on selectedModule
      /**
       * Renders the specific test UI based on the `selectedModule` state.
       * This function acts as a router for individual test modules.
       * @param {HTMLElement} parentDiv - The div to render the test into.
       */
      function renderTestInProgress(parentDiv) {
        switch (selectedModule) {
          case "listening":
            renderListeningTest(parentDiv);
            break;
          case "reading":
            renderReadingTest(parentDiv);
            break;
          case "writing":
            renderWritingTest(parentDiv);
            break;
          case "speaking":
            renderSpeakingTest(parentDiv);
            break;
        }
      }

      // --- Initialization Logic ---
      window.onload = async function () {
        // Initialize Firebase only once
        if (!appInstance) {
          appInstance = initializeApp(firebaseConfig);
          db = getFirestore(appInstance);
          auth = getAuth(appInstance);

          const authenticateUser = async () => {
            try {
              if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
                console.log("Signed in with custom token.");
              } else {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
              }
            } catch (error) {
              console.error("Firebase authentication error:", error);
              showMessageModal(
                "Authentication Error",
                `Failed to authenticate with Firebase: ${error.message}. Some features may not work. Please try refreshing the page.`
              );
            }
          };
          await authenticateUser(); // Ensure authentication completes before setting isAuthReady

          onAuthStateChanged(auth, (user) => {
            if (user) {
              userId = user.uid;
              console.log("Firebase User ID:", userId);
            } else {
              userId = null;
              console.log("No Firebase user is signed in.");
            }
            isAuthReady = true; // Auth state is now known
            renderApp(); // Initial render once auth is ready
          });
        } else {
          renderApp(); // Initial render if Firebase already initialized (e.g., on manual refresh)
        }
      };
    </script>
  </body>
</html>
