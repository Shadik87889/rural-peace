<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IELTS Mahir Community Forum</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for professional icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      /* Changed to system font stack for a more "Apple app-like" and professional feel */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji",
          "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      /* Specific font classes can be kept for titles if desired, but general body will use system font */
      .font-anton {
        font-family: "Anton", sans-serif; /* Kept for strong branding on title */
      }
      /* Custom scrollbar for better aesthetics */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg-scroll-track, #f1f1f1);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--bg-scroll-thumb, #888);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--bg-scroll-thumb-hover, #555);
      }

      /* Theme-specific scrollbar colors */
      .dark {
        --bg-scroll-track: #374151; /* gray-700 */
        --bg-scroll-thumb: #6b7280; /* gray-500 */
        --bg-scroll-thumb-hover: #4b5563; /* gray-600 */
      }
      .light {
        --bg-scroll-track: #f3f4f6; /* gray-100 */
        --bg-scroll-thumb: #a0aec0; /* gray-400 */
        --bg-scroll-thumb-hover: #718096; /* gray-500 */
      }

      /* Toast Notification Styling */
      #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        padding: 12px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        color: white;
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        min-width: 250px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .toast.success {
        background-color: #28a745;
      } /* Green */
      .toast.error {
        background-color: #dc3545;
      } /* Red */
      .toast.info {
        background-color: #007bff;
      } /* Blue */
    </style>
  </head>
  <body class="light">
    <div
      id="app-root"
      class="min-h-screen flex flex-col transition-colors duration-300"
    >
      <!-- Header will be injected here -->
      <header
        id="app-header"
        class="py-4 px-6 md:px-8 flex items-center justify-between shadow-sm rounded-b-2xl transition-colors duration-300"
      ></header>

      <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar will be injected here -->
        <aside
          id="app-sidebar"
          class="fixed inset-y-0 left-0 w-64 md:relative md:w-auto transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out p-6 shadow-xl rounded-r-2xl md:rounded-2xl md:shadow-none z-40"
        ></aside>

        <!-- Main content area -->
        <main
          id="main-content"
          class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 flex"
        ></main>
      </div>
    </div>

    <!-- AI Response Modal -->
    <div
      id="ai-modal-overlay"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
    >
      <div
        id="ai-modal-content"
        class="relative rounded-2xl shadow-2xl p-6 md:p-8 max-w-lg w-full max-h-[85vh] md:max-h-[90vh] overflow-y-auto"
      >
        <button
          id="ai-modal-close-btn"
          class="absolute top-4 right-4 p-2 rounded-full transition-colors"
        >
          <i class="fas fa-times"></i>
        </button>
        <h3 id="ai-modal-title" class="text-2xl font-bold font-normal mb-4">
          AI Response
        </h3>
        <div id="ai-modal-body">
          <!-- AI content or loading spinner will be here -->
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Firebase SDK (Version 11.6.1 used in React example, so maintaining for consistency) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        addDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        collection,
        query,
        orderBy,
        where,
        arrayUnion,
        arrayRemove,
        serverTimestamp,
        writeBatch,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      // Removed Firebase Storage import as it won't be used for file uploads

      // --- Global State ---
      const appState = {
        db: null,
        auth: null,
        // storage: null, // Removed storage from state
        userId: null, // Current authenticated user's ID
        userProfile: null, // Current authenticated user's profile data
        isAuthReady: false,
        theme: "light", // 'light' or 'dark'
        view: "home", // 'home', 'postDetail', 'createPost', 'profile'
        homeFeedType: "latest", // 'latest', 'forYou', 'following'
        selectedPost: null,
        posts: [], // All posts fetched from Firestore
        comments: {}, // Comments will now store nested structure if available
        showSidebar: false,
        // Track Firestore listeners to unsubscribe later if needed (though for a simple app, not not strictly necessary)
        postsUnsubscribe: null,
        commentsUnsubscribe: null,
        activeCategory: null, // Track active category for filtering
        activeSubCategory: null, // Track active subcategory for filtering
        // State for "See More" comments/replies
        visibleCommentsCount: 5, // Initial count for main post comments
        visibleRepliesCount: {}, // Object to store visible count per parent comment ID
        editingPostId: null, // Track which post is being edited
        editingCommentId: null, // Track which comment is being edited
        expandedReplies: {}, // New state to track which comment replies are expanded
        editingProfile: false, // New state for profile editing
        viewedProfile: null, // The profile object of the user currently being viewed
        allUsersProfiles: [], // Cache for all user profiles for display and lookup
      };

      // --- Constants ---
      const MAX_VISIBLE_TOP_LEVEL_COMMENTS = 5;
      const MAX_VISIBLE_NESTED_REPLIES = 3;

      const BAND_GOALS = [
        "N/A",
        "5.0",
        "5.5",
        "6.0",
        "6.5",
        "7.0",
        "7.5",
        "8.0",
        "8.5",
        "9.0",
      ];
      const PREP_STATUSES = [
        "New Learner",
        "Beginner",
        "Intermediate",
        "Advanced",
        "Ready for Test",
        "Test Taken",
      ];
      const COUNTRIES = [
        "Afghanistan",
        "Albania",
        "Algeria",
        "Andorra",
        "Angola",
        "Antigua and Barbuda",
        "Argentina",
        "Armenia",
        "Australia",
        "Austria",
        "Azerbaijan",
        "Bahamas",
        "Bahrain",
        "Bangladesh",
        "Barbados",
        "Belarus",
        "Belgium",
        "Belize",
        "Benin",
        "Bhutan",
        "Bolivia",
        "Bosnia and Herzegovina",
        "Botswana",
        "Brazil",
        "Brunei",
        "Bulgaria",
        "Burkina Faso",
        "Burundi",
        "Cabo Verde",
        "Cambodia",
        "Cameroon",
        "Canada",
        "Central African Republic",
        "Chad",
        "Chile",
        "China",
        "Colombia",
        "Comoros",
        "Congo (Brazzaville)",
        "Congo (Kinshasa)",
        "Costa Rica",
        "Croatia",
        "Cuba",
        "Cyprus",
        "Czechia",
        "Denmark",
        "Djibouti",
        "Dominica",
        "Dominican Republic",
        "Ecuador",
        "Egypt",
        "El Salvador",
        "Equatorial Guinea",
        "Eritrea",
        "Estonia",
        "Eswatini",
        "Ethiopia",
        "Fiji",
        "Finland",
        "France",
        "Gabon",
        "Gambia",
        "Georgia",
        "Germany",
        "Ghana",
        "Greece",
        "Grenada",
        "Guatemala",
        "Guinea",
        "Guinea-Bissau",
        "Guyana",
        "Haiti",
        "Honduras",
        "Hungary",
        "Iceland",
        "India",
        "Indonesia",
        "Iran",
        "Iraq",
        "Ireland",
        "Israel",
        "Italy",
        "Ivory Coast",
        "Jamaica",
        "Japan",
        "Jordan",
        "Kazakhstan",
        "Kenya",
        "Kiribati",
        "Kosovo",
        "Kuwait",
        "Kyrgyzstan",
        "Laos",
        "Latvia",
        "Lebanon",
        "Lesotho",
        "Liberia",
        "Libya",
        "Liechtenstein",
        "Lithuania",
        "Luxembourg",
        "Madagascar",
        "Malawi",
        "Malaysia",
        "Maldives",
        "Mali",
        "Malta",
        "Marshall Islands",
        "Mauritania",
        "Mauritius",
        "Mexico",
        "Micronesia",
        "Moldova",
        "Monaco",
        "Mongolia",
        "Montenegro",
        "Morocco",
        "Mozambique",
        "Myanmar",
        "Namibia",
        "Nauru",
        "Nepal",
        "Netherlands",
        "New Zealand",
        "Nicaragua",
        "Niger",
        "Nigeria",
        "North Korea",
        "North Macedonia",
        "Norway",
        "Oman",
        "Pakistan",
        "Palau",
        "Palestine",
        "Panama",
        "Papua New Guinea",
        "Paraguay",
        "Peru",
        "Philippines",
        "Poland",
        "Portugal",
        "Qatar",
        "Romania",
        "Russia",
        "Rwanda",
        "Saint Kitts and Nevis",
        "Saint Lucia",
        "Saint Vincent and the Grenadines",
        "Samoa",
        "San Marino",
        "Sao Tome and Principe",
        "Saudi Arabia",
        "Senegal",
        "Serbia",
        "Seychelles",
        "Sierra Leone",
        "Singapore",
        "Slovakia",
        "Slovenia",
        "Solomon Islands",
        "Somalia",
        "South Africa",
        "South Korea",
        "South Sudan",
        "Spain",
        "Sri Lanka",
        "Sudan",
        "Suriname",
        "Sweden",
        "Switzerland",
        "Syria",
        "Taiwan",
        "Tajikistan",
        "Tanzania",
        "Thailand",
        "Timor-Leste",
        "Togo",
        "Tonga",
        "Trinidad and Tobago",
        "Tunisia",
        "Turkey",
        "Turkmenistan",
        "Tuvalu",
        "Uganda",
        "Ukraine",
        "United Arab Emirates",
        "United Kingdom",
        "United States",
        "Uruguay",
        "Uzbekistan",
        "Vanuatu",
        "Vatican City",
        "Venezuela",
        "Vietnam",
        "Yemen",
        "Zambia",
        "Zimbabwe",
      ];
      const IELTS_EXPERIENCES = [
        "First time taking IELTS",
        "Taken multiple times",
        "Preparing for the first time",
        "Already taken and passed",
      ];

      // Sample Badge Data (for UI display purposes)
      const ALL_BADGES = [
        {
          id: "first_post",
          name: "First Post",
          description: "Created your first forum post!",
          icon: "✍️",
        },
        {
          id: "helpful_member",
          name: "Helpful Member",
          description: "Received 10 upvotes on your posts/comments.",
          icon: "🌟",
        },
        {
          id: "ielts_master",
          name: "IELTS Master",
          description: "Achieved Band 9 goal.",
          icon: "🏆",
        },
        {
          id: "daily_streak",
          name: "Daily Contributor",
          description: "Posted or commented for 3 consecutive days.",
          icon: "🔥",
        },
        {
          id: "speaking_expert",
          name: "Speaking Expert",
          description: "Contributed significantly to Speaking topics.",
          icon: "🗣️",
        },
        {
          id: "writing_guru",
          name: "Writing Guru",
          description: "Contributed significantly to Writing topics.",
          icon: "📝",
        },
        {
          id: "resolved_solver",
          name: "Problem Solver",
          description: "Marked 5 of your questions as resolved.",
          icon: "✅",
        },
      ];

      // --- DOM Elements Cache ---
      const elements = {};

      // --- Helper Icons (Font Awesome classes) ---
      const Icons = {
        Sun: `<i class="fas fa-sun"></i>`,
        Moon: `<i class="fas fa-moon"></i>`,
        Plus: `<i class="fas fa-plus"></i>`,
        MessageCircleMore: `<i class="fas fa-comments"></i>`, // Changed to fa-comments
        Search: `<i class="fas fa-search"></i>`,
        ChevronDown: `<i class="fas fa-chevron-down"></i>`,
        ChevronRight: `<i class="fas fa-chevron-right"></i>`, // Added for collapsed replies
        User: `<i class="fas fa-user-circle"></i>`, // Changed to fa-user-circle for more realism
        Award: `<i class="fas fa-award"></i>`,
        Zap: `<i class="fas fa-bolt"></i>`, // Changed to fa-bolt for AI/power
        CheckCircle: `<i class="fas fa-check-circle"></i>`,
        ThumbsUp: `<i class="far fa-thumbs-up"></i>`, // Using 'far' for outlined icon
        ThumbsUpSolid: `<i class="fas fa-thumbs-up"></i>`, // Using 'fas' for filled icon
        ThumbsDown: `<i class="far fa-thumbs-down"></i>`, // Using 'far' for outlined icon
        ThumbsDownSolid: `<i class="fas fa-thumbs-down"></i>`, // Using 'fas' for filled icon
        ArrowLeft: `<i class="fas fa-arrow-left"></i>`,
        Menu: `<i class="fas fa-bars"></i>`,
        X: `<i class="fas fa-times"></i>`,
        Target: `<i class="fas fa-bullseye"></i>`, // Changed to fa-bullseye for target
        Activity: `<i class="fas fa-chart-line"></i>`, // Changed to fa-chart-line for activity/progress
        Edit: `<i class="fas fa-edit"></i>`, // Edit icon
        Save: `<i class="fas fa-save"></i>`, // Save icon
        Cancel: `<i class="fas fa-times-circle"></i>`, // Cancel icon
        Link: `<i class="fas fa-external-link-alt"></i>`, // Link icon
        Trash: `<i class="fas fa-trash-alt"></i>`, // Trash/Delete icon
        Star: `<i class="fas fa-star"></i>`, // For a "Following" button or similar
        Users: `<i class="fas fa-users"></i>`, // For a "Following Feed"
        Filter: `<i class="fas fa-filter"></i>`, // For general filter icon
        Heart: `<i class="fas fa-heart"></i>`, // For "For You" or trending
        UserPlus: `<i class="fas fa-user-plus"></i>`, // For follow button
        UserCheck: `<i class="fas fa-user-check"></i>`, // For unfollow button
      };

      // --- Core Functions ---

      /**
       * Displays a transient toast notification to the user.
       * @param {string} message The message to display.
       * @param {'success'|'error'|'info'} type The type of notification (influences styling).
       * @param {number} duration The duration in milliseconds before the toast disappears.
       */
      function showToast(message, type, duration = 3000) {
        const toastContainer = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = `
                ${
                  type === "success"
                    ? '<i class="fas fa-check-circle"></i>'
                    : ""
                }
                ${
                  type === "error"
                    ? '<i class="fas fa-exclamation-triangle"></i>'
                    : ""
                }
                ${type === "info" ? '<i class="fas fa-info-circle"></i>' : ""}
                <span>${message}</span>
            `;
        toastContainer.appendChild(toast);

        // Trigger reflow to ensure CSS transition plays
        void toast.offsetWidth;

        toast.classList.add("show");

        setTimeout(() => {
          toast.classList.remove("show");
          toast.addEventListener("transitionend", () => toast.remove());
        }, duration);
      }

      function updateThemeClasses() {
        const body = document.body;
        if (appState.theme === "dark") {
          body.classList.remove("light");
          body.classList.add("dark");
          elements.header.classList.remove("bg-white", "text-gray-800");
          elements.header.classList.add("bg-gray-800", "text-white");
          elements.sidebar.classList.remove("bg-white", "text-gray-800");
          elements.sidebar.classList.add("bg-gray-900", "text-white");
        } else {
          body.classList.remove("dark");
          body.classList.add("light");
          elements.header.classList.remove("bg-gray-800", "text-white");
          elements.header.classList.add("bg-white", "text-gray-800");
          elements.sidebar.classList.remove("bg-gray-900", "text-white");
          elements.sidebar.classList.add("bg-white", "text-gray-800");
        }

        // Update modal theme
        const modalContent = document.getElementById("ai-modal-content");
        const modalCloseBtn = document.getElementById("ai-modal-close-btn");
        const modalTitle = document.getElementById("ai-modal-title");
        const modalBody = document.getElementById("ai-modal-body");

        if (modalContent && modalTitle && modalBody && modalCloseBtn) {
          if (appState.theme === "dark") {
            modalContent.classList.remove("bg-white");
            modalContent.classList.add("bg-gray-800");
            modalTitle.classList.remove("text-gray-900");
            modalTitle.classList.add("text-white");
            modalBody.classList.remove("text-gray-700");
            modalBody.classList.add("text-gray-300");
            modalCloseBtn.classList.remove("hover:bg-gray-100");
            modalCloseBtn.classList.add("hover:bg-gray-700");
          } else {
            modalContent.classList.remove("bg-gray-800");
            modalContent.classList.add("bg-white");
            modalTitle.classList.remove("text-white");
            modalTitle.classList.add("text-gray-900");
            modalBody.classList.remove("text-gray-300");
            modalBody.classList.add("text-gray-700");
            modalCloseBtn.classList.remove("hover:bg-gray-700");
            modalCloseBtn.classList.add("hover:bg-gray-100");
          }
        }
      }

      function toggleTheme() {
        appState.theme = appState.theme === "light" ? "dark" : "light";
        updateThemeClasses();
        renderApp(); // Re-render to apply theme to dynamic content
      }

      /**
       * Formats a Firestore Timestamp or Date object into a Facebook-like relative time string.
       * @param {firebase.firestore.Timestamp | Date} timestamp The timestamp or date object.
       * @returns {string} The formatted relative time string.
       */
      function formatRelativeTime(timestamp) {
        if (!timestamp) return "N/A";

        const date = timestamp.toDate ? timestamp.toDate() : timestamp; // Convert Firestore Timestamp to Date object
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 60) {
          return seconds <= 0 ? "Just now" : `${seconds}s ago`;
        }

        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) {
          return `${minutes}m ago`;
        }

        const hours = Math.floor(minutes / 60);
        if (hours < 24) {
          return `${hours}h ago`;
        }

        const yesterday = new Date(now);
        yesterday.setDate(now.getDate() - 1);
        if (
          date.getDate() === yesterday.getDate() &&
          date.getMonth() === yesterday.getMonth() &&
          date.getFullYear() === yesterday.getFullYear()
        ) {
          return `Yesterday at ${new Intl.DateTimeFormat("en-US", {
            hour: "numeric",
            minute: "numeric",
            hour12: true,
          }).format(date)}`;
        }

        // Within the current year
        if (date.getFullYear() === now.getFullYear()) {
          return new Intl.DateTimeFormat("en-US", {
            month: "short",
            day: "numeric",
            hour: "numeric",
            minute: "numeric",
            hour12: true,
          }).format(date);
        }

        // Older than current year
        return new Intl.DateTimeFormat("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        }).format(date);
      }

      /**
       * Navigates to a new view in the application.
       * @param {string} newView The name of the new view ('home', 'postDetail', 'createPost', 'profile').
       * @param {object} [options={}] Optional parameters for the new view.
       * @param {object} [options.post] The post object if navigating to 'postDetail'.
       * @param {string} [options.category] The category to filter by if navigating to 'home'.
       * @param {string} [options.subCategory] The subcategory to filter by if navigating to 'home'.
       * @param {string} [options.targetUserId] The ID of the user whose profile is to be viewed if navigating to 'profile'.
       * @param {'latest'|'forYou'|'following'} [options.homeFeedType] The type of feed to show if navigating to 'home'.
       */
      function navigateTo(newView, options = {}) {
        appState.view = newView;
        appState.selectedPost = options.post || null;
        appState.activeCategory = options.category || null;
        appState.activeSubCategory = options.subCategory || null;
        appState.showSidebar = false; // Close sidebar on navigation

        // Update homeFeedType only if navigating to 'home' and a new type is provided
        if (newView === "home" && options.homeFeedType) {
          appState.homeFeedType = options.homeFeedType;
        } else if (newView !== "home") {
          // Reset homeFeedType when navigating away from home, or keep previous setting if returning to generic home
          // We can decide to always reset to 'latest' if desired, but for now, it's sticky
        }

        // Set the viewed profile ID. If navigating to 'profile' and targetUserId is provided, use it.
        // Otherwise, if it's 'profile' view without a target, assume current user.
        // For other views, clear viewedProfile to ensure no stale data.
        if (newView === "profile") {
          appState.viewedProfile = options.targetUserId || appState.userId;
        } else {
          appState.viewedProfile = null;
        }

        // Reset visible comment/reply counts and editing state when navigating away from post detail
        if (newView !== "postDetail") {
          appState.visibleCommentsCount = MAX_VISIBLE_TOP_LEVEL_COMMENTS;
          appState.visibleRepliesCount = {};
          appState.editingPostId = null;
          appState.editingCommentId = null;
          appState.expandedReplies = {}; // Reset expanded replies state
        }
        // Reset profile editing state if navigating away from profile (or to a different profile)
        if (
          newView !== "profile" ||
          (newView === "profile" && options.targetUserId !== appState.userId)
        ) {
          appState.editingProfile = false;
        }

        renderMainContent();
        renderSidebar(); // Update sidebar visibility
        // Ensure posts are re-fetched with new filters if navigating to home
        if (appState.isAuthReady) {
          // No need to re-run setupFirestoreListeners for posts now, as filtering is client-side
          // The onSnapshot listener for posts will automatically update appState.posts
          // Then renderPostList will filter based on appState.activeCategory/SubCategory
          // But we need to ensure comments listener is re-setup if postId changes
          if (appState.commentsUnsubscribe) {
            appState.commentsUnsubscribe(); // Unsubscribe old comments listener
            setupFirestoreListeners(); // Re-subscribe with correct post ID if needed, though for ALL comments this is not necessary
          }
        }
      }

      async function addPost(newPostData) {
        if (!appState.db || !appState.userId || !appState.userProfile) {
          console.error("Database, user ID or user profile not ready.");
          showToast(
            "Error: User not authenticated or profile missing.",
            "error"
          );
          return;
        }

        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          await addDoc(
            collection(appState.db, `artifacts/${appId}/public/data/posts`),
            {
              ...newPostData,
              authorId: appState.userId,
              authorName: appState.userProfile.name,
              createdAt: serverTimestamp(),
              upvotes: 0,
              downvotes: 0,
              upvotedBy: [],
              downvotedBy: [],
              isResolved: false,
              tags: [],
              imageUrl: null,
              videoUrl: null,
            }
          );
          console.log("Post added successfully!");
          showToast("Post created successfully!", "success");
          navigateTo("home");
        } catch (e) {
          console.error("Error adding post: ", e);
          showToast("Error creating post. Check console.", "error");
        }
      }

      async function updatePost(postId, updatedData) {
        if (!appState.db) return;
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          await updateDoc(
            doc(appState.db, `artifacts/${appId}/public/data/posts`, postId),
            updatedData
          );
          console.log("Post updated successfully!");
          showToast("Post updated successfully!", "success");
          appState.editingPostId = null; // Exit editing mode
          renderPostDetail(); // Re-render to show updated post
        } catch (e) {
          console.error("Error updating post: ", e);
          showToast("Error updating post. Check console.", "error");
        }
      }

      async function deletePost(postId) {
        if (!appState.db || !appState.userId) {
          showToast("Error: User not authenticated.", "error");
          return;
        }

        showConfirmationModal(
          "Delete Post",
          "Are you sure you want to delete this post and all its comments?",
          async () => {
            try {
              const appId =
                typeof __app_id !== "undefined"
                  ? __app_id
                  : "ielts-mahir-community-forum";
              const batch = writeBatch(appState.db);

              // Delete the post document
              const postRef = doc(
                appState.db,
                `artifacts/${appId}/public/data/posts`,
                postId
              );
              batch.delete(postRef);

              // Query and delete all comments associated with the post
              const commentsQuery = query(
                collection(
                  appState.db,
                  `artifacts/${appId}/public/data/comments`
                ),
                where("postId", "==", postId)
              );
              const commentsSnapshot = await getDocs(commentsQuery);
              commentsSnapshot.forEach((commentDoc) => {
                batch.delete(commentDoc.ref);
              });

              await batch.commit();
              console.log("Post and associated comments deleted successfully!");
              showToast("Post and comments deleted successfully!", "success");
              navigateTo("home"); // Go back to home page after deletion
            } catch (e) {
              console.error("Error deleting post and comments: ", e);
              showToast(
                "Error deleting post. Check console for details (e.g., permissions).",
                "error"
              );
            }
          }
        );
      }

      async function addComment(postId, content, parentId = null, depth = 0) {
        if (
          !appState.db ||
          !appState.userId ||
          !appState.userProfile ||
          !content.trim()
        ) {
          console.error(
            "Database, user ID, user profile, or comment content not ready."
          );
          showToast(
            "Error: User not authenticated or comment content empty.",
            "error"
          );
          return;
        }
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          await addDoc(
            collection(appState.db, `artifacts/${appId}/public/data/comments`),
            {
              postId: postId,
              authorId: appState.userId,
              authorName: appState.userProfile.name,
              content: content,
              createdAt: serverTimestamp(),
              parentId: parentId,
              depth: depth, // Keep depth for potential future use or debugging, though not for direct rendering
              upvotes: 0,
              downvotes: 0,
              upvotedBy: [],
              downvotedBy: [],
            }
          );
          console.log("Comment added successfully!");
          showToast("Comment added successfully!", "success");
        } catch (e) {
          console.error("Error adding comment: ", e);
          showToast("Error adding comment. Check console.", "error");
        }
      }

      async function updateComment(commentId, updatedContent) {
        if (!appState.db) return;
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          await updateDoc(
            doc(
              appState.db,
              `artifacts/${appId}/public/data/comments`,
              commentId
            ),
            {
              content: updatedContent,
            }
          );
          console.log("Comment updated successfully!");
          showToast("Comment updated successfully!", "success");
          appState.editingCommentId = null; // Exit editing mode
          renderComments(appState.selectedPost.id); // Re-render comments
        } catch (e) {
          console.error("Error updating comment: ", e);
          showToast("Error updating comment. Check console.", "error");
        }
      }

      async function deleteComment(commentId, postId) {
        if (!appState.db || !appState.userId) {
          showToast("Error: User not authenticated.", "error");
          return;
        }

        showConfirmationModal(
          "Delete Comment",
          "Are you sure you want to delete this comment and its replies?",
          async () => {
            try {
              const appId =
                typeof __app_id !== "undefined"
                  ? __app_id
                  : "ielts-mahir-community-forum";
              const batch = writeBatch(appState.db);

              // Delete the comment document itself
              const commentRef = doc(
                appState.db,
                `artifacts/${appId}/public/data/comments`,
                commentId
              );
              batch.delete(commentRef);

              // Query and delete all replies to this comment (recursively not needed, just direct children)
              // The Firestore listener for comments will re-evaluate and update the UI accordingly.
              const nestedRepliesQuery = query(
                collection(
                  appState.db,
                  `artifacts/${appId}/public/data/comments`
                ),
                where("parentId", "==", commentId)
              );
              const nestedRepliesSnapshot = await getDocs(nestedRepliesQuery);
              nestedRepliesSnapshot.forEach((nestedReplyDoc) => {
                batch.delete(nestedReplyDoc.ref);
              });

              await batch.commit();
              console.log("Comment and nested replies deleted successfully!");
              showToast("Comment deleted successfully!", "success");
              // Re-render comments for the current post to reflect changes
              renderComments(postId);
            } catch (e) {
              console.error("Error deleting comment and nested replies: ", e);
              showToast(
                "Error deleting comment. Check console for details (e.g., permissions).",
                "error"
              );
            }
          }
        );
      }

      async function togglePostResolved(postId, isResolved) {
        if (!appState.db) return;
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          await updateDoc(
            doc(appState.db, `artifacts/${appId}/public/data/posts`, postId),
            {
              isResolved: !isResolved,
            }
          );
          console.log("Post resolved status updated.");
          showToast("Post resolved status updated!", "info");
        } catch (e) {
          console.error("Error updating post resolved status: ", e);
          showToast("Error updating resolved status. Check console.", "error");
        }
      }

      async function updatePostVotes(postId, type) {
        if (!appState.db || !appState.userId) return;
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          const postRef = doc(
            appState.db,
            `artifacts/${appId}/public/data/posts`,
            postId
          );
          const postSnap = await getDoc(postRef);
          if (postSnap.exists()) {
            const currentData = postSnap.data();
            let newUpvotes = currentData.upvotes || 0;
            let newDownvotes = currentData.downvotes || 0;
            let upvotedBy = currentData.upvotedBy || [];
            let downvotedBy = currentData.downvotedBy || [];

            const userAlreadyUpvoted = upvotedBy.includes(appState.userId);
            const userAlreadyDownvoted = downvotedBy.includes(appState.userId);

            let authorReputationChange = 0;

            if (type === "up") {
              if (userAlreadyUpvoted) {
                // User clicked upvote again, so remove upvote
                upvotedBy = upvotedBy.filter((id) => id !== appState.userId);
                newUpvotes--;
                authorReputationChange = -1; // Lose 1 reputation for removing upvote
              } else {
                // User upvoted
                upvotedBy = [...upvotedBy, appState.userId];
                newUpvotes++;
                authorReputationChange = 1; // Gain 1 reputation for upvote
                // If previously downvoted, remove downvote
                if (userAlreadyDownvoted) {
                  downvotedBy = downvotedBy.filter(
                    (id) => id !== appState.userId
                  );
                  newDownvotes--;
                  authorReputationChange += 1; // Gain 1 more reputation for negating a downvote
                }
              }
            } else if (type === "down") {
              if (userAlreadyDownvoted) {
                // User clicked downvote again, so remove downvote
                downvotedBy = downvotedBy.filter(
                  (id) => id !== appState.userId
                );
                newDownvotes--;
                authorReputationChange = 1; // Gain 1 reputation for removing downvote
              } else {
                downvotedBy = [...downvotedBy, appState.userId];
                newDownvotes++;
                authorReputationChange = -1; // Lose 1 reputation for downvote
                // If previously upvoted, remove upvote
                if (userAlreadyUpvoted) {
                  upvotedBy = upvotedBy.filter((id) => id !== appState.userId);
                  newUpvotes--;
                  authorReputationChange += -1; // Lose 1 more reputation for negating an upvote
                }
              }
            }

            await updateDoc(postRef, {
              upvotes: newUpvotes,
              downvotes: newDownvotes,
              upvotedBy: upvotedBy,
              downvotedBy: downvotedBy,
            });

            // Update author's reputation only if there was a change and it's not the author themselves voting
            if (
              authorReputationChange !== 0 &&
              currentData.authorId !== appState.userId
            ) {
              const authorProfileRef = doc(
                appState.db,
                `artifacts/${appId}/users/${currentData.authorId}/userProfile/profile`
              );
              const authorProfileSnap = await getDoc(authorProfileRef);
              if (authorProfileSnap.exists()) {
                const currentReputation =
                  authorProfileSnap.data().reputation || 0;
                await updateDoc(authorProfileRef, {
                  reputation: Math.max(
                    0,
                    currentReputation + authorReputationChange
                  ), // Reputation cannot go below 0
                });
                // Show a toast about reputation change if needed
                // showToast(`Reputation for ${currentData.authorName} changed by ${authorReputationChange}`, 'info');
              }
            }
            showToast("Vote updated!", "info");
          }
        } catch (e) {
          console.error("Error updating post votes: ", e);
          showToast("Error updating vote. Check console.", "error");
        }
      }

      async function updateCommentVotes(commentId, type) {
        if (!appState.db || !appState.userId) return;
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          const commentRef = doc(
            appState.db,
            `artifacts/${appId}/public/data/comments`,
            commentId
          );
          const commentSnap = await getDoc(commentRef);
          if (commentSnap.exists()) {
            const currentData = commentSnap.data();
            let newUpvotes = currentData.upvotes || 0;
            let newDownvotes = currentData.downvotes || 0;
            let upvotedBy = currentData.upvotedBy || [];
            let downvotedBy = currentData.downvotedBy || [];

            const userAlreadyUpvoted = upvotedBy.includes(appState.userId);
            const userAlreadyDownvoted = downvotedBy.includes(appState.userId);

            let authorReputationChange = 0;

            if (type === "up") {
              if (userAlreadyUpvoted) {
                upvotedBy = upvotedBy.filter((id) => id !== appState.userId);
                newUpvotes--;
                authorReputationChange = -1;
              } else {
                upvotedBy = [...upvotedBy, appState.userId];
                newUpvotes++;
                authorReputationChange = 1;
                if (userAlreadyDownvoted) {
                  downvotedBy = downvotedBy.filter(
                    (id) => id !== appState.userId
                  );
                  newDownvotes--;
                  authorReputationChange += 1;
                }
              }
            } else if (type === "down") {
              if (userAlreadyDownvoted) {
                downvotedBy = downvotedBy.filter(
                  (id) => id !== appState.userId
                );
                newDownvotes--;
                authorReputationChange = 1;
              } else {
                downvotedBy = [...downvotedBy, appState.userId];
                newDownvotes++;
                authorReputationChange = -1;
                if (userAlreadyUpvoted) {
                  upvotedBy = upvotedBy.filter((id) => id !== appState.userId);
                  newUpvotes--;
                  authorReputationChange += -1;
                }
              }
            }

            await updateDoc(commentRef, {
              upvotes: newUpvotes,
              downvotes: newDownvotes,
              upvotedBy: upvotedBy,
              downvotedBy: downvotedBy,
            });

            // Update author's reputation
            if (
              authorReputationChange !== 0 &&
              currentData.authorId !== appState.userId
            ) {
              const authorProfileRef = doc(
                appState.db,
                `artifacts/${appId}/users/${currentData.authorId}/userProfile/profile`
              );
              const authorProfileSnap = await getDoc(authorProfileRef);
              if (authorProfileSnap.exists()) {
                const currentReputation =
                  authorProfileSnap.data().reputation || 0;
                await updateDoc(authorProfileRef, {
                  reputation: Math.max(
                    0,
                    currentReputation + authorReputationChange
                  ),
                });
              }
            }
            showToast("Comment vote updated!", "info");
          }
        } catch (e) {
          console.error("Error updating comment votes: ", e);
          showToast("Error updating comment vote. Check console.", "error");
        }
      }

      /**
       * Toggles follow status for a target user.
       * @param {string} targetUserId The ID of the user to follow/unfollow.
       */
      async function toggleFollow(targetUserId) {
        if (!appState.db || !appState.userId || !appState.userProfile) {
          showToast("Please sign in to follow users.", "info");
          return;
        }
        if (targetUserId === appState.userId) {
          showToast("You cannot follow yourself.", "info");
          return;
        }

        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          const currentUserProfileRef = doc(
            appState.db,
            `artifacts/${appId}/users/${appState.userId}/userProfile/profile`
          );

          let updatedFollowingArray;
          let isCurrentlyFollowing =
            appState.userProfile.following &&
            appState.userProfile.following.includes(targetUserId);

          if (isCurrentlyFollowing) {
            // Unfollow
            updatedFollowingArray = appState.userProfile.following.filter(
              (id) => id !== targetUserId
            );
            showToast(
              `Unfollowed ${
                appState.allUsersProfiles.find((p) => p.userId === targetUserId)
                  ?.name || "user"
              }.`,
              "info"
            );
          } else {
            // Follow
            updatedFollowingArray = [
              ...(appState.userProfile.following || []),
              targetUserId,
            ];
            showToast(
              `Following ${
                appState.allUsersProfiles.find((p) => p.userId === targetUserId)
                  ?.name || "user"
              }!`,
              "success"
            );
          }

          // Update Firestore
          await updateDoc(currentUserProfileRef, {
            following: updatedFollowingArray,
          });

          // Update local appState immediately
          appState.userProfile.following = updatedFollowingArray;

          // Re-render the main content to update all follow buttons
          renderMainContent();
        } catch (e) {
          console.error("Error toggling follow:", e);
          showToast("Error toggling follow. Check console.", "error");
        }
      }

      async function callGeminiAI(prompt, targetElementId) {
        const modalBody = document.getElementById("ai-modal-body");
        modalBody.innerHTML = `<div class="flex flex-col justify-center items-center h-24">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
                <p class="mt-3 ${
                  appState.theme === "light" ? "text-gray-700" : "text-gray-300"
                }">Generating AI response...</p>
            </div>`;
        document.getElementById("ai-modal-overlay").classList.remove("hidden");

        try {
          let chatHistory = [];
          chatHistory.push({ role: "user", parts: [{ text: prompt }] });
          const payload = { contents: chatHistory };
          // IMPORTANT: Updated API key as per user's correction
          const apiKey = "AIzaSyCsdeFOJrU43BZmnRP5WD1pm80fZH1cxN4";
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          if (
            result.candidates &&
            result.candidates.length > 0 &&
            result.candidates[0].content &&
            result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0
          ) {
            const text = result.candidates[0].content.parts[0].text;
            modalBody.innerHTML = `<p class="font-normal whitespace-pre-wrap ${
              appState.theme === "light" ? "text-gray-700" : "text-gray-300"
            }">${text}</p>`;
          } else {
            modalBody.innerHTML = `<p class="font-normal ${
              appState.theme === "light" ? "text-red-600" : "text-red-400"
            }">Failed to get AI response: Unexpected structure.</p>`;
            console.error(
              "Gemini API: Unexpected response structure or content missing.",
              result
            );
          }
        } catch (error) {
          modalBody.innerHTML = `<p class="font-normal ${
            appState.theme === "light" ? "text-red-600" : "text-red-400"
          }">Error calling AI. Please try again.</p>`;
          console.error("Error calling Gemini API:", error);
        }
      }

      // --- Custom Confirmation Modal ---
      function showConfirmationModal(title, message, onConfirm) {
        const modalOverlay = elements.aiModalOverlay; // Reusing AI modal for confirmation
        const modalContent = document.getElementById("ai-modal-content");
        const modalTitle = document.getElementById("ai-modal-title");
        const modalBody = document.getElementById("ai-modal-body");

        modalTitle.textContent = title;
        modalBody.innerHTML = `
                <p class="mb-4 ${
                  appState.theme === "light" ? "text-gray-700" : "text-gray-300"
                }">${message}</p>
                <div class="flex justify-end gap-3">
                    <button id="confirm-cancel-btn" class="px-4 py-2 rounded-xl text-sm font-semibold ${
                      appState.theme === "light"
                        ? "bg-gray-300 text-gray-800 hover:bg-gray-400"
                        : "bg-gray-600 text-white hover:bg-gray-700"
                    }">Cancel</button>
                    <button id="confirm-ok-btn" class="px-4 py-2 rounded-xl text-sm font-semibold bg-red-600 text-white hover:bg-red-700">Delete</button>
                </div>
            `;
        modalOverlay.classList.remove("hidden");

        document.getElementById("confirm-ok-btn").onclick = () => {
          modalOverlay.classList.add("hidden");
          onConfirm();
        };
        document.getElementById("confirm-cancel-btn").onclick = () => {
          modalOverlay.classList.add("hidden");
        };
        // Close button on modal header
        elements.aiModalCloseBtn.onclick = () => {
          modalOverlay.classList.add("hidden");
        };
      }

      // --- Update User Profile Function ---
      async function updateUserProfile(updatedData) {
        if (!appState.db || !appState.userId) {
          showToast("Error: User not authenticated.", "error");
          return;
        }
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          const userRef = doc(
            appState.db,
            `artifacts/${appId}/users/${appState.userId}/userProfile/profile`
          );

          // Update user profile document
          await updateDoc(userRef, updatedData);

          // If the name was updated, update all posts by this user
          if (
            updatedData.name &&
            updatedData.name !== appState.userProfile.name
          ) {
            const batch = writeBatch(appState.db);
            const userPostsQuery = query(
              collection(appState.db, `artifacts/${appId}/public/data/posts`),
              where("authorId", "==", appState.userId)
            );
            const userPostsSnapshot = await getDocs(userPostsQuery);

            userPostsSnapshot.forEach((postDoc) => {
              batch.update(postDoc.ref, { authorName: updatedData.name });
            });

            // Also update comments by this user
            const userCommentsQuery = query(
              collection(
                appState.db,
                `artifacts/${appId}/public/data/comments`
              ),
              where("authorId", "==", appState.userId)
            );
            const userCommentsSnapshot = await getDocs(userCommentsQuery);

            userCommentsSnapshot.forEach((commentDoc) => {
              batch.update(commentDoc.ref, { authorName: updatedData.name });
            });

            await batch.commit();
            showToast("Posts and comments updated with new name!", "info");
          }

          showToast("Profile updated successfully!", "success");
          appState.editingProfile = false; // Exit editing mode
          // Re-fetch user profile to update appState with the latest (including implicitly updated name for posts/comments)
          const userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            appState.userProfile = userSnap.data();
          }
          // Ensure allUsersProfiles is updated with the latest current user profile
          const index = appState.allUsersProfiles.findIndex(
            (p) => p.userId === appState.userId
          );
          if (index > -1) {
            appState.allUsersProfiles[index] = {
              ...appState.userProfile,
              userId: appState.userId,
            };
          } else {
            appState.allUsersProfiles.push({
              ...appState.userProfile,
              userId: appState.userId,
            });
          }
          renderProfilePage(appState.userId); // Re-render current user's profile view
        } catch (e) {
          console.error("Error updating user profile or posts:", e);
          showToast("Error updating profile. Check console.", "error");
        }
      }

      // --- Render Functions for Views ---

      function renderRightSidebar() {
        const rightSidebar = document.getElementById("right-sidebar");
        if (!rightSidebar) return; // Only render if sidebar exists (i.e., on larger screens)

        // Clear existing content and set base classes for consistency
        rightSidebar.innerHTML = "";
        rightSidebar.className = `w-64 ml-8 p-6 hidden lg:block rounded-2xl shadow-lg ${
          appState.theme === "light" ? "bg-white" : "bg-gray-800"
        } flex-shrink-0`;

        // Search Bar Section
        const searchSection = document.createElement("div");
        searchSection.className = `mb-8 p-4 rounded-xl ${
          appState.theme === "light" ? "bg-gray-50" : "bg-gray-700"
        } shadow-inner`;
        searchSection.innerHTML = `
                <h3 class="text-lg font-semibold mb-3 ${
                  appState.theme === "light" ? "text-gray-800" : "text-white"
                }">
                    <i class="fas fa-search mr-2"></i> Search Forum
                </h3>
                <div class="relative">
                    <input type="text" id="sidebar-search-input" placeholder="Search posts and people..." class="w-full p-2.5 pl-10 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                      appState.theme === "light"
                        ? "border-gray-200 bg-white text-gray-900"
                        : "border-gray-600 bg-gray-800 text-white"
                    } transition-colors">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 ${
                      appState.theme === "light"
                        ? "text-gray-400"
                        : "text-gray-300"
                    }">${Icons.Search}</span>
                </div>
                <div id="sidebar-search-results" class="mt-3 max-h-60 overflow-y-auto space-y-2 text-sm"></div>
            `;
        rightSidebar.appendChild(searchSection);

        const searchInput = document.getElementById("sidebar-search-input");
        const searchResultsContainer = document.getElementById(
          "sidebar-search-results"
        );

        let searchTimeout;
        searchInput.oninput = () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            const query = searchInput.value.toLowerCase().trim();
            searchResultsContainer.innerHTML = ""; // Clear previous results

            if (query.length > 0) {
              // Search for posts
              const matchingPosts = appState.posts
                .filter(
                  (post) =>
                    post.title.toLowerCase().includes(query) ||
                    post.content.toLowerCase().includes(query)
                )
                .slice(0, 3); // Limit to top 3 posts

              // Search for people
              const matchingUsers = appState.allUsersProfiles
                .filter(
                  (user) =>
                    user.name.toLowerCase().includes(query) ||
                    (user.bio && user.bio.toLowerCase().includes(query)) ||
                    user.userId.toLowerCase().includes(query) // Can also search by user ID prefix
                )
                .slice(0, 3); // Limit to top 3 users

              if (matchingPosts.length > 0) {
                const postsHeader = document.createElement("h4");
                postsHeader.className = `font-semibold text-base mb-2 mt-3 ${
                  appState.theme === "light" ? "text-gray-800" : "text-white"
                }`;
                postsHeader.textContent = "Posts";
                searchResultsContainer.appendChild(postsHeader);

                matchingPosts.forEach((post) => {
                  const resultItem = document.createElement("div");
                  resultItem.className = `p-2 rounded-lg cursor-pointer ${
                    appState.theme === "light"
                      ? "hover:bg-blue-50 text-gray-700"
                      : "hover:bg-blue-900 text-gray-200"
                  } transition-colors`;
                  resultItem.innerHTML = `
                                    <div class="font-medium ${
                                      appState.theme === "light"
                                        ? "text-blue-700"
                                        : "text-blue-300"
                                    } line-clamp-1">${post.title}</div>
                                    <div class="text-xs ${
                                      appState.theme === "light"
                                        ? "text-gray-600"
                                        : "text-gray-400"
                                    } line-clamp-2">${post.content}</div>
                                `;
                  resultItem.onclick = (e) => {
                    e.stopPropagation(); // Prevent search input from losing focus immediately
                    navigateTo("postDetail", { post: post });
                  };
                  searchResultsContainer.appendChild(resultItem);
                });
              }

              if (matchingUsers.length > 0) {
                const peopleHeader = document.createElement("h4");
                peopleHeader.className = `font-semibold text-base mb-2 mt-3 ${
                  appState.theme === "light" ? "text-gray-800" : "text-white"
                }`;
                peopleHeader.textContent = "People";
                searchResultsContainer.appendChild(peopleHeader);

                matchingUsers.forEach((user) => {
                  const resultItem = document.createElement("div");
                  resultItem.className = `p-2 rounded-lg cursor-pointer flex items-center gap-2 ${
                    appState.theme === "light"
                      ? "hover:bg-green-50 text-gray-700"
                      : "hover:bg-green-900 text-gray-200"
                  } transition-colors`;
                  resultItem.innerHTML = `
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center bg-blue-100 text-blue-600 text-lg font-bold">
                                        ${
                                          user.name
                                            ? user.name[0].toUpperCase()
                                            : Icons.User
                                        }
                                    </div>
                                    <div>
                                        <div class="font-medium ${
                                          appState.theme === "light"
                                            ? "text-green-700"
                                            : "text-green-300"
                                        }">${
                    user.name || `User-${user.userId.substring(0, 5)}`
                  }</div>
                                        <div class="text-xs ${
                                          appState.theme === "light"
                                            ? "text-gray-600"
                                            : "text-gray-400"
                                        } line-clamp-1">${
                    user.bio || "IELTS Aspirant"
                  } • ${user.reputation || 0} pts</div>
                                    </div>
                                `;
                  resultItem.onclick = (e) => {
                    e.stopPropagation();
                    navigateTo("profile", { targetUserId: user.userId });
                  };
                  searchResultsContainer.appendChild(resultItem);
                });
              }

              if (matchingPosts.length === 0 && matchingUsers.length === 0) {
                searchResultsContainer.innerHTML = `<p class="p-2 ${
                  appState.theme === "light" ? "text-gray-500" : "text-gray-400"
                }">No results found.</p>`;
              }
            }
          }, 300); // Debounce search input
        };

        // User Stats Section
        const userStatsSection = document.createElement("div");
        userStatsSection.className = `mb-8 p-4 rounded-xl ${
          appState.theme === "light" ? "bg-gray-50" : "bg-gray-700"
        } shadow-inner`;
        userStatsSection.innerHTML = `
                <h3 class="text-lg font-semibold mb-4 ${
                  appState.theme === "light" ? "text-gray-800" : "text-white"
                }">
                    <i class="fas fa-user-circle mr-2"></i> Your Stats
                </h3>
                ${
                  appState.userProfile
                    ? `
                    <div class="space-y-3 text-sm">
                        <div class="flex items-center gap-2 ${
                          appState.theme === "light"
                            ? "text-gray-700"
                            : "text-gray-300"
                        }">
                            ${
                              Icons.Award
                            } Reputation: <span class="font-bold">${
                        appState.userProfile.reputation || 0
                      }</span>
                        </div>
                        <div class="flex items-center gap-2 ${
                          appState.theme === "light"
                            ? "text-gray-700"
                            : "text-gray-300"
                        }">
                            ${
                              Icons.Target
                            } Target Band: <span class="font-bold">${
                        appState.userProfile.bandGoal || "N/A"
                      }</span>
                        </div>
                        <div class="flex items-center gap-2 ${
                          appState.theme === "light"
                            ? "text-gray-700"
                            : "text-gray-300"
                        }">
                            ${Icons.Activity} Status: <span class="font-bold">${
                        appState.userProfile.preparationStatus || "New Learner"
                      }</span>
                        </div>
                    </div>
                `
                    : `<p class="text-sm ${
                        appState.theme === "light"
                          ? "text-gray-600"
                          : "text-gray-400"
                      }">Sign in to see your stats.</p>`
                }
            `;
        rightSidebar.appendChild(userStatsSection);

        // Top Users Section (Simplified Leaderboard)
        const topUsersSection = document.createElement("div");
        topUsersSection.className = `mb-8 p-4 rounded-xl ${
          appState.theme === "light" ? "bg-gray-50" : "bg-gray-700"
        } shadow-inner`;
        // Sort allUsersProfiles by reputation in descending order, take top 5
        const topUsers = [...appState.allUsersProfiles]
          .sort((a, b) => (b.reputation || 0) - (a.reputation || 0))
          .slice(0, 5);

        let topUsersHtml = "";
        if (topUsers.length > 0) {
          topUsersHtml = `<ul class="space-y-3 text-sm">`;
          topUsers.forEach((user) => {
            topUsersHtml += `
                    <li class="flex items-center gap-2 ${
                      appState.theme === "light"
                        ? "text-gray-700"
                        : "text-gray-300"
                    }">
                        <span class="w-5 h-5 flex-shrink-0">${
                          Icons.Award
                        }</span>
                        <span class="flex-1 font-semibold cursor-pointer hover:underline" data-user-id="${
                          user.userId
                        }">${
              user.name || `User-${user.userId.substring(0, 5)}`
            }</span>
                        <span class="font-bold text-blue-500">${
                          user.reputation || 0
                        } pts</span>
                    </li>
                `;
          });
          topUsersHtml += `</ul>`;
        } else {
          topUsersHtml = `<p class="text-sm ${
            appState.theme === "light" ? "text-gray-600" : "text-gray-400"
          }">No top users yet.</p>`;
        }

        topUsersSection.innerHTML = `
            <h3 class="text-lg font-semibold mb-4 ${
              appState.theme === "light" ? "text-gray-800" : "text-white"
            }">
                <i class="fas fa-trophy mr-2"></i> Top Users
            </h3>
            ${topUsersHtml}
        `;
        rightSidebar.appendChild(topUsersSection);

        // Make top user names clickable
        topUsers.forEach((user) => {
          const userLink = topUsersSection.querySelector(
            `[data-user-id="${user.userId}"]`
          );
          if (userLink) {
            userLink.onclick = (e) => {
              e.stopPropagation();
              navigateTo("profile", { targetUserId: user.userId });
            };
          }
        });

        // Quick Links Section
        const quickLinksSection = document.createElement("div");
        quickLinksSection.className = `p-4 rounded-xl ${
          appState.theme === "light" ? "bg-gray-50" : "bg-gray-700"
        } shadow-inner`;
        quickLinksSection.innerHTML = `
                <h3 class="text-lg font-semibold mb-4 ${
                  appState.theme === "light" ? "text-gray-800" : "text-white"
                }">
                    <i class="fas fa-external-link-alt mr-2"></i> Quick Links
                </h3>
                <ul class="space-y-3 text-sm">
                    <li>
                        <a href="https://www.ielts.org/" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 ${
                          appState.theme === "light"
                            ? "text-blue-600 hover:text-blue-700"
                            : "text-blue-400 hover:text-blue-300"
                        } transition-colors">
                            ${Icons.Link} Official IELTS Website
                        </a>
                    </li>
                    <li>
                        <a href="https://takeielts.britishcouncil.org/prepare-test/free-ielts-practice-tests" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 ${
                          appState.theme === "light"
                            ? "text-blue-600 hover:text-blue-700"
                            : "text-blue-400 hover:text-blue-300"
                        } transition-colors">
                            ${Icons.Link} Free Practice Tests
                        </a>
                    </li>
                    <li>
                        <a href="https://www.youtube.com/c/E2IELTS" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 ${
                          appState.theme === "light"
                            ? "text-blue-600 hover:text-blue-700"
                            : "text-blue-400 hover:text-blue-300"
                        } transition-colors">
                            ${Icons.Link} E2 IELTS YouTube
                        </a>
                    </li>
                </ul>
            `;
        rightSidebar.appendChild(quickLinksSection);
      }

      function renderHeader() {
        const header = elements.header;
        header.innerHTML = `
                <div class="flex items-center gap-4">
                    <button id="menu-toggle-btn" class="md:hidden p-2 rounded-xl ${
                      appState.theme === "light"
                        ? "hover:bg-gray-100"
                        : "hover:bg-gray-700"
                    } transition-colors" aria-label="Toggle sidebar">
                        ${Icons.Menu}
                    </button>
                    <h1 id="app-title" class="font-anton text-3xl cursor-pointer text-blue-600 hover:text-blue-700 transition-colors">
                        IELTS Mahir
                    </h1>
                </div>
                <div class="flex items-center gap-4">
                    ${
                      appState.userId
                        ? `<span class="text-sm font-medium hidden sm:block ${
                            appState.theme === "light"
                              ? "text-gray-600"
                              : "text-gray-300"
                          }">User ID: ${appState.userId.substring(
                            0,
                            8
                          )}...</span>`
                        : ""
                    }
                    <button id="create-post-btn" class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-all text-sm font-semibold transform active:scale-95">
                        ${
                          Icons.Plus
                        } <span class="hidden sm:inline">Create Post</span>
                    </button>
                    <button id="theme-toggle-btn" class="p-2.5 rounded-full shadow-sm ${
                      appState.theme === "light"
                        ? "bg-gray-100 text-gray-700 hover:bg-gray-200"
                        : "bg-gray-700 text-gray-200 hover:bg-gray-600"
                    } transition-colors transform active:scale-95" aria-label="Toggle theme">
                        ${appState.theme === "light" ? Icons.Moon : Icons.Sun}
                    </button>
                    <button id="profile-btn" class="p-2.5 rounded-full shadow-sm ${
                      appState.theme === "light"
                        ? "bg-gray-100 text-gray-700 hover:bg-gray-200"
                        : "bg-gray-700 text-gray-200 hover:bg-gray-600"
                    } transition-colors transform active:scale-95" aria-label="User Profile">
                        ${Icons.User}
                    </button>
                </div>
            `;

        document.getElementById("app-title").onclick = () => navigateTo("home");
        document.getElementById("create-post-btn").onclick = () =>
          navigateTo("createPost");
        document.getElementById("theme-toggle-btn").onclick = toggleTheme;
        document.getElementById("profile-btn").onclick = () =>
          navigateTo("profile", { targetUserId: appState.userId }); // Navigate to *current* user's profile
        document.getElementById("menu-toggle-btn").onclick = () => {
          appState.showSidebar = !appState.showSidebar;
          renderSidebar();
        };
        updateThemeClasses(); // Ensure header has correct theme classes
      }

      function renderSidebar() {
        const sidebar = elements.sidebar;
        const categoriesData = [
          {
            name: "IELTS Speaking",
            subcategories: ["Cue Cards", "Fluency", "Pronunciation"],
          },
          {
            name: "IELTS Writing",
            subcategories: [
              "Writing Task 1",
              "Writing Task 2",
              "Grammar Help",
              "Vocabulary",
            ],
          },
          { name: "IELTS Listening" },
          { name: "IELTS Reading" },
          { name: "Tips & Strategies" },
          { name: "Band 9 Answers" },
          { name: "Motivation & Support" },
        ];

        sidebar.classList.toggle("-translate-x-full", !appState.showSidebar);
        sidebar.classList.toggle("translate-x-0", appState.showSidebar);

        sidebar.innerHTML = `
                <div class="flex justify-between items-center mb-6 md:hidden">
                    <h2 class="font-normal font-bold text-xl text-blue-600">Categories</h2>
                    <button id="sidebar-close-btn" class="p-2 rounded-full ${
                      appState.theme === "light"
                        ? "hover:bg-gray-100"
                        : "hover:bg-gray-700"
                    } transition-colors">
                        ${Icons.X}
                    </button>
                </div>
                <nav id="sidebar-nav" class="space-y-3"></nav>
            `;

        document.getElementById("sidebar-close-btn").onclick = () => {
          appState.showSidebar = false;
          renderSidebar();
        };

        const sidebarNav = document.getElementById("sidebar-nav");

        // Add main feed filters
        const feedFiltersDiv = document.createElement("div");
        feedFiltersDiv.className = `pb-4 mb-4 border-b ${
          appState.theme === "light" ? "border-gray-200" : "border-gray-700"
        }`;
        feedFiltersDiv.innerHTML = `
            <h3 class="text-lg font-semibold mb-3 ${
              appState.theme === "light" ? "text-gray-800" : "text-white"
            }">
                <span class="w-5 h-5 mr-2">${Icons.Filter}</span> Filter Feed
            </h3>
            <ul class="space-y-2">
                <li>
                    <button id="feed-latest-btn" class="block w-full text-left p-2 rounded-lg font-normal ${
                      appState.homeFeedType === "latest"
                        ? appState.theme === "light"
                          ? "bg-blue-100 text-blue-700"
                          : "bg-blue-800 text-blue-100"
                        : appState.theme === "light"
                        ? "text-gray-700 hover:bg-blue-50 hover:text-blue-700"
                        : "text-gray-200 hover:bg-blue-900 hover:text-blue-100"
                    } transition-all">
                        Latest Posts
                    </button>
                </li>
                <li>
                    <button id="feed-for-you-btn" class="block w-full text-left p-2 rounded-lg font-normal ${
                      appState.homeFeedType === "forYou"
                        ? appState.theme === "light"
                          ? "bg-blue-100 text-blue-700"
                          : "bg-blue-800 text-blue-100"
                        : appState.theme === "light"
                        ? "text-gray-700 hover:bg-blue-50 hover:text-blue-700"
                        : "text-gray-200 hover:bg-blue-900 hover:text-blue-100"
                    } transition-all">
                        <span class="w-4 h-4 inline-block align-middle mr-1">${
                          Icons.Heart
                        }</span> For You
                    </button>
                </li>
                <li>
                    <button id="feed-following-btn" class="block w-full text-left p-2 rounded-lg font-normal ${
                      appState.homeFeedType === "following"
                        ? appState.theme === "light"
                          ? "bg-blue-100 text-blue-700"
                          : "bg-blue-800 text-blue-100"
                        : appState.theme === "light"
                        ? "text-gray-700 hover:bg-blue-50 hover:text-blue-700"
                        : "text-gray-200 hover:bg-blue-900 hover:text-blue-100"
                    } transition-all">
                        <span class="w-4 h-4 inline-block align-middle mr-1">${
                          Icons.Users
                        }</span> Following
                    </button>
                </li>
            </ul>
        `;
        sidebarNav.appendChild(feedFiltersDiv);

        document.getElementById("feed-latest-btn").onclick = () =>
          navigateTo("home", { homeFeedType: "latest" });
        document.getElementById("feed-for-you-btn").onclick = () =>
          navigateTo("home", { homeFeedType: "forYou" });
        document.getElementById("feed-following-btn").onclick = () =>
          navigateTo("home", { homeFeedType: "following" });

        // Add Categories section
        const categoriesSection = document.createElement("div");
        categoriesSection.className = `pb-4`;
        categoriesSection.innerHTML = `
            <h3 class="text-lg font-semibold mb-3 ${
              appState.theme === "light" ? "text-gray-800" : "text-white"
            }">
                <span class="w-5 h-5 mr-2">${
                  Icons.ChevronDown
                }</span> Categories
            </h3>
            <nav id="categories-nav" class="space-y-3"></nav>
        `;
        sidebarNav.appendChild(categoriesSection);
        const categoriesNav = document.getElementById("categories-nav");

        categoriesData.forEach((category) => {
          const categoryDiv = document.createElement("div");
          const isCategoryActive = appState.activeCategory === category.name;

          categoryDiv.innerHTML = `
                    <button id="category-btn-${category.name.replace(
                      /\s/g,
                      "-"
                    )}" class="flex items-center justify-between w-full p-3 rounded-lg font-normal font-medium ${
            isCategoryActive
              ? appState.theme === "light"
                ? "bg-blue-100 text-blue-700"
                : "bg-blue-800 text-blue-100"
              : appState.theme === "light"
              ? "text-gray-700 hover:bg-blue-50 hover:text-blue-700"
              : "text-gray-200 hover:bg-blue-900 hover:text-blue-100"
          } transition-all">
                        <span>${category.name}</span>
                        ${
                          category.subcategories
                            ? `<span id="chevron-${category.name.replace(
                                /\s/g,
                                "-"
                              )}" class="${
                                appState.openCategories?.[category.name]
                                  ? "rotate-180"
                                  : ""
                              } transition-transform duration-200">${
                                Icons.ChevronDown
                              }</span>`
                            : ""
                        }
                    </button>
                    ${
                      category.subcategories
                        ? `<ul id="subcategories-list-${category.name.replace(
                            /\s/g,
                            "-"
                          )}" class="ml-4 mt-2 space-y-2 ${
                            appState.openCategories?.[category.name]
                              ? ""
                              : "hidden"
                          }"></ul>`
                        : ""
                    }
                `;
          categoriesNav.appendChild(categoryDiv); // Append to categoriesNav instead of sidebarNav directly

          document.getElementById(
            `category-btn-${category.name.replace(/\s/g, "-")}`
          ).onclick = () => {
            if (category.subcategories) {
              // Toggle subcategories display
              appState.openCategories = {
                ...appState.openCategories,
                [category.name]: !appState.openCategories?.[category.name],
              };
              renderSidebar(); // Re-render sidebar to toggle submenu
            }
            // Navigate to filter by main category or subcategory
            navigateTo("home", { category: category.name, subCategory: null }); // Always reset subCategory when main is clicked
          };

          if (category.subcategories) {
            const subcategoriesList = document.getElementById(
              `subcategories-list-${category.name.replace(/\s/g, "-")}`
            );
            subcategoriesList.className += ` ${
              appState.theme === "light"
                ? "border-l border-gray-200"
                : "border-l border-gray-700"
            }`; // Add border for visual separation
            subcategoriesList.classList.add(
              `${
                appState.theme === "light" ? "text-gray-600" : "text-gray-300"
              }`
            ); // Set text color for subcategories
            subcategoriesList.classList.add("pl-4"); // Added padding to push items away from border
            category.subcategories.forEach((sub) => {
              const subLi = document.createElement("li");
              const isSubCategoryActive =
                appState.activeSubCategory === sub &&
                appState.activeCategory === category.name;
              subLi.innerHTML = `
                            <button class="block w-full text-left p-2 rounded-lg font-normal text-sm ${
                              isSubCategoryActive
                                ? appState.theme === "light"
                                  ? "bg-blue-50 text-blue-600"
                                  : "bg-blue-700 text-blue-200"
                                : appState.theme === "light"
                                ? "text-gray-600 hover:bg-blue-50 hover:text-blue-600"
                                : "text-gray-300 hover:bg-blue-800 hover:text-blue-200"
                            } transition-colors">
                                ${sub}
                            </button>
                        `;
              subLi.querySelector("button").onclick = () =>
                navigateTo("home", {
                  category: category.name,
                  subCategory: sub,
                });
              subcategoriesList.appendChild(subLi);
            });
          }
        });
        updateThemeClasses(); // Ensure sidebar has correct theme classes
      }

      function renderPostList() {
        const mainContent = elements.mainContent;
        mainContent.innerHTML = `
                <div class="flex-1">
                    <h2 class="text-3xl font-bold font-normal mb-8 ${
                      appState.theme === "light"
                        ? "text-gray-900"
                        : "text-white"
                    }">
                        ${
                          appState.homeFeedType === "latest"
                            ? "Latest Discussions"
                            : appState.homeFeedType === "forYou"
                            ? "For You Discussions"
                            : appState.homeFeedType === "following"
                            ? "Discussions from Followed Users"
                            : "Latest Discussions"
                        }
                        ${
                          appState.activeCategory
                            ? `<span class="${
                                appState.theme === "light"
                                  ? "text-blue-600"
                                  : "text-blue-400"
                              }"> - ${appState.activeCategory}</span>`
                            : ""
                        }
                        ${
                          appState.activeSubCategory
                            ? `<span class="${
                                appState.theme === "light"
                                  ? "text-indigo-600"
                                  : "text-indigo-400"
                              }"> (${appState.activeSubCategory})</span>`
                            : ""
                        }
                    </h2>
                    <div id="posts-container" class="space-y-6"></div>
                </div>
                <div id="right-sidebar" class="w-64 ml-8 p-6 hidden lg:block rounded-2xl shadow-lg ${
                  appState.theme === "light" ? "bg-white" : "bg-gray-800"
                }">
                    <!-- Right sidebar content will be rendered here -->
                </div>
            `;

        let postsToDisplay = [...appState.posts]; // Create a mutable copy

        // Apply category/subcategory filters
        postsToDisplay = postsToDisplay.filter((post) => {
          let matchesCategory = true;
          let matchesSubCategory = true;

          if (appState.activeCategory) {
            matchesCategory = post.category === appState.activeCategory;
          }
          if (appState.activeSubCategory) {
            matchesSubCategory =
              post.subCategory === appState.activeSubCategory;
          }
          return matchesCategory && matchesSubCategory;
        });

        // Apply feed type specific sorting/filtering
        if (appState.homeFeedType === "forYou") {
          // Simple "For You" logic: prioritize by net upvotes (upvotes - downvotes), then recency
          postsToDisplay.sort((a, b) => {
            const aScore = (a.upvotes || 0) - (a.downvotes || 0);
            const bScore = (b.upvotes || 0) - (b.downvotes || 0); // Corrected: should be b.downvotes
            if (bScore !== aScore) return bScore - aScore; // Higher score first
            return (
              (b.createdAt?.toDate() || new Date(0)) -
              (a.createdAt?.toDate() || new Date(0))
            ); // More recent if scores are equal
          });
        } else if (appState.homeFeedType === "following") {
          const followedUserIds = appState.userProfile?.following || [];
          if (followedUserIds.length > 0) {
            postsToDisplay = postsToDisplay.filter((post) =>
              followedUserIds.includes(post.authorId)
            );
          } else {
            postsToDisplay = []; // No posts if not following anyone
          }
          // Always sort followed posts by recency
          postsToDisplay.sort(
            (a, b) =>
              (b.createdAt?.toDate() || new Date(0)) -
              (a.createdAt?.toDate() || new Date(0))
          );
        } else {
          // 'latest' or default
          // Already sorted by createdAt DESC in Firestore listener, so no extra sort needed here.
          // If it wasn't, we'd do: postsToDisplay.sort((a, b) => (b.createdAt?.toDate() || new Date(0)) - (a.createdAt?.toDate() || new Date(0)));
        }

        const postsContainer = document.getElementById("posts-container");
        if (postsToDisplay.length === 0) {
          let message = "No posts found for this selection.";
          if (appState.homeFeedType === "following") {
            message =
              "You are not following any users, or they haven't posted yet.";
          }
          postsContainer.innerHTML = `<p class="text-lg ${
            appState.theme === "light" ? "text-gray-600" : "text-gray-400"
          }">${message} Be the first to create one!</p>`;
        } else {
          postsToDisplay.forEach((post) => {
            const postDiv = document.createElement("div");
            postDiv.className = `p-6 rounded-2xl shadow-lg transition-all duration-200 hover:shadow-xl hover:scale-[1.01] cursor-pointer ${
              appState.theme === "light" ? "bg-white" : "bg-gray-800"
            }`;
            // Removed direct onclick on postDiv to prevent conflict with internal buttons
            // instead, we'll make sure clicking anywhere else on the postdiv also navigates
            postDiv.addEventListener("click", (e) => {
              // Only navigate if the click target is not a button or a clickable span (like author name, which will have its own handler)
              if (
                e.target.tagName !== "BUTTON" &&
                e.target.tagName !== "SPAN" &&
                e.target.tagName !== "A"
              ) {
                navigateTo("postDetail", { post: post });
              }
            });

            const formattedTime = formatRelativeTime(post.createdAt);
            const commentsCount = (appState.comments[post.id] || []).length;

            const isAuthorCurrentUsers =
              appState.userId && post.authorId === appState.userId;
            const isFollowingAuthor = appState.userProfile?.following?.includes(
              post.authorId
            );

            postDiv.innerHTML = `
                        <h3 class="text-xl font-semibold font-normal mb-2 ${
                          appState.theme === "light"
                            ? "text-blue-700"
                            : "text-blue-400"
                        }">
                            ${post.title}
                        </h3>
                        <p class="text-sm ${
                          appState.theme === "light"
                            ? "text-gray-600"
                            : "text-gray-300"
                        } mb-3 line-clamp-2">
                            ${post.content}
                        </p>
                        <div class="flex items-center justify-between text-xs font-normal ${
                          appState.theme === "light"
                            ? "text-gray-500"
                            : "text-gray-400"
                        } border-t pt-3 mt-4 ${
              appState.theme === "light" ? "border-gray-100" : "border-gray-700"
            }">
                            <div class="flex items-center gap-2">
                                <span class="w-4 h-4">${Icons.User}</span>
                                <span class="font-bold cursor-pointer hover:underline" data-user-id="${
                                  post.authorId
                                }">${post.authorName || "Anonymous"}</span>
                                ${
                                  !isAuthorCurrentUsers && appState.userId
                                    ? `
                                    <button class="ml-2 px-2 py-1 rounded-full text-xs font-semibold
                                        ${
                                          isFollowingAuthor
                                            ? "bg-gray-300 text-gray-800 hover:bg-gray-400"
                                            : "bg-blue-100 text-blue-700 hover:bg-blue-200"
                                        }
                                        dark:${
                                          isFollowingAuthor
                                            ? "bg-gray-600 text-white hover:bg-gray-700"
                                            : "bg-blue-900 text-blue-200 hover:bg-blue-800"
                                        }
                                        transition-colors transform active:scale-95 follow-button hidden sm:block"
                                        data-target-user-id="${post.authorId}">
                                        ${
                                          isFollowingAuthor
                                            ? `<i class="fas fa-check"></i> Unfollow`
                                            : `<i class="fas fa-user-plus"></i> Follow`
                                        }
                                    </button>
                                `
                                    : ""
                                }
                                <span class="mx-1">•</span>
                                <span>${formattedTime}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="flex items-center gap-1 text-green-500">
                                    <span class="w-4 h-4">${
                                      Icons.ThumbsUp
                                    }</span> ${post.upvotes || 0}
                                </span>
                                <span class="flex items-center gap-1 text-red-500">
                                    <span class="w-4 h-4">${
                                      Icons.ThumbsDown
                                    }</span> ${post.downvotes || 0}
                                </span>
                                <span class="flex items-center gap-1 text-blue-500">
                                    <span class="w-4 h-4">${
                                      Icons.MessageCircleMore
                                    }</span> ${commentsCount}
                                </span>
                                ${
                                  post.isResolved
                                    ? `<span class="flex items-center gap-1 text-green-600 font-semibold"> <span class="w-4 h-4">${Icons.CheckCircle}</span> Resolved</span>`
                                    : ""
                                }
                            </div>
                        </div>
                        ${
                          post.category
                            ? `
                            <div class="mt-3 flex flex-wrap gap-2">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                  appState.theme === "light"
                                    ? "bg-blue-50 text-blue-700"
                                    : "bg-blue-900 text-blue-200"
                                }">
                                    ${post.category}
                                </span>
                                ${
                                  post.subCategory
                                    ? `<span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                        appState.theme === "light"
                                          ? "bg-indigo-50 text-indigo-700"
                                          : "bg-indigo-900 text-indigo-200"
                                      }"> ${post.subCategory}</span>`
                                    : ""
                                }
                                ${
                                  post.tags && post.tags.length > 0
                                    ? post.tags
                                        .map(
                                          (tag) =>
                                            `<span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                              appState.theme === "light"
                                                ? "bg-gray-100 text-gray-600"
                                                : "bg-gray-700 text-gray-300"
                                            }">${tag}</span>`
                                        )
                                        .join("")
                                    : ""
                                }
                            </div>
                        `
                            : ""
                        }
                    `;
            postsContainer.appendChild(postDiv);

            // Make author names clickable
            const authorNameSpan = postDiv.querySelector(
              `span[data-user-id="${post.authorId}"]`
            );
            if (authorNameSpan) {
              authorNameSpan.onclick = (e) => {
                e.stopPropagation(); // Prevent the postDiv's click event from firing
                navigateTo("profile", { targetUserId: post.authorId });
              };
            }

            // Attach event listener for the new follow button
            const followButton = postDiv.querySelector(`.follow-button`);
            if (followButton) {
              followButton.onclick = (e) => {
                e.stopPropagation(); // Prevent the postDiv's click event from firing
                toggleFollow(post.authorId);
              };
            }
          });
        }
        renderRightSidebar(); // Render the right sidebar for home view
      }

      function renderPostDetail() {
        const post = appState.selectedPost;
        if (!post) {
          navigateTo("home"); // Redirect if no post is selected
          return;
        }

        const isAuthorCurrentUsers =
          appState.userId && post.authorId === appState.userId;
        const isFollowingAuthor = appState.userProfile?.following?.includes(
          post.authorId
        );
        const formattedTime = formatRelativeTime(post.createdAt);

        const mainContent = elements.mainContent;
        mainContent.innerHTML = `
                <div class="flex-1">
                    <button id="back-to-home-btn" class="mb-6 flex items-center gap-2 text-base font-semibold ${
                      appState.theme === "light"
                        ? "text-blue-600 hover:text-blue-700"
                        : "text-blue-400 hover:text-blue-300"
                    } transition-colors">
                        <span class="w-5 h-5">${
                          Icons.ArrowLeft
                        }</span> Back to Forum
                    </button>

                    <div class="p-6 md:p-8 rounded-2xl shadow-lg transition-colors duration-300 ${
                      appState.theme === "light" ? "bg-white" : "bg-gray-800"
                    }">
                        ${
                          appState.editingPostId === post.id
                            ? `
                            <!-- Edit Post Form -->
                            <div class="space-y-4">
                                <div>
                                    <label for="edit-post-title" class="block text-sm font-medium mb-1 ${
                                      appState.theme === "light"
                                        ? "text-gray-700"
                                        : "text-gray-300"
                                    }">Title</label>
                                    <input type="text" id="edit-post-title" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                      appState.theme === "light"
                                        ? "border-gray-200 bg-gray-50 text-gray-900"
                                        : "border-gray-700 bg-gray-900 text-white"
                                    } transition-colors" value="${
                                post.title
                              }" required />
                                </div>
                                <div>
                                    <label for="edit-post-content" class="block text-sm font-medium mb-1 ${
                                      appState.theme === "light"
                                        ? "text-gray-700"
                                        : "text-gray-300"
                                    }">Content</label>
                                    <textarea id="edit-post-content" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                      appState.theme === "light"
                                        ? "border-gray-200 bg-gray-50 text-gray-900"
                                        : "border-gray-700 bg-gray-900 text-white"
                                    } transition-colors" rows="8" required>${
                                post.content
                              }</textarea>
                                </div>
                                <div class="flex gap-3">
                                    <button id="save-post-btn" class="flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-xl shadow-md hover:bg-green-700 transition-all text-sm font-semibold transform active:scale-95">
                                        ${Icons.Save} Save
                                    </button>
                                    <button id="cancel-edit-post-btn" class="flex items-center gap-2 px-5 py-2.5 bg-gray-300 text-gray-800 rounded-xl shadow-md hover:bg-gray-400 transition-all text-sm font-semibold transform active:scale-95">
                                        ${Icons.Cancel} Cancel
                                    </button>
                                </div>
                            </div>
                        `
                            : `
                            <!-- Display Post -->
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-3xl md:text-4xl font-bold font-normal ${
                                  appState.theme === "light"
                                    ? "text-gray-900"
                                    : "text-white"
                                }">
                                    ${post.title}
                                </h2>
                                <div class="flex gap-2">
                                    ${
                                      isAuthorCurrentUsers
                                        ? `
                                        <button id="edit-post-btn" class="p-2 rounded-full ${
                                          appState.theme === "light"
                                            ? "hover:bg-gray-100"
                                            : "hover:bg-gray-700"
                                        } transition-colors" aria-label="Edit Post">
                                            ${Icons.Edit}
                                        </button>
                                        <button id="delete-post-btn" class="p-2 rounded-full ${
                                          appState.theme === "light"
                                            ? "hover:bg-red-100 text-red-600"
                                            : "hover:bg-red-800 text-red-400"
                                        } transition-colors" aria-label="Delete Post">
                                            ${Icons.Trash}
                                        </button>
                                    `
                                        : ""
                                    }
                                </div>
                            </div>
                            <div class="flex flex-wrap items-center gap-4 text-sm font-normal mb-4">
                                <span class="flex items-center gap-1 ${
                                  appState.theme === "light"
                                    ? "text-gray-600"
                                    : "text-gray-300"
                                }">
                                    <span class="w-4 h-4">${
                                      Icons.User
                                    }</span> <span class="font-bold cursor-pointer hover:underline" data-user-id="${
                                post.authorId
                              }">${post.authorName || "Anonymous"}</span>
                                </span>
                                ${
                                  !isAuthorCurrentUsers && appState.userId
                                    ? `
                                    <button id="follow-author-btn" class="px-2 py-1 rounded-full text-xs font-semibold
                                        ${
                                          isFollowingAuthor
                                            ? "bg-gray-300 text-gray-800 hover:bg-gray-400"
                                            : "bg-blue-100 text-blue-700 hover:bg-blue-200"
                                        }
                                        dark:${
                                          isFollowingAuthor
                                            ? "bg-gray-600 text-white hover:bg-gray-700"
                                            : "bg-blue-900 text-blue-200 hover:bg-blue-800"
                                        }
                                        transition-colors transform active:scale-95">
                                        ${
                                          isFollowingAuthor
                                            ? `<i class="fas fa-check"></i> Unfollow`
                                            : `<i class="fas fa-user-plus"></i> Follow`
                                        }
                                    </button>
                                `
                                    : ""
                                }
                                ${
                                  post.createdAt
                                    ? `<span class="flex items-center gap-1 ${
                                        appState.theme === "light"
                                          ? "text-gray-600"
                                          : "text-gray-300"
                                      }">
                                    <span class="mx-1">•</span>
                                    ${formattedTime}
                                </span>`
                                    : ""
                                }
                                ${
                                  post.isResolved
                                    ? `<span class="flex items-center gap-1 text-green-600 font-semibold px-2 py-1 bg-green-100 dark:bg-green-900 dark:text-green-200 rounded-full">
                                    <span class="w-4 h-4">${Icons.CheckCircle}</span> Resolved
                                </span>`
                                    : ""
                                }
                            </div>
                            <p class="text-lg font-normal leading-relaxed mb-6 ${
                              appState.theme === "light"
                                ? "text-gray-800"
                                : "text-gray-200"
                            }">
                                ${post.content}
                            </p>
                        `
                        }

                        <div class="flex flex-wrap gap-3 mb-6 border-t pt-4 ${
                          appState.theme === "light"
                            ? "border-gray-100"
                            : "border-gray-700"
                        }">
                            <button id="upvote-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold 
                                ${
                                  post.upvotedBy &&
                                  post.upvotedBy.includes(appState.userId)
                                    ? appState.theme === "light"
                                      ? "bg-blue-500 text-white"
                                      : "bg-blue-600 text-white"
                                    : appState.theme === "light"
                                    ? "bg-blue-100 text-blue-700 hover:bg-blue-200"
                                    : "bg-blue-900 text-blue-200 hover:bg-blue-800"
                                }
                                transition-colors transform active:scale-95">
                                <span class="w-4 h-4">${
                                  post.upvotedBy &&
                                  post.upvotedBy.includes(appState.userId)
                                    ? Icons.ThumbsUpSolid
                                    : Icons.ThumbsUp
                                }</span> ${post.upvotes || 0}
                            </button>
                            <button id="downvote-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold 
                                ${
                                  post.downvotedBy &&
                                  post.downvotedBy.includes(appState.userId)
                                    ? appState.theme === "light"
                                      ? "bg-red-500 text-white"
                                      : "bg-red-600 text-white"
                                    : appState.theme === "light"
                                    ? "bg-red-100 text-red-700 hover:bg-red-200"
                                    : "bg-red-900 text-red-200 hover:bg-red-800"
                                }
                                transition-colors transform active:scale-95">
                                <span class="w-4 h-4">${
                                  post.downvotedBy &&
                                  post.downvotedBy.includes(appState.userId)
                                    ? Icons.ThumbsDownSolid
                                    : Icons.ThumbsDown
                                }</span> ${post.downvotes || 0}
                            </button>
                            ${
                              post.authorId === appState.userId
                                ? `
                                <button id="resolve-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold ${
                                  post.isResolved
                                    ? "bg-orange-100 text-orange-700 hover:bg-orange-200"
                                    : "bg-green-100 text-green-700 hover:bg-green-200"
                                } ${
                                    appState.theme === "dark" &&
                                    (post.isResolved
                                      ? "bg-orange-900 text-orange-200 hover:bg-orange-800"
                                      : "bg-green-900 text-green-200 hover:bg-green-800")
                                  } transition-colors transform active:scale-95">
                                    <span class="w-4 h-4">${
                                      Icons.CheckCircle
                                    }</span> ${
                                    post.isResolved
                                      ? "Unresolve"
                                      : "Mark as Resolved"
                                  }
                                </button>
                            `
                                : ""
                            }
                            <button id="ai-summary-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold ${
                              appState.theme === "light"
                                ? "bg-purple-100 text-purple-700 hover:bg-purple-200"
                                : "bg-purple-900 text-purple-200 hover:bg-purple-800"
                            } transition-colors transform active:scale-95">
                                <span class="w-4 h-4">${
                                  Icons.Zap
                                }</span> AI Summary
                            </button>
                            <button id="ai-suggest-answer-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold ${
                              appState.theme === "light"
                                ? "bg-indigo-100 text-indigo-700 hover:bg-indigo-200"
                                : "bg-indigo-900 text-indigo-200 hover:bg-indigo-800"
                            } transition-colors transform active:scale-95">
                                <span class="w-4 h-4">${
                                  Icons.Zap
                                }</span> AI Suggest Answer
                            </button>
                            <button id="ai-grammar-check-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold ${
                              appState.theme === "light"
                                ? "bg-teal-100 text-teal-700 hover:bg-teal-200"
                                : "bg-teal-900 text-teal-200 hover:bg-teal-800"
                            } transition-colors transform active:scale-95">
                                <span class="w-4 h-4">${
                                  Icons.Zap
                                }</span> AI Grammar Check
                            </button>
                            <button id="ai-auto-tag-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold ${
                              appState.theme === "light"
                                ? "bg-emerald-100 text-emerald-700 hover:bg-emerald-200"
                                : "bg-emerald-900 text-emerald-200 hover:bg-emerald-800"
                            } transition-colors transform active:scale-95">
                                <span class="w-4 h-4">${
                                  Icons.Zap
                                }</span> AI Auto-Tag
                            </button>
                        </div>

                        ${
                          post.category
                            ? `
                            <div class="mt-3 flex flex-wrap gap-2 mb-6">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                  appState.theme === "light"
                                    ? "bg-blue-50 text-blue-700"
                                    : "bg-blue-900 text-blue-200"
                                }">
                                    ${post.category}
                                </span>
                                ${
                                  post.subCategory
                                    ? `<span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                        appState.theme === "light"
                                          ? "bg-indigo-50 text-indigo-700"
                                          : "bg-indigo-900 text-indigo-200"
                                      }"> ${post.subCategory}</span>`
                                    : ""
                                }
                                ${
                                  post.tags && post.tags.length > 0
                                    ? post.tags
                                        .map(
                                          (tag) =>
                                            `<span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                              appState.theme === "light"
                                                ? "bg-gray-100 text-gray-600"
                                                : "bg-gray-700 text-gray-300"
                                            }">${tag}</span>`
                                        )
                                        .join("")
                                    : ""
                                }
                            </div>
                        `
                            : ""
                        }
                    </div>

                    <div class="mt-8">
                        <h3 class="text-2xl font-bold font-normal mb-4 ${
                          appState.theme === "light"
                            ? "text-gray-900"
                            : "text-white"
                        }">Comments (<span id="comments-count">0</span>)</h3>
                        <div id="comments-container" class="space-y-4"></div>

                        <div class="mt-6 p-6 rounded-2xl shadow-lg ${
                          appState.theme === "light"
                            ? "bg-white"
                            : "bg-gray-800"
                        }">
                            <h4 class="text-xl font-bold font-normal mb-4 ${
                              appState.theme === "light"
                                ? "text-gray-900"
                                : "text-white"
                            }">Add a Comment</h4>
                            <textarea id="comment-content-textarea" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                              appState.theme === "light"
                                ? "border-gray-200 bg-gray-50 text-gray-900"
                                : "border-gray-700 bg-gray-900 text-white"
                            } transition-colors" rows="4" placeholder="Write your comment here..." required></textarea>
                            <button id="post-comment-btn" class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-colors font-semibold transform active:scale-95" disabled>
                                Post Comment
                            </button>
                        </div>
                    </div>
                </div>
                <div id="right-sidebar" class="w-64 ml-8 p-6 hidden lg:block rounded-2xl shadow-lg ${
                  appState.theme === "light" ? "bg-white" : "bg-gray-800"
                }">
                    <!-- Right sidebar content will be rendered here -->
                </div>
            `;

        document.getElementById("back-to-home-btn").onclick = () =>
          navigateTo("home");
        document.getElementById("upvote-btn").onclick = () =>
          updatePostVotes(post.id, "up");
        document.getElementById("downvote-btn").onclick = () =>
          updatePostVotes(post.id, "down");

        // Make author name clickable
        const authorNameSpan = mainContent.querySelector(
          `span[data-user-id="${post.authorId}"]`
        );
        if (authorNameSpan) {
          authorNameSpan.onclick = (e) => {
            e.stopPropagation();
            navigateTo("profile", { targetUserId: post.authorId });
          };
        }

        // Attach event listener for the new follow button on post detail page
        const followAuthorBtn = document.getElementById("follow-author-btn");
        if (followAuthorBtn) {
          followAuthorBtn.onclick = (e) => {
            e.stopPropagation();
            toggleFollow(post.authorId);
          };
        }

        if (post.authorId === appState.userId) {
          const resolveBtn = document.getElementById("resolve-btn");
          if (resolveBtn) {
            // Ensure button exists if user is author
            resolveBtn.onclick = () =>
              togglePostResolved(post.id, post.isResolved);
          }

          const editPostBtn = document.getElementById("edit-post-btn");
          if (editPostBtn) {
            editPostBtn.onclick = () => {
              appState.editingPostId = post.id;
              renderPostDetail(); // Re-render in edit mode
            };
          }

          const deletePostBtn = document.getElementById("delete-post-btn");
          if (deletePostBtn) {
            deletePostBtn.onclick = () => deletePost(post.id);
          }

          const savePostBtn = document.getElementById("save-post-btn");
          const cancelEditPostBtn = document.getElementById(
            "cancel-edit-post-btn"
          );
          if (savePostBtn && cancelEditPostBtn) {
            savePostBtn.onclick = () => {
              const newTitle = document.getElementById("edit-post-title").value;
              const newContent = document.getElementById("edit-post-content")
                .value;
              if (newTitle.trim() && newContent.trim()) {
                updatePost(post.id, { title: newTitle, content: newContent });
              } else {
                showToast("Title and content cannot be empty.", "error");
              }
            };
            cancelEditPostBtn.onclick = () => {
              appState.editingPostId = null;
              renderPostDetail(); // Exit edit mode
            };
          }
        }

        document.getElementById("ai-summary-btn").onclick = () =>
          callGeminiAI(
            `Summarize the following IELTS forum post and its comments:\n\nPost Title: "${
              post.title
            }"\nPost Content: "${post.content}"\n\nComments:\n${(
              appState.comments[post.id] || []
            )
              .map((c) => c.content)
              .join("\n")}`,
            "ai-summary-response"
          );
        document.getElementById("ai-suggest-answer-btn").onclick = () =>
          callGeminiAI(
            `Given the following IELTS forum post and comments, suggest a helpful answer or improvement:\n\nPost Title: "${
              post.title
            }"\nPost Content: "${post.content}"\n\nExisting Comments:\n${(
              appState.comments[post.id] || []
            )
              .map((c) => c.content)
              .join("\n")}`,
            "ai-suggest-answer-response"
          );
        document.getElementById("ai-grammar-check-btn").onclick = () =>
          callGeminiAI(
            `Check the grammar and spelling of the following text from an IELTS forum post. Provide corrections and explanations:\n\n"${post.content}"`,
            "ai-grammar-check-response"
          );
        document.getElementById("ai-auto-tag-btn").onclick = () =>
          callGeminiAI(
            `Given the following IELTS forum post content, suggest relevant tags (e.g., "Grammar", "Band 7+", "Cue Card", "Writing Task 2", "Speaking Practice"). Provide them as a comma-separated list:\n\n"${post.content}"`,
            "ai-auto-tag-response"
          );

        const commentContentTextarea = document.getElementById(
          "comment-content-textarea"
        );
        const postCommentBtn = document.getElementById("post-comment-btn");

        commentContentTextarea.oninput = () => {
          postCommentBtn.disabled = !commentContentTextarea.value.trim();
        };
        postCommentBtn.onclick = () => {
          // Add top-level comment (depth 0)
          addComment(post.id, commentContentTextarea.value, null, 0);
          commentContentTextarea.value = "";
          postCommentBtn.disabled = true;
        };

        renderComments(post.id);
        renderRightSidebar(); // Render the right sidebar for post detail view
      }

      function renderComments(postId) {
        const commentsContainer = document.getElementById("comments-container");
        const commentsCountSpan = document.getElementById("comments-count");
        const allPostComments = appState.comments[postId] || [];

        commentsCountSpan.textContent = allPostComments.length;
        commentsContainer.innerHTML = ""; // Clear existing comments

        if (allPostComments.length === 0) {
          commentsContainer.innerHTML = `<p class="text-md ${
            appState.theme === "light" ? "text-gray-600" : "text-gray-400"
          }">No comments yet. Be the first to reply!</p>`;
          return;
        }

        // Create a map for quick lookup and to store direct children for each comment
        const commentData = new Map();
        allPostComments.forEach((comment) => {
          commentData.set(comment.id, { ...comment, directChildren: [] });
        });

        // Populate directChildren for each comment
        allPostComments.forEach((comment) => {
          if (comment.parentId && commentData.has(comment.parentId)) {
            commentData
              .get(comment.parentId)
              .directChildren.push(commentData.get(comment.id));
          }
        });

        // Get all top-level comments and sort them
        const topLevelComments = Array.from(commentData.values())
          .filter(
            (comment) =>
              comment.parentId === null || comment.parentId === undefined
          )
          .sort(
            (a, b) =>
              (a.createdAt?.toDate() || new Date(0)) -
              (b.createdAt?.toDate() || new Date(0))
          );

        // Helper function to get all descendants (for unified toggle logic)
        function getAllDescendants(commentId, commentsMap) {
          let descendants = [];
          const comment = commentsMap.get(commentId);
          if (!comment || !comment.directChildren) return descendants;

          // Use a stack for depth-first traversal to ensure correct order for display
          const stack = [
            ...comment.directChildren.sort(
              (a, b) =>
                (b.createdAt?.toDate() || new Date(0)) -
                (a.createdAt?.toDate() || new Date(0))
            ),
          ]; // Sort initially for consistent processing order

          while (stack.length > 0) {
            const currentChild = stack.pop(); // Get the last item (LIFO for stack)
            descendants.push(currentChild);
            // Add children of the currentChild to the stack in reverse order to maintain chronological order when popped
            if (
              currentChild.directChildren &&
              currentChild.directChildren.length > 0
            ) {
              stack.push(
                ...currentChild.directChildren.sort(
                  (a, b) =>
                    (b.createdAt?.toDate() || new Date(0)) -
                    (a.createdAt?.toDate() || new Date(0))
                )
              );
            }
          }
          // Sort descendants by creation date to ensure chronological order in the flat list
          return descendants.sort(
            (a, b) =>
              (a.createdAt?.toDate() || new Date(0)) -
              (b.createdAt?.toDate() || new Date(0))
          );
        }

        // Function to render a single comment block
        function renderCommentBlock(comment, containerElement) {
          const isReply =
            comment.parentId !== null && comment.parentId !== undefined;
          // Apply ml-8 only if it's a reply
          const indentClasses = isReply ? "ml-8" : "";

          const isAuthorCurrentUsers =
            appState.userId && comment.authorId === appState.userId;
          const isFollowingAuthor = appState.userProfile?.following?.includes(
            comment.authorId
          );
          const formattedTime = formatRelativeTime(comment.createdAt);

          const commentDiv = document.createElement("div");
          commentDiv.className = `p-4 rounded-xl shadow-sm mb-3 ${
            appState.theme === "light"
              ? "bg-white border border-gray-100"
              : "bg-gray-800 border border-gray-700"
          } ${indentClasses}`;

          let repliedToHtml = "";
          if (isReply) {
            const parentComment = commentData.get(comment.parentId);
            if (parentComment) {
              repliedToHtml = `<span class="text-blue-500 font-semibold">@${
                parentComment.authorName || "Anonymous"
              }</span> `;
            }
          }

          commentDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-2 text-sm">
                        <span class="w-4 h-4">${Icons.User}</span>
                        <span class="font-semibold ${
                          appState.theme === "light"
                            ? "text-gray-800"
                            : "text-gray-200"
                        } cursor-pointer hover:underline" data-user-id="${
            comment.authorId
          }">${comment.authorName || "Anonymous"}</span>
                        ${
                          !isAuthorCurrentUsers && appState.userId
                            ? `
                            <button class="ml-2 px-2 py-1 rounded-full text-xs font-semibold
                                ${
                                  isFollowingAuthor
                                    ? "bg-gray-300 text-gray-800 hover:bg-gray-400"
                                    : "bg-gray-600 text-white hover:bg-gray-700"
                                }
                                dark:${
                                  isFollowingAuthor
                                    ? "bg-gray-600 text-white hover:bg-gray-700"
                                    : "bg-blue-900 text-blue-200 hover:bg-blue-800"
                                }
                                transition-colors transform active:scale-95 follow-button-comment"
                                data-target-user-id="${comment.authorId}">
                                ${
                                  isFollowingAuthor
                                    ? `<i class="fas fa-check"></i> Unfollow`
                                    : `<i class="fas fa-user-plus"></i> Follow`
                                }
                            </button>
                        `
                            : ""
                        }
                        <span class="${
                          appState.theme === "light"
                            ? "text-gray-500"
                            : "text-gray-400"
                        }">
                            ${formattedTime}
                        </span>
                    </div>
                    ${
                      appState.editingCommentId === comment.id
                        ? `
                        <!-- Edit Comment Form -->
                        <div class="space-y-2">
                            <textarea id="edit-comment-content-${
                              comment.id
                            }" class="w-full p-2 border rounded-xl focus:ring-1 focus:ring-blue-400 ${
                            appState.theme === "light"
                              ? "border-gray-200 bg-gray-50 text-gray-900"
                              : "border-gray-700 bg-gray-900 text-white"
                          } transition-colors" rows="2" required>${
                            comment.content
                          }</textarea>
                            <div class="flex gap-2">
                                <button id="save-comment-btn-${
                                  comment.id
                                }" class="flex items-center gap-1 px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs hover:bg-green-700 transition-colors">
                                    ${Icons.Save} Save
                                </button>
                                <button id="cancel-edit-comment-btn-${
                                  comment.id
                                }" class="flex items-center gap-1 px-3 py-1.5 bg-gray-300 text-gray-800 rounded-lg text-xs hover:bg-gray-400 transition-colors">
                                    ${Icons.Cancel} Cancel
                                </button>
                            </div>
                        </div>
                    `
                        : `
                        <!-- Display Comment -->
                        <div class="flex items-center justify-between">
                            <p class="font-normal ${
                              appState.theme === "light"
                                ? "text-gray-700"
                                : "text-gray-300"
                            } mb-3">${repliedToHtml}${comment.content}</p>
                            ${
                              comment.authorId === appState.userId
                                ? `
                                <div class="flex gap-2">
                                    <button id="edit-comment-btn-${
                                      comment.id
                                    }" class="p-1 rounded-full ${
                                    appState.theme === "light"
                                      ? "hover:bg-gray-100"
                                      : "hover:bg-gray-700"
                                  } transition-colors text-xs" aria-label="Edit Comment">
                                        ${Icons.Edit}
                                    </button>
                                    <button id="delete-comment-btn-${
                                      comment.id
                                    }" class="p-1 rounded-full ${
                                    appState.theme === "light"
                                      ? "hover:bg-red-100 text-red-600"
                                      : "hover:bg-red-800 text-red-400"
                                  } transition-colors text-xs" aria-label="Delete Comment">
                                        ${Icons.Trash}
                                    </button>
                                </div>
                            `
                                : ""
                            }
                        </div>
                    `
                    }
                    <div class="flex flex-wrap gap-2 text-sm">
                        <button id="comment-upvote-btn-${
                          comment.id
                        }" class="flex items-center gap-1 px-2 py-1 rounded-md text-xs font-semibold 
                            ${
                              comment.upvotedBy &&
                              comment.upvotedBy.includes(appState.userId)
                                ? appState.theme === "light"
                                  ? "bg-blue-500 text-white"
                                  : "bg-blue-600 text-white"
                                : appState.theme === "light"
                                ? "bg-blue-50 text-blue-700 hover:bg-blue-100"
                                : "bg-blue-900 text-blue-200 hover:bg-blue-800"
                            }
                            transition-colors">
                            <span class="w-3 h-3">${
                              comment.upvotedBy &&
                              comment.upvotedBy.includes(appState.userId)
                                ? Icons.ThumbsUpSolid
                                : Icons.ThumbsUp
                            }</span> ${comment.upvotes || 0}
                        </button>
                        <button id="comment-downvote-btn-${
                          comment.id
                        }" class="flex items-center gap-1 px-2 py-1 rounded-md text-xs font-semibold 
                            ${
                              comment.downvotedBy &&
                              comment.downvotedBy.includes(appState.userId)
                                ? appState.theme === "light"
                                  ? "bg-red-500 text-white"
                                  : "bg-red-600 text-white"
                                : appState.theme === "light"
                                ? "bg-red-50 text-red-700 hover:bg-red-100"
                                : "bg-red-900 text-red-200 hover:bg-red-800"
                            }
                            transition-colors">
                            <span class="w-3 h-3">${
                              comment.downvotedBy &&
                              comment.downvotedBy.includes(appState.userId)
                                ? Icons.ThumbsDownSolid
                                : Icons.ThumbsDown
                            }</span> ${comment.downvotes || 0}
                        </button>
                        <button id="comment-ai-summary-btn-${
                          comment.id
                        }" class="flex items-center gap-1 px-2 py-1 rounded-md text-xs font-semibold ${
            appState.theme === "light"
              ? "bg-purple-50 text-purple-700 hover:bg-purple-100"
              : "bg-purple-900 text-purple-200 hover:bg-purple-800"
          } transition-colors">
                            <span class="w-3 h-3">${Icons.Zap}</span> AI
                        </button>
                        <button id="comment-reply-btn-${
                          comment.id
                        }" class="flex items-center gap-1 px-2 py-1 rounded-md text-xs font-semibold ${
            appState.theme === "light"
              ? "bg-gray-100 text-gray-700 hover:bg-gray-200"
              : "bg-gray-700 text-gray-200 hover:bg-gray-600"
          } transition-colors">
                            Reply
                        </button>
                    </div>
                    <div id="reply-form-container-${
                      comment.id
                    }" class="mt-3 hidden">
                        <textarea id="reply-textarea-${
                          comment.id
                        }" class="w-full p-2 border rounded-xl focus:ring-1 focus:ring-blue-400 ${
            appState.theme === "light"
              ? "border-gray-200 bg-gray-50 text-gray-900"
              : "border-gray-700 bg-gray-900 text-white"
          } transition-colors" rows="2" placeholder="Write your reply..." required></textarea>
                        <button id="submit-reply-btn-${
                          comment.id
                        }" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors" disabled>Post Reply</button>
                    </div>
                `;
          containerElement.appendChild(commentDiv);

          // Make author name clickable in comments
          const commentAuthorNameSpan = commentDiv.querySelector(
            `span[data-user-id="${comment.authorId}"]`
          );
          if (commentAuthorNameSpan) {
            commentAuthorNameSpan.onclick = (e) => {
              e.stopPropagation();
              navigateTo("profile", { targetUserId: comment.authorId });
            };
          }

          // Attach event listener for the new follow button in comments
          const followCommentAuthorBtn = commentDiv.querySelector(
            `.follow-button-comment`
          );
          if (followCommentAuthorBtn) {
            followCommentAuthorBtn.onclick = (e) => {
              e.stopPropagation();
              toggleFollow(comment.authorId);
            };
          }

          // Attach event listeners for comment actions
          document.getElementById(
            `comment-upvote-btn-${comment.id}`
          ).onclick = () => updateCommentVotes(comment.id, "up");
          document.getElementById(
            `comment-downvote-btn-${comment.id}`
          ).onclick = () => updateCommentVotes(comment.id, "down");
          document.getElementById(
            `comment-ai-summary-btn-${comment.id}`
          ).onclick = () =>
            callGeminiAI(
              `Analyze and provide a concise summary or critique of the following comment within an IELTS forum discussion:\n\n"${comment.content}"\n\nComment Author: ${comment.authorName}`,
              `ai-comment-response-${comment.id}`
            );

          const replyButton = document.getElementById(
            `comment-reply-btn-${comment.id}`
          );
          const replyFormContainer = document.getElementById(
            `reply-form-container-${comment.id}`
          );
          const replyTextarea = document.getElementById(
            `reply-textarea-${comment.id}`
          );
          const submitReplyBtn = document.getElementById(
            `submit-reply-btn-${comment.id}`
          );

          replyButton.onclick = () => {
            replyFormContainer.classList.toggle("hidden");
            if (!replyFormContainer.classList.contains("hidden")) {
              replyTextarea.focus();
            }
          };

          replyTextarea.oninput = () => {
            submitReplyBtn.disabled = !replyTextarea.value.trim();
          };

          submitReplyBtn.onclick = () => {
            // When adding a reply, the depth increments. However, for visual display
            // we only care about the single indent for any reply.
            addComment(
              postId,
              replyTextarea.value,
              comment.id,
              comment.depth + 1
            );
            replyTextarea.value = "";
            submitReplyBtn.disabled = true;
            replyFormContainer.classList.add("hidden"); // Hide form after submitting
          };

          // Edit comment listeners
          if (comment.authorId === appState.userId) {
            const editCommentBtn = document.getElementById(
              `edit-comment-btn-${comment.id}`
            );
            if (editCommentBtn) {
              editCommentBtn.onclick = () => {
                appState.editingCommentId = comment.id;
                renderComments(postId); // Re-render comments to show edit form
              };
            }
            const saveCommentBtn = document.getElementById(
              `save-comment-btn-${comment.id}`
            );
            const cancelEditCommentBtn = document.getElementById(
              `cancel-edit-comment-btn-${comment.id}`
            );
            if (saveCommentBtn && cancelEditCommentBtn) {
              saveCommentBtn.onclick = () => {
                const newContent = document.getElementById(
                  `edit-comment-content-${comment.id}`
                ).value;
                if (newContent.trim()) {
                  updateComment(comment.id, newContent);
                } else {
                  showToast("Comment content cannot be empty.", "error");
                }
              };
              cancelEditCommentBtn.onclick = () => {
                appState.editingCommentId = null;
                renderComments(postId); // Exit edit mode
              };
            }
            const deleteCommentBtn = document.getElementById(
              `delete-comment-btn-${comment.id}`
            );
            if (deleteCommentBtn) {
              deleteCommentBtn.onclick = () =>
                deleteComment(comment.id, postId);
            }
          }
        }

        // Render comments based on the flattened and sorted list
        // Process top-level comments first, then their descendants if expanded
        topLevelComments.forEach((toplevelComment) => {
          renderCommentBlock(toplevelComment, commentsContainer); // Render the top-level comment

          // If the top-level comment is expanded, render all its descendants
          if (appState.expandedReplies[toplevelComment.id]) {
            const allDescendants = getAllDescendants(
              toplevelComment.id,
              commentData
            );
            allDescendants.forEach((descendant) => {
              renderCommentBlock(descendant, commentsContainer);
            });
          }

          // Add the "View/Hide Replies" button only for top-level comments that have direct children
          if (toplevelComment.directChildren.length > 0) {
            const toggleRepliesButton = document.createElement("button");
            const areRepliesExpanded =
              appState.expandedReplies[toplevelComment.id];
            const allReplyCount = getAllDescendants(
              toplevelComment.id,
              commentData
            ).length; // Count total descendants
            const buttonText = areRepliesExpanded
              ? `Hide Replies`
              : `View ${allReplyCount} replies`;
            const icon = areRepliesExpanded
              ? Icons.ChevronDown
              : Icons.ChevronRight;

            // This button should appear below the top-level comment's content, but before the next top-level comment.
            // It should not be indented, to indicate it controls the entire thread.
            toggleRepliesButton.className = `flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold mt-2 mb-3 ${
              appState.theme === "light"
                ? "bg-blue-50 text-blue-700 hover:bg-blue-100"
                : "bg-blue-900 text-blue-200 hover:bg-blue-800"
            } transition-colors`;
            toggleRepliesButton.innerHTML = `${icon} ${buttonText}`;
            toggleRepliesButton.onclick = (e) => {
              e.stopPropagation();
              appState.expandedReplies = {
                ...appState.expandedReplies,
                [toplevelComment.id]: !areRepliesExpanded, // Toggle state for the top-level comment
              };
              renderComments(postId); // Re-render all comments to reflect changes
            };
            commentsContainer.appendChild(toggleRepliesButton);
          }
        });
      }

      function renderCreatePostForm() {
        const mainContent = elements.mainContent;
        mainContent.innerHTML = `
                <div class="flex-1">
                    <button id="back-to-home-btn" class="mb-6 flex items-center gap-2 text-base font-semibold ${
                      appState.theme === "light"
                        ? "text-blue-600 hover:text-blue-700"
                        : "text-blue-400 hover:text-blue-300"
                    } transition-colors">
                        <span class="w-5 h-5">${
                          Icons.ArrowLeft
                        }</span> Back to Forum
                    </button>
                    <div class="p-6 md:p-8 rounded-2xl shadow-lg transition-colors duration-300 ${
                      appState.theme === "light" ? "bg-white" : "bg-gray-800"
                    }">
                        <h2 class="text-3xl font-bold font-normal mb-6 ${
                          appState.theme === "light"
                            ? "text-gray-900"
                            : "text-white"
                        }">Create New Post</h2>
                        <form id="create-post-form" class="space-y-6">
                            <div>
                                <label for="post-title" class="block text-sm font-medium mb-2 ${
                                  appState.theme === "light"
                                    ? "text-gray-700"
                                    : "text-gray-300"
                                }">Title</label>
                                <input type="text" id="post-title" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                  appState.theme === "light"
                                    ? "border-gray-200 bg-gray-50 text-gray-900"
                                    : "border-gray-700 bg-gray-900 text-white"
                                } transition-colors" placeholder="Enter post title" required />
                            </div>
                            <div>
                                <label for="post-content" class="block text-sm font-medium mb-2 ${
                                  appState.theme === "light"
                                    ? "text-gray-700"
                                    : "text-gray-300"
                                }">Content</label>
                                <!-- Rich Text Editor Placeholder -->
                                <textarea id="post-content" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                  appState.theme === "light"
                                    ? "border-gray-200 bg-gray-50 text-gray-900"
                                    : "border-gray-700 bg-gray-900 text-white"
                                } transition-colors" rows="8" placeholder="Share your thoughts, questions, or tips..." required></textarea>
                                <p class="mt-2 text-xs ${
                                  appState.theme === "light"
                                    ? "text-gray-500"
                                    : "text-gray-400"
                                }">
                                    Share your thoughts, questions, or tips. (A rich text editor will be added here soon for better formatting!)
                                </p>
                            </div>
                            <!-- Image and Video upload fields removed -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="post-category" class="block text-sm font-medium mb-2 ${
                                      appState.theme === "light"
                                        ? "text-gray-700"
                                        : "text-gray-300"
                                    }">Category</label>
                                    <select id="post-category" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                      appState.theme === "light"
                                        ? "border-gray-200 bg-gray-50 text-gray-900"
                                        : "border-gray-700 bg-gray-900 text-white"
                                    } transition-colors" required>
                                        <option value="">Select a Category</option>
                                    </select>
                                </div>
                                <div id="subcategory-container" class="hidden">
                                    <label for="post-sub-category" class="block text-sm font-medium mb-2 ${
                                      appState.theme === "light"
                                        ? "text-gray-700"
                                        : "text-gray-300"
                                    }">Subcategory (Optional)</label>
                                    <select id="post-sub-category" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                      appState.theme === "light"
                                        ? "border-gray-200 bg-gray-50 text-gray-900"
                                        : "border-gray-700 bg-gray-900 text-white"
                                    } transition-colors"></select>
                                </div>
                            </div>
                            <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-colors font-semibold transform active:scale-95">
                                Create Post
                            </button>
                        </form>
                    </div>
                </div>
                <div id="right-sidebar" class="w-64 ml-8 p-6 hidden lg:block rounded-2xl shadow-lg ${
                  appState.theme === "light" ? "bg-white" : "bg-gray-800"
                }">
                    <!-- Right sidebar content will be rendered here -->
                </div>
            `;

        document.getElementById("back-to-home-btn").onclick = () =>
          navigateTo("home");

        const form = document.getElementById("create-post-form");
        const titleInput = document.getElementById("post-title");
        const contentTextarea = document.getElementById("post-content");
        const categorySelect = document.getElementById("post-category");
        const subCategorySelect = document.getElementById("post-sub-category");
        const subCategoryContainer = document.getElementById(
          "subcategory-container"
        );
        // Removed references to imageUpload and videoUpload

        const categoriesData = [
          {
            name: "IELTS Speaking",
            subcategories: ["Cue Cards", "Fluency", "Pronunciation"],
          },
          {
            name: "IELTS Writing",
            subcategories: [
              "Writing Task 1",
              "Writing Task 2",
              "Grammar Help",
              "Vocabulary",
            ],
          },
          { name: "IELTS Listening" },
          { name: "IELTS Reading" },
          { name: "Tips & Strategies" },
          { name: "Band 9 Answers" },
          { name: "Motivation & Support" },
        ];

        // Populate categories
        categoriesData.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat.name;
          option.textContent = cat.name;
          categorySelect.appendChild(option);
        });

        // Handle category change to update subcategories
        categorySelect.onchange = () => {
          const selectedCategory = categoriesData.find(
            (cat) => cat.name === categorySelect.value
          );
          subCategorySelect.innerHTML =
            '<option value="">Select a Subcategory</option>'; // Reset subcategories
          if (
            selectedCategory &&
            selectedCategory.subcategories &&
            selectedCategory.subcategories.length > 0
          ) {
            subCategoryContainer.classList.remove("hidden");
            selectedCategory.subcategories.forEach((sub) => {
              const option = document.createElement("option");
              option.value = sub;
              option.textContent = sub;
              subCategorySelect.appendChild(option);
            });
          } else {
            subCategoryContainer.classList.add("hidden");
          }
        };

        form.onsubmit = async (e) => {
          e.preventDefault();
          await addPost({
            title: titleInput.value,
            content: contentTextarea.value,
            category: categorySelect.value,
            subCategory: subCategorySelect.value || null,
          });
          // No need to clear file inputs as they are removed
        };
        renderRightSidebar(); // Render the right sidebar for create post view
      }

      /**
       * Renders a user's profile page. This function now supports viewing
       * both the current user's profile and other users' profiles.
       * @param {string} targetUserId The ID of the user whose profile is to be displayed.
       */
      async function renderProfilePage(targetUserId) {
        const mainContent = elements.mainContent;
        const appId =
          typeof __app_id !== "undefined"
            ? __app_id
            : "ielts-mahir-community-forum";

        let profileData = appState.allUsersProfiles.find(
          (p) => p.userId === targetUserId
        );
        let isCurrentUserProfile = targetUserId === appState.userId;

        // If profileData is not in our local cache, fetch it.
        if (!profileData) {
          if (!appState.db) {
            mainContent.innerHTML = `<div class="flex-1 p-6 flex justify-center items-center ${
              appState.theme === "light" ? "text-gray-700" : "text-gray-300"
            }">Database not initialized.</div>`;
            return;
          }
          mainContent.innerHTML = `<div class="flex-1 p-6 flex justify-center items-center ${
            appState.theme === "light" ? "text-gray-700" : "text-gray-300"
          }">
                    <div class="flex flex-col items-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                        <p class="text-lg ${
                          appState.theme === "light"
                            ? "text-gray-700"
                            : "text-gray-300"
                        }">Loading profile...</p>
                    </div>
                </div>`;
          try {
            const userRef = doc(
              appState.db,
              `artifacts/${appId}/users/${targetUserId}/userProfile/profile`
            );
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
              profileData = { userId: targetUserId, ...userSnap.data() };
              // Add to cache
              const index = appState.allUsersProfiles.findIndex(
                (p) => p.userId === targetUserId
              );
              if (index === -1) {
                appState.allUsersProfiles.push(profileData);
              } else {
                appState.allUsersProfiles[index] = profileData;
              }
            } else {
              mainContent.innerHTML = `<div class="flex-1 p-6 flex justify-center items-center ${
                appState.theme === "light" ? "text-red-600" : "text-red-400"
              }">User profile not found.</div>`;
              return;
            }
          } catch (e) {
            console.error("Error fetching profile:", e);
            mainContent.innerHTML = `<div class="flex-1 p-6 flex justify-center items-center ${
              appState.theme === "light" ? "text-red-600" : "text-red-400"
            }">Error loading profile.</div>`;
            showToast("Error loading profile. Check console.", "error");
            return;
          }
        }

        const profile = profileData;
        let lastLoginStatus = "N/A";
        if (profile.lastLogin) {
          const now = new Date();
          const lastLoginDate = profile.lastLogin.toDate();
          const minutesSinceLastLogin = Math.floor(
            (now - lastLoginDate) / (1000 * 60)
          );

          if (minutesSinceLastLogin <= 15) {
            // Consider "active now" if logged in within last 15 minutes
            lastLoginStatus = "Active Now";
          } else {
            lastLoginStatus = `Last Online: ${formatRelativeTime(
              profile.lastLogin
            )}`;
          }
        }

        // Filter posts created by the current viewed user
        const userPosts = appState.posts.filter(
          (post) => post.authorId === targetUserId
        );

        // Check if current user is following the viewed profile
        const isFollowing = appState.userProfile?.following?.includes(
          targetUserId
        );

        // Calculate followers from the local cache of all users
        const followersCount = appState.allUsersProfiles.filter((p) =>
          p.following?.includes(targetUserId)
        ).length;

        mainContent.innerHTML = `
                <div class="flex-1">
                    <button id="back-to-home-btn" class="mb-6 flex items-center gap-2 text-base font-semibold ${
                      appState.theme === "light"
                        ? "text-blue-600 hover:text-blue-700"
                        : "text-blue-400 hover:text-blue-300"
                    } transition-colors">
                        <span class="w-5 h-5">${
                          Icons.ArrowLeft
                        }</span> Back to Forum
                    </button>
                    <div class="p-6 md:p-8 rounded-2xl shadow-lg transition-colors duration-300 ${
                      appState.theme === "light" ? "bg-white" : "bg-gray-800"
                    }">
                        <div class="flex flex-col sm:flex-row items-center gap-6 mb-6 pb-6 border-b border-gray-200 dark:border-gray-700">
                            <div class="w-28 h-28 rounded-full flex items-center justify-center bg-blue-100 text-blue-600 text-6xl font-anton ring-4 ring-blue-200 dark:ring-blue-700">
                                ${
                                  profile.name
                                    ? profile.name[0].toUpperCase()
                                    : Icons.User
                                }
                            </div>
                            <div class="text-center sm:text-left flex-1">
                                <h2 class="text-3xl md:text-4xl font-bold font-anton ${
                                  appState.theme === "light"
                                    ? "text-gray-900"
                                    : "text-white"
                                }">${profile.name || "Anonymous"}</h2>
                                <p class="text-md ${
                                  appState.theme === "light"
                                    ? "text-gray-600"
                                    : "text-gray-400"
                                }">User ID: ${targetUserId}</p>
                                ${
                                  profile.lastLogin
                                    ? `<p class="text-xs ${
                                        appState.theme === "light"
                                          ? "text-gray-500"
                                          : "text-gray-400"
                                      }">Status: ${lastLoginStatus}</p>`
                                    : ""
                                }
                            </div>
                            <div class="flex-shrink-0">
                                ${
                                  isCurrentUserProfile && appState.userId
                                    ? appState.editingProfile
                                      ? `
                                        <button id="save-profile-btn" class="flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-xl shadow-md hover:bg-green-700 transition-all text-sm font-semibold transform active:scale-95">
                                            ${Icons.Save} Save Changes
                                        </button>
                                        <button id="cancel-edit-profile-btn" class="flex items-center gap-2 px-5 py-2.5 bg-gray-300 text-gray-800 rounded-xl shadow-md hover:bg-gray-400 transition-all text-sm font-semibold transform active:scale-95 mt-2">
                                            ${Icons.Cancel} Cancel
                                        </button>
                                    `
                                      : `
                                        <button id="edit-profile-btn" class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-all text-sm font-semibold transform active:scale-95">
                                            ${Icons.Edit} Edit Profile
                                        </button>
                                    `
                                    : // Render Follow/Unfollow button for other users
                                    appState.userId &&
                                      targetUserId !== appState.userId
                                    ? `
                                        <button id="follow-btn" class="flex items-center gap-2 px-5 py-2.5 rounded-xl shadow-md transition-all text-sm font-semibold transform active:scale-95 ${
                                          isFollowing
                                            ? "bg-gray-300 text-gray-800 hover:bg-gray-400"
                                            : "bg-blue-600 text-white hover:bg-blue-700"
                                        }">
                                            ${
                                              isFollowing
                                                ? `<i class="fas fa-check"></i> Unfollow`
                                                : `<i class="fas fa-user-plus"></i> Follow`
                                            }
                                        </button>
                                    `
                                    : ""
                                }
                            </div>
                        </div>

                        ${
                          isCurrentUserProfile && appState.editingProfile
                            ? `
                            <!-- Edit Profile Form -->
                            <div class="space-y-4">
                                <div>
                                    <label for="edit-profile-name" class="block text-sm font-medium mb-1 ${
                                      appState.theme === "light"
                                        ? "text-gray-700"
                                        : "text-gray-300"
                                    }">Name</label>
                                    <input type="text" id="edit-profile-name" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                      appState.theme === "light"
                                        ? "border-gray-200 bg-gray-50 text-gray-900"
                                        : "border-gray-700 bg-gray-900 text-white"
                                    } transition-colors" value="${
                                profile.name || ""
                              }" required />
                                </div>
                                <div>
                                    <label for="edit-profile-bio" class="block text-sm font-medium mb-1 ${
                                      appState.theme === "light"
                                        ? "text-gray-700"
                                        : "text-gray-300"
                                    }">Bio (Optional)</label>
                                    <textarea id="edit-profile-bio" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                      appState.theme === "light"
                                        ? "border-gray-200 bg-gray-50 text-gray-900"
                                        : "border-gray-700 bg-gray-900 text-white"
                                    } transition-colors" rows="3" placeholder="Tell us about yourself...">${
                                profile.bio || ""
                              }</textarea>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="edit-profile-band-goal" class="block text-sm font-medium mb-1 ${
                                          appState.theme === "light"
                                            ? "text-gray-700"
                                            : "text-gray-300"
                                        }">Target Band</label>
                                        <select id="edit-profile-band-goal" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                          appState.theme === "light"
                                            ? "border-gray-200 bg-gray-50 text-gray-900"
                                            : "border-gray-700 bg-gray-900 text-white"
                                        } transition-colors"></select>
                                    </div>
                                    <div>
                                        <label for="edit-profile-prep-status" class="block text-sm font-medium mb-1 ${
                                          appState.theme === "light"
                                            ? "text-gray-700"
                                            : "text-gray-300"
                                        }">Preparation Status</label>
                                        <select id="edit-profile-prep-status" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                          appState.theme === "light"
                                            ? "border-gray-200 bg-gray-50 text-gray-900"
                                            : "border-gray-700 bg-gray-900 text-white"
                                        } transition-colors"></select>
                                    </div>
                                    <div>
                                        <label for="edit-profile-country" class="block text-sm font-medium mb-1 ${
                                          appState.theme === "light"
                                            ? "text-gray-700"
                                            : "text-gray-300"
                                        }">Country</label>
                                        <select id="edit-profile-country" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                          appState.theme === "light"
                                            ? "border-gray-200 bg-gray-50 text-gray-900"
                                            : "border-gray-700 bg-gray-900 text-white"
                                        } transition-colors"></select>
                                    </div>
                                    <div>
                                        <label for="edit-profile-ielts-experience" class="block text-sm font-medium mb-1 ${
                                          appState.theme === "light"
                                            ? "text-gray-700"
                                            : "text-gray-300"
                                        }">IELTS Experience</label>
                                        <select id="edit-profile-ielts-experience" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                          appState.theme === "light"
                                            ? "border-gray-200 bg-gray-50 text-gray-900"
                                            : "border-gray-700 bg-gray-900 text-white"
                                        } transition-colors"></select>
                                    </div>
                                </div>
                            </div>
                        `
                            : `
                            <!-- Display Profile -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <h3 class="text-xl font-semibold font-normal mb-4 ${
                                      appState.theme === "light"
                                        ? "text-gray-800"
                                        : "text-white"
                                    }">About Me</h3>
                                    <div class="space-y-4">
                                        <div class="flex items-start gap-3 p-3 rounded-lg ${
                                          appState.theme === "light"
                                            ? "bg-gray-50"
                                            : "bg-gray-700"
                                        } shadow-sm">
                                            <span class="w-5 h-5 flex-shrink-0">${
                                              Icons.User
                                            }</span>
                                            <p class="font-normal ${
                                              appState.theme === "light"
                                                ? "text-gray-700"
                                                : "text-gray-300"
                                            }">
                                                ${
                                                  profile.bio ||
                                                  "No bio provided."
                                                }
                                            </p>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 rounded-lg ${
                                          appState.theme === "light"
                                            ? "bg-gray-50"
                                            : "bg-gray-700"
                                        } shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.Award
                                            }</span>
                                            <span class="font-normal ${
                                              appState.theme === "light"
                                                ? "text-gray-700"
                                                : "text-gray-300"
                                            }">
                                                Reputation Points: <span class="font-bold text-lg">${
                                                  profile.reputation || 0
                                                }</span>
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 rounded-lg ${
                                          appState.theme === "light"
                                            ? "bg-gray-50"
                                            : "bg-gray-700"
                                        } shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.Users
                                            }</span>
                                            <span class="font-normal ${
                                              appState.theme === "light"
                                                ? "text-gray-700"
                                                : "text-gray-300"
                                            }">
                                                Followers: <span class="font-bold text-lg">${followersCount}</span>
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 rounded-lg ${
                                          appState.theme === "light"
                                            ? "bg-gray-50"
                                            : "bg-gray-700"
                                        } shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.Star
                                            }</span>
                                            <span class="font-normal ${
                                              appState.theme === "light"
                                                ? "text-gray-700"
                                                : "text-gray-300"
                                            }">
                                                Following: <span class="font-bold text-lg">${
                                                  (profile.following || [])
                                                    .length
                                                }</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="text-xl font-semibold font-normal mb-4 ${
                                      appState.theme === "light"
                                        ? "text-gray-800"
                                        : "text-white"
                                    }">IELTS Journey</h3>
                                    <div class="space-y-4">
                                        <div class="flex items-center gap-3 p-3 rounded-lg ${
                                          appState.theme === "light"
                                            ? "bg-gray-50"
                                            : "bg-gray-700"
                                        } shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.Target
                                            }</span>
                                            <span class="font-normal ${
                                              appState.theme === "light"
                                                ? "text-gray-700"
                                                : "text-gray-300"
                                            }">
                                                Target Band: <span class="font-bold text-lg">${
                                                  profile.bandGoal || "N/A"
                                                }</span>
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 rounded-lg ${
                                          appState.theme === "light"
                                            ? "bg-gray-50"
                                            : "bg-gray-700"
                                        } shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.Activity
                                            }</span>
                                            <span class="font-normal ${
                                              appState.theme === "light"
                                                ? "text-gray-700"
                                                : "text-gray-300"
                                            }">
                                                Preparation Status: <span class="font-bold text-lg">${
                                                  profile.preparationStatus ||
                                                  "New Learner"
                                                }</span>
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 rounded-lg ${
                                          appState.theme === "light"
                                            ? "bg-gray-50"
                                            : "bg-gray-700"
                                        } shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.Link
                                            }</span>
                                            <span class="font-normal ${
                                              appState.theme === "light"
                                                ? "text-gray-700"
                                                : "text-gray-300"
                                            }">
                                                Country: <span class="font-bold text-lg">${
                                                  profile.country ||
                                                  "Not specified"
                                                }</span>
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 rounded-lg ${
                                          appState.theme === "light"
                                            ? "bg-gray-50"
                                            : "bg-gray-700"
                                        } shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.CheckCircle
                                            }</span>
                                            <span class="font-normal ${
                                              appState.theme === "light"
                                                ? "text-gray-700"
                                                : "text-gray-300"
                                            }">
                                                IELTS Experience: <span class="font-bold text-lg">${
                                                  profile.ieltsExperience ||
                                                  "Not specified"
                                                }</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-span-1 md:col-span-2">
                                    <h3 class="text-xl font-semibold font-normal mb-4 ${
                                      appState.theme === "light"
                                        ? "text-gray-800"
                                        : "text-white"
                                    }">Badges</h3>
                                    <div id="badges-container" class="flex flex-wrap gap-3">
                                        <!-- Badges will be appended here -->
                                    </div>
                                </div>
                            </div>
                        `
                        }
                    </div>

                    <!-- User's Posts Section -->
                    <div class="mt-8 p-6 md:p-8 rounded-2xl shadow-lg transition-colors duration-300 ${
                      appState.theme === "light" ? "bg-white" : "bg-gray-800"
                    }">
                        <h3 class="text-2xl font-bold font-normal mb-4 ${
                          appState.theme === "light"
                            ? "text-gray-900"
                            : "text-white"
                        }">${profile.name || "This user"}'s Posts (${
          userPosts.length
        })</h3>
                        <div id="user-posts-container" class="space-y-6">
                            <!-- User's posts will be rendered here -->
                        </div>
                    </div>
                </div>
                <div id="right-sidebar" class="w-64 ml-8 p-6 hidden lg:block rounded-2xl shadow-lg ${
                  appState.theme === "light" ? "bg-white" : "bg-gray-800"
                }">
                    <!-- Right sidebar content will be rendered here -->
                </div>
            `;
        document.getElementById("back-to-home-btn").onclick = () =>
          navigateTo("home");

        // Handle edit/save/cancel buttons ONLY if it's the current user's profile
        if (isCurrentUserProfile && appState.userId) {
          if (appState.editingProfile) {
            const nameInput = document.getElementById("edit-profile-name");
            const bioTextarea = document.getElementById("edit-profile-bio");
            const bandGoalSelect = document.getElementById(
              "edit-profile-band-goal"
            );
            const prepStatusSelect = document.getElementById(
              "edit-profile-prep-status"
            );
            const countrySelect = document.getElementById(
              "edit-profile-country"
            );
            const ieltsExperienceSelect = document.getElementById(
              "edit-profile-ielts-experience"
            );

            // Populate select options
            BAND_GOALS.forEach((goal) => {
              const option = document.createElement("option");
              option.value = goal;
              option.textContent = goal;
              bandGoalSelect.appendChild(option);
            });
            bandGoalSelect.value = profile.bandGoal || BAND_GOALS[0];

            PREP_STATUSES.forEach((status) => {
              const option = document.createElement("option");
              option.value = status;
              option.textContent = status;
              prepStatusSelect.appendChild(option);
            });
            prepStatusSelect.value =
              profile.preparationStatus || PREP_STATUSES[0];

            COUNTRIES.forEach((country) => {
              const option = document.createElement("option");
              option.value = country;
              option.textContent = country;
              countrySelect.appendChild(option);
            });
            countrySelect.value = profile.country || ""; // Set default or current value

            IELTS_EXPERIENCES.forEach((exp) => {
              const option = document.createElement("option");
              option.value = exp;
              option.textContent = exp;
              ieltsExperienceSelect.appendChild(option);
            });
            ieltsExperienceSelect.value =
              profile.ieltsExperience || IELTS_EXPERIENCES[0];

            document.getElementById("save-profile-btn").onclick = () => {
              const updatedData = {
                name: nameInput.value.trim(),
                bio: bioTextarea.value.trim(),
                bandGoal: bandGoalSelect.value,
                preparationStatus: prepStatusSelect.value,
                country: countrySelect.value,
                ieltsExperience: ieltsExperienceSelect.value,
              };
              if (updatedData.name) {
                updateUserProfile(updatedData);
              } else {
                showToast("Name cannot be empty.", "error");
              }
            };
            document.getElementById("cancel-edit-profile-btn").onclick = () => {
              appState.editingProfile = false;
              renderProfilePage(targetUserId); // Re-render without edit mode
            };
          } else {
            document.getElementById("edit-profile-btn").onclick = () => {
              appState.editingProfile = true;
              renderProfilePage(targetUserId); // Re-render in edit mode
            };
          }
        } else if (appState.userId && targetUserId !== appState.userId) {
          // Logic for other users' profiles
          const followBtn = document.getElementById("follow-btn");
          if (followBtn) {
            followBtn.onclick = () => toggleFollow(targetUserId);
          }
        }

        const badgesContainer = document.getElementById("badges-container");
        if (profile.badges && profile.badges.length > 0) {
          profile.badges.forEach((badgeId) => {
            const badge = ALL_BADGES.find((b) => b.id === badgeId);
            if (badge) {
              const badgeSpan = document.createElement("span");
              badgeSpan.className = `flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium ${
                appState.theme === "light"
                  ? "bg-yellow-100 text-yellow-800"
                  : "bg-yellow-900 text-yellow-200"
              } shadow-sm`;
              badgeSpan.innerHTML = `<span class="text-lg">${badge.icon}</span> ${badge.name}`;
              badgesContainer.appendChild(badgeSpan);
            }
          });
        } else {
          badgesContainer.innerHTML = `<p class="text-md ${
            appState.theme === "light" ? "text-gray-600" : "text-gray-400"
          }">No badges earned yet.</p>`;
        }

        // Render user's posts
        const userPostsContainer = document.getElementById(
          "user-posts-container"
        );
        if (userPosts.length === 0) {
          userPostsContainer.innerHTML = `<p class="text-lg ${
            appState.theme === "light" ? "text-gray-600" : "text-gray-400"
          }">There are no posts from this user yet.</p>`;
        } else {
          userPosts.forEach((post) => {
            const postDiv = document.createElement("div");
            postDiv.className = `p-6 rounded-2xl shadow-lg transition-all duration-200 hover:shadow-xl hover:scale-[1.01] cursor-pointer ${
              appState.theme === "light" ? "bg-white" : "bg-gray-800"
            }`;
            postDiv.addEventListener("click", (e) => {
              if (
                e.target.tagName !== "BUTTON" &&
                e.target.tagName !== "SPAN" &&
                e.target.tagName !== "A"
              ) {
                navigateTo("postDetail", { post: post });
              }
            });

            const formattedTime = formatRelativeTime(post.createdAt);
            const commentsCount = (appState.comments[post.id] || []).length;
            const isAuthorCurrentUsersPost =
              appState.userId && post.authorId === appState.userId;
            const isFollowingPostAuthor = appState.userProfile?.following?.includes(
              post.authorId
            );

            postDiv.innerHTML = `
                        <h3 class="text-xl font-semibold font-normal mb-2 ${
                          appState.theme === "light"
                            ? "text-blue-700"
                            : "text-blue-400"
                        }">
                            ${post.title}
                        </h3>
                        <p class="text-sm ${
                          appState.theme === "light"
                            ? "text-gray-600"
                            : "text-gray-300"
                        } mb-3 line-clamp-2">
                            ${post.content}
                        </p>
                        <div class="flex items-center justify-between text-xs font-normal ${
                          appState.theme === "light"
                            ? "text-gray-500"
                            : "text-gray-400"
                        } border-t pt-3 mt-4 ${
              appState.theme === "light" ? "border-gray-100" : "border-gray-700"
            }">
                            <div class="flex items-center gap-2">
                                <span class="w-4 h-4">${Icons.User}</span>
                                <span class="font-bold cursor-pointer hover:underline" data-user-id="${targetUserId}">${
              post.authorName || "Anonymous"
            }</span>
                                ${
                                  !isAuthorCurrentUsersPost && appState.userId
                                    ? `
                                    <button class="ml-2 px-2 py-1 rounded-full text-xs font-semibold
                                        ${
                                          isFollowingPostAuthor
                                            ? "bg-gray-300 text-gray-800 hover:bg-gray-400"
                                            : "bg-blue-100 text-blue-700 hover:bg-blue-200"
                                        }
                                        dark:${
                                          isFollowingPostAuthor
                                            ? "bg-gray-600 text-white hover:bg-gray-700"
                                            : "bg-blue-900 text-blue-200 hover:bg-blue-800"
                                        }
                                        transition-colors transform active:scale-95 follow-button hidden sm:block"
                                        data-target-user-id="${post.authorId}">
                                        ${
                                          isFollowingPostAuthor
                                            ? `<i class="fas fa-check"></i> Unfollow`
                                            : `<i class="fas fa-user-plus"></i> Follow`
                                        }
                                    </button>
                                `
                                    : ""
                                }
                                <span class="mx-1">•</span>
                                <span>${formattedTime}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="flex items-center gap-1 text-green-500">
                                    <span class="w-4 h-4">${
                                      Icons.ThumbsUp
                                    }</span> ${post.upvotes || 0}
                                </span>
                                <span class="flex items-center gap-1 text-red-500">
                                    <span class="w-4 h-4">${
                                      Icons.ThumbsDown
                                    }</span> ${post.downvotes || 0}
                                </span>
                                <span class="flex items-center gap-1 text-blue-500">
                                    <span class="w-4 h-4">${
                                      Icons.MessageCircleMore
                                    }</span> ${commentsCount}
                                </span>
                                ${
                                  post.isResolved
                                    ? `<span class="flex items-center gap-1 text-green-600 font-semibold"> <span class="w-4 h-4">${Icons.CheckCircle}</span> Resolved</span>`
                                    : ""
                                }
                            </div>
                        </div>
                        ${
                          post.category
                            ? `
                            <div class="mt-3 flex flex-wrap gap-2">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                  appState.theme === "light"
                                    ? "bg-blue-50 text-blue-700"
                                    : "bg-blue-900 text-blue-200"
                                }">
                                    ${post.category}
                                </span>
                                ${
                                  post.subCategory
                                    ? `<span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                        appState.theme === "light"
                                          ? "bg-indigo-50 text-indigo-700"
                                          : "bg-indigo-900 text-indigo-200"
                                      }"> ${post.subCategory}</span>`
                                    : ""
                                }
                                ${
                                  post.tags && post.tags.length > 0
                                    ? post.tags
                                        .map(
                                          (tag) =>
                                            `<span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                              appState.theme === "light"
                                                ? "bg-gray-100 text-gray-600"
                                                : "bg-gray-700 text-gray-300"
                                            }">${tag}</span>`
                                        )
                                        .join("")
                                    : ""
                                }
                            </div>
                        `
                            : ""
                        }
                    `;
            userPostsContainer.appendChild(postDiv);

            const postAuthorNameSpan = postDiv.querySelector(
              `span[data-user-id="${targetUserId}"]`
            );
            if (postAuthorNameSpan) {
              postAuthorNameSpan.onclick = (e) => {
                e.stopPropagation();
                navigateTo("profile", { targetUserId: targetUserId });
              };
            }

            // Attach event listener for the new follow button
            const followButtonPost = postDiv.querySelector(`.follow-button`);
            if (followButtonPost) {
              followButtonPost.onclick = (e) => {
                e.stopPropagation(); // Prevent the postDiv's click event from firing
                toggleFollow(post.authorId);
              };
            }
          });
        }
        renderRightSidebar(); // Render the right sidebar for profile view
      }

      // --- Main Render Loop ---
      function renderMainContent() {
        if (!appState.isAuthReady) {
          elements.mainContent.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center font-normal ${
                      appState.theme === "light"
                        ? "text-gray-800"
                        : "text-white"
                    } flex-1">
                        <div class="flex flex-col items-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                            <p class="text-lg ${
                              appState.theme === "light"
                                ? "text-gray-700"
                                : "text-gray-300"
                            }">Loading IELTS Mahir...</p>
                        </div>
                    </div>
                `;
          return;
        }

        switch (appState.view) {
          case "home":
            renderPostList();
            break;
          case "postDetail":
            renderPostDetail();
            break;
          case "createPost":
            renderCreatePostForm();
            break;
          case "profile":
            // Pass the target user ID for rendering
            renderProfilePage(appState.viewedProfile || appState.userId);
            break;
          default:
            renderPostList();
        }
      }

      function renderApp() {
        renderHeader();
        renderSidebar();
        renderMainContent();
        updateThemeClasses(); // Apply theme on initial render
      }

      // --- Firebase Listener Setup Function ---
      function setupFirestoreListeners() {
        const appId =
          typeof __app_id !== "undefined"
            ? __app_id
            : "ielts-mahir-community-forum";

        // Unsubscribe from previous listeners if they exist
        if (appState.postsUnsubscribe) appState.postsUnsubscribe();
        if (appState.commentsUnsubscribe) appState.commentsUnsubscribe();
        // Removed appState.userProfilesUnsubscribe as it was causing permission errors

        let postsQueryRef = collection(
          appState.db,
          `artifacts/${appId}/public/data/posts`
        );
        postsQueryRef = query(postsQueryRef, orderBy("createdAt", "desc"));

        // Set up real-time listener for posts
        appState.postsUnsubscribe = onSnapshot(
          postsQueryRef,
          (snapshot) => {
            appState.posts = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            // Update selectedPost with latest data if on post detail view
            if (appState.view === "postDetail" && appState.selectedPost) {
              const updatedSelectedPost = appState.posts.find(
                (p) => p.id === appState.selectedPost.id
              );
              if (updatedSelectedPost) {
                appState.selectedPost = updatedSelectedPost;
              }
            }
            updateCachedUserProfiles(); // Call this when posts update
            // Always re-render relevant content after posts update
            if (
              appState.view === "home" ||
              appState.view === "postDetail" ||
              appState.view === "profile"
            ) {
              renderMainContent();
            }
          },
          (error) => {
            console.error("Error fetching posts:", error);
            showToast("Error loading posts. Check console.", "error");
          }
        );

        // Set up real-time listener for ALL comments (to sort in memory later)
        const commentsColRef = collection(
          appState.db,
          `artifacts/${appId}/public/data/comments`
        );
        appState.commentsUnsubscribe = onSnapshot(
          commentsColRef,
          (snapshot) => {
            const allFetchedComments = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            // Organize comments by postId
            const commentsByPost = {};
            allFetchedComments.forEach((comment) => {
              if (!commentsByPost[comment.postId]) {
                commentsByPost[comment.postId] = [];
              }
              commentsByPost[comment.postId].push(comment);
            });

            appState.comments = commentsByPost;
            updateCachedUserProfiles(); // Call this when comments update
            // Re-render relevant content based on current view
            if (appState.view === "home") {
              renderPostList(); // To update comment counts on posts in home view
            } else if (
              appState.view === "postDetail" &&
              appState.selectedPost
            ) {
              renderComments(appState.selectedPost.id); // Re-render comments if on post detail view
            }
          },
          (error) => {
            console.error("Error fetching comments:", error);
            showToast("Error loading comments. Check console.", "error");
          }
        );
      }

      // New function to update the cache of user profiles from posts and comments
      async function updateCachedUserProfiles() {
        if (!appState.db) return;
        const appId =
          typeof __app_id !== "undefined"
            ? __app_id
            : "ielts-mahir-community-forum";

        const uniqueUserIds = new Set();
        // Add current user to ensure their profile is always in cache
        if (appState.userId) {
          uniqueUserIds.add(appState.userId);
        }
        appState.posts.forEach((post) => uniqueUserIds.add(post.authorId));
        Object.values(appState.comments)
          .flat()
          .forEach((comment) => uniqueUserIds.add(comment.authorId));

        const newAllUsersProfiles = [];
        for (const userId of uniqueUserIds) {
          // Check if profile is already in cache to avoid re-fetching unnecessarily
          const existingProfile = appState.allUsersProfiles.find(
            (p) => p.userId === userId
          );
          if (existingProfile) {
            newAllUsersProfiles.push(existingProfile);
            continue; // Skip fetching if already cached
          }

          const profileRef = doc(
            appState.db,
            `artifacts/${appId}/users/${userId}/userProfile/profile`
          );
          try {
            const profileSnap = await getDoc(profileRef);
            if (profileSnap.exists()) {
              newAllUsersProfiles.push({
                userId: userId,
                ...profileSnap.data(),
              });
            }
          } catch (e) {
            console.warn(
              `Could not fetch profile for user ${userId} during cache update (might be deleted or permission issue for specific user):`,
              e
            );
          }
        }
        appState.allUsersProfiles = newAllUsersProfiles;

        // Trigger re-render for views that depend on allUsersProfiles
        if (appState.view === "profile" || appState.view === "home") {
          renderMainContent();
        }
      }

      // --- Firebase Initialization and Listeners ---
      document.addEventListener("DOMContentLoaded", async () => {
        elements.header = document.getElementById("app-header");
        elements.sidebar = document.getElementById("app-sidebar");
        elements.mainContent = document.getElementById("main-content");
        elements.aiModalOverlay = document.getElementById("ai-modal-overlay");
        elements.aiModalCloseBtn = document.getElementById(
          "ai-modal-close-btn"
        );

        elements.aiModalCloseBtn.onclick = () => {
          elements.aiModalOverlay.classList.add("hidden");
        };

        // Define default Firebase config and app ID for local development
        // IMPORTANT: These have been updated with your provided details
        const defaultAppId = "ielts-mahir-community-forum";
        const defaultFirebaseConfig = {
          apiKey: "AIzaSyAxsd0CnLsh7t7yFy3ZPp6saGD_YpLL1mY",
          authDomain: "ielts-mahir-community-forum.firebaseapp.com",
          projectId: "ielts-mahir-community-forum",
          storageBucket: "ielts-mahir-community-forum.firebase-storage.app", // This will be unused
          messagingSenderId: "1036043607546",
          appId: "1:1036043607546:web:bd217e04cc0ec5f296d843",
          measurementId: "G-YC4CG1WKD3",
        };

        const appId = typeof __app_id !== "undefined" ? __app_id : defaultAppId;
        const firebaseConfig =
          typeof __firebase_config !== "undefined"
            ? JSON.parse(__firebase_config)
            : defaultFirebaseConfig;

        try {
          const app = initializeApp(firebaseConfig);
          appState.db = getFirestore(app);
          appState.auth = getAuth(app);

          // Listen for auth state changes
          onAuthStateChanged(appState.auth, async (user) => {
            if (user) {
              appState.userId = user.uid;
              appState.viewedProfile = user.uid; // Default to current user's profile on auth success

              // Fetch or create user profile
              const userRef = doc(
                appState.db,
                `artifacts/${appId}/users/${user.uid}/userProfile/profile`
              );
              const userSnap = await getDoc(userRef);
              if (userSnap.exists()) {
                appState.userProfile = userSnap.data();
                // Ensure following array exists
                if (!appState.userProfile.following) {
                  await updateDoc(userRef, { following: [] });
                  appState.userProfile.following = [];
                }
                // Ensure badges array exists
                if (!appState.userProfile.badges) {
                  // Check if they earned the first_post badge only if they've made posts.
                  // This is a simplified check. A proper system would check total posts count.
                  const userPostsQuery = query(
                    collection(
                      appState.db,
                      `artifacts/${appId}/public/data/posts`
                    ),
                    where("authorId", "==", user.uid)
                  );
                  const userPostsSnap = await getDocs(userPostsQuery);
                  if (userPostsSnap.empty) {
                    // No posts yet, so just "first_post"
                    await updateDoc(userRef, { badges: ["first_post"] });
                    appState.userProfile.badges = ["first_post"];
                  } else if (
                    !userPostsSnap.empty &&
                    !(userSnap.data().badges || []).includes("first_post")
                  ) {
                    // If posts exist but badge isn't there, add it.
                    await updateDoc(userRef, {
                      badges: arrayUnion("first_post"),
                    });
                    appState.userProfile.badges = [
                      ...(userSnap.data().badges || []),
                      "first_post",
                    ];
                  } else {
                    appState.userProfile.badges = userSnap.data().badges || [];
                  }
                }
              } else {
                const newUserProfile = {
                  name: `User-${user.uid.substring(0, 5)}`,
                  bandGoal: "N/A",
                  preparationStatus: "New Learner",
                  reputation: 0,
                  badges: ["first_post"], // Give new users a "first post" badge by default
                  createdAt: serverTimestamp(),
                  userId: user.uid,
                  bio: "",
                  country: "",
                  ieltsExperience: "",
                  following: [], // Initialize following list
                };
                await setDoc(userRef, newUserProfile);
                appState.userProfile = newUserProfile;
              }
              // Update lastLogin timestamp
              await updateDoc(userRef, { lastLogin: serverTimestamp() });
            } else {
              // Sign in anonymously if no token is provided or custom token fails
              const initialAuthToken =
                typeof __initial_auth_token !== "undefined"
                  ? __initial_auth_token
                  : null;

              if (initialAuthToken && initialAuthToken.length > 0) {
                try {
                  await signInWithCustomToken(appState.auth, initialAuthToken);
                } catch (customTokenError) {
                  console.warn(
                    "Custom token sign-in failed, falling back to anonymous:",
                    customTokenError
                  );
                  await signInAnonymously(appState.auth);
                }
              } else {
                await signInAnonymously(appState.auth);
              }
            }
            appState.isAuthReady = true;
            // ONLY set up Firestore listeners AFTER authentication is ready
            setupFirestoreListeners();
            renderApp(); // Initial render once auth is ready
          });
        } catch (error) {
          console.error("Error initializing Firebase or signing in:", error);
          showToast(
            "Failed to initialize app. Check console for Firebase configuration and network issues.",
            "error"
          );
          appState.isAuthReady = true; // Ensure UI unblocks even on error
          renderApp();
        }
      });
    </script>
  </body>
</html>
